<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯åº—å‹™ç³»çµ±</title>
    <style>
        /* --- æ¨£å¼è¨­å®šå€ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; }
        
        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input, button, select { width: 100%; padding: 12px; margin: 5px 0; font-size: 16px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button.manager-btn { background: #dc3545; } /* ç´…è‰²æŒ‰éˆ•çµ¦ä¸»ç®¡ */
        .hidden { display: none; }

        /* åœ°åœ–å€åŸŸæ¨¡å‹ */
        .store-map { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .zone { 
            background: #e9ecef; height: 100px; border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; border: 2px solid #ccc;
            text-align: center;
            transition: all 0.3s;
        }
        .zone:active { transform: scale(0.98); }
        .zone small { font-size: 12px; color: #666; margin-top: 5px; display: block;}
        
        /* ç‹€æ…‹é¡è‰²è®Šæ› */
        .zone.ok { background: #d4edda; border-color: #28a745; color: #155724; }
        .zone.warning { background: #fff3cd; border-color: #ffc107; color: #856404; }

        /* äº¤æ¥æ¸…å–® */
        ul { padding-left: 20px; }
        li { margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .meta { font-size: 12px; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h2 style="text-align:center;">ğŸª é›²ç«¯åº—å‹™ç³»çµ±</h2>
        <p style="text-align:center; color:gray; font-size:14px;">è«‹è¼¸å…¥å§“åèˆ‡è·ä½ä»¥ç™»å…¥</p>
        <label>é¸æ“‡èº«åˆ†ï¼š</label>
        <select id="role-select">
            <option value="staff">ä¸€èˆ¬å“¡å·¥</option>
            <option value="manager">å€¼ç­ä¸»ç®¡</option>
        </select>
        <input type="text" id="username" placeholder="è«‹è¼¸å…¥ä½ çš„å§“å">
        <button onclick="login()">ç™»å…¥ç³»çµ±</button>
    </div>

    <div id="app-screen" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; background: #333; color: white; padding: 10px; margin: -15px -15px 15px -15px;">
            <span id="user-display">ä½¿ç”¨è€…</span>
            <button onclick="location.reload()" style="width: auto; background: #555; font-size: 12px; padding: 5px 10px;">ç™»å‡º</button>
        </div>

        <h3>ğŸ“ ç¾å ´æª¢æŸ¥ (é»æ“Šå›å ±)</h3>
        <p style="font-size: 12px; color: gray;">ğŸ’¡ é»æ“Šæ ¼å­è¼¸å…¥ç‹€æ…‹ (å¦‚: æ­£å¸¸/æº«åº¦éé«˜)ï¼Œè³‡æ–™æœƒå³æ™‚åŒæ­¥</p>
        <div class="store-map">
            <div class="zone" id="zone-fridge-a" onclick="reportStatus('zone-fridge-a', 'å†°ç®± A (ç”Ÿé®®)')">
                <strong>å†°ç®± A (ç”Ÿé®®)</strong>
                <small id="status-zone-fridge-a">è¼‰å…¥ä¸­...</small>
            </div>
            <div class="zone" id="zone-fridge-b" onclick="reportStatus('zone-fridge-b', 'å†°ç®± B (é£²æ–™)')">
                <strong>å†°ç®± B (é£²æ–™)</strong>
                <small id="status-zone-fridge-b">è¼‰å…¥ä¸­...</small>
            </div>
            <div class="zone" id="zone-shelf-c" onclick="reportStatus('zone-shelf-c', 'è²¨æ¶ C (ä¹¾è²¨)')">
                <strong>è²¨æ¶ C (ä¹¾è²¨)</strong>
                <small id="status-zone-shelf-c">è¼‰å…¥ä¸­...</small>
            </div>
            <div class="zone" id="zone-cashier" onclick="reportStatus('zone-cashier', 'æ”¶éŠ€å°')">
                <strong>æ”¶éŠ€å°</strong>
                <small id="status-zone-cashier">è¼‰å…¥ä¸­...</small>
            </div>
        </div>

        <hr>
        <h3>ğŸ“ äº¤æ¥èˆ‡ä»£è¾¦</h3>
        <ul id="handover-list">
            <li>è³‡æ–™è¼‰å…¥ä¸­...</li>
        </ul>
        <div style="display:flex; gap:5px;">
            <input type="text" id="new-todo" placeholder="è¼¸å…¥äº¤æ¥äº‹é …...">
            <button onclick="addHandover()" style="width: 80px;">æ–°å¢</button>
        </div>

        <div id="manager-section" class="hidden">
            <hr>
            <h3 style="color: #dc3545;">ğŸ“Š ä¸»ç®¡è©•åˆ†/å ±è¡¨å€</h3>
            <div style="background: #ffebeb; padding: 10px; border-radius: 5px; border: 1px solid #f5c6cb;">
                <label>ä»Šæ—¥ç‡Ÿæ”¶èª¤å·® (å…ƒ)ï¼š</label>
                <input type="number" id="cash-diff" placeholder="ä¾‹å¦‚ï¼š-50">
                <label>ç›¸é—œäººå“¡/å‚™è¨»ï¼š</label>
                <input type="text" id="target-staff" placeholder="è¼¸å…¥å“¡å·¥å§“å">
                <button class="manager-btn" onclick="submitScore()">æäº¤è©•åˆ†èˆ‡æ‡²è™•</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // 1. å¼•å…¥ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. ä½ çš„å°ˆæ¡ˆé‘°åŒ™ (å·²å¡«å…¥)
    const firebaseConfig = {
      apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
      authDomain: "join-home-f3070.firebaseapp.com",
      projectId: "join-home-f3070",
      storageBucket: "join-home-f3070.firebasestorage.app",
      messagingSenderId: "590173788810",
      appId: "1:590173788810:web:13986424ec8bf9a5f7eb73",
      measurementId: "G-M4169BDVH5"
    };

    // 3. å•Ÿå‹•è³‡æ–™åº«
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // æŠŠåŠŸèƒ½æ›è¼‰åˆ°å…¨åŸŸè®Šæ•¸ windowï¼Œè®“ä¸‹æ–¹çš„æŒ‰éˆ•å¯ä»¥ä½¿ç”¨
    window.db = db;
    window.setDoc = setDoc;
    window.addDoc = addDoc;
    window.doc = doc;
    window.collection = collection;
    
    // 4. è¨­å®šå³æ™‚ç›£è½ (Real-time Listener)
    
    // ç›£è½æª¢æŸ¥å€åŸŸç‹€æ…‹
    const zones = ['zone-fridge-a', 'zone-fridge-b', 'zone-shelf-c', 'zone-cashier'];
    zones.forEach(zoneId => {
        onSnapshot(doc(db, "checks", zoneId), (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                // å‘¼å«ä¸‹æ–¹çš„æ›´æ–°ç•«é¢å‡½å¼
                updateZoneUI(zoneId, data);
            } else {
                // é è¨­ç‹€æ…‹
                updateZoneUI(zoneId, { status: "æœªæª¢æŸ¥", checker: "ç„¡" });
            }
        });
    });

    // ç›£è½äº¤æ¥äº‹é … (æœ€æ–°çš„ 10 ç­†)
    const q = query(collection(db, "handover"), orderBy("time", "desc"), limit(10));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById('handover-list');
        list.innerHTML = ""; 
        if (snapshot.empty) {
            list.innerHTML = "<li>ç›®å‰ç„¡äº¤æ¥äº‹é …</li>";
        }
        snapshot.forEach((doc) => {
            const data = doc.data();
            const timeStr = data.time ? new Date(data.time.toDate()).toLocaleString([], {hour: '2-digit', minute:'2-digit'}) : "";
            const li = document.createElement('li');
            li.innerHTML = `
                <span style="font-weight:bold;">${data.content}</span><br>
                <span class="meta">ğŸ‘¤ ${data.author} | ğŸ•’ ${timeStr}</span>
            `;
            list.appendChild(li);
        });
    });

    // ç•«é¢æ›´æ–°å·¥å…·
    window.updateZoneUI = function(elementId, data) {
        const el = document.getElementById(elementId);
        const statusText = document.getElementById('status-' + elementId);
        
        // é‡ç½®æ¨£å¼
        el.classList.remove('ok', 'warning');
        
        let displayStatus = data.status || "æœªæª¢æŸ¥";
        let displayTemp = data.temp ? `(${data.temp})` : "";
        let displayChecker = data.checker ? data.checker : "å¾…ç¢ºèª";

        if (displayStatus.includes('æ­£å¸¸') || displayStatus.includes('å®Œæˆ') || displayStatus.includes('ok')) {
            el.classList.add('ok');
            statusText.innerText = `âœ… ${displayStatus} ${displayTemp}\nğŸ‘¤ ${displayChecker}`;
        } else if (displayStatus === "æœªæª¢æŸ¥") {
            statusText.innerText = `âšª æœªæª¢æŸ¥`;
        } else {
            el.classList.add('warning');
            statusText.innerText = `âš ï¸ ${displayStatus} ${displayTemp}\nğŸ‘¤ ${displayChecker}`;
        }
    }
</script>

<script>
    let currentUser = null;

    // ç™»å…¥
    function login() {
        const name = document.getElementById('username').value;
        const role = document.getElementById('role-select').value;
        if (!name) return alert("è«‹è¼¸å…¥å§“åï¼");

        currentUser = { name, role };
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('user-display').innerText = `${role === 'manager' ? 'ä¸»ç®¡' : 'å¤¥ä¼´'}ï¼š${name}`;

        if (role === 'manager') {
            document.getElementById('manager-section').classList.remove('hidden');
        }
    }

    // å›å ±ç‹€æ…‹
    async function reportStatus(zoneId, zoneName) {
        if (!currentUser) return;
        
        const status = prompt(`æ­£åœ¨æª¢æŸ¥ã€${zoneName}ã€‘\nè«‹è¼¸å…¥ç‹€æ…‹ (ä¾‹å¦‚ï¼šæ­£å¸¸ã€æº«åº¦ 5åº¦ã€é«’äº‚)ï¼š`, "æ­£å¸¸");
        if (!status) return;

        try {
            // å¯«å…¥è³‡æ–™åº«
            await window.setDoc(window.doc(window.db, "checks", zoneId), {
                status: status,
                temp: status.includes('åº¦') ? status : '', 
                checker: currentUser.name,
                lastCheck: new Date(),
                zoneName: zoneName
            });
        } catch (e) {
            console.error(e);
            alert("ä¸Šå‚³å¤±æ•—ï¼è«‹æª¢æŸ¥ä½ æ˜¯å¦å·²å•Ÿç”¨ Firebase Firestore è³‡æ–™åº«ã€‚");
        }
    }

    // æ–°å¢äº¤æ¥
    async function addHandover() {
        const input = document.getElementById('new-todo');
        const val = input.value;
        if (!val) return;

        try {
            await window.addDoc(window.collection(window.db, "handover"), {
                content: val,
                author: currentUser.name,
                time: new Date()
            });
            input.value = ""; 
        } catch (e) {
            alert("æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«æ¬Šé™");
        }
    }

    // ä¸»ç®¡è©•åˆ†
    async function submitScore() {
        const diff = document.getElementById('cash-diff').value;
        const target = document.getElementById('target-staff').value;
        
        if(!diff || !target) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");

        try {
            await window.addDoc(window.collection(window.db, "reports"), {
                cashDiff: diff,
                targetStaff: target,
                manager: currentUser.name,
                date: new Date()
            });
            alert(`å·²è¨˜éŒ„ï¼š${target} èª¤å·® ${diff} å…ƒ`);
            document.getElementById('cash-diff').value = "";
            document.getElementById('target-staff').value = "";
        } catch (e) {
            alert("å„²å­˜å¤±æ•—");
        }
    }
</script>

</body>
</html>