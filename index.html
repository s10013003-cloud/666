<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>æ™ºæ…§é–€å¸‚ V35 (UUID çµæ§‹ç‰ˆ)</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f4f7f6; padding-bottom: 100px; }
    .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; }

    .nav { display: flex; position: sticky; top: 0; background: #fff; border-bottom: 3px solid #ddd; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .nav div { flex: 1; padding: 12px 0; text-align: center; font-weight: bold; color: #666; cursor: pointer; font-size: 14px; }
    .nav div.active { color: #007bff; border-bottom: 3px solid #007bff; background: #f0f8ff; }

    .section-header { background: #e9ecef; padding: 10px; margin: 10px 0; font-weight: bold; border-left: 5px solid #007bff; display: flex; justify-content: space-between; align-items: center; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 10px; }

    .box { border: 2px solid #ccc; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; background: #fff; min-height: 70px;
      display:flex; flex-direction:column; justify-content:center; align-items:center; position: relative; }
    .box.ok { background: #d4edda !important; border-color: #28a745 !important; color: #155724; }
    .box.alert { background: #f8d7da !important; border-color: #dc3545 !important; animation: flash 1s infinite; }
    .manager-note { display: block; font-size: 10px; color: #d63384; background: #fce4ec; padding: 2px 5px; border-radius: 4px; margin-top: 2px; border: 1px solid #f8bbd0; }

    .del-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%;
      font-size: 12px; display: none; z-index: 5; line-height:20px; text-align:center; }
    .editing .del-btn { display: block; }
    .editing .box { border: 2px dashed blue; }

    #shelf-canvas { border: 2px solid #333; position: relative; width: 95%; height: 350px; background: #eee; margin: 10px auto; overflow: hidden; }
    .shape { position: absolute; border: 2px solid #333; background: rgba(255,255,255,0.9);
      display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; cursor: pointer; text-align: center; padding: 2px; font-weight: bold; user-select:none;}
    .shape.done { background: #28a745 !important; color: white !important; }
    .shape.selected { border: 3px solid red; z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.5); }

    #bell { position: fixed; top: 10px; right: 10px; font-size: 24px; background: white; border-radius: 50%; padding: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 200; cursor: pointer; }
    #badge { position: absolute; top: 0; right: 0; background: red; color: white; width: 18px; height: 18px; border-radius: 50%;
      font-size: 11px; text-align: center; line-height: 18px; display: none; }
    #noti-dropdown { position: fixed; top: 60px; right: 10px; width: 260px; background: white; border: 1px solid #ccc;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 199; display: none; max-height: 300px; overflow-y: auto; border-radius: 8px; font-size: 13px; }
    .noti-item{ padding:8px 10px; border-bottom:1px solid #eee; }

    input, select, button, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #bbb; border-radius: 5px; box-sizing: border-box; font-size: 15px; }
    button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
    .btn-g { background: #28a745; } .btn-r { background: #dc3545; } .btn-o { background: #fd7e14; }
    .btn-s { width: auto; padding: 3px 8px; font-size: 12px; margin-right: 3px; }
    .hide { display: none !important; }

    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 14px; }
    td, th { border: 1px solid #ddd; padding: 5px; text-align: center; }
    .inp-money { width: 100%; text-align: center; padding: 8px; border: 1px solid #ccc; background: #fff; }

    #img-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000;
      display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    #img-overlay.show { opacity: 1; pointer-events: auto; }
    #big-img { max-width: 95%; max-height: 95%; border: 2px solid white; transition: transform 0.3s; transform: scale(0.5); }
    #img-overlay.show #big-img { transform: scale(1); }

    .star{ cursor:pointer; font-size:18px; color:#aaa; }
    .star.on{ color:#f5c518; }

    @keyframes flash { 0%, 100% {opacity: 1;} 50% {opacity: 0.5;} }
  </style>
</head>
<body>

<div id="img-overlay" onclick="closeZoom()"><img id="big-img" alt="zoom"></div>

<div id="bell" onclick="toggleNoti()">ğŸ””<div id="badge">0</div></div>
<div id="noti-dropdown"></div>

<div class="container">
  <div id="page-auth" style="padding:40px 20px; text-align:center;">
    <h2>ğŸª é–€å¸‚ V35</h2>
    <div id="box-login">
      <input id="l-id" placeholder="å¸³è™Ÿ">
      <input id="l-pw" type="password" placeholder="å¯†ç¢¼">
      <button onclick="login()">ç™»å…¥</button>
      <p onclick="swAuth(true)" style="color:blue; margin-top:20px; cursor:pointer;">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š</p>
    </div>

    <div id="box-reg" class="hide">
      <input id="r-name" placeholder="å§“å">
      <!-- V35: è¨»å†Šä¸æä¾›ä¸»ç®¡é¸é …ï¼ˆé¿å…è‡ªåŠ©å‡ç´šï¼‰ -->
      <select id="r-shift"><option>æ—©ç­</option><option>æ™šç­</option></select>
      <input id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
      <input id="r-pw" type="password" placeholder="è¨­å®šå¯†ç¢¼">
      <button class="btn-g" onclick="reg()">ç¢ºèªè¨»å†Š</button>
      <p onclick="swAuth(false)" style="color:blue; margin-top:20px; cursor:pointer;">è¿”å›ç™»å…¥</p>

      <div style="margin-top:16px; padding:10px; border:1px dashed #ccc; border-radius:8px; font-size:13px; color:#666;">
        ä¸»ç®¡å¸³è™Ÿå»ºè­°ç”±åº—é•·æ‰‹å‹•å»ºç«‹ï¼ˆé¿å…è¢«èª¤è¨»å†Šæˆä¸»ç®¡ï¼‰ã€‚
      </div>
    </div>
  </div>

  <div id="page-main" class="hide">
    <div style="background:#333; color:white; padding:10px; display:flex; justify-content:space-between; align-items:center;">
      <span id="user-info">--</span>
      <button onclick="location.reload()" style="width:auto; padding:5px 10px; background:#555; font-size:12px;">ç™»å‡º</button>
    </div>

    <div class="nav">
      <div onclick="tab('stock')" id="n-stock" class="active">è£œè²¨</div>
      <div onclick="tab('temp')" id="n-temp">å†°ç®±</div>
      <div onclick="tab('count')" id="n-count">å¸³å‹™</div>
      <div onclick="tab('svc')" id="n-svc">äº¤æ¥</div>
      <!-- V35: æ­£ç¢º idï¼šn-mgr -->
      <div onclick="tab('mgr')" id="n-mgr" class="hide">ä¸»ç®¡</div>
    </div>

    <div id="v-stock">
      <div class="section-header">
        ğŸ›’ æ¯æ—¥è£œè²¨
        <button id="btn-edit-stock" class="hide btn-s btn-o" onclick="toggleEdit('stock-list')">ç®¡ç†</button>
      </div>
      <div class="grid" id="stock-list"></div>
      <div id="add-stock-area" class="hide" style="padding:10px; text-align:center;">
        <button class="btn-g" onclick="addItem('stock')" style="width:100%">+ æ–°å¢é …ç›®</button>
      </div>

      <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸåœ–</div>
      <div id="mgr-map-tool" class="hide" style="padding:5px; background:#e9ecef;">
        <button onclick="addMapShape()" class="btn-s">+æ–¹å¡Š</button>
        <button onclick="saveMapData(true)" class="btn-s btn-g">ç™¼å¸ƒ</button>

        <div id="map-edit-bar" class="hide" style="margin-top:5px; padding:5px; background:#fff; border:1px solid #ccc;">
          <span style="font-size:12px;">é¸å–: <b id="sel-name"></b></span>
          <button onclick="renShape()" class="btn-s">æ”¹å</button>
          <button onclick="copyShape()" class="btn-s">è¤‡è£½</button>
          <button onclick="delShape()" class="btn-s btn-r">åˆªé™¤</button>
          <button onclick="reviewMapItem()" class="btn-s btn-o">æ‰¹æ”¹</button>
        </div>
      </div>
      <div id="shelf-canvas"></div>
    </div>

    <div id="v-temp" class="hide">
      <div class="section-header">
        â„ï¸ å†°ç®±æº«åº¦
        <button id="btn-edit-fridge" class="hide btn-s btn-o" onclick="toggleEdit('fridge-list')">ç®¡ç†</button>
      </div>
      <div class="grid" id="fridge-list"></div>
      <div id="add-fridge-area" class="hide" style="padding:10px;">
        <button class="btn-g" onclick="addItem('fridge')" style="width:100%">+ æ–°å¢å†°ç®±</button>
      </div>
    </div>

    <div id="v-count" class="hide">
      <div class="section-header">ğŸ“¥ é€²æ«ƒ (ä¸Šä¸€ç­)</div>
      <div style="padding:10px; background:#e3f2fd;">
        æ”¶éŠ€ï¼š<input id="in-c" disabled style="width:80px; display:inline">
        åº«å­˜ï¼š<input id="in-s" disabled style="width:80px; display:inline">
        <div id="mgr-in-tools" class="hide" style="margin-top:5px;">
          <button class="btn-s btn-o" onclick="unlockIn()">ä¿®æ”¹</button>
          <button id="btn-save-in" class="hide btn-s btn-g" onclick="saveIn()">å„²å­˜</button>
        </div>
      </div>

      <div class="section-header">ğŸª™ äº¤ç­é»ç®—</div>
      <table>
        <tr><th>é¢é¡</th><th>æ”¶éŠ€</th><th>åº«å­˜</th><th>å°è¨ˆ</th></tr>
        <tbody id="money-body"></tbody>
      </table>
      <div style="text-align:right; font-weight:bold; color:blue; padding:10px;">ç¸½è¨ˆ: $<span id="total-cash">0</span></div>

      <div class="section-header">ğŸ“ é›»è©±å¡</div>
      <div id="card-list" class="grid"></div>

      <div class="section-header">ğŸ“Š ç‡Ÿæ”¶</div>
      <div class="grid">
        <input type="number" id="val-rev" placeholder="ç‡Ÿæ¥­é¡" oninput="calcAvg()">
        <input type="number" id="val-vis" placeholder="ä¾†å®¢æ•¸" oninput="calcAvg()">
        <input type="text" id="val-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
      </div>
      <div class="grid">
        <input type="number" id="pay-cr" placeholder="ä¿¡ç”¨å¡"><input type="number" id="pay-tw" placeholder="å°ç£Pay">
        <input type="number" id="pay-ln" placeholder="Line Pay"><input type="number" id="pay-pt" placeholder="ä½¿ç”¨é»æ•¸">
        <input type="number" id="pay-rf" placeholder="ç¾é‡‘æ‰£æ¬¾">
      </div>

      <div class="section-header">â• é¡å¤–æ”¶æ”¯</div>
      <div class="grid">
        <button class="btn-g" onclick="addEx('in')">+æ”¶å…¥</button>
        <button class="btn-r" onclick="addEx('out')">+æ”¯å‡º</button>
      </div>
      <div id="ex-list" style="padding:10px;"></div>

      <button class="btn-g" style="width:100%; margin-top:20px;" onclick="alert('å ±è¡¨å·²å„²å­˜')">æäº¤äº¤ç­å ±è¡¨</button>
    </div>

    <div id="v-svc" class="hide">
      <div class="grid">
        <button onclick="openForm('äº¤æ¥')">ğŸ“ äº¤æ¥</button>
        <button onclick="openForm('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
        <button onclick="openForm('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
        <button onclick="openForm('å”®ç½„')">âš¡ å”®ç½„</button>
        <button onclick="openForm('å ±å»¢')">ğŸ—‘ï¸ å ±å»¢</button>
        <button onclick="openForm('è©¢å•')" class="btn-o">â“ è©¢å•</button>
      </div>
      <div id="feed-list" style="margin-top:15px;"></div>
    </div>

    <div id="v-mgr" class="hide">
      <div class="section-header">ğŸŒŸ å“¡å·¥è©•åˆ†</div>
      <select id="mgr-target"><option value="">é¸æ“‡å“¡å·¥</option></select>

      <div style="padding:15px; background:#f9f9f9; margin-top:10px;">
        <p>å·¥ä½œæ•ˆç‡:
          <span class="star" onclick="rate(this,1)">â˜…</span><span class="star" onclick="rate(this,2)">â˜…</span><span class="star" onclick="rate(this,3)">â˜…</span><span class="star" onclick="rate(this,4)">â˜…</span><span class="star" onclick="rate(this,5)">â˜…</span>
        </p>
        <p>è£œè²¨å®Œæˆ:
          <span class="star" onclick="rate(this,1)">â˜…</span><span class="star" onclick="rate(this,2)">â˜…</span><span class="star" onclick="rate(this,3)">â˜…</span><span class="star" onclick="rate(this,4)">â˜…</span><span class="star" onclick="rate(this,5)">â˜…</span>
        </p>
        <p>ç”Ÿé®®æª¢æŸ¥:
          <span class="star" onclick="rate(this,1)">â˜…</span><span class="star" onclick="rate(this,2)">â˜…</span><span class="star" onclick="rate(this,3)">â˜…</span><span class="star" onclick="rate(this,4)">â˜…</span><span class="star" onclick="rate(this,5)">â˜…</span>
        </p>
        <p>é¡§å®¢åæ‡‰:
          <span class="star" onclick="rate(this,1)">â˜…</span><span class="star" onclick="rate(this,2)">â˜…</span><span class="star" onclick="rate(this,3)">â˜…</span><span class="star" onclick="rate(this,4)">â˜…</span><span class="star" onclick="rate(this,5)">â˜…</span>
        </p>

        <button class="btn-g" onclick="saveRating()">å„²å­˜</button>
        <div id="rating-hint" style="margin-top:8px; font-size:12px; color:#666;"></div>
      </div>
    </div>
  </div>
</div>

<div id="modal-form" class="hide" style="position:fixed; top:5%; left:5%; width:90%; height:90%; background:white; border:2px solid #007bff; padding:15px; overflow-y:auto; z-index:3000; box-shadow:0 0 15px rgba(0,0,0,0.3);">
  <h3 id="modal-title">--</h3>
  <div id="modal-fields"></div>
  <div style="margin-top:10px;">
    <label>æ‹ç…§ä¸Šå‚³ï¼š</label>
    <input type="file" id="modal-img" accept="image/*" onchange="previewImg()">
    <img id="preview-box" alt="preview" style="width:100px; display:none; margin-top:5px; border:1px solid #ccc;">
  </div>
  <div style="margin-top:20px; display:flex; gap:10px;">
    <button class="btn-g" onclick="submitForm()">é€å‡º</button>
    <button onclick="document.getElementById('modal-form').classList.add('hide')" style="background:#666;">å–æ¶ˆ</button>
  </div>
</div>

<script>
/* =======================
   V35: UUID + é·ç§» + å®‰å…¨
   ======================= */

// --- DB: LocalStorage ---
const DB = {
  get: (k) => JSON.parse(localStorage.getItem(k) || '{}'),
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
  arr: (k) => JSON.parse(localStorage.getItem(k) || '[]'),
  push: (k, v) => {
    let a = JSON.parse(localStorage.getItem(k) || '[]');
    a.unshift(v);
    localStorage.setItem(k, JSON.stringify(a));
  }
};

// --- UUID ---
function uuid(){
  // crypto.randomUUID åœ¨ç¾ä»£ç€è¦½å™¨éƒ½å¯ç”¨ï¼›fallback ä¹Ÿæä¾›
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
    const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}

// --- æ—¥æœŸ keyï¼ˆæ¯æ—¥é‡ç½® status ç”¨ï¼‰ ---
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd= String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

// ============= V35 åˆå§‹åŒ–è³‡æ–™èˆ‡é·ç§» =============

// V35 conf_stock: [{id,name}]
function ensureStockConf(){
  const v = localStorage.getItem('conf_stock_v');
  if(v === '35') return;

  // èˆŠç‰ˆå¯èƒ½æ˜¯ conf_stock: ["å¤–ç±é¤…ä¹¾", ...]
  const oldRaw = localStorage.getItem('conf_stock');
  if(oldRaw){
    try{
      const old = JSON.parse(oldRaw);
      if(Array.isArray(old) && old.length && typeof old[0] === 'string'){
        const next = old.map(name=>({id: uuid(), name}));
        localStorage.setItem('conf_stock', JSON.stringify(next));
      }
    }catch(e){}
  }else{
    // å…¨æ–°é è¨­
    const next = ['å¤–ç±é¤…ä¹¾','å¤–ç±æ³¡éºµ','è¸æ¶','å†°ç®±é£²æ–™','å±¤æ¶é£²æ–™','å†·å‡é£Ÿå“','åƒåœ¾è¢‹/å…æ´—','è¡›ç”Ÿç´™','ç‰™è†/æ´—è¡£ç²¾','ä¸€èˆ¬é¤…ä¹¾/æ³¡éºµ']
      .map(name=>({id: uuid(), name}));
    localStorage.setItem('conf_stock', JSON.stringify(next));
  }

  localStorage.setItem('conf_stock_v','35');
}

// V35 conf_fridge: [{id,name,type}]
function ensureFridgeConf(){
  const v = localStorage.getItem('conf_fridge_v');
  if(v === '35') return;

  const oldRaw = localStorage.getItem('conf_fridge');
  if(oldRaw){
    try{
      const old = JSON.parse(oldRaw);
      if(Array.isArray(old) && old.length){
        if(typeof old[0] === 'object' && old[0].n && old[0].t){
          const next = old.map(f=>({id: uuid(), name: f.n, type: f.t}));
          localStorage.setItem('conf_fridge', JSON.stringify(next));
        }else if(typeof old[0] === 'object' && old[0].name && old[0].type && old[0].id){
          // å·²ç¶“æ˜¯æ–°çµæ§‹
        }
      }
    }catch(e){}
  }else{
    const next = [
      {name:'å†·è—1',type:'c'},{name:'å†·è—2',type:'c'},{name:'å†·è—3',type:'c'},{name:'å†·è—4',type:'c'},
      {name:'å†·å‡1',type:'f'},{name:'å†·å‡2',type:'f'},{name:'å†·å‡3',type:'f'},{name:'å†·å‡4',type:'f'},{name:'å†·å‡5',type:'f'},{name:'å†·å‡6',type:'f'}
    ].map(x=>({id:uuid(), ...x}));
    localStorage.setItem('conf_fridge', JSON.stringify(next));
  }

  localStorage.setItem('conf_fridge_v','35');
}

// status é·ç§»ï¼šèˆŠ key stk_0/ref_0 -> æ–° key itemId
function migrateStatusToUUID(){
  const v = localStorage.getItem('status_v');
  if(v === '35') return;

  const s = DB.get('status'); // èˆŠ: {stk_0:{...}, ref_1:{...}}
  const stockConf = DB.arr('conf_stock'); // æ–°: [{id,name}]
  const fridgeConf = DB.arr('conf_fridge'); // æ–°: [{id,name,type}]

  let next = {};

  // å˜—è©¦ä¾åºå°æ˜ ï¼ˆåªåšä¸€æ¬¡æ€§é·ç§»ï¼Œå¯èƒ½ä¸å®Œç¾ï¼Œä½†æ¯”ç›´æ¥æ¸…æ‰å¥½ï¼‰
  Object.keys(s).forEach(k=>{
    if(k.startsWith('stk_')){
      const idx = parseInt(k.split('_')[1],10);
      const it = stockConf[idx];
      if(it) next[it.id] = {...s[k], itemId: it.id, kind:'stock', name: it.name};
    }else if(k.startsWith('ref_')){
      const idx = parseInt(k.split('_')[1],10);
      const it = fridgeConf[idx];
      if(it) next[it.id] = {...s[k], itemId: it.id, kind:'fridge', name: it.name, type: it.type};
    }else{
      // å¦‚æœæœ¬ä¾†å°±ä¸æ˜¯ stk/refï¼Œä¿ç•™
      next[k] = s[k];
    }
  });

  DB.set('status', next);
  localStorage.setItem('status_v','35');
}

// æ¯æ—¥é‡ç½®ï¼šåªé‡ç½® statusï¼ˆä¸å‹• feeds / map_shapesï¼‰
function resetDailyStatusIfNeeded(){
  const meta = DB.get('meta');
  const t = todayKey();
  if(meta.lastDay !== t){
    // æ¸…æ‰æ¯æ—¥ç‹€æ…‹
    DB.set('status', {});
    DB.set('meta', {...meta, lastDay: t});
  }
}

// ============= å…¨åŸŸç‹€æ…‹ =============
let me = null;
let shapes = DB.arr('map_shapes');
let selShapeIdx = null;
let imgBase64 = "";
let exArr = [];

// ============= ç™»å…¥/è¨»å†Š =============
function swAuth(reg) {
  document.getElementById('box-login').classList.toggle('hide', reg);
  document.getElementById('box-reg').classList.toggle('hide', !reg);
}

function reg() {
  const id=document.getElementById('r-id').value.trim();
  const nm=document.getElementById('r-name').value.trim();
  const pw=document.getElementById('r-pw').value;
  const shift=document.getElementById('r-shift').value;
  if(!id||!nm||!pw) return alert("è«‹å¡«å¯«");

  let u=DB.get('users');
  if(u[id]) return alert("æ­¤å¸³è™Ÿå·²å­˜åœ¨");
  u[id]={name:nm, pw:pw, shift};
  DB.set('users', u);

  alert("âœ… è¨»å†ŠæˆåŠŸï¼"); swAuth(false);
}

function login() {
  const id=document.getElementById('l-id').value.trim();
  const pw=document.getElementById('l-pw').value;
  let u=DB.get('users');

  if(u[id] && u[id].pw===pw) { me={...u[id], id}; init(); }
  else alert("å¸³å¯†éŒ¯èª¤");
}

// ============= åˆå§‹åŒ– =============
function init() {
  // V35: åˆå§‹åŒ–/é·ç§»
  ensureStockConf();
  ensureFridgeConf();
  migrateStatusToUUID();
  resetDailyStatusIfNeeded();

  document.getElementById('page-auth').classList.add('hide');
  document.getElementById('page-main').classList.remove('hide');
  document.getElementById('user-info').innerText = `${me.name} (${me.shift})`;

  if(me.shift==='ä¸»ç®¡') {
    document.getElementById('n-mgr').classList.remove('hide');
    document.getElementById('mgr-map-tool').classList.remove('hide');
    document.getElementById('mgr-in-tools').classList.remove('hide');
    document.getElementById('btn-edit-stock').classList.remove('hide');
    document.getElementById('btn-edit-fridge').classList.remove('hide');
  }

  renderItems();

  document.getElementById('money-body').innerHTML =
    [500,100,50,10,5,1].map(u=>`
      <tr>
        <td>${u}</td>
        <td><input type="number" class="inp-money" id="mr_${u}" oninput="calcCash()"></td>
        <td><input type="number" class="inp-money" id="ms_${u}" oninput="calcCash()"></td>
        <td style="color:blue" id="sub_${u}">0</td>
      </tr>`).join('');

  const cards=["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
  document.getElementById('card-list').innerHTML =
    cards.map(c=>`
      <div style="border:1px solid #ccc; padding:5px; border-radius:5px;">
        <b>${c}</b>
        <div style="display:flex; gap:5px;">
          <input type="number" id="cd_s_${c}" placeholder="éŠ·" style="width:50%">
          <input type="number" id="cd_l_${c}" placeholder="å­˜" style="width:50%">
        </div>
      </div>`).join('');

  buildMgrTargets();
  renderAll();
}

// å»ºç«‹ä¸»ç®¡è©•åˆ†ä¸‹æ‹‰
function buildMgrTargets(){
  if(me.shift!=='ä¸»ç®¡') return;
  const u = DB.get('users');
  const sel = document.getElementById('mgr-target');
  sel.innerHTML = `<option value="">é¸æ“‡å“¡å·¥</option>` + Object.keys(u)
    .filter(k=>u[k].shift!=='ä¸»ç®¡')
    .map(k=>`<option value="${k}">${u[k].name} (${u[k].shift})</option>`)
    .join('');

  sel.onchange = loadRating;
  loadRating();
}

// ============= è£œè²¨/å†°ç®± æ¸²æŸ“ (UUID) =============
function renderItems() {
  const stocks = DB.arr('conf_stock'); // [{id,name}]
  document.getElementById('stock-list').innerHTML = stocks.map((it)=>`
    <div class="box" data-id="${it.id}" onclick="chkStock('${it.id}')">
      ${it.name}<br><small>å¾…æª¢</small>
      <div class="del-btn" onclick="delItem('stock','${it.id}'); event.stopPropagation();">X</div>
    </div>`).join('');

  const fridges = DB.arr('conf_fridge'); // [{id,name,type}]
  document.getElementById('fridge-list').innerHTML = fridges.map((it)=>`
    <div class="box" data-id="${it.id}" onclick="inputTemp('${it.id}')">
      ${it.name}<br><small>å¾…æ¸¬</small>
      <div class="del-btn" onclick="delItem('fridge','${it.id}'); event.stopPropagation();">X</div>
    </div>`).join('');
}

function renderAll() {
  let s=DB.get('status'), store=DB.get('store');

  // æ›´æ–°è£œè²¨ç‹€æ…‹
  document.querySelectorAll('#stock-list .box').forEach(el=>{
    const id = el.getAttribute('data-id');
    const st = s[id];
    if(st){
      el.className = `box ${st.alert?'alert':'ok'}`;
      el.innerHTML = `${st.name}<br><small>${st.alert?'âš ï¸ '+(st.val||'ç•°å¸¸') : 'âœ… '+(st.user||'')}</small>
        ${st.mgrReply ? `<span class="manager-note">æ‰¹: ${st.mgrReply}</span>` : ''}`
        + (document.querySelector('#stock-list.editing') ? `<div class="del-btn" onclick="delItem('stock','${id}'); event.stopPropagation();">X</div>` : '');
    }else{
      el.className = 'box';
      const nm = el.textContent.split('\n')[0];
      el.innerHTML = `${nm}<br><small>å¾…æª¢</small>`
        + (document.querySelector('#stock-list.editing') ? `<div class="del-btn" onclick="delItem('stock','${id}'); event.stopPropagation();">X</div>` : '');
    }
  });

  // æ›´æ–°å†°ç®±ç‹€æ…‹
  document.querySelectorAll('#fridge-list .box').forEach(el=>{
    const id = el.getAttribute('data-id');
    const st = s[id];
    if(st){
      el.className = `box ${st.alert?'alert':'ok'}`;
      el.innerHTML = `${st.name}<br><small>${st.alert?'âš ï¸ '+(st.val||'ç•°å¸¸') : 'âœ… '+(st.user||'')}</small>
        ${st.mgrReply ? `<span class="manager-note">æ‰¹: ${st.mgrReply}</span>` : ''}`
        + (document.querySelector('#fridge-list.editing') ? `<div class="del-btn" onclick="delItem('fridge','${id}'); event.stopPropagation();">X</div>` : '');
    }else{
      el.className = 'box';
      const nm = el.textContent.split('\n')[0];
      el.innerHTML = `${nm}<br><small>å¾…æ¸¬</small>`
        + (document.querySelector('#fridge-list.editing') ? `<div class="del-btn" onclick="delItem('fridge','${id}'); event.stopPropagation();">X</div>` : '');
    }
  });

  // é€²æ«ƒæ›´æ–°ï¼ˆV35: merge storeï¼Œä¸è¦†è“‹ï¼‰
  document.getElementById('in-c').value = store.cash || 0;
  document.getElementById('in-s').value = store.stock || 0;

  // é›»è©±å¡ placeholder
  if(store.cards) {
    for(let k in store.cards) {
      let el = document.getElementById(`cd_l_${k}`);
      if(el) el.placeholder = `ä¸Š:${store.cards[k]}`;
    }
  }

  renderFeed();
  drawMap();
}

function tab(t) {
  document.querySelectorAll('.nav div').forEach(e=>e.classList.remove('active'));
  document.getElementById('n-'+t).classList.add('active');
  ['stock','temp','count','svc','mgr'].forEach(x=>document.getElementById('v-'+x).classList.add('hide'));
  document.getElementById('v-'+t).classList.remove('hide');
}

// ============= è£œè²¨ checkï¼šUUID key =============
function chkStock(itemId) {
  if(document.querySelector('#stock-list.editing')) return;

  const conf = DB.arr('conf_stock').find(x=>x.id===itemId);
  if(!conf) return alert("æ‰¾ä¸åˆ°é …ç›®");

  let s=DB.get('status');

  if(me.shift === 'ä¸»ç®¡' && s[itemId] && s[itemId].user) {
    const r = prompt(`å“¡å·¥ ${s[itemId].user} æ–¼ ${s[itemId].time} å®Œæˆã€‚\nè«‹è¼¸å…¥ä¸»ç®¡è©•èª/æ‰¹æ”¹ï¼š`, s[itemId].mgrReply || "");
    if(r !== null) {
      s[itemId].mgrReply = r;
      DB.set('status', s);
      renderAll();
    }
  } else {
    if(confirm(`${conf.name} å®Œæˆï¼Ÿ`)) {
      s[itemId]={itemId, kind:'stock', name: conf.name, user:me.name, time:new Date().toLocaleTimeString()};
      DB.set('status',s);
      renderAll();
    }
  }
}

// ============= å†°ç®±æº«åº¦ï¼šUUID key =============
function inputTemp(itemId) {
  if(document.querySelector('#fridge-list.editing')) return;

  const conf = DB.arr('conf_fridge').find(x=>x.id===itemId);
  if(!conf) return alert("æ‰¾ä¸åˆ°å†°ç®±");

  const v=prompt(conf.name+" æº«åº¦ï¼š", conf.type==='f'?'-':'');
  if(v===null || v==="") return;
  const n=parseFloat(v);
  if(Number.isNaN(n)) return alert("è«‹è¼¸å…¥æ•¸å­—");

  let alertFlag=false;
  if((conf.type==='f' && n>-10) || (conf.type==='c' && (n<0 || n>7))) {
    alert("ğŸš¨ æº«åº¦ç•°å¸¸ï¼");
    alertFlag=true;
  }

  let s=DB.get('status');
  s[itemId]={itemId, kind:'fridge', name: conf.name, type: conf.type, user:me.name, val:v+"åº¦", alert:alertFlag, time:new Date().toLocaleTimeString()};
  DB.set('status',s);
  renderAll();
}

// ============= ä¸»ç®¡ç®¡ç†æ¨¡å¼ï¼ˆUUIDï¼‰ =============
function toggleEdit(listId) {
  const el = document.getElementById(listId);
  el.classList.toggle('editing');
  const btn = listId==='stock-list' ? 'add-stock-area' : 'add-fridge-area';
  document.getElementById(btn).classList.toggle('hide');
  renderAll();
}

function addItem(type) {
  if(type==='stock'){
    const list = DB.arr('conf_stock');
    const name = prompt("åç¨±:");
    if(!name) return;
    list.push({id:uuid(), name:name.trim()});
    localStorage.setItem('conf_stock', JSON.stringify(list));
    renderItems(); renderAll();
  }else{
    const list = DB.arr('conf_fridge');
    const name = prompt("å†°ç®±åç¨±:");
    if(!name) return;
    const t = prompt("é¡å‹ (c=å†·è—, f=å†·å‡)", "c");
    const typeChar = (t||'c').toLowerCase()==='f' ? 'f' : 'c';
    list.push({id:uuid(), name:name.trim(), type:typeChar});
    localStorage.setItem('conf_fridge', JSON.stringify(list));
    renderItems(); renderAll();
  }
}

function delItem(type, itemId) {
  if(!confirm("åˆªé™¤?")) return;

  let s = DB.get('status');
  if(s[itemId]) delete s[itemId];
  DB.set('status', s);

  if(type==='stock'){
    let list = DB.arr('conf_stock').filter(x=>x.id!==itemId);
    localStorage.setItem('conf_stock', JSON.stringify(list));
  }else{
    let list = DB.arr('conf_fridge').filter(x=>x.id!==itemId);
    localStorage.setItem('conf_fridge', JSON.stringify(list));
  }

  renderItems();
  renderAll();
}

// ============= å¸³å‹™ =============
function calcCash() {
  let tot=0;
  [500,100,50,10,5,1].forEach(u=>{
    const r=Number(document.getElementById(`mr_${u}`).value)||0;
    const s=Number(document.getElementById(`ms_${u}`).value)||0;
    const sub=(r+s)*u;
    document.getElementById(`sub_${u}`).innerText=sub;
    tot+=sub;
  });
  document.getElementById('total-cash').innerText=tot;
}

function calcAvg() {
  const s=Number(document.getElementById('val-rev').value);
  const v=Number(document.getElementById('val-vis').value);
  if(v>0) document.getElementById('val-avg').value=Math.round(s/v);
  else document.getElementById('val-avg').value="";
}

function addEx(type) {
  const a=prompt("é‡‘é¡");
  const t=prompt("å‚™è¨»");
  if(a) {
    exArr.push({type, amt:Number(a), txt:t});
    document.getElementById('ex-list').innerHTML += `<div style="color:${type==='in'?'green':'red'}">${type==='in'?'æ”¶':'æ”¯'} $${a} (${t||''})</div>`;
  }
}

// æ¬Šé™è§£é–
function unlockIn() {
  document.getElementById('in-c').disabled=false;
  document.getElementById('in-s').disabled=false;
  document.getElementById('btn-save-in').classList.remove('hide');
}

// V35: store merge æ›´æ–°ï¼Œé¿å…è¦†è“‹ cards
function saveIn() {
  const old = DB.get('store');
  const next = {
    ...old,
    cash: parseFloat(document.getElementById('in-c').value) || 0,
    stock: parseFloat(document.getElementById('in-s').value) || 0
  };
  DB.set('store', next);
  alert("å·²æ›´æ–°");
  location.reload();
}

// ============= è¡¨å–® =============
let fType="";
function openForm(t) {
  fType=t;
  document.getElementById('modal-form').classList.remove('hide');
  document.getElementById('modal-title').innerText=t;
  const f=document.getElementById('modal-fields');
  imgBase64="";
  document.getElementById('preview-box').style.display='none';

  if(t==='å®¢è¨‚') f.innerHTML=`
    <input id="fi-1" placeholder="å“å">
    <input id="fi-2" placeholder="æ¢ç¢¼">
    <input id="fi-3" type="number" placeholder="æ•¸é‡">
    <input id="fi-4" type="number" placeholder="å”®åƒ¹">
    <hr>
    <input id="fi-5" placeholder="å®¢å">
    <input id="fi-6" placeholder="é›»è©±">
    <input id="fi-7" placeholder="LINE ID">
    <input id="fi-8" placeholder="è¯çµ¡æ™‚é–“">`;
  else if(t==='ç¶­ä¿®') f.innerHTML=`
    <input id="fi-1" placeholder="å“å">
    <input id="fi-2" placeholder="æ•…éšœåŸå› ">
    <input id="fi-3" type="date" placeholder="è³¼è²·æ—¥">
    <input id="fi-4" placeholder="æ¢ç¢¼">
    <hr>
    <input id="fi-5" placeholder="å®¢å">
    <input id="fi-6" placeholder="é›»è©±">
    <input id="fi-7" placeholder="LINE ID">
    <input id="fi-8" placeholder="è¯çµ¡æ™‚é–“">`;
  else if(t==='å ±å»¢') f.innerHTML=`
    <input id="fi-1" placeholder="å“å">
    <input id="fi-2" placeholder="æ¢ç¢¼">
    <input id="fi-3" placeholder="æ•¸é‡">`;
  else f.innerHTML=`<textarea id="fi-1" placeholder="å…§å®¹..." style="height:100px"></textarea>`;
}

function previewImg() {
  const file = document.getElementById('modal-img').files[0];
  if(file) {
    const r = new FileReader();
    r.onload = e => {
      imgBase64 = e.target.result;
      document.getElementById('preview-box').src = imgBase64;
      document.getElementById('preview-box').style.display = 'block';
    };
    r.readAsDataURL(file);
  }
}

function submitForm() {
  let txt="";
  document.querySelectorAll('#modal-fields input, #modal-fields textarea').forEach(i=>{
    if(i.value) txt+= i.placeholder + ":" + i.value + " / ";
  });
  if(!txt && !imgBase64) return alert("âŒ è«‹å‹¿ç•™ç©ºï¼");

  DB.push('feeds', {id:uuid(), type:fType, txt, img:imgBase64, user:me.name, time:new Date().toLocaleString(), done:false, mgrReply:""});
  alert("âœ… æˆåŠŸ");
  document.getElementById('modal-form').classList.add('hide');
  renderFeed();
}

// ============= äº¤æ¥è¨Šæ¯ / éˆ´éº =============
function renderFeed() {
  const fs=DB.arr('feeds');
  const d=document.getElementById('feed-list'); d.innerHTML="";
  const noti=document.getElementById('noti-dropdown'); noti.innerHTML="";
  let unread=0;

  fs.forEach((b,i)=>{
    if(!b.done) {
      unread++;
      noti.innerHTML += `<div class="noti-item">${b.type}: ${(b.txt||'').substring(0,18)}...</div>`;
    }

    d.innerHTML += `
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px; border-left:5px solid ${b.done?'green':'orange'}">
        <b>[${b.type}] ${b.user}</b> <small>${b.time}</small><br>${b.txt||''}
        ${b.img ? `<br><img src="${b.img}" style="width:60px; margin-top:5px;" onclick="zoom('${b.img}')">` : ''}
        ${b.mgrReply ? `<div style="background:#fce4ec; padding:5px; margin-top:5px; font-size:12px; color:#d63384;">ğŸ‘® æ‰¹æ”¹: ${b.mgrReply}</div>` : ''}
        <div style="text-align:right; margin-top:5px;">
          ${!b.done ? `<button onclick="finishFeed(${i})" class="btn-s">å®Œæˆ</button>` : 'âœ…'}
          ${me.shift==='ä¸»ç®¡' ? `<button onclick="replyFeed(${i})" class="btn-s btn-o">æ‰¹æ”¹</button>` : ''}
        </div>
      </div>`;
  });

  const badge = document.getElementById('badge');
  badge.innerText = unread;
  badge.style.display = unread>0 ? 'block' : 'none';
}

function finishFeed(i) {
  let fs=DB.arr('feeds');
  fs[i].done=true;
  localStorage.setItem('feeds',JSON.stringify(fs));
  renderFeed();
}
function replyFeed(i) {
  const r=prompt("æ‰¹æ”¹/å›è¦†ï¼š", DB.arr('feeds')[i].mgrReply||"");
  if(r!==null){
    let fs=DB.arr('feeds');
    fs[i].mgrReply=r;
    localStorage.setItem('feeds',JSON.stringify(fs));
    renderFeed();
  }
}
function toggleNoti() {
  const n=document.getElementById('noti-dropdown');
  n.style.display=n.style.display==='block'?'none':'block';
}
function zoom(s){
  document.getElementById('big-img').src=s;
  document.getElementById('img-overlay').classList.add('show');
}
function closeZoom(){
  document.getElementById('img-overlay').classList.remove('show');
}

// ============= åœ°åœ–ï¼šæ‹–æ›³ä¿®æ­£ï¼ˆcanvas ç›¸å°åº§æ¨™ï¼‰ =============
function drawMap() {
  const c=document.getElementById('shelf-canvas');
  c.innerHTML="";
  shapes = DB.arr('map_shapes');

  shapes.forEach((s,i)=>{
    const d=document.createElement('div');
    d.className = `shape ${s.done?'done':''} ${selShapeIdx===i?'selected':''}`;
    d.style.left=(s.x||50)+'px';
    d.style.top=(s.y||50)+'px';
    d.style.width="60px";
    d.style.height="40px";

    let info = s.name || 'æœªå‘½å';
    if(s.done) {
      const t = (s.checkTime||'').split(' ')[1] || '';
      info += `<br><span style='font-size:9px'>âœ…${s.checker||'æŸäºº'} ${t}</span>`;
    }
    if(s.mgrNote) info += `<br><span style='font-size:9px; color:purple'>æ‰¹:${s.mgrNote}</span>`;
    d.innerHTML = info;

    if(me.shift==='ä¸»ç®¡') {
      d.onclick=()=>{
        selShapeIdx=i;
        document.getElementById('sel-name').innerText=s.name||'æœªå‘½å';
        document.getElementById('map-edit-bar').classList.remove('hide');
        drawMap();
      };

      d.onmousedown=(e)=>{
        e.preventDefault();
        const canvas = document.getElementById('shelf-canvas');
        const rect = canvas.getBoundingClientRect();

        const startX = e.clientX - rect.left;
        const startY = e.clientY - rect.top;

        const ox = startX - (s.x||0);
        const oy = startY - (s.y||0);

        document.onmousemove = (ev)=>{
          const x = ev.clientX - rect.left;
          const y = ev.clientY - rect.top;
          s.x = Math.max(0, Math.min(x - ox, rect.width - 60));
          s.y = Math.max(0, Math.min(y - oy, rect.height - 40));
          d.style.left = s.x + 'px';
          d.style.top  = s.y + 'px';
        };

        document.onmouseup = ()=>{
          document.onmousemove = null;
          document.onmouseup = null;
          saveMapData(false); // æ”¾é–‹è‡ªå‹•å­˜
        };
      };
    } else {
      d.onclick=()=>{
        if(confirm("å®Œæˆ?")){
          s.done=true;
          s.checker=me.name;
          s.checkTime=new Date().toLocaleString();
          saveMapData(false);
        }
      };
    }

    c.appendChild(d);
  });
}

function addMapShape(){
  const n=prompt("åç¨±");
  if(n){
    shapes.push({id:uuid(), name:n, x:50, y:50, done:false, checker:"", checkTime:"", mgrNote:""});
    saveMapData(true);
  }
}

function saveMapData(showAlert){
  localStorage.setItem('map_shapes',JSON.stringify(shapes));
  drawMap();
  if(me.shift==='ä¸»ç®¡' && showAlert) alert("å·²ç™¼å¸ƒ");
}

function delShape(){
  if(selShapeIdx===null) return;
  shapes.splice(selShapeIdx,1);
  selShapeIdx=null;
  saveMapData(true);
  document.getElementById('map-edit-bar').classList.add('hide');
}

function renShape(){
  if(selShapeIdx===null) return;
  const n=prompt("æ–°å", shapes[selShapeIdx].name||"");
  if(n){
    shapes[selShapeIdx].name=n;
    saveMapData(true);
  }
}

function copyShape(){
  if(selShapeIdx===null) return;
  const s=shapes[selShapeIdx];
  shapes.push({...s, id:uuid(), x:(s.x||50)+20, y:(s.y||50)+20});
  saveMapData(true);
}

function reviewMapItem(){
  if(selShapeIdx===null) return;
  const r = prompt("è¼¸å…¥æ‰¹æ”¹æ„è¦‹ï¼š", shapes[selShapeIdx].mgrNote||"");
  if(r!==null){
    shapes[selShapeIdx].mgrNote = r;
    saveMapData(true);
  }
}

// ============= ä¸»ç®¡è©•åˆ†ï¼ˆå¯ä¿å­˜ï¼‰ =============
function rate(el, v){
  const p = el.parentNode;
  const stars = p.querySelectorAll('.star');
  stars.forEach((s,i)=> s.classList.toggle('on', i < v));
  p.dataset.score = String(v);
}

function loadRating(){
  if(me.shift!=='ä¸»ç®¡') return;
  const uid = document.getElementById('mgr-target').value;
  const hint = document.getElementById('rating-hint');
  if(!uid){
    hint.innerText = "è«‹å…ˆé¸æ“‡å“¡å·¥";
    // æ¸…é¡¯ç¤º
    document.querySelectorAll('#v-mgr p').forEach(p=>{
      p.dataset.score = "";
      p.querySelectorAll('.star').forEach(s=>s.classList.remove('on'));
    });
    return;
  }
  const all = DB.get('ratings');
  const rec = all[uid] || {};
  const keys = ['å·¥ä½œæ•ˆç‡','è£œè²¨å®Œæˆ','ç”Ÿé®®æª¢æŸ¥','é¡§å®¢åæ‡‰'];

  document.querySelectorAll('#v-mgr p').forEach((p,idx)=>{
    const k = keys[idx];
    const v = Number(rec[k]||0);
    p.dataset.score = String(v||"");
    const stars = p.querySelectorAll('.star');
    stars.forEach((s,i)=> s.classList.toggle('on', i < v));
  });

  hint.innerText = rec._time ? `ä¸Šæ¬¡å„²å­˜ï¼š${rec._time}` : "å°šæœªå„²å­˜éè©•åˆ†";
}

function saveRating(){
  if(me.shift!=='ä¸»ç®¡') return;
  const uid = document.getElementById('mgr-target').value;
  if(!uid) return alert("è«‹å…ˆé¸æ“‡å“¡å·¥");

  const keys = ['å·¥ä½œæ•ˆç‡','è£œè²¨å®Œæˆ','ç”Ÿé®®æª¢æŸ¥','é¡§å®¢åæ‡‰'];
  const ps = document.querySelectorAll('#v-mgr p');
  let rec = {};
  ps.forEach((p,idx)=>{
    rec[keys[idx]] = Number(p.dataset.score||0);
  });
  rec._time = new Date().toLocaleString();
  rec._by = me.name;

  const all = DB.get('ratings');
  all[uid] = rec;
  DB.set('ratings', all);

  alert("è©•åˆ†å·²å„²å­˜");
  loadRating();
}
</script>
</body>
</html>
