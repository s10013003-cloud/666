<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é–€å¸‚ç³»çµ± V18</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #343a40; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; }
        
        /* èªè­‰ä»‹é¢ */
        .auth-box { padding: 40px 20px; text-align: center; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* å°èˆªåˆ— */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .nav-item { flex: 0 0 auto; padding: 15px 20px; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; color: #666; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8f9fa; }

        /* æ ¼å­ç‹€æ…‹ */
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 15px 5px; text-align: center; cursor: pointer; min-height: 80px; }
        .zone.ok { background: #d4edda !important; border-color: #28a745 !important; color: #155724; }
        .zone.warning { background: #fff3cd !important; border-color: #dc3545 !important; animation: flash 1s infinite; }
        .highlight-foreign { background: #f3e5f5; border: 2px solid #6f42c1; color: #5e35b1; font-weight: bold; }

        /* å¸³å‹™å¤§ç©ºæ ¼ */
        .money-table { width: 100%; border-collapse: collapse; }
        .money-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .money-table input { width: 85px; height: 40px; font-size: 20px; text-align: center; border: 1px solid #999; }
        
        /* æµ®å‹•æŒ‰éˆ•/éˆ´éº */
        #bell { position: fixed; top: 15px; right: 15px; z-index: 2000; cursor: pointer; font-size: 24px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .dot { position: absolute; top: 0; right: 0; background: red; width: 10px; height: 10px; border-radius: 50%; }

        /* é€šç”¨ */
        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-success { background: var(--success); }
        .hidden { display: none !important; }
        @keyframes flash { 0%, 100% {opacity: 1;} 50% {opacity: 0.6;} }
    </style>
</head>
<body>

<div id="bell" onclick="showNoti()">
    ğŸ””<div id="noti-dot" class="dot hidden"></div>
</div>

<div class="container">
    <div id="auth-screen" class="auth-box">
        <div class="card">
            <h2 id="auth-title">ğŸª æ™ºæ…§é–€å¸‚ V18</h2>
            <div id="login-area">
                <input type="text" id="l-id" placeholder="å¸³è™Ÿ">
                <input type="password" id="l-pw" placeholder="å¯†ç¢¼">
                <button onclick="doLogin()">ç™»å…¥æ‰“å¡</button>
                <p onclick="toggleAuth(true)" style="color:blue; cursor:pointer;">æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š</p>
            </div>
            <div id="register-area" class="hidden">
                <input type="text" id="r-name" placeholder="çœŸå¯¦å§“å">
                <select id="r-shift"><option value="æ—©ç­">æ—©ç­</option><option value="æ™šç­">æ™šç­</option><option value="ä¸»ç®¡">ä¸»ç®¡</option></select>
                <input type="text" id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
                <input type="password" id="r-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button class="btn-success" onclick="doRegister()">ç¢ºèªè¨»å†Š</button>
                <p onclick="toggleAuth(false)" style="color:blue; cursor:pointer;">è¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±</div>
            <div class="nav-item" onclick="switchTab('counter')">ğŸ’° å¸³å‹™</div>
            <div class="nav-item" onclick="switchTab('handover')">ğŸ¤ äº¤æ¥å®¢æœ</div>
            <div id="nav-mgr" class="nav-item hidden" onclick="switchTab('manager')">ğŸ“Š ä¸»ç®¡</div>
        </div>

        <div id="tab-stock" class="p-10">
            <div class="section-header" style="background:#fce4ec; padding:10px;">ğŸ”¥ é‡é» (å¤–ç±æ³¡éºµ/é¤…ä¹¾)</div>
            <div class="grid-box">
                <div class="zone highlight-foreign" id="s-for-n" onclick="checkItem('s-for-n','å¤–ç±æ³¡éºµ')">å¤–ç±æ³¡éºµ<br><small>å¾…æª¢</small></div>
                <div class="zone highlight-foreign" id="s-for-c" onclick="checkItem('s-for-c','å¤–ç±é¤…ä¹¾')">å¤–ç±é¤…ä¹¾<br><small>å¾…æª¢</small></div>
            </div>
            <div class="section-header" style="padding:10px;">ğŸ“… æ¯æ—¥æ•ˆæœŸ</div>
            <div class="grid-box">
                <div class="zone" id="c-f" onclick="checkItem('c-f','ç”Ÿé®®æ•ˆæœŸ')">ç”Ÿé®®æ•ˆæœŸ</div>
                <div class="zone" id="c-d" onclick="checkItem('c-d','æ—¥é…æ•ˆæœŸ')">æ—¥é…æ•ˆæœŸ</div>
                <div class="zone" id="c-b" onclick="checkItem('c-b','éºµåŒ…æ•ˆæœŸ')">éºµåŒ…æ•ˆæœŸ</div>
            </div>
            <div class="section-header" style="padding:10px;">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸæ¨¡å‹</div>
            <div id="mgr-map-ctrl" class="hidden">
                <button onclick="addMap()">+æ–°å¢æ–¹å¡Š</button>
                <button onclick="saveMap()" style="background:green;">å„²å­˜åœ°åœ–</button>
            </div>
            <div id="shelf-canvas"></div>
        </div>

        <div id="tab-temp" class="hidden">
            <div class="section-header" style="padding:10px;">ğŸŒ¡ï¸ å†°ç®± 10 å° (å®šæ™‚æª¢æŸ¥)</div>
            <div id="f-grid" class="grid-box"></div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header" style="padding:10px;">ğŸ“¥ é€²æ«ƒè³‡è¨Š <button id="m-edit-in" class="hidden" onclick="unlockIn()" style="width:auto; padding:2px 8px; font-size:10px;">ä¸»ç®¡ç·¨è¼¯</button></div>
            <div style="background:#e3f2fd; padding:15px; border-radius:8px;">
                æ”¶éŠ€ç¾é‡‘ï¼š<input type="number" id="in-cash" disabled>
                åº«å­˜é›¶éŒ¢ï¼š<input type="number" id="in-stock" disabled>
                <button id="in-save" class="hidden" onclick="saveInV18()" style="background:green;">å„²å­˜é€²æ«ƒ</button>
            </div>
            <div class="section-header" style="padding:10px;">ğŸª™ é›¢æ«ƒé»ç®— (å¤§ç©ºæ ¼)</div>
            <table class="money-table" id="m-table"></table>
            <div style="text-align:right; font-weight:bold; color:blue; padding:10px;">ç¸½è¨ˆï¼š$<span id="out-sum">0</span></div>
            <hr>
            <input type="number" id="v-sales" placeholder="ç‡Ÿæ¥­é¡" oninput="calcAvg()">
            <input type="number" id="v-visit" placeholder="ä¾†å®¢æ•¸" oninput="calcAvg()">
            <input type="text" id="v-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
            <button onclick="doCalcV18()" style="background:orange; color:black;">ğŸ§® è©¦ç®—</button>
            <button onclick="doSubmitV18()" style="background:green;">âœ… æäº¤å ±è¡¨</button>
        </div>

        <div id="tab-handover" class="hidden">
            <div class="grid-box">
                <button onclick="openForm('äº¤æ¥')">ğŸ“ äº¤æ¥</button>
                <button onclick="openForm('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="openForm('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
                <button onclick="openForm('å”®ç½„')">âš¡ å”®ç½„</button>
            </div>
            <div id="svc-pop" class="hidden" style="background:#fff; border:2px solid var(--primary); padding:15px; border-radius:12px; margin-top:10px;">
                <h3 id="svc-title">--</h3>
                <div id="svc-fields"></div>
                <input type="file" id="svc-img" accept="image/*" capture="camera">
                <button onclick="submitSvcV18()">ç¢ºèªç™¼é€</button>
            </div>
            <div id="feed" style="margin-top:15px;"></div>
        </div>

        <div id="tab-manager" class="hidden">
            <div class="section-header" style="padding:10px;">ğŸŒŸ ç¸¾æ•ˆè©•åˆ†</div>
            <select id="e-target"><option value="">é¸æ“‡å“¡å·¥</option></select>
            <button onclick="saveRatingV18()">å„²å­˜è©•åˆ†</button>
        </div>
    </div>
</div>

<script>
    // --- 1. Firebase åˆå§‹åŒ– (ç©©å®šå…¨åŸŸç‰ˆ) ---
    const config = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73"
    };
    firebase.initializeApp(config);
    const db = firebase.firestore();

    let user = null;
    let mapShapes = [];

    // --- 2. èªè­‰åŠŸèƒ½ (ä¿®æ­£ç™»å…¥ Bug) ---
    function toggleAuth(isReg) {
        document.getElementById('login-area').classList.toggle('hidden', isReg);
        document.getElementById('register-area').classList.toggle('hidden', !isReg);
    }

    async function doRegister() {
        const id = document.getElementById('r-id').value;
        const name = document.getElementById('r-name').value;
        const pw = document.getElementById('r-pw').value;
        const shift = document.getElementById('r-shift').value;
        if(!id || !name || !pw) return alert("è«‹å¡«å¯«å®Œæ•´");
        
        await db.collection("users").doc(id).set({ name, pw, shift, points: 0 });
        alert("âœ… è¨»å†ŠæˆåŠŸï¼è«‹æŒ‰ç¢ºå®šå¾Œè¿”å›ç™»å…¥ç•«é¢ã€‚");
        toggleAuth(false);
    }

    async function doLogin() {
        const id = document.getElementById('l-id').value;
        const pw = document.getElementById('l-pw').value;
        try {
            const snap = await db.collection("users").doc(id).get();
            if(snap.exists() && snap.data().pw === pw) {
                user = { ...snap.data(), id };
                startApp();
            } else alert("âŒ å¸³å¯†éŒ¯èª¤");
        } catch(e) { alert("é€£ç·šå¤±æ•—ï¼š" + e.message); }
    }

    // --- 3. æ ¸å¿ƒç¨‹å¼ ---
    function startApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        if(user.shift === 'ä¸»ç®¡') {
            document.getElementById('nav-mgr').classList.remove('hidden');
            document.getElementById('mgr-map-ctrl').classList.remove('hidden');
            document.getElementById('m-edit-in').classList.remove('hidden');
        }
        
        // å†°ç®±åˆå§‹åŒ–
        const fridges = [
            {id:'f1',n:'é–‹æ”¾1',t:'c'},{id:'f2',n:'é–‹æ”¾2',t:'c'},{id:'f3',n:'å†·è—1',t:'c'},{id:'f4',n:'å†·è—2',t:'c'},
            {id:'f5',n:'å†·å‡1',t:'f'},{id:'f6',n:'å†·å‡2',t:'f'},{id:'f7',n:'è‡¥å¼1',t:'f'},{id:'f8',n:'è‡¥å¼2',t:'f'},
            {id:'f9',n:'è‡¥å¼3',t:'f'},{id:'f10',n:'è‡¥å¼4',t:'f'}
        ];
        document.getElementById('f-grid').innerHTML = fridges.map(f => `<div class="zone" id="${f.id}" onclick="inputT('${f.id}','${f.n}','${f.t}')">${f.n}<br><small>å¾…æ¸¬</small></div>`).join('');

        // éŒ¢å¹£è¡¨æ ¼
        const units = [500,100,50,10,5,1];
        document.getElementById('m-table').innerHTML = units.map(u => `<tr><td>${u}å…ƒ</td><td><input type="number" id="m-r-${u}" oninput="calcSumV18()"></td><td><input type="number" id="m-s-${u}" oninput="calcSumV18()"></td><td id="m-sub-${u}">$0</td></tr>`).join('');

        startListeners();
    }

    function startListeners() {
        // æ¨¡å‹åœ–
        db.collection("settings").doc("global_map").onSnapshot(s => { if(s.exists()) renderMapV18(s.data()); });
        // é€²æ«ƒè³‡è¨Š
        db.collection("store_status").doc("current").onSnapshot(s => {
            if(s.exists()){
                document.getElementById('in-cash').value = s.data().cash || 0;
                document.getElementById('in-stock').value = s.data().stock || 0;
            }
        });
        // å†°ç®±ç‹€æ…‹
        const ids = ['f1','f2','f3','f4','f5','f6','f7','f8','f9','f10','s-for-n','s-for-c','c-f','c-d','c-b'];
        ids.forEach(id => {
            db.collection("checks").doc(id).onSnapshot(s => {
                if(s.exists()){
                    const d = s.data();
                    const el = document.getElementById(id);
                    el.className = `zone ${d.status==='ç•°å¸¸'?'warning':'ok'} ${id.includes('for')?'highlight-foreign':''}`;
                    el.querySelector('small').innerText = `âœ… ${d.val} (${d.user})`;
                }
            });
        });
        // äº¤æ¥æ¸…å–®
        db.collection("broadcasts").orderBy("time","desc").limit(10).onSnapshot(s => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            s.forEach(d => {
                const b = d.data();
                feed.innerHTML += `<div style="background:#fff; border-left:5px solid ${b.done?'green':'orange'}; padding:10px; margin-bottom:10px; border-radius:8px;">
                    <b>[${b.type}] ${b.user}</b> <p>${b.content}</p>
                    ${b.img ? `<img src="${b.img}" style="width:80px; border-radius:5px;" onclick="zoomV18('${b.img}')">` : ''}
                </div>`;
            });
        });
    }

    // --- 4. é»æ“ŠåŠŸèƒ½ (æ›è¼‰è‡³ Window) ---
    window.inputT = async (id, name, type) => {
        const val = prompt(`${name} æº«åº¦ï¼š`, type==='f'?'-':'');
        if(!val) return;
        const num = parseFloat(val);
        let status = "æ­£å¸¸";
        if((type==='f' && num > -10) || (type==='c' && (num<0 || num>7))) status = "ç•°å¸¸";
        if(status === "ç•°å¸¸") alert("ğŸš¨ æº«åº¦ç•°å¸¸ï¼ç³»çµ±å·²è‡ªå‹•é€šå ±ä¸»ç®¡ã€‚");
        await db.collection("checks").doc(id).set({ val: val+"åº¦", status, user: user.name, time: new Date() });
        await db.collection("logs").add({ item: name, val: num, status, user: user.name, time: new Date() });
    };

    window.checkItem = async (id, name) => {
        if(confirm(`${name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
            await db.collection("checks").doc(id).set({ val: "OK", status: "æ­£å¸¸", user: user.name, time: new Date() });
        }
    };

    window.calcSumV18 = () => {
        let total = 0;
        [500,100,50,10,5,1].forEach(u => {
            const sum = (Number(document.getElementById(`m-r-${u}`).value)||0) + (Number(document.getElementById(`m-s-${u}`).value)||0);
            document.getElementById(`m-sub-${u}`).innerText = "$" + (sum * u);
            total += (sum * u);
        });
        document.getElementById('out-sum').innerText = total;
    };

    window.doCalcV18 = () => {
        const inC = Number(document.getElementById('in-cash').value)||0;
        const inS = Number(document.getElementById('in-stock').value)||0;
        const out = Number(document.getElementById('out-sum').innerText)||0;
        const rev = Number(document.getElementById('v-sales').value)||0;
        const diff = (inC + inS - out + rev) * -1; // ç°¡åŒ–å…¬å¼ç¤ºç¯„
        document.getElementById('diff-show').innerText = diff;
    };

    window.doSubmitV18 = async () => {
        const diff = document.getElementById('diff-show').innerText;
        await db.collection("reports").add({ diff, user: user.name, time: new Date() });
        alert("âœ… å ±è¡¨å·²æäº¤");
        location.reload();
    };

    window.openForm = (type) => {
        document.getElementById('svc-pop').classList.remove('hidden');
        document.getElementById('svc-title').innerText = type;
        document.getElementById('svc-fields').innerHTML = `<input id="s-p" placeholder="å“å/æ¢ç¢¼">`;
    };

    window.submitSvcV18 = async () => {
        const content = document.getElementById('s-p').value;
        const file = document.getElementById('svc-img').files[0];
        const save = async (img = "") => {
            await db.collection("broadcasts").add({ type: document.getElementById('svc-title').innerText, content, img, user: user.name, time: new Date(), done: false });
            alert("âœ… å·²é€šå ±");
            document.getElementById('svc-pop').classList.add('hidden');
        };
        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => save(e.target.result);
            reader.readAsDataURL(file);
        } else save();
    };

    function renderMapV18(data) {
        mapShapes = data.shapes || [];
        const canvas = document.getElementById('shelf-canvas');
        canvas.innerHTML = "";
        mapShapes.forEach(s => {
            const div = document.createElement('div');
            div.className = `shape ${s.done?'done':''}`;
            div.style.left = s.x+"px"; div.style.top = s.y+"px";
            div.innerText = s.name;
            if(user.shift==='ä¸»ç®¡'){
                div.onmousedown = (e) => {
                    let ox = e.clientX-s.x; let oy = e.clientY-s.y;
                    document.onmousemove = (ev) => {
                        s.x = ev.clientX-ox; s.y = ev.clientY-oy;
                        div.style.left=s.x+"px"; div.style.top=s.y+"px";
                    };
                    document.onmouseup = () => document.onmousemove = null;
                };
            } else {
                div.onclick = async () => {
                    s.done = true;
                    await db.collection("settings").doc("global_map").set({ shapes: mapShapes });
                };
            }
            canvas.appendChild(div);
        });
    }

    window.addMap = () => {
        const n = prompt("åå­—");
        if(n){ mapShapes.push({id:Date.now(), name:n, x:30, y:30, done:false}); renderMapV18({shapes:mapShapes}); }
    };
    window.saveMap = async () => { await db.collection("settings").doc("global_map").set({ shapes: mapShapes }); alert("å·²ç™¼å¸ƒ"); };

    window.unlockIn = () => { document.getElementById('in-cash').disabled = false; document.getElementById('in-stock').disabled = false; document.getElementById('in-save').classList.remove('hidden'); };
    window.saveInV18 = async () => { await db.collection("store_status").doc("current").set({ cash: document.getElementById('in-cash').value, stock: document.getElementById('in-stock').value }); alert("æ›´æ–°æˆåŠŸ"); location.reload(); };

</script>

<script>
    // --- ä¸€èˆ¬ UI ---
    function switchTab(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }
    function calcAvg() {
        const s = Number(document.getElementById('v-sales').value);
        const v = Number(document.getElementById('v-visit').value);
        if(v > 0) document.getElementById('v-avg').value = Math.round(s/v);
    }
    function zoomV18(src) {
        document.getElementById('img-zoom').src = src;
        const overlay = document.getElementById('img-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('show'), 10);
    }
    function closeImgZoom() {
        const overlay = document.getElementById('img-overlay');
        overlay.classList.remove('show');
        setTimeout(() => overlay.style.display = 'none', 300);
    }
</script>
</body>
</html>