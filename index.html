<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é–€å¸‚ V35 (å®Œç¾å–®æ©Ÿç‰ˆ)</title>
    <style>
        /* --- æ ¸å¿ƒ CSS --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 120px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; }
        
        /* å°èˆª */
        .nav { display: flex; position: sticky; top: 0; background: #fff; border-bottom: 3px solid #ddd; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav div { flex: 1; padding: 12px 0; text-align: center; font-weight: bold; color: #666; cursor: pointer; font-size: 15px; }
        .nav div.active { color: #007bff; border-bottom: 3px solid #007bff; background: #eef7ff; }

        /* å€å¡Šæ¨™é¡Œ */
        .head { background: #e9ecef; padding: 10px; margin: 15px 0 10px 0; font-weight: bold; border-left: 5px solid #007bff; display: flex; justify-content: space-between; align-items: center; }
        
        /* æ ¼å­ç³»çµ± */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 10px; }
        .box { border: 2px solid #ccc; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; background: #fff; min-height: 70px; display:flex; flex-direction:column; justify-content:center; align-items:center; position: relative; transition:0.2s; }
        .box.ok { background: #d4edda !important; border-color: #28a745 !important; color: #155724; font-weight: bold; }
        /* 1. æº«åº¦ç•°å¸¸ç´…åº• */
        .box.alert { background: #dc3545 !important; border-color: #a71d2a !important; color: white !important; animation: shake 0.4s; }
        .foreign { background: #f3e5f5; border: 2px solid #9c27b0; color: #6a1b9a; font-weight: bold; }

        /* ç®¡ç†æ¨¡å¼åˆªé™¤ç´ */
        .del-btn { position: absolute; top: -8px; right: -8px; background: red; color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; line-height: 24px; display: none; z-index: 10; border: 2px solid white; box-shadow: 0 2px 2px rgba(0,0,0,0.3); }
        .editing .del-btn { display: block; }
        .editing .box { border: 2px dashed #007bff; animation: pulse 1s infinite; }

        /* æ¨¡å‹åœ– */
        #shelf-canvas { border: 2px solid #333; position: relative; width: 95%; height: 350px; background: #eee; margin: 10px auto; overflow: hidden; }
        .shape { position: absolute; border: 2px solid #333; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; text-align: center; padding: 2px; font-weight: bold; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .shape.done { background: #28a745 !important; color: white !important; }
        .shape.selected { border: 3px solid red; z-index: 20; transform: scale(1.05); }
        .shape-info { font-size: 9px; margin-top: 2px; display: block; }

        /* åœ–ç‰‡æ”¾å¤§ */
        #img-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #img-overlay.show { opacity: 1; pointer-events: auto; }
        #big-img { max-width: 95%; max-height: 95%; border: 2px solid white; border-radius: 5px; transform: scale(0.8); transition: transform 0.3s; }
        #img-overlay.show #big-img { transform: scale(1); }

        /* éˆ´éº */
        #bell { position: fixed; top: 15px; right: 15px; font-size: 26px; background: white; border-radius: 50%; padding: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 200; cursor: pointer; }
        #badge { position: absolute; top: 0; right: 0; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 12px; text-align: center; line-height: 20px; display: none; border: 2px solid white; }
        
        /* å¸³å‹™è¡¨ */
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 10px; }
        td, th { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .inp-money { width: 100%; text-align: center; padding: 8px; border: 1px solid #ccc; font-size: 16px; background: #fff; }

        /* é€šç”¨å…ƒä»¶ */
        input, select, button, textarea { width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #bbb; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.96); }
        .btn-g { background: #28a745; } .btn-r { background: #dc3545; } .btn-o { background: #fd7e14; }
        .btn-s { width: auto; padding: 4px 10px; font-size: 12px; margin-right: 3px; }
        .hide { display: none !important; }
        .stars span { font-size: 32px; color: #ddd; cursor: pointer; }
        .stars span.gold { color: #ffc107; }

        @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 50%{transform:translateX(5px)} 75%{transform:translateX(-5px)} 100%{transform:translateX(0)} }
        @keyframes pulse { 0%{box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4)} 70%{box-shadow: 0 0 0 10px rgba(0, 123, 255, 0)} 100%{box-shadow: 0 0 0 0 rgba(0, 123, 255, 0)} }
    </style>
</head>
<body>

<div id="img-overlay" onclick="closeZoom()"><img id="big-img"></div>

<div id="bell" onclick="gotoSvc()">ğŸ””<div id="badge">0</div></div>

<div class="container">
    <div id="page-auth" style="padding:40px 20px; text-align:center;">
        <h2>ğŸª æ™ºæ…§é–€å¸‚ V35</h2>
        <div id="box-login">
            <input id="l-id" placeholder="å¸³è™Ÿ">
            <input id="l-pw" type="password" placeholder="å¯†ç¢¼">
            <button onclick="login()">ç™»å…¥</button>
            <p onclick="swAuth(true)" style="color:blue; margin-top:20px; cursor:pointer;">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š</p>
        </div>
        <div id="box-reg" class="hide">
            <input id="r-name" placeholder="çœŸå¯¦å§“å">
            <select id="r-shift"><option>æ—©ç­</option><option>æ™šç­</option><option>ä¸»ç®¡</option></select>
            <input id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
            <input id="r-pw" type="password" placeholder="è¨­å®šå¯†ç¢¼">
            <button class="btn-g" onclick="reg()">ç¢ºèªè¨»å†Š</button>
            <p onclick="swAuth(false)" style="color:blue; margin-top:20px; cursor:pointer;">è¿”å›ç™»å…¥</p>
        </div>
    </div>

    <div id="page-main" class="hide">
        <div style="background:#333; color:white; padding:12px; display:flex; justify-content:space-between; align-items:center;">
            <span id="user-info">--</span>
            <button onclick="logout()" style="width:auto; padding:5px 10px; background:#555; font-size:12px;">ç™»å‡º</button>
        </div>

        <div class="nav">
            <div onclick="tab('stock')" id="n-stock" class="active">è£œè²¨</div>
            <div onclick="tab('temp')" id="n-temp">å†°ç®±</div>
            <div onclick="tab('count')" id="n-count">å¸³å‹™</div>
            <div onclick="tab('svc')" id="n-svc">å®¢æœ</div>
            <div onclick="tab('mgr')" id="n-mgr" class="hide">ä¸»ç®¡</div>
        </div>

        <div id="v-stock">
            <div class="head" style="background:#f3e5f5; color:#4a148c;">ğŸ”¥ é‡é»è£œè²¨</div>
            <div class="grid">
                <div class="box foreign" id="stk_noodle" onclick="chk('stk_noodle','å¤–ç±æ³¡éºµ')">å¤–ç±æ³¡éºµ<br><small>å¾…æª¢</small></div>
                <div class="box foreign" id="stk_cookie" onclick="chk('stk_cookie','å¤–ç±é¤…ä¹¾')">å¤–ç±é¤…ä¹¾<br><small>å¾…æª¢</small></div>
            </div>

            <div class="head">
                ğŸ›’ æ¯æ—¥è£œè²¨ 
                <button id="btn-edit-stock" class="hide btn-s btn-o" onclick="toggleEdit('stock-grid')">ç®¡ç†</button>
            </div>
            <div class="grid" id="stock-grid"></div> <div id="add-stock-area" class="hide" style="padding:10px;">
                <button class="btn-g" style="width:100%" onclick="addItem('stock')">+ æ–°å¢è£œè²¨é …ç›®</button>
            </div>

            <div class="head">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸåœ–</div>
            <div id="mgr-map-tool" class="hide" style="padding:5px; background:#e9ecef;">
                <button onclick="addMapShape()" class="btn-s btn-g">+ æ–°å¢æ–¹å¡Š</button>
                <button onclick="saveMapData()" class="btn-s btn-o">ç™¼å¸ƒåœ°åœ–</button>
                <div id="map-edit-bar" class="hide" style="margin-top:5px; padding:5px; background:#fff; border:1px solid #ccc; border-radius:5px;">
                    <span style="color:red; font-size:12px;">é¸å–: <b id="sel-name"></b></span><br>
                    <button onclick="renShape()" class="btn-s">æ”¹å</button>
                    <button onclick="copyShape()" class="btn-s">è¤‡è£½</button>
                    <button onclick="delShape()" class="btn-s btn-r">åˆªé™¤</button>
                    <button onclick="reviewMapItem()" class="btn-s btn-o">æ‰¹æ”¹</button>
                </div>
            </div>
            <div id="shelf-canvas"></div>
        </div>

        <div id="v-temp" class="hide">
            <div class="head">
                â„ï¸ å†°ç®±åˆ—è¡¨ 
                <button id="btn-edit-fridge" class="hide btn-s btn-o" onclick="toggleEdit('fridge-grid')">ç®¡ç†</button>
            </div>
            <div class="grid" id="fridge-grid"></div>
            <div id="add-fridge-area" class="hide" style="padding:10px;">
                <button class="btn-g" style="width:100%" onclick="addItem('fridge')">+ æ–°å¢å†°ç®±</button>
            </div>
        </div>

        <div id="v-count" class="hide">
            <div class="head">ğŸ“¥ ä¸Šä¸€ç­ç•™å­˜ (é€²æ«ƒ)</div>
            <div style="padding:10px; background:#e3f2fd;">
                æ”¶éŠ€ï¼š<input id="in-c" disabled style="width:100px; display:inline"> 
                åº«å­˜ï¼š<input id="in-s" disabled style="width:100px; display:inline">
                <div id="mgr-in-tools" class="hide" style="margin-top:5px;">
                    <button class="btn-s btn-o" onclick="unlockIn()">âœï¸ ä¿®æ”¹é€²æ«ƒ</button>
                    <button id="btn-save-in" class="hide btn-s btn-g" onclick="saveIn()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>
            </div>

            <div class="head">ğŸª™ äº¤ç­é»ç®—</div>
            <table>
                <tr><th>é¢é¡</th><th>æ”¶éŠ€</th><th>åº«å­˜</th><th>å°è¨ˆ</th></tr>
                <tbody id="money-body"></tbody>
            </table>
            <div style="text-align:right; font-weight:bold; color:blue; padding:10px; font-size:18px;">ç¸½è¨ˆ: $<span id="total-cash">0</span></div>

            <div class="head">ğŸ“ é›»è©±å¡</div>
            <div id="card-list" class="grid"></div>

            <div class="head">ğŸ“Š ç‡Ÿæ”¶</div>
            <div class="grid">
                <input type="number" id="val-rev" placeholder="ç‡Ÿæ¥­é¡" oninput="calcAvg()">
                <input type="number" id="val-vis" placeholder="ä¾†å®¢æ•¸" oninput="calcAvg()">
                <input type="text" id="val-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
            </div>
            <div class="grid">
                <input type="number" id="pay-cr" placeholder="ä¿¡ç”¨å¡"><input type="number" id="pay-tw" placeholder="å°ç£Pay">
                <input type="number" id="pay-ln" placeholder="Line Pay"><input type="number" id="pay-pt" placeholder="ä½¿ç”¨é»æ•¸">
                <input type="number" id="pay-rf" placeholder="ç¾é‡‘æ‰£æ¬¾">
            </div>

            <div class="head">â• é¡å¤–æ”¶æ”¯</div>
            <div class="grid">
                <button class="btn-g" onclick="addEx('in')">+æ”¶å…¥</button>
                <button class="btn-r" onclick="addEx('out')">+æ”¯å‡º</button>
            </div>
            <div id="ex-list" style="padding:10px;"></div>

            <button class="btn-g" style="width:100%; margin-top:20px;" onclick="alert('å ±è¡¨å·²å„²å­˜')">æäº¤äº¤ç­å ±è¡¨</button>
        </div>

        <div id="v-svc" class="hide">
            <div class="grid">
                <button onclick="openForm('äº¤æ¥')">ğŸ“ äº¤æ¥</button>
                <button onclick="openForm('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="openForm('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
                <button onclick="openForm('å ±å»¢')">ğŸ—‘ï¸ å ±å»¢</button>
                <button onclick="openForm('è©¢å•')" class="btn-o">â“ è©¢å•</button>
            </div>
            <div id="feed-list" style="margin-top:15px;"></div>
        </div>

        <div id="v-mgr" class="hide">
            <div class="head">ğŸŒŸ å“¡å·¥è©•åˆ†</div>
            <select id="mgr-target"><option>é¸æ“‡å“¡å·¥</option></select>
            <div style="padding:15px; background:#f9f9f9; margin-top:10px;">
                <p>å·¥ä½œæ•ˆç‡: <span class="stars" onclick="rate(this, event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <p>è£œè²¨å®Œæˆ: <span class="stars" onclick="rate(this, event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <p>ç”Ÿé®®æª¢æŸ¥: <span class="stars" onclick="rate(this, event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <p>é¡§å®¢åæ‡‰: <span class="stars" onclick="rate(this, event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <button class="btn-g" onclick="alert('è©•åˆ†å·²å„²å­˜')">å„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-form" class="hide" style="position:fixed; top:5%; left:5%; width:90%; height:90%; background:white; border:2px solid #007bff; padding:15px; overflow-y:auto; z-index:3000; box-shadow:0 0 20px rgba(0,0,0,0.5);">
    <h3 id="modal-title">--</h3>
    <div id="modal-fields"></div>
    <div style="margin-top:10px;">
        <label>æ‹ç…§ä¸Šå‚³ï¼š</label>
        <input type="file" id="modal-img" accept="image/*" onchange="previewImg()">
        <img id="preview-box" style="width:100px; display:none; margin-top:5px; border:1px solid #ccc;">
    </div>
    <div style="margin-top:20px; display:flex; gap:10px;">
        <button class="btn-g" onclick="submitForm()">é€å‡º</button>
        <button onclick="document.getElementById('modal-form').classList.add('hide')" style="background:#666;">å–æ¶ˆ</button>
    </div>
</div>

<script>
// --- DB æ ¸å¿ƒ: æœ¬æ©Ÿå„²å­˜ ---
const DB = {
    get: (k) => JSON.parse(localStorage.getItem(k) || '{}'),
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    arr: (k) => JSON.parse(localStorage.getItem(k) || '[]'),
    push: (k, v) => {
        let a = JSON.parse(localStorage.getItem(k) || '[]');
        a.unshift(v);
        localStorage.setItem(k, JSON.stringify(a));
    }
};

// --- åˆå§‹åŒ–é è¨­è³‡æ–™ (è‹¥ç„¡è³‡æ–™å‰‡å¯«å…¥) ---
if(!localStorage.getItem('conf_stock')) {
    localStorage.setItem('conf_stock', JSON.stringify(['è¸æ¶','å†°ç®±é£²æ–™','å±¤æ¶é£²æ–™','å†·å‡é£Ÿå“','åƒåœ¾è¢‹/å…æ´—','è¡›ç”Ÿç´™','ç‰™è†/æ´—è¡£ç²¾','ä¸€èˆ¬é¤…ä¹¾/æ³¡éºµ']));
}
if(!localStorage.getItem('conf_fridge')) {
    localStorage.setItem('conf_fridge', JSON.stringify([
        {n:'å†·è—1',t:'c'},{n:'å†·è—2',t:'c'},{n:'å†·è—3',t:'c'},{n:'å†·è—4',t:'c'},
        {n:'å†·å‡1',t:'f'},{n:'å†·å‡2',t:'f'},{n:'å†·å‡3',t:'f'},{n:'å†·å‡4',t:'f'},{n:'å†·å‡5',t:'f'},{n:'å†·å‡6',t:'f'}
    ]));
}

let me = null;
let shapes = DB.arr('map_shapes');
let selShapeIdx = null;
let imgBase64 = "";
let exArr = [];

// --- ç™»å…¥è¨»å†Š ---
function swAuth(reg) {
    document.getElementById('box-login').classList.toggle('hide', reg);
    document.getElementById('box-reg').classList.toggle('hide', !reg);
}
function reg() {
    const id=document.getElementById('r-id').value, nm=document.getElementById('r-name').value, pw=document.getElementById('r-pw').value;
    if(!id||!nm||!pw) return alert("è«‹å¡«å¯«");
    let u=DB.get('users'); u[id]={name:nm, pw:pw, shift:document.getElementById('r-shift').value}; DB.set('users', u);
    // 1. è¨»å†Šä¿è­‰å½ˆçª—
    alert("âœ… è¨»å†ŠæˆåŠŸï¼è«‹æŒ‰ç¢ºå®šè¿”å›ç™»å…¥ã€‚"); 
    swAuth(false);
}
function login() {
    const id=document.getElementById('l-id').value, pw=document.getElementById('l-pw').value;
    let u=DB.get('users');
    if(u[id] && u[id].pw===pw) { me={...u[id], id}; init(); } else alert("å¸³å¯†éŒ¯èª¤");
}
function logout() { location.reload(); }

// --- åˆå§‹åŒ– ---
function init() {
    document.getElementById('page-auth').classList.add('hide');
    document.getElementById('page-main').classList.remove('hide');
    document.getElementById('user-info').innerText = `${me.name} (${me.shift})`;
    
    // ä¸»ç®¡æ¬Šé™é–‹é—œ
    if(me.shift==='ä¸»ç®¡') {
        document.getElementById('nav-mgr').classList.remove('hide');
        document.getElementById('mgr-map-tool').classList.remove('hide');
        document.getElementById('mgr-in-tools').classList.remove('hide');
        document.getElementById('btn-edit-stock').classList.remove('hide');
        document.getElementById('btn-edit-fridge').classList.remove('hide');
    }

    renderDynamic(); // æ¸²æŸ“å‹•æ…‹åˆ—è¡¨
    
    // éŒ¢å¹£
    document.getElementById('money-body').innerHTML = [500,100,50,10,5,1].map(u=>`<tr><td>${u}</td><td><input type="number" class="inp-money" id="mr_${u}" oninput="calcCash()"></td><td><input type="number" class="inp-money" id="ms_${u}" oninput="calcCash()"></td><td style="color:blue" id="sub_${u}">0</td></tr>`).join('');
    
    // é›»è©±å¡
    const cards=["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
    document.getElementById('card-list').innerHTML = cards.map(c=>`<div style="border:1px solid #ccc; padding:5px; border-radius:5px;"><b>${c}</b><div style="display:flex; gap:5px;"><input type="number" id="cd_s_${c}" placeholder="éŠ·" style="width:50%"><input type="number" id="cd_l_${c}" placeholder="å­˜" style="width:50%"></div></div>`).join('');

    renderAll();
}

function renderDynamic() {
    // è£œè²¨åˆ—è¡¨
    const stocks = JSON.parse(localStorage.getItem('conf_stock'));
    document.getElementById('stock-grid').innerHTML = stocks.map((s,i)=>`
        <div class="box" id="stk_${i}" onclick="chk('stk_${i}','${s}')">
            ${s}<br><small>å¾…æª¢</small>
            <div class="del-btn" onclick="delItem('stock',${i}); event.stopPropagation();">X</div>
        </div>`).join('');

    // å†°ç®±åˆ—è¡¨
    const fridges = JSON.parse(localStorage.getItem('conf_fridge'));
    document.getElementById('fridge-grid').innerHTML = fridges.map((f,i)=>`
        <div class="box" id="ref_${i}" onclick="inputTemp('ref_${i}','${f.n}','${f.t}')">
            ${f.n}<br><small>å¾…æ¸¬</small>
            <div class="del-btn" onclick="delItem('fridge',${i}); event.stopPropagation();">X</div>
        </div>`).join('');
}

function renderAll() {
    let s=DB.get('status'), store=DB.get('store');
    // ç‹€æ…‹æ›´æ–°
    for(let k in s) {
        const el=document.getElementById(k);
        if(el) {
            el.className = `box ${s[k].alert?'alert':'ok'} ${k.includes('noodle')||k.includes('cookie')?'foreign':''}`;
            el.innerHTML = `${s[k].name}<br><small>${s[k].alert?'âš ï¸ '+s[k].val : 'âœ… '+s[k].user}</small>
            ${s[k].mgrReply ? `<br><span style="color:blue;font-size:10px">æ‰¹:${s[k].mgrReply}</span>` : ''}`;
            
            // ä¿æŒåˆªé™¤ç´
            if(document.querySelector('.editing')) {
                const type = k.includes('stk') ? 'stock' : 'fridge';
                const idx = k.split('_')[1];
                if(type && idx) el.innerHTML += `<div class="del-btn" onclick="delItem('${type}', ${idx}); event.stopPropagation();">X</div>`;
            }
        }
    }
    // é€²æ«ƒæ›´æ–°
    document.getElementById('in-c').value = store.cash || 0;
    document.getElementById('in-s').value = store.stock || 0;
    if(store.cards) {
        for(let k in store.cards) {
            let el = document.getElementById(`cd_l_${k}`);
            if(el) el.placeholder = `ä¸Š:${store.cards[k]}`;
        }
    }
    
    renderFeed();
    drawMap();
}

function tab(t) {
    document.querySelectorAll('.nav div').forEach(e=>e.classList.remove('active'));
    document.getElementById('n-'+t).classList.add('active');
    ['stock','temp','count','svc','mgr'].forEach(x=>document.getElementById('v-'+x).classList.add('hide'));
    document.getElementById('v-'+t).classList.remove('hide');
}

// --- æª¢æŸ¥èˆ‡æº«åº¦ ---
function chk(id, name) {
    if(document.getElementById(id).closest('.editing')) return;
    let s=DB.get('status');
    // ä¸»ç®¡æ‰¹æ”¹åŠŸèƒ½
    if(me.shift==='ä¸»ç®¡' && s[id] && s[id].user) {
        const r = prompt("ä¸»ç®¡æ‰¹æ”¹/è©•èªï¼š", s[id].mgrReply||"");
        if(r!==null) { s[id].mgrReply=r; DB.set('status',s); renderAll(); }
    } else {
        if(confirm(`${name} å®Œæˆï¼Ÿ`)) {
            s[id]={name, user:me.name, time:new Date().toLocaleTimeString()}; 
            DB.set('status',s); renderAll();
        }
    }
}

function inputTemp(id, name, type) {
    if(document.getElementById(id).closest('.editing')) return;
    const v=prompt(name+" æº«åº¦ï¼š", type==='f'?'-':'');
    if(!v) return;
    const n=parseFloat(v);
    let alertFlag=false;
    // 4. æº«åº¦ç•°å¸¸é‚è¼¯
    if((type==='f' && n>-10) || (type==='c' && (n<0 || n>7))) { alert("ğŸš¨ æº«åº¦ç•°å¸¸ï¼"); alertFlag=true; }
    
    let s=DB.get('status');
    s[id]={name, user:me.name, val:v+"åº¦", alert:alertFlag, time:new Date().toLocaleTimeString()};
    DB.set('status',s); renderAll();
}

// --- ç®¡ç†æ¨¡å¼ (æ–°å¢/åˆªé™¤) ---
function toggleEdit(id) {
    const el = document.getElementById(id);
    el.classList.toggle('editing');
    const area = id==='stock-grid' ? 'add-stock-area' : 'add-fridge-area';
    document.getElementById(area).classList.toggle('hide');
}
function addItem(type) {
    const key = `conf_${type}`;
    let list = JSON.parse(localStorage.getItem(key));
    const n = prompt("åç¨±:"); if(!n) return;
    if(type==='fridge') {
        const t = prompt("é¡å‹ (c=å†·è—, f=å†·å‡)", "c");
        list.push({n, t});
    } else list.push(n);
    localStorage.setItem(key, JSON.stringify(list));
    renderDynamic(); renderAll();
}
function delItem(type, idx) {
    if(!confirm("åˆªé™¤?")) return;
    const key = `conf_${type}`;
    let list = JSON.parse(localStorage.getItem(key));
    list.splice(idx, 1);
    localStorage.setItem(key, JSON.stringify(list));
    renderDynamic(); renderAll();
}

// --- å¸³å‹™ ---
function calcCash() {
    let tot=0;
    [500,100,50,10,5,1].forEach(u=>{
        const r=Number(document.getElementById(`mr_${u}`).value)||0, s=Number(document.getElementById(`ms_${u}`).value)||0;
        const sub=(r+s)*u; document.getElementById(`sub_${u}`).innerText=sub; tot+=sub;
    });
    document.getElementById('total-cash').innerText=tot;
}
function calcAvg() {
    const s=Number(document.getElementById('val-rev').value), v=Number(document.getElementById('val-vis').value);
    if(v>0) document.getElementById('val-avg').value=Math.round(s/v);
}
function addEx(type) {
    const a=prompt("é‡‘é¡"), t=prompt("å‚™è¨»");
    if(a) { exArr.push({type, amt:Number(a), txt:t}); document.getElementById('ex-list').innerHTML += `<div style="color:${type==='in'?'green':'red'}">${type==='in'?'æ”¶':'æ”¯'} $${a} (${t})</div>`; }
}
function unlockIn() { document.getElementById('in-c').disabled=false; document.getElementById('in-s').disabled=false; document.getElementById('btn-save-in').classList.remove('hide'); }
function saveIn() { DB.set('store', {cash:parseFloat(document.getElementById('in-c').value), stock:parseFloat(document.getElementById('in-s').value)}); alert("å·²æ›´æ–°"); location.reload(); }

// --- è¡¨å–®èˆ‡åœ–ç‰‡ ---
let fType="";
function openForm(t) {
    fType=t; document.getElementById('modal-form').classList.remove('hide');
    document.getElementById('modal-title').innerText=t;
    const f=document.getElementById('modal-fields');
    imgBase64=""; document.getElementById('preview-box').style.display='none';
    
    if(t==='å®¢è¨‚') f.innerHTML=`<input id="fi-1" placeholder="å“å"><input id="fi-2" placeholder="æ¢ç¢¼"><input id="fi-3" placeholder="æ•¸é‡"><input id="fi-4" placeholder="å”®åƒ¹"><input id="fi-5" placeholder="å®¢å"><input id="fi-6" placeholder="é›»è©±"><input id="fi-7" placeholder="Line"><input id="fi-8" placeholder="è¯çµ¡æ™‚é–“">`;
    else if(t==='ç¶­ä¿®') f.innerHTML=`<input id="fi-1" placeholder="å“å"><input id="fi-2" placeholder="æ•…éšœåŸå› "><input id="fi-3" placeholder="è³¼è²·æ—¥"><input id="fi-4" placeholder="æ¢ç¢¼"><input id="fi-5" placeholder="å®¢å"><input id="fi-6" placeholder="é›»è©±"><input id="fi-7" placeholder="Line"><input id="fi-8" placeholder="è¯çµ¡æ™‚é–“">`;
    else if(t==='å ±å»¢') f.innerHTML=`<input id="fi-1" placeholder="å“å"><input id="fi-2" placeholder="æ¢ç¢¼"><input id="fi-3" placeholder="æ•¸é‡">`;
    else f.innerHTML=`<textarea id="fi-1" placeholder="å…§å®¹..." style="height:100px"></textarea>`;
}

function previewImg() {
    const file = document.getElementById('modal-img').files[0];
    if(file) {
        const r = new FileReader();
        r.onload = e => { imgBase64 = e.target.result; document.getElementById('preview-box').src = imgBase64; document.getElementById('preview-box').style.display = 'block'; };
        r.readAsDataURL(file);
    }
}

function submitForm() {
    let txt=""; document.querySelectorAll('#modal-fields input, #modal-fields textarea').forEach(i=>{if(i.value) txt+=i.placeholder+":"+i.value+" / ";});
    if(!txt && !imgBase64) return alert("âŒ å…§å®¹æˆ–åœ–ç‰‡ä¸å¯ç‚ºç©ºï¼");
    DB.push('feeds', {type:fType, txt, img:imgBase64, user:me.name, time:new Date().toLocaleString(), done:false});
    alert("âœ… æˆåŠŸ"); document.getElementById('modal-form').classList.add('hide'); renderFeed();
}

function renderFeed() {
    const fs=DB.arr('feeds');
    const d=document.getElementById('feed-list'); d.innerHTML="";
    const noti=document.getElementById('noti-dropdown'); noti.innerHTML="";
    let unread=0;
    fs.forEach((b,i)=>{
        if(!b.done) { unread++; noti.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #eee">${b.type}</div>`; }
        d.innerHTML += `<div style="border:1px solid #ccc; padding:10px; margin-bottom:10px; border-left:5px solid ${b.done?'green':'orange'}">
            <b>[${b.type}] ${b.user}</b> <small>${b.time}</small><br>${b.txt}
            ${b.img ? `<br><img src="${b.img}" style="width:60px; margin-top:5px;" onclick="zoom('${b.img}')">` : ''}
            ${b.reply ? `<div style="background:#eee; padding:5px; margin-top:5px; color:blue;">ğŸ‘® ${b.reply}</div>` : ''}
            <div style="text-align:right; margin-top:5px;">
                ${!b.done ? `<button onclick="finishFeed(${i})" class="btn-s">å®Œæˆ</button>` : 'âœ…'}
                ${me.shift==='ä¸»ç®¡' ? `<button onclick="replyFeed(${i})" class="btn-s btn-o">æ‰¹æ”¹</button>` : ''}
            </div>
        </div>`;
    });
    document.getElementById('badge').style.display=unread?'block':'none';
    document.getElementById('badge').innerText=unread;
}
function finishFeed(i) { let fs=DB.arr('feeds'); fs[i].done=true; localStorage.setItem('feeds',JSON.stringify(fs)); renderFeed(); }
function replyFeed(i) { const r=prompt("æ‰¹æ”¹/å›è¦†ï¼š"); if(r){ let fs=DB.arr('feeds'); fs[i].reply=r; localStorage.setItem('feeds',JSON.stringify(fs)); renderFeed(); }}
function toggleNoti() { const n=document.getElementById('noti-dropdown'); n.style.display=n.style.display==='block'?'none':'block'; }
function gotoSvc() { tab('svc'); toggleNoti(); }
function zoom(s){ document.getElementById('big-img').src=s; document.getElementById('img-overlay').classList.add('show'); }
function closeZoom(){ document.getElementById('img-overlay').classList.remove('show'); }

// --- åœ°åœ– ---
function drawMap() {
    const c=document.getElementById('shelf-canvas'); c.innerHTML="";
    shapes = DB.arr('map_shapes');
    shapes.forEach((s,i)=>{
        const d=document.createElement('div');
        d.className = `shape ${s.done?'done':''} ${selShapeIdx===i?'selected':''}`;
        d.style.left=s.x+'px'; d.style.top=s.y+'px'; d.style.width="60px"; d.style.height="40px";
        
        let info = s.name;
        if(s.done) info += `<br><span style='font-size:9px'>âœ…${s.checker||''}</span>`;
        if(s.mgrNote) info += `<br><span style='font-size:9px; color:blue'>${s.mgrNote}</span>`;
        d.innerHTML = info;

        if(me.shift==='ä¸»ç®¡') {
            d.onclick=()=>{ selShapeIdx=i; document.getElementById('sel-name').innerText=s.name; document.getElementById('map-edit-bar').classList.remove('hide'); drawMap(); };
            d.onmousedown=e=>{
                const ox=e.clientX-s.x, oy=e.clientY-s.y;
                document.onmousemove=ev=>{ s.x=ev.clientX-ox; s.y=ev.clientY-oy; d.style.left=s.x+'px'; d.style.top=s.y+'px'; };
                document.onmouseup=()=>document.onmousemove=null;
            };
        } else d.onclick=()=>{ 
            if(confirm("å®Œæˆ?")){ 
                s.done=true; s.checker=me.name; s.checkTime=new Date().toLocaleString(); 
                saveMapData(); 
            } 
        };
        c.appendChild(d);
    });
}
function addMapShape(){ const n=prompt("åç¨±"); if(n){ shapes.push({name:n,x:50,y:50,done:false}); saveMapData(); }}
function saveMapData(){ localStorage.setItem('map_shapes',JSON.stringify(shapes)); drawMap(); if(me.shift!=='ä¸»ç®¡') alert("å·²æ›´æ–°"); else alert("å·²ç™¼å¸ƒ"); }
function delShape(){ shapes.splice(selShapeIdx,1); saveMapData(); document.getElementById('map-edit-bar').classList.add('hide'); }
function copyShape(){ const s=shapes[selShapeIdx]; shapes.push({...s, x:s.x+20, y:s.y+20}); saveMapData(); }
function renShape(){ const n=prompt("æ–°å"); if(n){ shapes[selShapeIdx].name=n; saveMapData(); }}
function reviewMapItem() { const r=prompt("æ‰¹æ”¹è©•èª:"); if(r){ shapes[selShapeIdx].mgrNote=r; saveMapData(); }}

function rate(span,v) { span.parentNode.querySelectorAll('span').forEach((s,i)=>s.className=i<v?'gold':''); }
</script>
</body>
</html>