<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–€å¸‚ç‡Ÿé‹ç³»çµ± V14</title>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background: #f0f2f5; padding-bottom: 90px; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; }
        
        /* é ‚éƒ¨é€šçŸ¥éˆ´éº */
        #noti-bell { position: fixed; top: 15px; right: 15px; z-index: 1001; cursor: pointer; font-size: 24px; }
        #noti-count { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; }

        /* å°èˆª */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .nav-item { flex: 0 0 auto; padding: 12px 15px; cursor: pointer; color: #666; font-weight: bold; border-bottom: 4px solid transparent; white-space: nowrap; font-size: 14px;}
        .nav-item.active { color: #007bff; border-bottom-color: #007bff; background: #f8f9fa; }

        /* åˆ†é¡æ¨™ç±¤ */
        .section-header { background: #e9ecef; padding: 10px; margin: 15px -15px; font-weight: bold; border-left: 5px solid #007bff; display: flex; justify-content: space-between; }
        
        /* å†°ç®±æ ¼å­æ¨£å¼ */
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px 5px; text-align: center; cursor: pointer; min-height: 60px; font-size: 14px; }
        .zone.ok { background: #d4edda; border-color: #28a745; }
        .zone.warning { background: #fff3cd; border-color: #dc3545; animation: flash 1s infinite; }
        .highlight-foreign { background: linear-gradient(135deg, #6f42c1 0%, #4b2c84 100%) !important; color: #ffd700 !important; font-weight: bold; }

        /* å¸³å‹™è¡¨æ ¼æ¨£å¼ */
        .money-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 13px; }
        .money-table th { background: #f8f9fa; padding: 5px; border: 1px solid #ddd; }
        .money-table td { padding: 5px; border: 1px solid #ddd; text-align: center; }
        .money-table input { width: 60px; text-align: right; padding: 3px; }

        /* è©•åˆ†æ˜Ÿæ˜Ÿ */
        .star { font-size: 25px; color: #ddd; cursor: pointer; }
        .star.selected { color: #ffc107; }

        /* æ¨¡å‹åœ– */
        #shelf-canvas { border: 2px solid #333; position: relative; width: 100%; height: 350px; background: #eee; overflow: hidden; background-size: contain; background-repeat: no-repeat; }
        .shape { position: absolute; border: 2px solid #333; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; font-size: 10px; padding: 2px; cursor: pointer; text-align: center; }
        .shape.done { background: rgba(40, 167, 69, 0.7); color: white; }

        /* é€šç”¨æŒ‰éˆ•èˆ‡è¼¸å…¥ */
        input, select, button, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-small { width: auto; padding: 5px 10px; font-size: 12px; }
        .hidden { display: none !important; }
        @keyframes flash { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }
    </style>
</head>
<body>

<div id="noti-bell" onclick="toggleNotiList()">
    ğŸ””<span id="noti-count" class="hidden">0</span>
</div>

<div id="noti-list" class="hidden" style="position:fixed; top:50px; right:15px; width:250px; background:white; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1002; border-radius:8px; padding:10px; max-height:400px; overflow-y:auto;">
    <h4 style="margin:0 0 10px 0;">æ–°é€šçŸ¥æé†’</h4>
    <div id="noti-items-content">ç›®å‰ç„¡æ–°é€šçŸ¥</div>
</div>

<div class="container">
    <div id="auth-screen">
        <div style="text-align:center; padding:30px;">
            <h2>ğŸª é–€å¸‚æ™ºæ…§ç³»çµ± V14</h2>
            <div id="login-area">
                <input type="text" id="login-id" placeholder="å¸³è™Ÿ">
                <input type="password" id="login-pw" placeholder="å¯†ç¢¼">
                <button onclick="handleLogin()">ä¸Šç­æ‰“å¡</button>
                <p style="font-size:12px; cursor:pointer;" onclick="toggleAuth(true)">è¨»å†Šå¸³è™Ÿ</p>
            </div>
            <div id="register-area" class="hidden">
                <input type="text" id="reg-name" placeholder="å§“å">
                <select id="reg-shift"><option value="æ—©ç­">æ—©ç­</option><option value="æ™šç­">æ™šç­</option><option value="ä¸»ç®¡">ä¸»ç®¡</option></select>
                <input type="text" id="reg-id" placeholder="è¨­å®šå¸³è™Ÿ">
                <input type="password" id="reg-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button onclick="handleRegister()" style="background:#28a745;">å®Œæˆè¨»å†Š</button>
                <p style="font-size:12px; cursor:pointer;" onclick="toggleAuth(false)">è¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div style="background:#333; color:white; padding:10px; margin:-15px -15px 10px -15px; display:flex; justify-content:space-between; align-items:center;">
            <span><span id="display-info">--</span> ğŸ†<span id="display-points">0</span></span>
            <button onclick="location.reload()" style="width:auto; padding:5px; font-size:10px;">ç™»å‡º</button>
        </div>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±</div>
            <div class="nav-item" onclick="switchTab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="switchTab('counter')">ğŸ’° å¸³å‹™</div>
            <div class="nav-item" onclick="switchTab('handover')">ğŸ¤ äº¤æ¥/å®¢æœ</div>
            <div class="nav-item hidden" id="nav-mgr" onclick="switchTab('manager')">ğŸ“Š ä¸»ç®¡è©•åˆ†</div>
        </div>

        <div id="tab-temp">
            <div class="section-header">â„ï¸ å†·è— (0~7åº¦)</div>
            <div class="grid-box" id="chiller-grid"></div>
            <div class="section-header">ğŸ§Š å†·å‡ (<-10åº¦)</div>
            <div class="grid-box" id="freezer-grid"></div>
        </div>

        <div id="tab-stock" class="hidden">
            <div class="section-header">ğŸ”¥ é‡é»è£œè²¨ (å¤–ç±)</div>
            <div class="grid-box">
                <div class="zone highlight-foreign" id="s-for-noodle" onclick="checkStock('s-for-noodle','â˜…å¤–ç±æ³¡éºµ')">â˜…å¤–ç±æ³¡éºµâ˜…<small>--</small></div>
                <div class="zone highlight-foreign" id="s-for-cookie" onclick="checkStock('s-for-cookie','â˜…å¤–ç±é¤…ä¹¾')">â˜…å¤–ç±é¤…ä¹¾â˜…<small>--</small></div>
            </div>
            <div class="section-header">ğŸ“… æ¯æ—¥æ•ˆæœŸ</div>
            <div class="grid-box">
                <div class="zone" id="c-fresh" onclick="checkStock('c-fresh','ç”Ÿé®®æ•ˆæœŸ')">ç”Ÿé®®æ•ˆæœŸ</div>
                <div class="zone" id="c-daily" onclick="checkStock('c-daily','æ—¥é…æ•ˆæœŸ')">æ—¥é…æ•ˆæœŸ</div>
                <div class="zone" id="c-bread" onclick="checkStock('c-bread','éºµåŒ…æ•ˆæœŸ')">éºµåŒ…æ•ˆæœŸ</div>
            </div>
            <div class="section-header">ğŸ›’ æ¯æ—¥è£œè²¨</div>
            <div class="grid-box">
                <div class="zone" id="s-cig" onclick="checkStock('s-cig','è¸æ¶è£œè²¨')">è¸æ¶è£œè²¨</div>
                <div class="zone" id="s-f-drink" onclick="checkStock('s-f-drink','å†°ç®±é£²æ–™')">å†°ç®±é£²æ–™</div>
                <div class="zone" id="s-s-drink" onclick="checkStock('s-s-drink','å±¤æ¶é£²æ–™')">å±¤æ¶é£²æ–™</div>
                <div class="zone" id="s-frozen" onclick="checkStock('s-frozen','å†·å‡é£Ÿå“')">å†·å‡é£Ÿå“</div>
                <div class="zone" id="s-trash" onclick="checkStock('s-trash','åƒåœ¾è¢‹/å…æ´—')">åƒåœ¾è¢‹/å…æ´—</div>
                <div class="zone" id="s-tissue" onclick="checkStock('s-tissue','è¡›ç”Ÿç´™')">è¡›ç”Ÿç´™</div>
            </div>
            <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸåœ–æ¡ˆ</div>
            <div id="mgr-map-ctrl" class="hidden">
                <input type="file" id="map-bg-up" onchange="mapBgUpload(event)">
                <div style="display:flex; gap:5px;">
                    <button onclick="addMapShape()" class="btn-small">æ–°å¢å€å¡Š</button>
                    <button onclick="saveMapData()" class="btn-small" style="background:green;">å„²å­˜é…ç½®</button>
                </div>
            </div>
            <div id="shelf-canvas"></div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header">ğŸ“¥ é€²æ«ƒè³‡è¨Š (ä¸»ç®¡å¯ç·¨è¼¯)</div>
            <div id="in-data-area" style="background:#e3f2fd; padding:10px; border-radius:5px;">
                </div>
            
            <div class="section-header">ğŸª™ é›¢æ«ƒé»ç®— (å…¨ç´°é …)</div>
            <table class="money-table">
                <thead><tr><th>é¢é¡</th><th>æ”¶éŠ€æ©Ÿ(ç•™)</th><th>åº«å­˜(é‡‘åº«)</th><th>å°è¨ˆ</th></tr></thead>
                <tbody id="out-money-rows"></tbody>
            </table>
            <div style="text-align:right; font-weight:bold; color:#007bff;">æœ¬ç­ç¸½ç¾ï¼š$<span id="out-total-sum">0</span></div>

            <div class="section-header">ğŸ“ é›»è©±å¡ç›¤é»</div>
            <div id="card-area-v14"></div>

            <div class="section-header">ğŸ“Š ç‡Ÿæ”¶æ•¸æ“š</div>
            <div class="grid-box">
                <div><small>ç‡Ÿæ¥­é¡</small><input type="number" id="v-turnover" oninput="calcAvgSales()"></div>
                <div><small>ä¾†å®¢æ•¸</small><input type="number" id="v-visitors" oninput="calcAvgSales()"></div>
                <div><small>å®¢å–®åƒ¹</small><input type="number" id="v-avg" readonly style="background:#eee;"></div>
            </div>
            <div class="grid-box" style="margin-top:10px;">
                <input type="number" id="v-credit" placeholder="ä¿¡ç”¨å¡">
                <input type="number" id="v-twpay" placeholder="å°ç£Pay">
                <input type="number" id="v-linepay" placeholder="LINE PAY">
                <input type="number" id="v-points" placeholder="é»æ•¸">
                <input type="number" id="v-refund" placeholder="ç¾é‡‘é€€æ¬¾">
                <input type="number" id="v-thousands" placeholder="åƒéˆ”æŠ½é›¢(å¼µ)">
            </div>

            <div class="section-header">â• é¡å¤–æ”¶æ”¯çµ±è¨ˆ</div>
            <div id="extra-container"></div>
            <button onclick="addExtraRow()" style="background:#6c757d; font-size:12px;">+ æ–°å¢ä¸€ç­†æ”¶æ”¯</button>

            <div style="margin-top:20px; text-align:center; background:#333; color:white; padding:15px; border-radius:10px;">
                <h3>çµç®—èª¤å·®ï¼š<span id="v-diff">0</span> å…ƒ</h3>
                <button onclick="calcFinalDiff()" style="background:#ffc107; color:black;">ğŸ§® è©¦ç®—èª¤å·®</button>
                <button onclick="submitReportV14()" style="background:#28a745; margin-top:10px;">âœ… æäº¤æ­£å¼å ±è¡¨</button>
            </div>
        </div>

        <div id="tab-handover" class="hidden">
            <div class="section-header">ğŸ“ äº¤æ¥/å®¢æœæŒ‰éˆ•å€</div>
            <div class="grid-box">
                <button onclick="openForm('task','äº¤æ¥äº‹é …')">ğŸ“ äº¤æ¥</button>
                <button onclick="openForm('preorder','å®¢è¨‚é è³¼')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="openForm('repair','é›»å™¨ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
                <button onclick="openForm('soldout','å•†å“å”®ç½„')">âš¡ å”®ç½„</button>
                <button onclick="openForm('scrap','å•†å“å ±å»¢')">ğŸ—‘ï¸ å ±å»¢</button>
            </div>
            
            <div id="form-popup" class="hidden" style="background:#fff; border:2px solid #007bff; padding:15px; border-radius:10px; margin-top:10px;">
                <h3 id="form-title">--</h3>
                <div id="form-fields"></div>
                <input type="file" id="form-img" accept="image/*" capture="camera">
                <button onclick="submitUniversalForm()" style="margin-top:10px;">ç¢ºèªé€å‡º</button>
                <button onclick="closeForm()" style="background:#666; margin-top:5px;">å–æ¶ˆ</button>
            </div>

            <div id="global-list-display" style="margin-top:15px;"></div>
        </div>

        <div id="tab-manager" class="hidden">
            <div class="section-header">ğŸŒŸ å“¡å·¥æ¯æ—¥è©•æ¯”</div>
            <select id="mgr-eval-target"><option value="">é¸æ“‡å“¡å·¥</option></select>
            <div id="mgr-stars-area">
                <div class="report-row">å·¥ä½œæ•ˆç‡: <span class="stars" data-id="eff"></span></div>
                <div class="report-row">è£œè²¨å®Œæˆ: <span class="stars" data-id="stk"></span></div>
                <div class="report-row">ç’°å¢ƒæ•´ç†: <span class="stars" data-id="env"></span></div>
                <div class="report-row">é¡§å®¢å›é¥‹: <span class="stars" data-id="fed"></span></div>
            </div>
            <button onclick="saveManagerEval()" style="background:#28a745; margin-top:10px;">å„²å­˜è©•åˆ†ä¸¦ç™¼é€ç©åˆ†</button>
            
            <div class="section-header">ğŸ“ˆ æ­·å²èª¤å·®èˆ‡çµ±è¨ˆ</div>
            <div id="mgr-history-area"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, query, orderBy, limit, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73",
        measurementId: "G-M4169BDVH5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    // --- èªè­‰é‚è¼¯ ---
    window.handleRegister = async () => {
        const id = document.getElementById('reg-id').value;
        const name = document.getElementById('reg-name').value;
        if(!id || !name) return;
        await setDoc(doc(db, "users", id), {
            name, shift: document.getElementById('reg-shift').value,
            pw: document.getElementById('reg-pw').value, points: 0
        });
        alert("è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥");
        window.toggleAuth(false);
    };

    window.handleLogin = async () => {
        const id = document.getElementById('login-id').value;
        const pw = document.getElementById('login-pw').value;
        const snap = await getDoc(doc(db, "users", id));
        if(snap.exists() && snap.data().pw === pw) {
            window.user = { ...snap.data(), id };
            startApp();
        } else alert("ç™»å…¥å¤±æ•—");
    };

    function startApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('display-info').innerText = `${window.user.name} (${window.user.shift})`;
        if(window.user.shift === 'ä¸»ç®¡') {
            document.getElementById('nav-mgr').classList.remove('hidden');
            document.getElementById('mgr-map-ctrl').classList.remove('hidden');
        }
        initUI();
        startListeners();
    }

    // --- åˆå§‹åŒ– UI ---
    function initUI() {
        // å†°ç®±
        const fridges = [
            {id:'f1', n:'é–‹æ”¾1', t:'chiller'}, {id:'f2', n:'é–‹æ”¾2', t:'chiller'},
            {id:'f3', n:'å†·è—1', t:'chiller'}, {id:'f4', n:'å†·è—2', t:'chiller'},
            {id:'f5', n:'å†·å‡1', t:'freezer'}, {id:'f6', n:'å†·å‡2', t:'freezer'},
            {id:'f7', n:'è‡¥å¼1', t:'freezer'}, {id:'f8', n:'è‡¥å¼2', t:'freezer'},
            {id:'f9', n:'è‡¥å¼3', t:'freezer'}, {id:'f10', n:'è‡¥å¼4', t:'freezer'}
        ];
        fridges.forEach(f => {
            const html = `<div class="zone" id="${f.id}" onclick="checkTempV14('${f.id}','${f.n}','${f.t}')">${f.n}<br><small>å¾…æ¸¬</small></div>`;
            document.getElementById(f.t==='chiller'?'chiller-grid':'freezer-grid').innerHTML += html;
        });

        // å¸³å‹™æ˜ç´° (æ”¶éŠ€æ©Ÿ + åº«å­˜)
        const moneyT = document.getElementById('out-money-rows');
        [500,100,50,10,5,1].forEach(u => {
            moneyT.innerHTML += `<tr><td>${u}å…ƒ</td><td><input type="number" id="m-reg-${u}" oninput="calcMoneyV14()"></td><td><input type="number" id="m-res-${u}" oninput="calcMoneyV14()"></td><td class="subtotal" id="m-sub-${u}">$0</td></tr>`;
        });

        // é›»è©±å¡
        const cards = ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
        document.getElementById('card-area-v14').innerHTML = cards.map(c => 
            `<div style="display:flex; gap:5px; font-size:11px;">
                <label style="width:60px;">${c}</label>
                <input type="number" id="card-in-${c}" placeholder="é€²">
                <input type="number" id="card-sold-${c}" placeholder="éŠ·">
                <input type="number" id="card-left-${c}" placeholder="å­˜">
            </div>`).join('');

        // æ˜Ÿæ˜Ÿè©•åˆ†ç”Ÿæˆ
        document.querySelectorAll('.stars').forEach(s => {
            for(let i=1;i<=5;i++) s.innerHTML += `<span class="star" onclick="rateStar(this, ${i})">â˜…</span>`;
        });
        
        loadLastShiftV14();
    }

    // --- ç›£è½å™¨ ---
    function startListeners() {
        // ä»»å‹™ç›£è½
        onSnapshot(query(collection(db, "tasks"), orderBy("time", "desc"), limit(20)), (snap) => {
            const list = document.getElementById('global-list-display');
            list.innerHTML = "<h4>å³æ™‚æ¸…å–®</h4>";
            let newCount = 0;
            snap.forEach(d => {
                const t = d.data();
                if(!t.done) newCount++;
                list.innerHTML += `<div style="background:#fff; border:1px solid #ddd; padding:8px; margin-bottom:5px; border-left:5px solid ${t.done?'#28a745':'#ffc107'}">
                    <b>[${t.type}] ${t.user}</b>: ${t.content || t.msg} 
                    ${t.img ? `<br><img src="${t.img}" class="preview-img">` : ''}
                    <div style="text-align:right;"><button onclick="markDoneV14('${d.id}')" class="btn-small">${t.done?'å·²å®Œæˆ':'é»æ“Šå®Œæˆ'}</button></div>
                </div>`;
            });
            if(newCount > 0) {
                document.getElementById('noti-count').innerText = newCount;
                document.getElementById('noti-count').classList.remove('hidden');
            }
        });
        
        // å†°ç®±ç›£è½
        const ids = ['f1','f2','f3','f4','f5','f6','f7','f8','f9','f10','s-for-noodle','s-for-cookie','c-fresh','c-daily','c-bread','s-cig','s-f-drink','s-s-drink','s-frozen','s-trash','s-tissue'];
        ids.forEach(id => {
            onSnapshot(doc(db, "checks", id), (snap) => {
                if(snap.exists()){
                    const d = snap.data();
                    const el = document.getElementById(id);
                    if(el) {
                        el.className = `zone ${d.status==='ç•°å¸¸'?'warning':'ok'} ${id.includes('for')?'highlight-foreign':''}`;
                        el.querySelector('small').innerText = `âœ… ${d.val} (${d.user})`;
                    }
                }
            });
        });

        // æ¨¡å‹åœ–ç›£è½
        onSnapshot(doc(db, "settings", "map"), (snap) => { if(snap.exists()) renderMapV14(snap.data()); });
        
        // ç©åˆ†ç›£è½
        onSnapshot(doc(db, "users", window.user.id), (snap) => { document.getElementById('display-points').innerText = snap.data().points || 0; });
        
        // è¼‰å…¥è©•åˆ†ç›®æ¨™
        getDocs(collection(db, "users")).then(snap => {
            const sel = document.getElementById('mgr-eval-target');
            snap.forEach(d => sel.innerHTML += `<option value="${d.id}">${d.data().name}</option>`);
        });
    }

    // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ ---
    window.checkTempV14 = async (id, name, type) => {
        const val = prompt(`${name} æº«åº¦æª¢æŸ¥ï¼š`, type==='freezer'?'-':'');
        if(val === null) return;
        const num = parseFloat(val);
        let status = "æ­£å¸¸";
        if(type==='freezer' && num > -10) { alert("âš ï¸ è­¦å‘Šï¼šå†·å‡æº«åº¦ç•°å¸¸ï¼å·²ç™¼å‡ºé€šçŸ¥ï¼"); status="ç•°å¸¸"; }
        if(type==='chiller' && (num < 0 || num > 7)) { alert("âš ï¸ è­¦å‘Šï¼šå†·è—æº«åº¦ç•°å¸¸ï¼"); status="ç•°å¸¸"; }
        
        await setDoc(doc(db, "checks", id), { val: val+"åº¦", status, user: window.user.name, time: new Date() });
        await addDoc(collection(db, "logs"), { type: 'å†°ç®±', item: name, val: num, status, user: window.user.name, timestamp: new Date() });
    };

    window.checkStock = async (id, name) => {
        if(confirm(`${name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
            await setDoc(doc(db, "checks", id), { val: "OK", status: "æ­£å¸¸", user: window.user.name, time: new Date() });
            addPointsV14(5);
        }
    };

    window.calcMoneyV14 = () => {
        let total = 0;
        [500,100,50,10,5,1].forEach(u => {
            const reg = (parseFloat(document.getElementById(`m-reg-${u}`).value) || 0);
            const res = (parseFloat(document.getElementById(`m-res-${u}`).value) || 0);
            const sub = (reg + res) * u;
            document.getElementById(`m-sub-${u}`).innerText = "$" + sub;
            total += sub;
        });
        document.getElementById('out-total-sum').innerText = total;
    };

    window.submitUniversalForm = async () => {
        const title = document.getElementById('form-title').innerText;
        const file = document.getElementById('form-img').files[0];
        const fields = document.querySelectorAll('#form-fields input, #form-fields textarea');
        let content = "";
        fields.forEach(f => content += `${f.placeholder}: ${f.value} / `);
        
        const sendData = async (imgUrl = "") => {
            await addDoc(collection(db, "tasks"), {
                type: title, content, img: imgUrl, user: window.user.name, shift: window.user.shift, time: new Date(), done: false
            });
            alert("ç™¼é€æˆåŠŸï¼");
            closeForm();
            addPointsV14(10);
        };

        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => sendData(e.target.result);
            reader.readAsDataURL(file);
        } else sendData();
    };

    window.saveManagerEval = async () => {
        const target = document.getElementById('mgr-eval-target').value;
        if(!target) return alert("è«‹é¸æ“‡å“¡å·¥");
        let totalStars = 0;
        document.querySelectorAll('.stars').forEach(s => {
            totalStars += (s.querySelectorAll('.star.selected').length);
        });
        const bonus = totalStars * 10;
        const userRef = doc(db, "users", target);
        const snap = await getDoc(userRef);
        await updateDoc(userRef, { points: (snap.data().points || 0) + bonus });
        alert(`è©•åˆ†å„²å­˜æˆåŠŸï¼${target} å·²å¢åŠ  ${bonus} ç©åˆ†ã€‚`);
    };

    async function loadLastShiftV14() {
        const snap = await getDoc(doc(db, "store_status", "latest"));
        const area = document.getElementById('in-data-area');
        const isMgr = window.user.shift === 'ä¸»ç®¡';
        if(snap.exists()){
            const d = snap.data();
            window.lastData = d;
            area.innerHTML = `
                é€²æ«ƒç¾é‡‘ï¼š${isMgr ? `<input id="in-cash-val" value="${d.cash || 0}">` : `<b>${d.cash || 0}</b>`} <br>
                é€²æ«ƒåº«å­˜ï¼š${isMgr ? `<input id="in-stock-val" value="${d.stock || 0}">` : `<b>${d.stock || 0}</b>`}
            `;
        } else area.innerHTML = "å°šæœªæœ‰ä»»ä½•è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥è©¦ç®—";
    }

    function addPointsV14(pts) {
        updateDoc(doc(db, "users", window.user.id), { points: (window.user.points || 0) + pts });
    }
</script>

<script>
    // --- ä¸€èˆ¬ä»‹é¢é‚è¼¯ ---
    function switchTab(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }

    function toggleAuth(reg) {
        document.getElementById('login-area').classList.toggle('hidden', reg);
        document.getElementById('register-area').classList.toggle('hidden', !reg);
    }

    function calcAvgSales() {
        const t = parseFloat(document.getElementById('v-turnover').value) || 0;
        const v = parseFloat(document.getElementById('v-visitors').value) || 0;
        if(v > 0) document.getElementById('v-avg').value = Math.round(t/v);
    }

    let extraRows = [];
    function addExtraRow() {
        const amt = prompt("é‡‘é¡ï¼š");
        const note = prompt("å‚™è¨»ï¼š");
        if(amt) {
            extraRows.push({amt: parseFloat(amt), note});
            document.getElementById('extra-container').innerHTML += `<div style="font-size:12px;">${note}: $${amt}</div>`;
        }
    }

    function calcFinalDiff() {
        const inCash = parseFloat(document.getElementById('in-cash-val')?.value || window.lastData?.cash || 0);
        const inStock = parseFloat(document.getElementById('in-stock-val')?.value || window.lastData?.stock || 0);
        const outTotal = parseFloat(document.getElementById('out-total-sum').innerText);
        const turnover = parseFloat(document.getElementById('v-turnover').value) || 0;
        const deduct = (parseFloat(document.getElementById('v-credit').value)||0) + 
                       (parseFloat(document.getElementById('v-twpay').value)||0) +
                       (parseFloat(document.getElementById('v-linepay').value)||0) +
                       (parseFloat(document.getElementById('v-points').value)||0) +
                       (parseFloat(document.getElementById('v-refund').value)||0);
        const thousands = (parseFloat(document.getElementById('v-thousands').value)||0) * 1000;
        const extras = extraRows.reduce((a,b)=>a+b.amt,0);
        
        // å…¬å¼ï¼š(((é€²æ«ƒ+é€²åº«)-(é›¢æ«ƒ)+ç‡Ÿæ¥­é¡-æ‰£é …-åƒéˆ”+é¡å¤–æ”¶æ”¯)*-1)
        const diff = ((inCash + inStock - outTotal + turnover - deduct - thousands + extras) * -1);
        document.getElementById('v-diff').innerText = diff;
    }

    function openForm(type, title) {
        document.getElementById('form-popup').classList.remove('hidden');
        document.getElementById('form-title').innerText = title;
        const fields = document.getElementById('form-fields');
        fields.innerHTML = "";
        if(type==='preorder' || type==='repair' || type==='soldout' || type==='scrap') {
            fields.innerHTML = `<input id="f-pname" placeholder="å“å"> <input id="f-barcode" placeholder="æ¢ç¢¼">`;
            if(type==='preorder') fields.innerHTML += `<input id="f-qty" placeholder="æ•¸é‡"> <input id="f-cname" placeholder="å®¢å"> <input id="f-phone" placeholder="é›»è©±">`;
        } else {
            fields.innerHTML = `<textarea id="f-msg" placeholder="è«‹æè¿°äº¤æ¥å…§å®¹..."></textarea>`;
        }
    }
    function closeForm() { document.getElementById('form-popup').classList.add('hidden'); }

    function rateStar(el, count) {
        const parent = el.parentNode;
        parent.querySelectorAll('.star').forEach((s,i) => s.classList.toggle('selected', i < count));
    }

    // æ¨¡å‹åœ– 3.0 é‚è¼¯
    let shapes = [];
    window.addMapShape = () => {
        const name = prompt("å€åŸŸåç¨±ï¼š");
        if(!name) return;
        shapes.push({ id:Date.now(), name, x:50, y:50, w:60, h:40, done:false });
        renderMapV14({ shapes });
    };
    function renderMapV14(data) {
        shapes = data.shapes || [];
        const canvas = document.getElementById('shelf-canvas');
        canvas.innerHTML = "";
        if(data.bg) canvas.style.backgroundImage = `url(${data.bg})`;
        shapes.forEach(s => {
            const div = document.createElement('div');
            div.className = `shape ${s.done?'done':''}`;
            div.style.left = s.x+"px"; div.style.top = s.y+"px";
            div.style.width = s.w+"px"; div.style.height = s.h+"px";
            div.innerHTML = `<div>${s.name}${s.done?'<br>âœ…':''}</div>`;
            
            if(window.user.shift === 'ä¸»ç®¡') {
                div.onmousedown = (e) => {
                    let ox = e.clientX - s.x; let oy = e.clientY - s.y;
                    document.onmousemove = (ev) => { s.x=ev.clientX-ox; s.y=ev.clientY-oy; div.style.left=s.x+"px"; div.style.top=s.y+"px"; };
                    document.onmouseup = () => document.onmousemove = null;
                };
                div.oncontextmenu = (e) => {
                    e.preventDefault();
                    if(confirm("è¦åˆªé™¤é€™å€‹å€å¡Šå—ï¼Ÿ")) { shapes = shapes.filter(x => x.id !== s.id); renderMapV14({shapes}); }
                };
            } else {
                div.onclick = async () => {
                    if(confirm(`ç¢ºèªã€${s.name}ã€‘æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
                        s.done = true; s.user = window.user.name; s.time = new Date().toLocaleTimeString();
                        await window.setDoc(window.doc(window.db, "settings", "map"), { shapes });
                    }
                };
            }
            canvas.appendChild(div);
        });
    }
    window.saveMapData = async () => {
        await window.setDoc(window.doc(window.db, "settings", "map"), { shapes, bg: window.mapBgData || "" });
        alert("é…ç½®å·²å„²å­˜");
    };
    window.mapBgUpload = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            window.mapBgData = ev.target.result;
            document.getElementById('shelf-canvas').style.backgroundImage = `url(${ev.target.result})`;
        };
        reader.readAsDataURL(e.target.files[0]);
    };
</script>
</body>
</html>