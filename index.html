<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é–€å¸‚ V37 (ä¼æ¥­ç´šé‡æ§‹ç‰ˆ)</title>
    <style>
        /* --- Google Material Design é¢¨æ ¼å¾®èª¿ --- */
        :root { --primary: #1a73e8; --danger: #d93025; --warning: #f9ab00; --success: #1e8e3e; --bg: #f8f9fa; }
        body { font-family: Roboto, "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); padding-bottom: 120px; color: #202124; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }

        /* å°èˆªåˆ— */
        .nav { display: flex; position: sticky; top: 0; background: #fff; border-bottom: 1px solid #dadce0; z-index: 100; overflow-x: auto; }
        .nav div { flex: 0 0 auto; padding: 15px 20px; font-weight: 500; color: #5f6368; cursor: pointer; white-space: nowrap; }
        .nav div.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #e8f0fe; }

        /* å€å¡Šæ¨™é¡Œ */
        .head { background: #f1f3f4; padding: 12px 15px; margin: 10px 0; font-weight: bold; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; color: #202124; }
        
        /* æ ¼å­ç³»çµ± */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 10px; }
        .box { border: 1px solid #dadce0; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; background: #fff; min-height: 70px; display:flex; flex-direction:column; justify-content:center; align-items:center; position: relative; transition:0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .box:active { transform: scale(0.98); }
        
        /* ç‹€æ…‹è‰²ç³» */
        .box.ok { background: #e6f4ea !important; border-color: var(--success) !important; color: #137333; }
        .box.alert { background: #fce8e6 !important; border-color: var(--danger) !important; color: #c5221f; animation: shake 0.4s; font-weight: bold; }
        .priority { background: #fef7e0 !important; border: 2px solid var(--warning) !important; color: #b06000; font-weight: 900; }

        /* ç®¡ç†æ¨¡å¼ UI */
        .del-btn { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 14px; line-height: 24px; display: none; z-index: 10; border: 2px solid white; box-shadow: 0 2px 2px rgba(0,0,0,0.3); }
        .editing .del-btn { display: block; }
        .editing .box { border: 2px dashed var(--primary); opacity: 0.8; }

        /* æ¨¡å‹åœ– (Canvas) */
        #map-container { position: relative; width: 95%; height: 400px; background: #e8eaed; margin: 10px auto; border: 1px solid #dadce0; overflow: hidden; touch-action: none; }
        .shape { position: absolute; border: 2px solid #5f6368; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; cursor: grab; text-align: center; padding: 2px; font-weight: bold; user-select: none; }
        .shape.done { background: var(--success) !important; color: white !important; border-color: #0d652d; }
        .shape.selected { border: 3px solid var(--danger); z-index: 20; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        /* å¸³å‹™è¡¨ */
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 10px; }
        td, th { border: 1px solid #dadce0; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }
        .inp-money { width: 100%; text-align: center; padding: 8px; border: 1px solid #dadce0; font-size: 16px; background: #fff; border-radius: 4px; }
        .total-row { font-weight: bold; color: var(--primary); background: #e8f0fe; }

        /* å®¢æœç•™è¨€æ¿ */
        .feed-item { border: 1px solid #dadce0; padding: 12px; margin-bottom: 10px; border-radius: 8px; background: #fff; }
        .feed-item.done { border-left: 5px solid var(--success); }
        .feed-item.pending { border-left: 5px solid var(--warning); }
        .feed-meta { font-size: 12px; color: #5f6368; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .feed-reply { background: #f1f3f4; padding: 8px; margin-top: 8px; border-radius: 4px; font-size: 13px; border-left: 3px solid var(--primary); }

        /* é€šç”¨å…ƒä»¶ */
        input, select, button, textarea { width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; font-size: 16px; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }
        button { background: var(--primary); color: white; border: none; font-weight: 500; cursor: pointer; border-radius: 4px; }
        button:active { transform: translateY(1px); }
        .btn-g { background: var(--success); } .btn-r { background: var(--danger); } .btn-o { background: var(--warning); color: #333; }
        .btn-sm { width: auto; padding: 6px 12px; font-size: 13px; margin-right: 5px; }
        .hide { display: none !important; }
        
        /* åœ–ç‰‡èˆ‡éˆ´éº */
        #img-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #img-overlay.show { opacity: 1; pointer-events: auto; }
        #big-img { max-width: 95%; max-height: 95%; border: 2px solid white; transform: scale(0.8); transition: transform 0.3s; }
        #img-overlay.show #big-img { transform: scale(1); }
        #bell { position: fixed; top: 15px; right: 15px; font-size: 24px; background: white; border-radius: 50%; padding: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 200; cursor: pointer; }
        #badge { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 11px; text-align: center; line-height: 18px; display: none; }

        @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 50%{transform:translateX(5px)} 75%{transform:translateX(-5px)} 100%{transform:translateX(0)} }
    </style>
</head>
<body>

<div id="img-overlay" onclick="closeZoom()"><img id="big-img"></div>
<div id="bell" onclick="gotoSvc()">ğŸ””<div id="badge">0</div></div>

<div class="container">
    <div id="page-auth" style="padding:40px 20px; text-align:center;">
        <h2 style="color:var(--primary)">ğŸª æ™ºæ…§é–€å¸‚ V37</h2>
        <p style="color:#5f6368; font-size:12px;">Google Engineering Standard Build</p>
        <div id="box-login">
            <input id="l-id" placeholder="å¸³è™Ÿ">
            <input id="l-pw" type="password" placeholder="å¯†ç¢¼">
            <button onclick="login()" style="width:100%">ç™»å…¥</button>
            <p onclick="swAuth(true)" style="color:var(--primary); margin-top:20px; cursor:pointer;">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š</p>
        </div>
        <div id="box-reg" class="hide">
            <input id="r-name" placeholder="çœŸå¯¦å§“å">
            <select id="r-shift"><option>æ—©ç­</option><option>æ™šç­</option><option>ä¸»ç®¡</option></select>
            <input id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
            <input id="r-pw" type="password" placeholder="è¨­å®šå¯†ç¢¼">
            <button class="btn-g" onclick="reg()" style="width:100%">ç¢ºèªè¨»å†Š</button>
            <p onclick="swAuth(false)" style="color:var(--primary); margin-top:20px; cursor:pointer;">è¿”å›ç™»å…¥</p>
        </div>
    </div>

    <div id="page-main" class="hide">
        <div style="background:#333; color:white; padding:12px; display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ‘¤ <span id="user-info">--</span></span>
            <button onclick="logout()" class="btn-sm" style="background:#555;">ç™»å‡º</button>
        </div>

        <div class="nav">
            <div onclick="tab('stock')" id="n-stock" class="active">ğŸ“¦ è£œè²¨</div>
            <div onclick="tab('expiry')" id="n-expiry">ğŸ“… æ•ˆæœŸ</div>
            <div onclick="tab('temp')" id="n-temp">ğŸŒ¡ï¸ å†°ç®±</div>
            <div onclick="tab('count')" id="n-count">ğŸ’° å¸³å‹™</div>
            <div onclick="tab('svc')" id="n-svc">ğŸ¤ å®¢æœ</div>
            <div onclick="tab('mgr')" id="n-mgr" class="hide">ğŸ“Š ä¸»ç®¡</div>
        </div>

        <div id="v-stock">
            <div class="head">ğŸ”¥ é‡é»è£œè²¨ (å¿…é ˆé¡¯çœ¼)</div>
            <div class="grid">
                <div class="box priority" id="stk_noodle" onclick="chk('stk_noodle','å¤–ç±æ³¡éºµ')">å¤–ç±æ³¡éºµ<br><small>å¾…æª¢</small></div>
                <div class="box priority" id="stk_cookie" onclick="chk('stk_cookie','å¤–ç±é¤…ä¹¾')">å¤–ç±é¤…ä¹¾<br><small>å¾…æª¢</small></div>
            </div>

            <div class="head">
                ğŸ›’ æ¯æ—¥è£œè²¨ 
                <button id="btn-edit-stock" class="hide btn-sm btn-o" onclick="toggleEdit('stock-grid')">ç®¡ç†æ¸…å–®</button>
            </div>
            <div class="grid" id="stock-grid"></div> <div id="add-stock-area" class="hide" style="padding:10px;">
                <button class="btn-g" style="width:100%" onclick="addItem('stock')">+ æ–°å¢é …ç›®</button>
            </div>
        </div>

        <div id="v-expiry" class="hide">
            <div class="head">ğŸ“… æ¯æ—¥æ•ˆæœŸæª¢æŸ¥</div>
            <div class="grid">
                <div class="box" id="exp_bread" onclick="chk('exp_bread','éºµåŒ…')">éºµåŒ…</div>
                <div class="box" id="exp_drink" onclick="chk('exp_drink','æ—¥é…é£²æ–™')">æ—¥é…é£²æ–™</div>
                <div class="box" id="exp_veg" onclick="chk('exp_veg','ç”Ÿé®®è”¬èœ')">ç”Ÿé®®è”¬èœ</div>
            </div>

            <div class="head">
                ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸåœ– (å¯æ‹–æ›³/ç·¨è¼¯)
                <div id="map-ctrls" class="hide">
                    <button class="btn-sm btn-g" onclick="addShape()">+æ–¹å¡Š</button>
                    <button class="btn-sm btn-o" onclick="saveMap()">ç™¼å¸ƒ</button>
                </div>
            </div>
            <div id="map-edit-bar" class="hide" style="padding:10px; background:#e8f0fe; border-bottom:1px solid #ccc;">
                <b>é¸å–ä¸­: <span id="sel-name" style="color:red;">--</span></b>
                <div style="margin-top:5px;">
                    <button class="btn-sm" onclick="resizeShape()">èª¿æ•´å¤§å°</button>
                    <button class="btn-sm" onclick="renShape()">æ”¹å</button>
                    <button class="btn-sm btn-r" onclick="delShape()">åˆªé™¤</button>
                    <button class="btn-sm btn-o" onclick="mgrReviewShape()">æ‰¹æ”¹</button>
                </div>
            </div>
            <div id="map-container"></div>
        </div>

        <div id="v-temp" class="hide">
            <div class="head">
                â„ï¸ å†°ç®±æº«åº¦æª¢æŸ¥
                <button id="btn-edit-fridge" class="hide btn-sm btn-o" onclick="toggleEdit('fridge-grid')">ç®¡ç†æ¸…å–®</button>
            </div>
            <div style="padding:0 10px; color:#666; font-size:12px; margin-bottom:10px;">
                è¦å‰‡ï¼šå†·è— 0~7Â°Cï¼Œå†·å‡ <-10Â°C (å¿…é ˆè¼¸å…¥è² æ•¸)
            </div>
            <div class="grid" id="fridge-grid"></div> <div id="add-fridge-area" class="hide" style="padding:10px;">
                <button class="btn-g" style="width:100%" onclick="addItem('fridge')">+ æ–°å¢å†°ç®±</button>
            </div>
        </div>

        <div id="v-count" class="hide">
            <div class="head">ğŸ“¥ ä¸Šä¸€ç­ç•™å­˜ (ä¸»ç®¡å¯ä¿®)</div>
            <div style="padding:10px; background:#e3f2fd; border-radius:8px; margin:10px;">
                <label>æ”¶éŠ€ç•™å­˜ï¼š</label><input type="number" id="in-cash" disabled style="width:100px; display:inline-block">
                <label>é‡‘åº«ç•™å­˜ï¼š</label><input type="number" id="in-vault" disabled style="width:100px; display:inline-block">
                <div id="mgr-finance-tools" class="hide" style="margin-top:10px;">
                    <button class="btn-sm btn-o" onclick="unlockFinance()">âœï¸ è§£é–ç·¨è¼¯</button>
                    <button class="btn-sm btn-g" onclick="saveFinanceStart()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>
            </div>

            <div class="head">ğŸª™ äº¤ç­é»ç®— (å«é‡‘åº«)</div>
            <table>
                <tr><th>é¢é¡</th><th>æ”¶éŠ€æ©Ÿ</th><th>é‡‘åº«</th><th>å°è¨ˆ</th></tr>
                <tbody id="money-body"></tbody>
                <tr class="total-row">
                    <td colspan="3">ç¸½è¨ˆ</td>
                    <td id="total-cash">0</td>
                </tr>
            </table>

            <div class="head">ğŸ“ é›»è©±å¡ (é€²/éŠ·/å­˜)</div>
            <div id="card-list" class="grid"></div>

            <div class="head">ğŸ“Š ç‡Ÿæ”¶çµç®—</div>
            <div class="grid">
                <input type="number" id="val-rev" placeholder="ç‡Ÿæ¥­é¡" oninput="doCalc()">
                <input type="number" id="val-vis" placeholder="ä¾†å®¢æ•¸" oninput="doCalc()">
                <input type="text" id="val-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
            </div>
            
            <div class="head">ğŸ’³ éç¾é‡‘æ”¯ä»˜ & æ‰£æ¬¾</div>
            <div class="grid">
                <input type="number" class="deduct" placeholder="ä¿¡ç”¨å¡" oninput="doCalc()">
                <input type="number" class="deduct" placeholder="å°ç£Pay" oninput="doCalc()">
                <input type="number" class="deduct" placeholder="Line Pay" oninput="doCalc()">
                <input type="number" class="deduct" placeholder="é»æ•¸æŠ˜æŠµ" oninput="doCalc()">
                <input type="number" class="deduct" placeholder="ç¾é‡‘æ‰£æ¬¾" oninput="doCalc()">
            </div>

            <div class="head">â• é¡å¤–æ”¶æ”¯</div>
            <div class="grid">
                <button class="btn-g" onclick="addEx('in')">+ æ”¶å…¥</button>
                <button class="btn-r" onclick="addEx('out')">+ æ”¯å‡º</button>
            </div>
            <div id="ex-list" style="padding:10px;"></div>

            <div style="background:#333; color:white; padding:15px; margin-top:20px; text-align:center; border-radius:8px;">
                <h3>èª¤å·®ï¼š<span id="diff-val">0</span></h3>
                <button class="btn-g" onclick="submitReport()">æäº¤äº¤ç­å ±è¡¨</button>
            </div>
        </div>

        <div id="v-svc" class="hide">
            <div class="grid">
                <button onclick="openForm('äº¤æ¥')">ğŸ“ äº¤æ¥</button>
                <button onclick="openForm('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="openForm('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
                <button onclick="openForm('è©¢å•')" class="btn-o">â“ è©¢å•</button>
            </div>
            <div id="feed-list" style="margin-top:15px;"></div>
        </div>

        <div id="v-mgr" class="hide">
            <div class="head">ğŸŒŸ å“¡å·¥è¡¨ç¾è©•åˆ†</div>
            <select id="mgr-target" style="width:100%; margin-bottom:10px;"><option>é¸æ“‡å“¡å·¥...</option></select>
            <div style="padding:15px; background:#fff; border:1px solid #ddd; border-radius:8px;">
                <p>å·¥ä½œæ•ˆç‡: <span class="stars" onclick="rate(this, event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <p>è£œè²¨å®Œæˆ: <span class="stars" onclick="rate(this, event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <p>ç”Ÿé®®æª¢æŸ¥: <span class="stars" onclick="rate(this, event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <p>é¡§å®¢åæ‡‰: <span class="stars" onclick="rate(this, event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <button class="btn-g" onclick="alert('è©•åˆ†å·²å„²å­˜')">é€å‡ºè©•åˆ†</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-form" class="hide" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:flex; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-height:90%; overflow-y:auto; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
        <h3 id="modal-title" style="margin-top:0">--</h3>
        <div id="modal-fields"></div>
        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
            <label>ğŸ“· æ‹ç…§ä¸Šå‚³ï¼š</label>
            <input type="file" id="modal-img" accept="image/*" onchange="previewImg()">
            <img id="preview-box" style="width:100px; display:none; margin-top:5px; border:1px solid #ccc;">
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-g" style="flex:1" onclick="submitForm()">é€å‡º</button>
            <button style="flex:1; background:#666;" onclick="document.getElementById('modal-form').classList.add('hide')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
// --- 1. è³‡æ–™åº«æ ¸å¿ƒ (Google Engineer Approach: Clean Schema) ---
const DB = {
    get: (k) => JSON.parse(localStorage.getItem(k) || '{}'),
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    arr: (k) => JSON.parse(localStorage.getItem(k) || '[]'),
    push: (k, v) => {
        let a = JSON.parse(localStorage.getItem(k) || '[]');
        a.unshift(v);
        localStorage.setItem(k, JSON.stringify(a));
    }
};

// --- å¼·åˆ¶è³‡æ–™é·ç§»èˆ‡åˆå§‹åŒ– (è§£æ±º [object Object] å•é¡Œ) ---
function hardResetAndInit() {
    // æª¢æŸ¥ç‰ˆæœ¬ï¼Œè‹¥ä¸æ˜¯ v37 å‰‡é‡ç½®æ ¸å¿ƒè¨­å®š
    if (localStorage.getItem('app_version') !== 'v37') {
        console.log("åŸ·è¡Œè³‡æ–™çµæ§‹å‡ç´š...");
        
        // é è¨­è£œè²¨æ¸…å–®
        const defaultStock = ['å†°ç®±é£²æ–™','å±¤æ¶é£²æ–™','è¸æ¶','é›»æ± ','æ³¡éºµ/é¤…ä¹¾','åƒåœ¾è¢‹/å…æ´—é¤å…·','ç™¾è²¨ç”¨å“(ç‰™è†/æ´—è¡£ç²¾/è¡›ç”Ÿç´™)'];
        localStorage.setItem('conf_stock', JSON.stringify(defaultStock));

        // é è¨­å†°ç®±æ¸…å–®
        const defaultFridge = [
            {n:'é–‹æ”¾å¼å†°ç®±1', t:'c'}, {n:'é–‹æ”¾å¼å†°ç®±2', t:'c'},
            {n:'å†·è—æ«¥æ«ƒ1', t:'c'}, {n:'å†·è—æ«¥æ«ƒ2', t:'c'},
            {n:'å†·å‡æ«¥æ«ƒ1', t:'f'}, {n:'å†·å‡æ«¥æ«ƒ2', t:'f'},
            {n:'è‡¥å®¤å†°ç®±1', t:'f'}, {n:'è‡¥å®¤å†°ç®±2', t:'f'}, {n:'è‡¥å®¤å†°ç®±3', t:'f'}, {n:'è‡¥å®¤å†°ç®±4', t:'f'}
        ];
        localStorage.setItem('conf_fridge', JSON.stringify(defaultFridge));
        
        localStorage.setItem('app_version', 'v37');
    }
}
hardResetAndInit();

// å…¨åŸŸè®Šæ•¸
let me = null;
let shapes = DB.arr('map_shapes');
let selShapeIdx = null;
let imgBase64 = "";
let exArr = []; // é¡å¤–æ”¶æ”¯æš«å­˜

// --- 2. èº«ä»½é©—è­‰ ---
function swAuth(reg) {
    document.getElementById('box-login').classList.toggle('hide', reg);
    document.getElementById('box-reg').classList.toggle('hide', !reg);
}
function reg() {
    const id=document.getElementById('r-id').value, nm=document.getElementById('r-name').value, pw=document.getElementById('r-pw').value;
    if(!id||!nm||!pw) return alert("è«‹å¡«å¯«å®Œæ•´");
    let u=DB.get('users'); u[id]={name:nm, pw:pw, shift:document.getElementById('r-shift').value}; DB.set('users', u);
    alert("âœ… è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥"); swAuth(false);
}
function login() {
    const id=document.getElementById('l-id').value, pw=document.getElementById('l-pw').value;
    let u=DB.get('users');
    if(u[id] && u[id].pw===pw) { me={...u[id], id}; initApp(); } else alert("å¸³å¯†éŒ¯èª¤");
}
function logout() { location.reload(); }

// --- 3. æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– ---
function initApp() {
    document.getElementById('page-auth').classList.add('hide');
    document.getElementById('page-main').classList.remove('hide');
    document.getElementById('user-info').innerText = `${me.name} (${me.shift})`;

    // æ¬Šé™åˆ¤æ–·ï¼šè‹¥æ˜¯ä¸»ç®¡ï¼Œé¡¯ç¤ºæ‰€æœ‰éš±è—çš„ç®¡ç†æŒ‰éˆ•
    if (me.shift === 'ä¸»ç®¡') {
        document.querySelectorAll('.hide').forEach(el => {
            // åªé¡¯ç¤ºç‰¹å®šçš„ç®¡ç†å·¥å…·ï¼Œé¿å…é¡¯ç¤ºæ‰€æœ‰éš±è—å…ƒç´ (å¦‚Modal)
            if (el.id.includes('btn-edit') || el.id.includes('mgr') || el.id === 'n-mgr') {
                el.classList.remove('hide');
            }
        });
    }

    renderStock();
    renderFridge();
    renderMoneyTable();
    renderCards();
    renderFeed();
    drawMap();
    renderAllStatus(); // è¼‰å…¥å‹¾é¸ç‹€æ…‹
}

// --- A. è£œè²¨é‚è¼¯ ---
function renderStock() {
    const list = JSON.parse(localStorage.getItem('conf_stock'));
    document.getElementById('stock-grid').innerHTML = list.map((s,i) => `
        <div class="box" id="stk_${i}" onclick="checkItem('stk_${i}', '${s}')">
            ${s}<br><small>å¾…æª¢</small>
            <div class="del-btn" onclick="delConfItem('stock', ${i}); event.stopPropagation()">X</div>
        </div>
    `).join('');
}

// --- B. å†°ç®±é‚è¼¯ ---
function renderFridge() {
    const list = JSON.parse(localStorage.getItem('conf_fridge'));
    document.getElementById('fridge-grid').innerHTML = list.map((f,i) => `
        <div class="box" id="ref_${i}" onclick="inputTemp('ref_${i}', '${f.n}', '${f.t}')">
            ${f.n}<br><small>å¾…æ¸¬</small>
            <div class="del-btn" onclick="delConfItem('fridge', ${i}); event.stopPropagation()">X</div>
        </div>
    `).join('');
}

function inputTemp(id, name, type) {
    if (document.getElementById(id).closest('.editing')) return; // ç·¨è¼¯æ¨¡å¼ä¸è§¸ç™¼
    
    const val = prompt(`${name} æº«åº¦è¼¸å…¥ï¼š`, type==='f' ? '-' : '');
    if (val === null) return;
    if (val.trim() === "") return alert("æº«åº¦ä¸å¯ç©ºç™½ï¼");

    const n = parseFloat(val);
    let isAlert = false;
    
    // è¦å‰‡æª¢æŸ¥
    if (type === 'c' && (n < 0 || n > 7)) isAlert = true;
    if (type === 'f' && n > -10) isAlert = true; // -5 > -10 (True, ç•°å¸¸)

    if (isAlert) alert(`ğŸš¨ æº«åº¦ç•°å¸¸ï¼${name} å¿…é ˆ ${type==='c'?'0~7åº¦':'ä½æ–¼-10åº¦'}`);

    updateStatus(id, name, val + "Â°C", isAlert);
}

// --- C. ç‹€æ…‹ç®¡ç† (å…±ç”¨) ---
function checkItem(id, name) {
    if (document.getElementById(id).closest('.editing')) return;
    
    // ä¸»ç®¡æ‰¹æ”¹æ¨¡å¼
    let s = DB.get('status');
    if (me.shift === 'ä¸»ç®¡' && s[id] && s[id].user) {
        const r = prompt(`å“¡å·¥ ${s[id].user} æ–¼ ${s[id].time} å®Œæˆã€‚\nä¸»ç®¡æ‰¹æ”¹/è©•èªï¼š`, s[id].mgrReply || "");
        if (r !== null) {
            s[id].mgrReply = r;
            DB.set('status', s);
            renderAllStatus();
        }
    } else {
        if (confirm(`${name} ç¢ºèªå®Œæˆï¼Ÿ`)) {
            updateStatus(id, name, "å®Œæˆ", false);
        }
    }
}

function updateStatus(id, name, val, isAlert) {
    let s = DB.get('status');
    s[id] = { 
        name: name, 
        val: val, 
        alert: isAlert, 
        user: me.name, 
        time: new Date().toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'}) 
    };
    DB.set('status', s);
    renderAllStatus();
}

function renderAllStatus() {
    let s = DB.get('status');
    for (let k in s) {
        let el = document.getElementById(k);
        if (el) {
            el.className = `box ${s[k].alert ? 'alert' : 'ok'} ${k.includes('stk_noodle')||k.includes('stk_cookie') ? 'priority' : ''}`;
            el.innerHTML = `
                ${s[k].name}<br>
                <small>${s[k].alert ? 'âš ï¸ '+s[k].val : 'âœ… '+s[k].user}</small>
                ${s[k].mgrReply ? `<div style="color:blue;font-size:10px;border-top:1px solid #ccc">æ‰¹: ${s[k].mgrReply}</div>` : ''}
            `;
            // æ¢å¾©åˆªé™¤æŒ‰éˆ•
            if (document.querySelector('.editing')) {
                const type = k.includes('stk') ? 'stock' : 'fridge';
                const idx = k.split('_')[1];
                if(idx) el.innerHTML += `<div class="del-btn" onclick="delConfItem('${type}', ${idx}); event.stopPropagation()">X</div>`;
            }
        }
    }
    
    // è¼‰å…¥é€²æ«ƒè¨­å®š
    let store = DB.get('store');
    document.getElementById('in-cash').value = store.cash || 0;
    document.getElementById('in-vault').value = store.vault || 0;
    if(store.cards) {
        for(let k in store.cards) {
            let el = document.getElementById(`cl_${k}`);
            if(el) el.placeholder = `ä¸Š:${store.cards[k]}`;
        }
    }
}

// --- D. å¸³å‹™é‚è¼¯ ---
function renderMoneyTable() {
    const denoms = [500, 100, 50, 10, 5, 1];
    document.getElementById('money-body').innerHTML = denoms.map(u => `
        <tr>
            <td>${u}</td>
            <td><input type="number" class="inp-money" id="mr_${u}" oninput="calcTotal()"></td>
            <td><input type="number" class="inp-money" id="mv_${u}" oninput="calcTotal()"></td>
            <td id="sub_${u}" style="color:var(--primary); font-weight:bold;">0</td>
        </tr>
    `).join('');
}

function renderCards() {
    const cards = ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
    document.getElementById('card-list').innerHTML = cards.map(c => `
        <div style="border:1px solid #ccc; padding:5px; border-radius:5px;">
            <b>${c}</b>
            <div style="display:flex; gap:5px;">
                <input type="number" id="cs_${c}" placeholder="éŠ·" style="width:50%"> 
                <input type="number" id="cl_${c}" placeholder="å­˜" style="width:50%">
            </div>
        </div>
    `).join('');
}

function calcTotal() {
    let grandTotal = 0;
    [500, 100, 50, 10, 5, 1].forEach(u => {
        const r = Number(document.getElementById(`mr_${u}`).value) || 0;
        const v = Number(document.getElementById(`mv_${u}`).value) || 0;
        const sub = (r + v) * u;
        document.getElementById(`sub_${u}`).innerText = sub;
        grandTotal += sub;
    });
    document.getElementById('total-cash').innerText = grandTotal;
    doCalc();
}

function doCalc() {
    const inC = Number(document.getElementById('in-cash').value) || 0;
    const inV = Number(document.getElementById('in-vault').value) || 0;
    const counted = Number(document.getElementById('total-cash').innerText) || 0;
    
    const rev = Number(document.getElementById('val-rev').value) || 0;
    
    // è¨ˆç®—ä¾†å®¢å–®åƒ¹
    const vis = Number(document.getElementById('val-vis').value);
    if(vis > 0) document.getElementById('val-avg').value = Math.round(rev/vis);

    // æ‰£é …èˆ‡é¡å¤–
    let deduct = 0;
    document.querySelectorAll('.deduct').forEach(el => deduct += (Number(el.value)||0));
    
    let extIn = 0, extOut = 0;
    exArr.forEach(x => { if(x.type==='in') extIn+=x.amt; else extOut+=x.amt; });

    // å…¬å¼: (ä¸Šä¸€ç­ç¸½åˆ + ç‡Ÿæ”¶ + é¡å¤–å…¥) - (æ‰£é … + é¡å¤–æ”¯) - (æœ¬ç­é»ç®—ç¸½åˆ)
    // ç†æƒ³æ‡‰ç‚º 0
    const ideal = (inC + inV) + rev + extIn - deduct - extOut;
    const diff = counted - ideal; // æ­£æ•¸ä»£è¡¨å¤šéŒ¢ï¼Œè² æ•¸å°‘éŒ¢
    
    document.getElementById('diff-val').innerText = diff;
    document.getElementById('diff-val').style.color = diff === 0 ? 'green' : 'red';
}

// ä¸»ç®¡å¸³å‹™åŠŸèƒ½
function unlockFinance() {
    document.getElementById('in-cash').disabled = false;
    document.getElementById('in-vault').disabled = false;
    document.getElementById('btn-save-in').classList.remove('hide');
}
function saveFinanceStart() {
    let s = DB.get('store');
    s.cash = Number(document.getElementById('in-cash').value);
    s.vault = Number(document.getElementById('in-vault').value);
    DB.set('store', s);
    alert("å·²æ›´æ–°ä¸Šä¸€ç­ç•™å­˜");
    location.reload();
}

function addEx(type) {
    const amt = Number(prompt("é‡‘é¡:"));
    const txt = prompt("å‚™è¨»:");
    if(amt) {
        exArr.push({type, amt, txt});
        document.getElementById('ex-list').innerHTML += `<div style="color:${type==='in'?'green':'red'}">${type==='in'?'æ”¶':'æ”¯'} $${amt} (${txt})</div>`;
        doCalc();
    }
}

// --- E. å®¢æœ/äº¤æ¥ ---
let curFormType = "";
function openForm(type) {
    curFormType = type;
    document.getElementById('modal-form').classList.remove('hide');
    document.getElementById('modal-title').innerText = type;
    const f = document.getElementById('modal-fields');
    imgBase64 = ""; document.getElementById('preview-box').style.display='none';

    // è©³ç´°æ¬„ä½é…ç½®
    if(type === 'å®¢è¨‚') {
        f.innerHTML = `
            <input id="f1" placeholder="å“å"><input id="f2" placeholder="æ¢ç¢¼">
            <input id="f3" type="number" placeholder="æ•¸é‡"><input id="f4" type="number" placeholder="å”®åƒ¹">
            <hr>
            <input id="f5" placeholder="å®¢å"><input id="f6" placeholder="é›»è©±">
            <input id="f7" placeholder="LINE ID"><input id="f8" placeholder="æ–¹ä¾¿è¯çµ¡æ™‚é–“">
        `;
    } else if (type === 'ç¶­ä¿®') {
        f.innerHTML = `
            <input id="f1" placeholder="å“å"><input id="f2" placeholder="æ•…éšœåŸå› ">
            <input id="f3" type="date" placeholder="è³¼è²·æ—¥æœŸ"><input id="f4" placeholder="æ¢ç¢¼">
            <hr>
            <input id="f5" placeholder="å®¢å"><input id="f6" placeholder="é›»è©±">
            <input id="f7" placeholder="LINE ID"><input id="f8" placeholder="æ–¹ä¾¿è¯çµ¡æ™‚é–“">
        `;
    } else {
        f.innerHTML = `<textarea id="f1" placeholder="è«‹è¼¸å…¥å…§å®¹..." style="height:100px"></textarea>`;
    }
}

function previewImg() {
    const file = document.getElementById('modal-img').files[0];
    if(file) {
        const r = new FileReader();
        r.onload = e => { imgBase64 = e.target.result; document.getElementById('preview-box').src = imgBase64; document.getElementById('preview-box').style.display='block'; };
        r.readAsDataURL(file);
    }
}

function submitForm() {
    let txt = "";
    document.querySelectorAll('#modal-fields input, #modal-fields textarea').forEach(el => {
        if(el.value) txt += `${el.placeholder || 'å…§å®¹'}: ${el.value} <br>`;
    });

    if(!txt && !imgBase64) return alert("âŒ å…§å®¹æˆ–åœ–ç‰‡ä¸å¯ç‚ºç©º");

    DB.push('feeds', {
        type: curFormType,
        txt: txt,
        img: imgBase64,
        user: me.name,
        time: new Date().toLocaleString(),
        done: false,
        reply: "" // ä¸»ç®¡å›è¦†
    });

    alert("âœ… ç™¼é€æˆåŠŸ");
    document.getElementById('modal-form').classList.add('hide');
    renderFeed();
}

function renderFeed() {
    const feeds = DB.arr('feeds');
    const list = document.getElementById('feed-list');
    const noti = document.getElementById('noti-dropdown');
    
    list.innerHTML = "";
    noti.innerHTML = "<div style='padding:10px;font-weight:bold;background:#eee'>é€šçŸ¥åˆ—è¡¨</div>";
    
    let unread = 0;

    feeds.forEach((item, idx) => {
        if(!item.done) {
            unread++;
            noti.innerHTML += `<div style="padding:10px;border-bottom:1px solid #eee;font-size:12px;">${item.type} by ${item.user}</div>`;
        }

        // åˆ¤æ–·æ˜¯å¦ç‚ºæœ¬äººæˆ–ä¸»ç®¡ (æ¬Šé™æ§åˆ¶)
        const canEdit = (me.shift === 'ä¸»ç®¡' || me.name === item.user);

        list.innerHTML += `
            <div class="feed-item ${item.done?'done':'pending'}">
                <div class="feed-meta">
                    <span>${item.type} | ${item.user}</span>
                    <span>${item.time}</span>
                </div>
                <div>${item.txt}</div>
                ${item.img ? `<img src="${item.img}" style="width:80px; margin-top:5px; border-radius:4px;" onclick="zoom('${item.img}')">` : ''}
                
                ${item.reply ? `<div class="feed-reply">ğŸ‘® ä¸»ç®¡: ${item.reply}</div>` : ''}

                <div style="margin-top:8px; text-align:right;">
                    ${me.shift === 'ä¸»ç®¡' ? `<button class="btn-sm btn-o" onclick="mgrReply(${idx})">æ‰¹æ”¹</button>` : ''}
                    ${canEdit ? `<button class="btn-sm btn-r" onclick="delFeed(${idx})">åˆªé™¤</button>` : ''}
                    <button class="btn-sm btn-g" onclick="toggleDone(${idx})">${item.done ? 'é‡é–‹' : 'å®Œæˆ'}</button>
                </div>
            </div>
        `;
    });

    const badge = document.getElementById('badge');
    badge.innerText = unread;
    badge.style.display = unread > 0 ? 'block' : 'none';
}

function toggleDone(i) {
    let feeds = DB.arr('feeds');
    feeds[i].done = !feeds[i].done;
    localStorage.setItem('feeds', JSON.stringify(feeds));
    renderFeed();
}
function mgrReply(i) {
    const r = prompt("è¼¸å…¥æ‰¹æ”¹/æŒ‡å°å…§å®¹ï¼š");
    if(r) {
        let feeds = DB.arr('feeds');
        feeds[i].reply = r;
        localStorage.setItem('feeds', JSON.stringify(feeds));
        renderFeed();
    }
}
function delFeed(i) {
    if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ¢ç›®ï¼Ÿ")) {
        let feeds = DB.arr('feeds');
        feeds.splice(i, 1);
        localStorage.setItem('feeds', JSON.stringify(feeds));
        renderFeed();
    }
}

// --- F. æ¨¡å‹åœ– (Canvas äº’å‹•) ---
const mapDiv = document.getElementById('map-container');
let isMapEdit = false;

function drawMap() {
    mapDiv.innerHTML = "";
    shapes = DB.arr('map_shapes');
    shapes.forEach((s, i) => {
        const el = document.createElement('div');
        el.className = `shape ${s.done?'done':''} ${selShapeIdx===i?'selected':''}`;
        el.style.left = s.x + 'px';
        el.style.top = s.y + 'px';
        el.style.width = (s.w || 50) + 'px';
        el.style.height = (s.h || 50) + 'px';
        
        let html = `<span>${s.name}</span>`;
        if(s.checker) html += `<br><span style="font-size:9px">âœ…${s.checker}</span>`;
        if(s.mgrNote) html += `<br><span style="font-size:9px;color:blue">æ‰¹:${s.mgrNote}</span>`;
        el.innerHTML = html;

        // äº‹ä»¶ç¶å®š
        el.onclick = (e) => {
            e.stopPropagation();
            // ä¸»ç®¡æˆ–é¸å–æ¨¡å¼
            if(me.shift === 'ä¸»ç®¡') {
                selShapeIdx = i;
                document.getElementById('sel-name').innerText = s.name;
                document.getElementById('map-edit-bar').classList.remove('hide');
                drawMap();
            } else {
                // å“¡å·¥æª¢æŸ¥
                if(confirm(`${s.name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
                    s.done = true; 
                    s.checker = me.name; 
                    s.checkTime = new Date().toLocaleString();
                    saveMapData();
                }
            }
        };

        // æ‹–æ›³é‚è¼¯ (åƒ…ä¸»ç®¡)
        if(me.shift === 'ä¸»ç®¡') {
            el.onmousedown = (e) => {
                if(e.target !== el) return; // é˜²æ­¢é»åˆ°æ–‡å­—
                const startX = e.clientX - s.x;
                const startY = e.clientY - s.y;
                document.onmousemove = (ev) => {
                    s.x = ev.clientX - startX;
                    s.y = ev.clientY - startY;
                    el.style.left = s.x + 'px';
                    el.style.top = s.y + 'px';
                };
                document.onmouseup = () => {
                    document.onmousemove = null;
                    saveMapData();
                };
            };
        }
        
        mapDiv.appendChild(el);
    });
}

function addShape() {
    const n = prompt("å€å¡Šåç¨±:");
    const w = prompt("å¯¬åº¦ (é è¨­50):", "50");
    const h = prompt("é«˜åº¦ (é è¨­50):", "50");
    if(n) {
        shapes.push({name:n, x:50, y:50, w:parseInt(w)||50, h:parseInt(h)||50, done:false});
        saveMapData();
    }
}
function saveMapData() { localStorage.setItem('map_shapes', JSON.stringify(shapes)); drawMap(); }
function saveMap() { alert("åœ°åœ–è¨­å®šå·²å„²å­˜ä¸¦ç™¼å¸ƒ"); }
function delShape() { shapes.splice(selShapeIdx, 1); saveMapData(); document.getElementById('map-edit-bar').classList.add('hide'); }
function renShape() { const n = prompt("æ–°åç¨±"); if(n){ shapes[selShapeIdx].name=n; saveMapData(); }}
function resizeShape() {
    const w = prompt("æ–°å¯¬åº¦", shapes[selShapeIdx].w);
    const h = prompt("æ–°é«˜åº¦", shapes[selShapeIdx].h);
    if(w&&h) { shapes[selShapeIdx].w=parseInt(w); shapes[selShapeIdx].h=parseInt(h); saveMapData(); }
}
function mgrReviewShape() {
    const r = prompt("æ‰¹æ”¹å…§å®¹:");
    if(r) { shapes[selShapeIdx].mgrNote=r; saveMapData(); }
}

// --- é€šç”¨ ---
function tab(t) {
    document.querySelectorAll('.nav div').forEach(e=>e.classList.remove('active'));
    document.getElementById('n-'+t).classList.add('active');
    ['stock','expiry','temp','count','svc','mgr'].forEach(x=>document.getElementById('v-'+x).classList.add('hide'));
    document.getElementById('v-'+t).classList.remove('hide');
}
function toggleEdit(id) {
    const el = document.getElementById(id);
    el.classList.toggle('editing');
    const areaId = id === 'stock-grid' ? 'add-stock-area' : 'add-fridge-area';
    document.getElementById(areaId).classList.toggle('hide');
}
function addItem(type) {
    const key = `conf_${type}`;
    let list = JSON.parse(localStorage.getItem(key));
    const n = prompt("åç¨±:");
    if(!n) return;
    if(type === 'fridge') {
        const t = prompt("é¡å‹ (c=å†·è—, f=å†·å‡)", "c");
        list.push({n, t});
    } else {
        list.push(n);
    }
    localStorage.setItem(key, JSON.stringify(list));
    initApp(); // é‡ç¹ª
}
function delConfItem(type, idx) {
    if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
    const key = `conf_${type}`;
    let list = JSON.parse(localStorage.getItem(key));
    list.splice(idx, 1);
    localStorage.setItem(key, JSON.stringify(list));
    initApp();
}
function gotoSvc() { tab('svc'); document.getElementById('noti-dropdown').style.display='block'; }
function toggleNoti() { const d = document.getElementById('noti-dropdown'); d.style.display = d.style.display==='block'?'none':'block'; }
function zoom(s) { document.getElementById('big-img').src=s; document.getElementById('img-overlay').classList.add('show'); }
function closeZoom() { document.getElementById('img-overlay').classList.remove('show'); }
function submitReport() {
    // å„²å­˜ç‹€æ…‹çµ¦ä¸‹ä¸€ç­
    let s = DB.get('store');
    s.cash = parseFloat(document.getElementById('total-cash').innerText);
    // å¡ç‰‡åº«å­˜è½‰ç§»
    let cards = {};
    ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"].forEach(c => {
        cards[c] = document.getElementById(`cl_${c}`).value || 0;
    });
    s.cards = cards;
    DB.set('store', s);
    alert("äº¤ç­æˆåŠŸï¼è³‡æ–™å·²çµç®—");
    location.reload();
}
</script>
</body>
</html>