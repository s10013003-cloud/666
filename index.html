<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é–€å¸‚ V31 (å–®æ©Ÿæ——è‰¦ç‰ˆ)</title>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; }
        
        /* å°èˆªåˆ— */
        .nav { display: flex; position: sticky; top: 0; background: #fff; border-bottom: 3px solid #ddd; z-index: 100; }
        .nav div { flex: 1; padding: 12px 0; text-align: center; font-weight: bold; color: #666; cursor: pointer; font-size: 14px; }
        .nav div.active { color: #007bff; border-bottom: 3px solid #007bff; background: #f0f8ff; }

        /* æ¨™é¡Œèˆ‡æ ¼å­ */
        .section-header { background: #e9ecef; padding: 10px; margin: 10px 0; font-weight: bold; border-left: 5px solid #007bff; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 10px; }
        .box { border: 2px solid #ccc; padding: 15px 5px; text-align: center; border-radius: 8px; cursor: pointer; background: #fff; min-height: 60px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .box.ok { background: #d4edda !important; border-color: #28a745 !important; color: #155724; font-weight: bold; }
        .box.alert { background: #f8d7da !important; border-color: #dc3545 !important; animation: flash 1s infinite; }
        
        /* ç‰¹æ®Šæ¨£å¼ */
        .foreign { background: #f3e5f5; border: 2px solid #9c27b0; color: #6a1b9a; font-weight: bold; }
        
        /* éˆ´éºé€šçŸ¥ */
        #bell { position: fixed; top: 10px; right: 10px; font-size: 24px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 200; cursor: pointer; }
        #badge { position: absolute; top: 0; right: 0; background: red; color: white; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; text-align: center; line-height: 16px; display: none; }
        #noti-dropdown { position: fixed; top: 50px; right: 10px; width: 250px; background: white; border: 1px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 199; display: none; max-height: 300px; overflow-y: auto; border-radius: 8px; }
        .noti-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }

        /* å¸³å‹™è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        td, th { border: 1px solid #ddd; padding: 5px; text-align: center; }
        .inp-money { width: 60px; text-align: center; padding: 5px; border: 1px solid #ccc; background: #f9f9f9; }
        
        /* æ¨¡å‹åœ– */
        #shelf-canvas { border: 2px solid #333; position: relative; width: 95%; height: 300px; background: #eee; margin: 10px auto; overflow: hidden; }
        .shape { position: absolute; border: 2px solid #333; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; font-size: 11px; cursor: pointer; text-align: center; padding: 2px; }
        .shape.done { background: #28a745 !important; color: white !important; }
        .shape.selected { border: 3px solid red; z-index: 10; }

        /* é€šç”¨å…ƒä»¶ */
        input, select, button, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #999; border-radius: 5px; box-sizing: border-box; font-size: 15px; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-g { background: #28a745; } .btn-r { background: #dc3545; } .btn-o { background: #fd7e14; }
        .hide { display: none !important; }
        
        /* åœ–ç‰‡æ”¾å¤§ */
        #img-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; transition: opacity 0.3s; }
        #img-overlay img { max-width: 95%; max-height: 95%; border: 2px solid white; transition: transform 0.3s; }
        .thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; }

        /* æ˜Ÿæ˜Ÿè©•åˆ† */
        .stars span { font-size: 24px; color: #ddd; cursor: pointer; }
        .stars span.gold { color: #ffc107; }
    </style>
</head>
<body>

<div id="bell" onclick="toggleNoti()">ğŸ””<div id="badge">0</div></div>
<div id="noti-dropdown">
    <div style="padding:10px; background:#f0f0f0; font-weight:bold;">æœ€æ–°é€šçŸ¥</div>
    <div id="noti-list"></div>
</div>

<div id="img-overlay" onclick="closeZoom()"><img id="big-img"></div>

<div class="container">
    <div id="page-auth" style="padding:40px 20px; text-align:center;">
        <h2>ğŸª é–€å¸‚ç³»çµ± V31</h2>
        <div style="background:#e8f5e9; padding:5px; border-radius:5px; font-size:12px; margin-bottom:10px;">ğŸŸ¢ å–®æ©Ÿæ¨¡å¼ï¼šè³‡æ–™å­˜æ–¼æœ¬æ©Ÿï¼Œé€Ÿåº¦æœ€å¿«</div>
        
        <div id="box-login">
            <input id="l-id" placeholder="å¸³è™Ÿ">
            <input id="l-pw" type="password" placeholder="å¯†ç¢¼">
            <button onclick="login()">ç™»å…¥</button>
            <p onclick="swAuth(true)" style="color:blue; margin-top:20px;">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š</p>
        </div>
        <div id="box-reg" class="hide">
            <input id="r-name" placeholder="çœŸå¯¦å§“å">
            <select id="r-shift"><option>æ—©ç­</option><option>æ™šç­</option><option>ä¸»ç®¡</option></select>
            <input id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
            <input id="r-pw" type="password" placeholder="è¨­å®šå¯†ç¢¼">
            <button class="btn-g" onclick="reg()">ç¢ºèªè¨»å†Š</button>
            <p onclick="swAuth(false)" style="color:blue; margin-top:20px;">è¿”å›ç™»å…¥</p>
        </div>
    </div>

    <div id="page-main" class="hide">
        <div style="background:#333; color:white; padding:10px; display:flex; justify-content:space-between; align-items:center;">
            <span id="user-info">--</span>
            <button onclick="logout()" style="width:auto; padding:5px 10px; background:#555; font-size:12px;">ç™»å‡º</button>
        </div>

        <div class="nav">
            <div onclick="tab('stock')" id="n-stock" class="active">è£œè²¨</div>
            <div onclick="tab('temp')" id="n-temp">å†°ç®±</div>
            <div onclick="tab('count')" id="n-count">å¸³å‹™</div>
            <div onclick="tab('svc')" id="n-svc">å®¢æœ</div>
            <div onclick="tab('user')" id="n-user">æˆå°±</div>
            <div onclick="tab('mgr')" id="n-mgr" class="hide">ä¸»ç®¡</div>
        </div>

        <div id="v-stock">
            <div class="section-header" style="background:#f3e5f5; color:#4a148c;">ğŸ”¥ é‡é»è£œè²¨</div>
            <div class="grid">
                <div class="box foreign" id="stk-noodle" onclick="chk('stk-noodle','å¤–ç±æ³¡éºµ')">å¤–ç±æ³¡éºµ<br><small>å¾…æª¢</small></div>
                <div class="box foreign" id="stk-cookie" onclick="chk('stk-cookie','å¤–ç±é¤…ä¹¾')">å¤–ç±é¤…ä¹¾<br><small>å¾…æª¢</small></div>
            </div>

            <div class="section-header">ğŸ›’ æ¯æ—¥è£œè²¨ (å«ç™¾è²¨)</div>
            <div class="grid">
                <div class="box" id="stk-cig" onclick="chk('stk-cig','è¸æ¶')">è¸æ¶</div>
                <div class="box" id="stk-drink1" onclick="chk('stk-drink1','å†°ç®±é£²æ–™')">å†°ç®±é£²æ–™</div>
                <div class="box" id="stk-drink2" onclick="chk('stk-drink2','å±¤æ¶é£²æ–™')">å±¤æ¶é£²æ–™</div>
                <div class="box" id="stk-trash" onclick="chk('stk-trash','åƒåœ¾è¢‹/å…æ´—')">åƒåœ¾è¢‹/å…æ´—</div>
                <div class="box" id="stk-dept" onclick="chk('stk-dept','ç™¾è²¨(ç‰™è†/æ´—è¡£ç²¾)')">ç™¾è²¨é¡</div>
                <div class="box" id="stk-food" onclick="chk('stk-food','ä¸€èˆ¬é¤…ä¹¾/æ³¡éºµ')">ä¸€èˆ¬é¤…ä¹¾/æ³¡éºµ</div>
            </div>

            <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸåœ–</div>
            <div id="mgr-map-tool" class="hide" style="padding:5px;">
                <button onclick="addMapShape()" style="width:auto;">+æ–¹å¡Š</button>
                <div id="map-edit-bar" class="hide" style="background:#ddd; padding:5px; margin-top:5px;">
                    é¸å–ä¸­: <span id="sel-name"></span>
                    <button onclick="renShape()" style="width:auto; font-size:10px;">æ”¹å</button>
                    <button onclick="delShape()" class="btn-r" style="width:auto; font-size:10px;">åˆªé™¤</button>
                    <button onclick="saveMap()" class="btn-g" style="width:auto; font-size:10px;">ç™¼å¸ƒ</button>
                </div>
            </div>
            <div id="shelf-canvas"></div>
        </div>

        <div id="v-temp" class="hide">
            <div class="section-header">â„ï¸ å†·è—å€ (å…±4å°)</div>
            <div class="grid" id="grid-c"></div>
            <div class="section-header">ğŸ§Š å†·å‡å€ (å…±6å°)</div>
            <div class="grid" id="grid-f"></div>
        </div>

        <div id="v-count" class="hide">
            <div class="section-header">ğŸª™ äº¤ç­é›¶éŒ¢é»ç®—</div>
            <table>
                <tr><th>é¢é¡</th><th>æ”¶éŠ€æ©Ÿ</th><th>åº«å­˜(é‡‘åº«)</th><th>å°è¨ˆ</th></tr>
                <tbody id="money-body"></tbody>
            </table>
            <div style="text-align:right; font-weight:bold; color:blue; padding:10px;">ç¸½è¨ˆ: $<span id="total-cash">0</span></div>

            <div class="section-header">ğŸ“ é›»è©±å¡ (åº«å­˜/éŠ·å”®)</div>
            <div id="card-list" class="grid"></div>

            <div class="section-header">ğŸ“Š ç‡Ÿæ”¶çµç®—</div>
            <div class="grid">
                <input type="number" id="val-rev" placeholder="ç‡Ÿæ¥­é¡" oninput="calcAvg()">
                <input type="number" id="val-vis" placeholder="ä¾†å®¢æ•¸" oninput="calcAvg()">
                <input type="text" id="val-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
            </div>
            <div class="grid">
                <input type="number" id="pay-cr" placeholder="ä¿¡ç”¨å¡">
                <input type="number" id="pay-tw" placeholder="å°ç£Pay">
                <input type="number" id="pay-ln" placeholder="Line Pay">
                <input type="number" id="pay-pt" placeholder="ä½¿ç”¨é»æ•¸">
                <input type="number" id="pay-rf" placeholder="ç¾é‡‘æ‰£æ¬¾">
            </div>
            <button class="btn-g" onclick="alert('å ±è¡¨å·²å„²å­˜')">æäº¤äº¤ç­å ±è¡¨</button>
        </div>

        <div id="v-svc" class="hide">
            <div class="grid">
                <button onclick="openForm('äº¤æ¥')">ğŸ“ äº¤æ¥</button>
                <button onclick="openForm('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="openForm('ç¶­ä¿®')">ğŸ”§ é›»å™¨ç¶­ä¿®</button>
                <button onclick="openForm('å ±å»¢')">ğŸ—‘ï¸ å ±å»¢</button>
                <button onclick="openForm('è©¢å•')" class="btn-o">â“ å®¢äººè©¢å•</button>
            </div>
            <div id="feed-list" style="margin-top:15px;"></div>
        </div>

        <div id="v-user" class="hide">
            <div class="section-header">ğŸ† æˆ‘çš„æˆå°±</div>
            <div style="padding:20px; text-align:center; color:#666;">
                (åŠŸèƒ½é–‹ç™¼ä¸­...)
            </div>
        </div>

        <div id="v-mgr" class="hide">
            <div class="section-header">ğŸŒŸ å“¡å·¥è¡¨ç¾è©•åˆ†</div>
            <select id="mgr-target"><option>é¸æ“‡å“¡å·¥</option></select>
            <div style="padding:15px; background:#f9f9f9; margin-top:10px;">
                <p>å·¥ä½œæ•ˆç‡: <span class="stars" data-cat="eff"></span></p>
                <p>è£œè²¨å®Œæˆ: <span class="stars" data-cat="stk"></span></p>
                <p>ç”Ÿé®®æª¢æŸ¥: <span class="stars" data-cat="frs"></span></p>
                <p>é¡§å®¢åæ‡‰: <span class="stars" data-cat="cus"></span></p>
                <button class="btn-g" onclick="saveScore()">å„²å­˜è©•åˆ†</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-form" class="hide" style="position:fixed; top:5%; left:5%; width:90%; height:90%; background:white; border:2px solid #007bff; padding:15px; overflow-y:auto; z-index:3000; box-shadow:0 0 20px rgba(0,0,0,0.5);">
    <h3 id="modal-title">--</h3>
    <div id="modal-fields"></div>
    <div style="margin-top:10px;">
        <label>æ‹ç…§ä¸Šå‚³ï¼š</label>
        <input type="file" id="modal-img" accept="image/*">
    </div>
    <div style="margin-top:20px; display:flex; gap:10px;">
        <button class="btn-g" onclick="submitForm()">ç¢ºèªæ–°å¢</button>
        <button onclick="closeForm()" style="background:#666;">å–æ¶ˆ</button>
    </div>
</div>

<script>
// --- 1. LocalStorage æ ¸å¿ƒ (å–®æ©Ÿè³‡æ–™åº«) ---
const DB = {
    get: (k) => JSON.parse(localStorage.getItem(k) || '{}'),
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    arr: (k) => JSON.parse(localStorage.getItem(k) || '[]'),
    push: (k, v) => {
        let a = JSON.parse(localStorage.getItem(k) || '[]');
        a.unshift(v);
        localStorage.setItem(k, JSON.stringify(a));
    }
};

let me = null;
let shapes = DB.arr('map_shapes');
let selShapeIdx = null;

// --- 2. èªè­‰ ---
function swAuth(reg) {
    document.getElementById('box-login').classList.toggle('hide', reg);
    document.getElementById('box-reg').classList.toggle('hide', !reg);
}

function reg() {
    const id = document.getElementById('r-id').value;
    const nm = document.getElementById('r-name').value;
    const pw = document.getElementById('r-pw').value;
    const sf = document.getElementById('r-shift').value;
    if(!id||!nm||!pw) return alert("è«‹å¡«å¯«å®Œæ•´");
    
    let users = DB.get('users');
    if(users[id]) return alert("å¸³è™Ÿå·²å­˜åœ¨");
    
    users[id] = {name:nm, pw:pw, shift:sf};
    DB.set('users', users);
    alert("âœ… è¨»å†ŠæˆåŠŸï¼è«‹æŒ‰ç¢ºå®šè¿”å›ç™»å…¥");
    swAuth(false);
}

function login() {
    const id = document.getElementById('l-id').value;
    const pw = document.getElementById('l-pw').value;
    let users = DB.get('users');
    if(users[id] && users[id].pw === pw) {
        me = {...users[id], id};
        init();
    } else alert("å¸³å¯†éŒ¯èª¤");
}

function logout() { location.reload(); }

// --- 3. åˆå§‹åŒ– ---
function init() {
    document.getElementById('page-auth').classList.add('hide');
    document.getElementById('page-main').classList.remove('hide');
    document.getElementById('user-info').innerText = `${me.name} (${me.shift})`;
    
    if(me.shift==='ä¸»ç®¡') {
        document.getElementById('nav-mgr').classList.remove('hide');
        document.getElementById('mgr-map-tool').classList.remove('hide');
    }

    // ç”Ÿæˆå†°ç®± (10å°)
    const gc = document.getElementById('grid-c');
    const gf = document.getElementById('grid-f');
    // 1-4 å†·è—
    for(let i=1; i<=4; i++) gc.innerHTML += `<div class="box" id="ref_${i}" onclick="inputTemp('ref_${i}','å†·è—${i}','c')">å†·è—${i}<br><small>å¾…æ¸¬</small></div>`;
    // 5-10 å†·å‡
    for(let i=5; i<=10; i++) gf.innerHTML += `<div class="box" id="ref_${i}" onclick="inputTemp('ref_${i}','å†·å‡${i}','f')">å†·å‡${i}<br><small>å¾…æ¸¬</small></div>`;

    // ç”ŸæˆéŒ¢å¹£è¡¨æ ¼
    const mb = document.getElementById('money-body');
    [500,100,50,10,5,1].forEach(u => {
        mb.innerHTML += `<tr>
            <td>${u}</td>
            <td><input type="number" class="inp-money" id="mr_${u}" oninput="calcCash()"></td>
            <td><input type="number" class="inp-money" id="ms_${u}" oninput="calcCash()"></td>
            <td style="color:blue" id="sub_${u}">0</td>
        </tr>`;
    });

    // ç”Ÿæˆé›»è©±å¡
    const cards = ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
    document.getElementById('card-list').innerHTML = cards.map(c => `
        <div style="border:1px solid #ccc; padding:5px; border-radius:5px;">
            <b>${c}</b><br>
            éŠ·: <input type="number" style="width:50px; padding:5px;" placeholder="0"> 
            å­˜: <input type="number" style="width:50px; padding:5px;" placeholder="0">
        </div>
    `).join('');

    // ç”Ÿæˆè©•åˆ†æ˜Ÿæ˜Ÿ
    document.querySelectorAll('.stars').forEach(el => {
        let html = '';
        for(let i=1; i<=5; i++) html += `<span onclick="rate(this,${i})">â˜…</span>`;
        el.innerHTML = html;
    });

    renderAll();
}

// --- 4. ç•«é¢æ¸²æŸ“èˆ‡é‚è¼¯ ---
function renderAll() {
    // æ¸²æŸ“ç‹€æ…‹ (è£œè²¨/å†°ç®±)
    let checks = DB.get('checks');
    for(let k in checks) {
        const el = document.getElementById(k);
        if(el) {
            el.className = 'box ok' + (k.includes('stk-noodle')||k.includes('stk-cookie')?' foreign':'');
            el.innerHTML = `${checks[k].name}<br><small>${checks[k].time}</small>`;
        }
    }
    // æ¸²æŸ“åœ°åœ–
    drawMap();
    // æ¸²æŸ“ Feed
    renderFeed();
}

function tab(t) {
    document.querySelectorAll('.nav div').forEach(e=>e.classList.remove('active'));
    document.getElementById('n-'+t).classList.add('active');
    ['stock','temp','count','svc','user','mgr'].forEach(x=> document.getElementById('v-'+x).classList.add('hide'));
    document.getElementById('v-'+t).classList.remove('hide');
}

// è£œè²¨æ‰“å‹¾
function chk(id, name) {
    if(confirm(`${name} ç¢ºèªå®Œæˆï¼Ÿ`)) {
        let checks = DB.get('checks');
        const time = new Date().toLocaleTimeString();
        checks[id] = {name, user:me.name, time};
        DB.set('checks', checks);
        renderAll();
    }
}

// å†°ç®±æº«åº¦
function inputTemp(id, name, type) {
    const v = prompt(`${name} æº«åº¦ï¼š`, type==='f'?'-':'');
    if(!v) return;
    const n = parseFloat(v);
    if((type==='f' && n > -10) || (type==='c' && (n<0 || n>7))) alert("ğŸš¨ æº«åº¦ç•°å¸¸ï¼");
    
    let checks = DB.get('checks');
    checks[id] = {name, user:me.name, time:v+"åº¦"}; // å€Ÿç”¨ time æ¬„ä½å­˜æº«åº¦
    DB.set('checks', checks);
    renderAll();
}

// éŒ¢å¹£è¨ˆç®—
function calcCash() {
    let total = 0;
    [500,100,50,10,5,1].forEach(u => {
        const r = Number(document.getElementById(`mr_${u}`).value)||0;
        const s = Number(document.getElementById(`ms_${u}`).value)||0;
        const sub = (r+s)*u;
        document.getElementById(`sub_${u}`).innerText = sub;
        total += sub;
    });
    document.getElementById('total-cash').innerText = total;
}

function calcAvg() {
    const s = Number(document.getElementById('val-rev').value);
    const v = Number(document.getElementById('val-vis').value);
    if(v>0) document.getElementById('val-avg').value = Math.round(s/v);
}

// --- 5. è¡¨å–®å½ˆçª—ç³»çµ± ---
let formType = "";
function openForm(type) {
    formType = type;
    document.getElementById('modal-form').classList.remove('hide');
    document.getElementById('modal-title').innerText = "æ–°å¢ï¼š" + type;
    const f = document.getElementById('modal-fields');
    f.innerHTML = ""; // æ¸…ç©º

    // æ ¹æ“šéœ€æ±‚ç”¢ç”Ÿæ¬„ä½
    if(type === 'äº¤æ¥') {
        f.innerHTML = `<textarea id="f-content" placeholder="äº¤æ¥äº‹é …å…§å®¹..."></textarea>`;
    } else if(type === 'å®¢è¨‚') {
        f.innerHTML = `
            <input id="f-prod" placeholder="å“å"><input id="f-code" placeholder="æ¢ç¢¼">
            <input id="f-qty" type="number" placeholder="æ•¸é‡"><input id="f-price" type="number" placeholder="å”®åƒ¹">
            <hr><input id="f-cust" placeholder="å®¢äººå§“å"><input id="f-tel" placeholder="é›»è©±">
            <input id="f-line" placeholder="LINE ID"><input id="f-time" placeholder="æ–¹ä¾¿è¯çµ¡æ™‚é–“">
        `;
    } else if(type === 'ç¶­ä¿®') {
        f.innerHTML = `
            <input id="f-prod" placeholder="å“å"><input id="f-code" placeholder="æ¢ç¢¼">
            <input id="f-date" type="date" placeholder="è³¼è²·æ™‚é–“"><input id="f-reason" placeholder="æ•…éšœåŸå› ">
            <hr><input id="f-cust" placeholder="å®¢äººå§“å"><input id="f-tel" placeholder="é›»è©±">
            <input id="f-line" placeholder="LINE ID"><input id="f-time" placeholder="æ–¹ä¾¿è¯çµ¡æ™‚é–“">
        `;
    } else if(type === 'å ±å»¢') {
        f.innerHTML = `<input id="f-prod" placeholder="å“å"><input id="f-code" placeholder="æ¢ç¢¼"><input id="f-qty" type="number" placeholder="æ•¸é‡">`;
    } else if(type === 'è©¢å•') {
        f.innerHTML = `<textarea id="f-content" placeholder="å®¢äººè©¢å•å…§å®¹..."></textarea>`;
    }
}

function closeForm() { document.getElementById('modal-form').classList.add('hide'); }

function submitForm() {
    // æ”¶é›†è³‡æ–™
    let data = { type: formType, user: me.name, time: new Date().toLocaleString(), done: false };
    const inputs = document.querySelectorAll('#modal-fields input, #modal-fields textarea');
    let desc = "";
    inputs.forEach(i => { if(i.value) desc += `${i.placeholder}:${i.value} / `; });
    data.txt = desc;

    // åœ–ç‰‡è™•ç†
    const file = document.getElementById('modal-img').files[0];
    if(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            data.img = e.target.result;
            DB.push('feeds', data);
            finishSubmit();
        };
        reader.readAsDataURL(file);
    } else {
        DB.push('feeds', data);
        finishSubmit();
    }
}

function finishSubmit() {
    alert("âœ… æ–°å¢å®Œæˆï¼");
    closeForm();
    renderFeed();
    // æ¨¡æ“¬ä¸»ç®¡é€šçŸ¥ (ç´…é»)
    document.getElementById('badge').style.display = 'block';
    document.getElementById('badge').innerText = "!";
}

function renderFeed() {
    const feeds = DB.arr('feeds');
    const div = document.getElementById('feed-list');
    div.innerHTML = "";
    feeds.forEach((item, idx) => {
        div.innerHTML += `
            <div style="border:1px solid #ddd; padding:10px; margin-bottom:10px; background:${item.done?'#f0fff0':'#fff'}; border-radius:5px;">
                <div style="font-weight:bold; color:#007bff;">[${item.type}] ${item.user} <span style="font-size:10px; color:#999;">${item.time}</span></div>
                <div style="margin:5px 0;">${item.txt}</div>
                ${item.img ? `<img src="${item.img}" class="thumb" onclick="zoom('${item.img}')">` : ''}
                <div style="text-align:right;">
                    ${!item.done ? `<button onclick="confirmFeed(${idx})" class="btn-o" style="font-size:12px;">å®Œæˆ</button>` : 'âœ… å·²çµæ¡ˆ'}
                </div>
            </div>
        `;
    });
}

function confirmFeed(idx) {
    if(confirm("ç¢ºå®šè¦å°‡æ­¤äº‹é …æ¨™è¨˜ç‚ºå®Œæˆå—ï¼Ÿ")) {
        let feeds = DB.arr('feeds');
        feeds[idx].done = true;
        localStorage.setItem('feeds', JSON.stringify(feeds));
        renderFeed();
    }
}

function zoom(src) {
    const z = document.getElementById('img-overlay');
    document.getElementById('big-img').src = src;
    z.style.display = 'flex';
    setTimeout(()=>z.style.opacity=1, 10);
}
function closeZoom() {
    const z = document.getElementById('img-overlay');
    z.style.opacity=0;
    setTimeout(()=>z.style.display='none', 300);
}

// --- 6. æ¨¡å‹åœ– (å–®æ©Ÿç‰ˆ) ---
function drawMap() {
    const c = document.getElementById('shelf-canvas');
    c.innerHTML = "";
    shapes = DB.arr('map_shapes');
    shapes.forEach((s, i) => {
        const d = document.createElement('div');
        d.className = `shape ${s.done?'done':''} ${selShapeIdx===i?'selected':''}`;
        d.style.left = s.x+'px'; d.style.top = s.y+'px'; d.style.width="60px"; d.style.height="40px";
        d.innerText = s.name;
        
        if(me.shift==='ä¸»ç®¡') {
            d.onclick = () => {
                selShapeIdx = i;
                document.getElementById('sel-name').innerText = s.name;
                document.getElementById('map-edit-bar').classList.remove('hide');
                drawMap();
            };
        } else {
            d.onclick = () => {
                if(confirm(`${s.name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
                    s.done = true;
                    localStorage.setItem('map_shapes', JSON.stringify(shapes));
                    drawMap();
                }
            };
        }
        c.appendChild(d);
    });
}

function addMapShape() {
    const n = prompt("å€åŸŸåç¨±");
    if(n) {
        shapes.push({name:n, x:50, y:50, done:false});
        localStorage.setItem('map_shapes', JSON.stringify(shapes));
        drawMap();
    }
}
function saveMap() { alert("åœ°åœ–è¨­å®šå·²ç™¼å¸ƒ (æœ¬æ©Ÿå„²å­˜)"); }
function delShape() { shapes.splice(selShapeIdx, 1); localStorage.setItem('map_shapes', JSON.stringify(shapes)); document.getElementById('map-edit-bar').classList.add('hide'); drawMap(); }
function renShape() { const n = prompt("æ–°åç¨±"); if(n){ shapes[selShapeIdx].name = n; localStorage.setItem('map_shapes', JSON.stringify(shapes)); drawMap(); } }

// --- 7. å…¶ä»– ---
function toggleNoti() {
    const d = document.getElementById('noti-dropdown');
    d.style.display = d.style.display==='block'?'none':'block';
    if(d.style.display==='block') {
        // ç°¡å–®é¡¯ç¤ºé€šçŸ¥
        const feeds = DB.arr('feeds');
        const list = document.getElementById('noti-list');
        list.innerHTML = feeds.length ? "" : "<div style='padding:10px;'>ç„¡é€šçŸ¥</div>";
        feeds.forEach(f => {
            if(!f.done) list.innerHTML += `<div class="noti-item">ğŸ”” ${f.type}: ${f.txt.substring(0,15)}...</div>`;
        });
        document.getElementById('badge').style.display='none';
    }
}

// è©•åˆ†æ˜Ÿæ˜Ÿ
function rate(span, val) {
    const p = span.parentNode;
    p.querySelectorAll('span').forEach((s, i) => {
        s.style.color = i < val ? '#ffc107' : '#ddd';
    });
}
function saveScore() { alert("è©•åˆ†å·²å„²å­˜ï¼"); }

</script>
</body>
</html>