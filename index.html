<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§åº—å‹™ç³»çµ± V12 (å®Œæ•´å¯¦å‹™ç‰ˆ)</title>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background: #f0f2f5; padding-bottom: 90px; touch-action: manipulation; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; }
        
        /* è¨»å†Šç™»å…¥ */
        .auth-box { background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .hidden { display: none !important; }
        
        /* å°èˆªåˆ‡æ› */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .nav-item { flex: 0 0 auto; padding: 15px 20px; cursor: pointer; color: #666; font-weight: bold; border-bottom: 4px solid transparent; white-space: nowrap;}
        .nav-item.active { color: #007bff; border-bottom-color: #007bff; background: #f8f9fa; }

        /* å¤–ç±é£Ÿå“ - ç½®é ‚ä¸”ç‰¹æ®Šè‰² */
        .highlight-foreign { background: linear-gradient(135deg, #6f42c1 0%, #4b2c84 100%) !important; color: #ffd700 !important; border: 2px solid #ffd700 !important; font-weight: bold; }

        /* æ¨¡å‹åœ–èˆ‡æ‹–æ›³ */
        #shelf-canvas { border: 2px solid #333; position: relative; width: 100%; height: 350px; background: #eee; overflow: hidden; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .shelf-shape { position: absolute; cursor: move; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 2px solid #333; background: rgba(255,255,255,0.8); min-width: 50px; min-height: 50px; }
        .shelf-shape.checked { background: #d4edda !important; border-color: #28a745 !important; }

        /* é€šç”¨å…ƒä»¶ */
        .section-header { background: #e9ecef; padding: 10px; margin: 15px -15px; font-weight: bold; border-left: 5px solid #007bff; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px 5px; text-align: center; cursor: pointer; min-height: 70px; }
        .zone.ok { background: #d4edda; border-color: #28a745; }
        .zone.warning { background: #fff3cd; border-color: #dc3545; animation: flash 1s infinite; }
        
        input, select, button { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* å¸³å‹™è¡¨æ ¼ */
        .report-table { width: 100%; font-size: 13px; margin-bottom: 10px; }
        .report-table input { padding: 5px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-screen">
        <div class="auth-box">
            <h2 id="auth-title">ğŸª é–€å¸‚ç³»çµ±ç™»å…¥</h2>
            <div id="login-area">
                <input type="text" id="login-id" placeholder="å¸³è™Ÿ">
                <input type="password" id="login-pw" placeholder="å¯†ç¢¼">
                <button onclick="handleLogin()">ç™»å…¥</button>
                <p style="font-size:12px; cursor:pointer;" onclick="toggleAuth(true)">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Šä¸€å€‹</p>
            </div>
            <div id="register-area" class="hidden">
                <input type="text" id="reg-name" placeholder="å§“å">
                <select id="reg-shift"><option value="æ—©ç­">æ—©ç­</option><option value="æ™šç­">æ™šç­</option><option value="ä¸»ç®¡">ä¸»ç®¡</option></select>
                <input type="text" id="reg-id" placeholder="è¨­å®šå¸³è™Ÿ">
                <input type="password" id="reg-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button onclick="handleRegister()" style="background:#28a745;">å®Œæˆè¨»å†Š</button>
                <p style="font-size:12px; cursor:pointer;" onclick="toggleAuth(false)">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div style="background:#333; color:white; padding:10px; margin:-15px -15px 10px -15px; display:flex; justify-content:space-between; align-items:center;">
            <span id="display-info">--</span>
            <button onclick="location.reload()" style="width:auto; padding:5px; font-size:10px;">ç™»å‡º</button>
        </div>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±</div>
            <div class="nav-item" onclick="switchTab('counter')">ğŸ’° å¸³å‹™æ—¥å ±</div>
            <div class="nav-item" onclick="switchTab('service')">ğŸ’ å®¢æœ/äº¤æ¥</div>
            <div class="nav-item hidden" id="nav-mgr" onclick="switchTab('manager')">ğŸ“Š ä¸»ç®¡</div>
        </div>

        <div id="tab-stock">
            <div class="section-header">ğŸ”¥ é‡é»è£œè²¨ (å¤–ç±é£Ÿå“)</div>
            <div class="grid-box">
                <div class="zone highlight-foreign" id="stk-4" onclick="checkStock('stk-4','å¤–ç±æ³¡éºµ')">â˜…å¤–ç±æ³¡éºµâ˜…<small>--</small></div>
                <div class="zone highlight-foreign" id="stk-5" onclick="checkStock('stk-5','å¤–ç±é¤…ä¹¾')">â˜…å¤–ç±é¤…ä¹¾â˜…<small>--</small></div>
            </div>
            <div class="section-header">ğŸ“¦ æ¯æ—¥æª¢æŸ¥</div>
            <div class="grid-box">
                <div class="zone" id="stk-1" onclick="checkStock('stk-1','è¸æ¶è£œè²¨')">è¸æ¶è£œè²¨</div>
                <div class="zone" id="stk-2" onclick="checkStock('stk-2','å†°ç®±é£²æ–™')">å†°ç®±é£²æ–™</div>
                <div class="zone" id="stk-6" onclick="checkStock('stk-6','å†·å‡é£Ÿå“')">å†·å‡é£Ÿå“</div>
                <div class="zone" id="stk-7" onclick="checkStock('stk-7','åƒåœ¾è¢‹/å…æ´—')">åƒåœ¾è¢‹/å…æ´—</div>
                <div class="zone" id="chk-1" onclick="checkStock('chk-1','æ—¥é…é£²æ–™æ•ˆæœŸ')">æ—¥é…é£²æ–™æ•ˆæœŸ</div>
            </div>
            <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸæ¨¡å‹åœ–</div>
            <div id="mgr-draw-tools" class="hidden">
                <input type="file" id="bg-upload" accept="image/*" onchange="uploadBg()">
                <button onclick="addShape('square')" style="font-size:10px; width:48%; display:inline;">+æ–¹å¡Š</button>
                <button onclick="addShape('circle')" style="font-size:10px; width:48%; display:inline;">+åœ“å½¢</button>
                <button onclick="saveMap()" style="background:green; margin-top:5px;">å„²å­˜æ­¤æ¨¡å‹é…ç½®</button>
            </div>
            <div id="shelf-canvas"></div>
        </div>

        <div id="tab-temp" class="hidden">
            <div class="section-header">â„ï¸ å†·è— (0~7) / ğŸ§Š å†·å‡ (<-10)</div>
            <div class="grid-box" id="fridge-grid">
                </div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header">ğŸ“¥ é€²æ«ƒé»äº¤ (ä¸Šä¸€ç­)</div>
            <div style="background:#e3f2fd; padding:10px; border-radius:5px;">
                <label>é€²æ«ƒç¾é‡‘/é›¶éŒ¢</label><input type="number" id="cash-in-start">
                <label>é€²æ«ƒé›»è©±å¡ (ç¸½å¼µæ•¸)</label><input type="number" id="cards-in-start">
            </div>
            <div class="section-header">ğŸ“¤ é›¢æ«ƒçµå¸³ (æœ¬ç­)</div>
            <h4>ğŸª™ é›¶éŒ¢é»ç®—</h4>
            <table class="report-table">
                <tr><td>1å…ƒ:<input type="number" id="c1" oninput="calcOut()"></td><td>5å…ƒ:<input type="number" id="c5" oninput="calcOut()"></td></tr>
                <tr><td>10å…ƒ:<input type="number" id="c10" oninput="calcOut()"></td><td>50å…ƒ:<input type="number" id="c50" oninput="calcOut()"></td></tr>
                <tr><td>100å…ƒ:<input type="number" id="c100" oninput="calcOut()"></td><td>500å…ƒ:<input type="number" id="c500" oninput="calcOut()"></td></tr>
            </table>
            <h4>ğŸ“ é›»è©±å¡æ˜ç´°</h4>
            <div id="cards-detail-area"></div>
            <button onclick="calculateDiff()" style="background:#ffc107; color:black;">ğŸ§® è©¦ç®—èª¤å·®</button>
            <h3 style="text-align:center;">èª¤å·®ï¼š<span id="diff-res">0</span></h3>
            <button onclick="submitFinalReport()" style="background:green;">âœ… æäº¤æ­£å¼å ±è¡¨</button>
        </div>

        <div id="tab-service" class="hidden">
            <div class="section-header">ğŸ“ äº¤æ¥äº‹é … (æ‰€æœ‰äººéƒ½çœ‹å¾—åˆ°)</div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="task-input" placeholder="æ–°å¢äº¤æ¥äº‹é …...">
                <button onclick="addTask()" style="width:80px;">é€å‡º</button>
            </div>
            <div id="task-list" style="margin-top:10px;"></div>
            
            <div class="section-header">ğŸ’ å®¢æœå›å ±</div>
            <div class="grid-box">
                <div class="zone" onclick="svcForm('å®¢äººè©¢å•')">å®¢äººè©¢å•/è¨±é¡˜</div>
                <div class="zone" onclick="svcForm('å”®ç½„é€šå ±')">å•†å“å”®ç½„</div>
                <div class="zone" onclick="svcForm('å®¢è¨‚è³‡æ–™')">å®¢è¨‚/é è³¼</div>
                <div class="zone" onclick="svcForm('ç¶­ä¿®è³‡æ–™')">é›»å™¨ç¶­ä¿®</div>
            </div>
            <div id="svc-form-area" class="hidden" style="background:#eee; padding:10px; border-radius:8px;">
                <h4 id="svc-name">è¡¨å–®</h4>
                <div id="svc-inputs"></div>
                <button onclick="submitSvc()">ç¢ºèªé€å‡º</button>
            </div>
            <div id="svc-display-list" style="margin-top:10px;"></div>
        </div>

        <div id="tab-manager" class="hidden">
            <div class="section-header">ğŸ“Š é–€å¸‚æ•¸æ“šåˆ†æ</div>
            <div id="mgr-stats">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73",
        measurementId: "G-M4169BDVH5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    // --- èªè­‰é‚è¼¯ ---
    window.toggleAuth = (reg) => {
        document.getElementById('login-area').classList.toggle('hidden', reg);
        document.getElementById('register-area').classList.toggle('hidden', !reg);
    };

    window.handleRegister = async () => {
        const id = document.getElementById('reg-id').value;
        const data = {
            name: document.getElementById('reg-name').value,
            shift: document.getElementById('reg-shift').value,
            pw: document.getElementById('reg-pw').value,
            points: 0
        };
        await setDoc(doc(db, "users", id), data);
        alert("è¨»å†ŠæˆåŠŸï¼è«‹ç”¨å¸³è™Ÿç™»å…¥ã€‚");
        toggleAuth(false);
    };

    window.handleLogin = async () => {
        const id = document.getElementById('login-id').value;
        const pw = document.getElementById('login-pw').value;
        const snap = await getDoc(doc(db, "users", id));
        if(snap.exists() && snap.data().pw === pw) {
            window.user = snap.data();
            startApp();
        } else alert("ç™»å…¥å¤±æ•—");
    };

    function startApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('display-info').innerText = `${window.user.name} (${window.user.shift})`;
        if(window.user.shift === 'ä¸»ç®¡') {
            document.getElementById('nav-mgr').classList.remove('hidden');
            document.getElementById('mgr-draw-tools').classList.remove('hidden');
        }
        initAppContent();
    }

    // --- å…§å®¹åˆå§‹åŒ– ---
    function initAppContent() {
        // ç”Ÿæˆå†°ç®±
        const fGrid = document.getElementById('fridge-grid');
        const fridges = [
            {id:'f1', n:'é–‹æ”¾1', t:'chiller'}, {id:'f2', n:'é–‹æ”¾2', t:'chiller'},
            {id:'f3', n:'å†·è—1', t:'chiller'}, {id:'f4', n:'å†·è—2', t:'chiller'},
            {id:'f5', n:'å†·å‡1', t:'freezer'}, {id:'f6', n:'å†·å‡2', t:'freezer'},
            {id:'f7', n:'è‡¥å¼1', t:'freezer'}, {id:'f8', n:'è‡¥å¼2', t:'freezer'},
            {id:'f9', n:'è‡¥å¼3', t:'freezer'}, {id:'f10', n:'è‡¥å¼4', t:'freezer'}
        ];
        fGrid.innerHTML = fridges.map(f => `<div class="zone" id="${f.id}" onclick="checkTemp('${f.id}','${f.n}','${f.t}')">${f.n}<br><small>--</small></div>`).join('');

        // ç”Ÿæˆé›»è©±å¡
        const cards = ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
        document.getElementById('cards-detail-area').innerHTML = cards.map(c => 
            `<div style="display:flex; gap:5px; align-items:center; font-size:12px; margin-bottom:5px;">
                <label style="width:70px;">${c}:</label>
                <input type="number" id="card-sold-${c}" placeholder="è²©å”®" style="padding:5px;">
                <input type="number" id="card-left-${c}" placeholder="é›¢æ«ƒåº«å­˜" style="padding:5px;">
            </div>`).join('');

        // ç›£è½ä»»å‹™ (å³æ™‚åŒæ­¥)
        onSnapshot(query(collection(db, "tasks"), orderBy("time", "desc"), limit(10)), (snap) => {
            const list = document.getElementById('task-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                list.innerHTML += `<div style="background:#fff; padding:10px; border-radius:5px; margin-bottom:5px; border-left:4px solid #ffc107">
                    <b>${t.msg}</b> <small>(${t.user} - ${t.shift})</small>
                </div>`;
            });
        });

        // ç›£è½å®¢æœå›å ± (å³æ™‚åŒæ­¥)
        onSnapshot(query(collection(db, "services"), orderBy("time", "desc"), limit(10)), (snap) => {
            const list = document.getElementById('svc-display-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const s = d.data();
                list.innerHTML += `<div style="background:#f8f9fa; padding:8px; font-size:12px; border-bottom:1px solid #ddd;">
                    <b>[${s.type}]</b> ${s.content} <br><small>${s.user} @ ${new Date(s.time.toDate()).toLocaleString()}</small>
                </div>`;
            });
        });

        // è¼‰å…¥æ¨¡å‹åœ–
        loadMap();
    }

    // --- æ¨¡å‹åœ–é‚è¼¯ (æ‹–æ›³èˆ‡ä¸Šå‚³) ---
    let shapes = [];
    window.uploadBg = () => {
        const file = document.getElementById('bg-upload').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('shelf-canvas').style.backgroundImage = `url(${e.target.result})`;
            window.bgData = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    window.addShape = (type) => {
        const name = prompt("å€åŸŸåç¨±ï¼š");
        if(!name) return;
        const id = "s" + Date.now();
        const s = { id, type, name, x: 20, y: 20, done: false };
        shapes.push(s);
        renderShapes();
    };

    function renderShapes() {
        const container = document.getElementById('shelf-canvas');
        container.innerHTML = "";
        shapes.forEach(s => {
            const div = document.createElement('div');
            div.className = `shelf-shape ${s.done?'checked':''}`;
            div.id = s.id;
            div.innerText = s.name + (s.time ? `\n(${s.time})` : "");
            div.style.left = s.x + "px"; div.style.top = s.y + "px";
            div.style.borderRadius = s.type === 'circle' ? '50%' : '5px';
            
            // æ‹–æ›³é‚è¼¯
            if(window.user.shift === 'ä¸»ç®¡') {
                div.draggable = true;
                div.onmousedown = (e) => startDrag(e, s);
            } else {
                div.onclick = () => markShape(s);
            }
            container.appendChild(div);
        });
    }

    function startDrag(e, s) {
        let offsetX = e.clientX - s.x;
        let offsetY = e.clientY - s.y;
        document.onmousemove = (ev) => {
            s.x = ev.clientX - offsetX;
            s.y = ev.clientY - offsetY;
            renderShapes();
        };
        document.onmouseup = () => document.onmousemove = null;
    }

    async function markShape(s) {
        if(confirm(`ç¢ºèªã€${s.name}ã€‘æ•ˆæœŸæª¢æŸ¥å·²å®Œæˆï¼Ÿ`)) {
            s.done = true;
            s.time = new Date().toLocaleDateString();
            renderShapes();
            await saveMap();
        }
    }

    window.saveMap = async () => {
        await setDoc(doc(db, "settings", "map"), { shapes, bg: window.bgData || "" });
        alert("æ¨¡å‹å·²æ›´æ–°ï¼");
    };

    async function loadMap() {
        const snap = await getDoc(doc(db, "settings", "map"));
        if(snap.exists()){
            shapes = snap.data().shapes || [];
            window.bgData = snap.data().bg || "";
            document.getElementById('shelf-canvas').style.backgroundImage = `url(${window.bgData})`;
            renderShapes();
        }
    }

    // --- å†°ç®±èˆ‡æª¢æŸ¥ ---
    window.checkTemp = async (id, name, type) => {
        const def = type === 'freezer' ? '-' : '';
        const val = prompt(`${name} æº«åº¦ï¼š`, def);
        if(!val) return;
        const num = parseFloat(val);
        let status = "æ­£å¸¸";
        if(type==='freezer' && num > -10) { alert("âš ï¸ åš´é‡è­¦å‘Šï¼šå†·å‡é«˜æº«ï¼"); status="ç•°å¸¸"; }
        await setDoc(doc(db, "checks", id), { val: num+"åº¦", status, user: window.user.name, time: new Date() });
    };

    window.checkStock = async (id, name) => {
        if(confirm(`${name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
            await setDoc(doc(db, "checks", id), { val: "OK", status: "æ­£å¸¸", user: window.user.name, time: new Date() });
        }
    };

    // --- ä»»å‹™èˆ‡å®¢æœ ---
    window.addTask = async () => {
        const msg = document.getElementById('task-input').value;
        if(!msg) return;
        await addDoc(collection(db, "tasks"), { msg, user: window.user.name, shift: window.user.shift, time: new Date() });
        document.getElementById('task-input').value = "";
    };

    let curSvcType = "";
    window.svcForm = (type) => {
        curSvcType = type;
        document.getElementById('svc-form-area').classList.remove('hidden');
        document.getElementById('svc-name').innerText = type;
        document.getElementById('svc-inputs').innerHTML = `<textarea id="svc-content" placeholder="è«‹è¼¸å…¥è©³ç´°å…§å®¹..."></textarea>`;
    };

    window.submitSvc = async () => {
        const content = document.getElementById('svc-content').value;
        if(!content) return;
        await addDoc(collection(db, "services"), { type: curSvcType, content, user: window.user.name, time: new Date() });
        document.getElementById('svc-form-area').classList.add('hidden');
        alert("å›å ±æˆåŠŸï¼");
    };
</script>

<script>
    // --- ä¸€èˆ¬ä»‹é¢é‚è¼¯ ---
    function switchTab(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }

    function calcOut() {
        const total = (val('c1')*1) + (val('c5')*5) + (val('c10')*10) + (val('c50')*50) + (val('c100')*100) + (val('c500')*500);
        document.getElementById('diff-res').innerText = "é›¢æ«ƒç¸½ç¾ï¼š$" + total;
        return total;
    }
    
    function val(id) { return parseFloat(document.getElementById(id).value) || 0; }
</script>
</body>
</html>