<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é–€å¸‚ç³»çµ± V21</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --purple: #6f42c1; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; }
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .nav-item { flex: 0 0 auto; padding: 15px 20px; cursor: pointer; font-weight: bold; color: #666; white-space: nowrap; }
        .nav-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #f8f9fa; }
        .section-header { background: #e9ecef; padding: 10px; font-weight: bold; border-left: 5px solid var(--primary); margin: 10px 0; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 15px 5px; text-align: center; cursor: pointer; min-height: 70px; }
        .zone.ok { background: #d4edda !important; border-color: #28a745 !important; }
        .zone.warning { background: #fff3cd !important; border-color: #dc3545 !important; }
        .highlight-foreign { background: #f3e5f5; border: 2px solid var(--purple); color: var(--purple); font-weight: bold; }
        .money-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .money-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .money-table input { width: 80px; height: 35px; font-size: 18px; text-align: center; }
        #shelf-canvas { border: 2px solid #333; position: relative; width: 100%; height: 350px; background: #eee; background-size: contain; background-repeat: no-repeat; }
        .shape { position: absolute; border: 2px solid #333; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; text-align: center; font-size: 11px; cursor: pointer; }
        .shape.done { background: #28a745 !important; color: white !important; }
        input, select, button, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-screen" style="padding:40px 20px; text-align:center;">
        <div style="background:white; padding:25px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1);">
            <h2>ğŸª æ™ºæ…§é–€å¸‚ç³»çµ± V21</h2>
            <div id="login-area">
                <input type="text" id="l-id" placeholder="å¸³è™Ÿ">
                <input type="password" id="l-pw" placeholder="å¯†ç¢¼">
                <button onclick="doLogin()">ç™»å…¥æ‰“å¡</button>
                <p onclick="toggleAuth(true)" style="color:blue; cursor:pointer; margin-top:15px;">è¨»å†Šå¸³è™Ÿ</p>
            </div>
            <div id="register-area" class="hidden">
                <input type="text" id="r-name" placeholder="å§“å">
                <select id="r-shift"><option value="æ—©ç­">æ—©ç­</option><option value="æ™šç­">æ™šç­</option><option value="ä¸»ç®¡">ä¸»ç®¡</option></select>
                <input type="text" id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
                <input type="password" id="r-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button style="background:var(--success);" onclick="doRegister()">ç¢ºèªè¨»å†Š</button>
                <p onclick="toggleAuth(false)" style="color:blue; cursor:pointer; margin-top:15px;">è¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="nav-tabs">
            <div class="nav-item active" onclick="tab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="tab('temp')">ğŸŒ¡ï¸ å†°ç®±</div>
            <div class="nav-item" onclick="tab('counter')">ğŸ’° å¸³å‹™</div>
            <div class="nav-item" onclick="tab('handover')">ğŸ¤ äº¤æ¥å®¢æœ</div>
        </div>

        <div id="tab-stock">
            <div class="section-header">ğŸ”¥ é‡é»æª¢æŸ¥ (å¤–ç±)</div>
            <div class="grid-box">
                <div class="zone highlight-foreign" id="s-for-n" onclick="quickCheck('s-for-n','å¤–ç±æ³¡éºµ')">â˜…å¤–ç±æ³¡éºµâ˜…<br><small>å¾…æª¢</small></div>
                <div class="zone highlight-foreign" id="s-for-c" onclick="quickCheck('s-for-c','å¤–ç±é¤…ä¹¾')">â˜…å¤–ç±é¤…ä¹¾â˜…<br><small>å¾…æª¢</small></div>
            </div>
            <div class="section-header">ğŸ“… æ¯æ—¥æ•ˆæœŸ</div>
            <div class="grid-box">
                <div class="zone" id="c-f" onclick="quickCheck('c-f','ç”Ÿé®®æ•ˆæœŸ')">ç”Ÿé®®æ•ˆæœŸ</div>
                <div class="zone" id="c-d" onclick="quickCheck('c-d','æ—¥é…æ•ˆæœŸ')">æ—¥é…æ•ˆæœŸ</div>
                <div class="zone" id="c-b" onclick="quickCheck('c-b','éºµåŒ…æ•ˆæœŸ')">éºµåŒ…æ•ˆæœŸ</div>
            </div>
            <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸæ¨¡å‹åœ–</div>
            <div id="mgr-map-tools" class="hidden">
                <button onclick="addMapBox()">+æ–°å¢å€å¡Š</button>
                <button onclick="saveGlobalMap()" style="background:green;">ç™¼å¸ƒåœ°åœ–</button>
            </div>
            <div id="shelf-canvas"></div>
        </div>

        <div id="tab-temp" class="hidden">
            <div class="section-header">ğŸŒ¡ï¸ å†°ç®±æº«åº¦æª¢æŸ¥</div>
            <div id="f-grid" class="grid-box"></div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header">ğŸª™ é›¢æ«ƒé›¶éŒ¢é»ç®—</div>
            <table class="money-table" id="m-table"></table>
            <div style="text-align:right; font-weight:bold; color:blue; padding:10px;">ç¸½ç¾ï¼š$<span id="out-sum">0</span></div>
            <div class="section-header">ğŸ“Š ç‡Ÿæ”¶æ•¸æ“š</div>
            <input type="number" id="v-rev" placeholder="ç‡Ÿæ¥­é¡">
            <input type="number" id="v-vis" placeholder="ä¾†å®¢æ•¸">
            <button onclick="doCalcV21()" style="background:orange; color:black;">è©¦ç®—èª¤å·®</button>
            <h2 id="diff-res" style="text-align:center;">èª¤å·®ï¼š0</h2>
            <button onclick="doSubmitV21()" style="background:green;">æäº¤æ­£å¼å ±è¡¨</button>
        </div>

        <div id="tab-handover" class="hidden">
            <div class="grid-box">
                <button onclick="svc('äº¤æ¥')">ğŸ“ äº¤æ¥</button>
                <button onclick="svc('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="svc('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
            </div>
            <div id="svc-pop" class="hidden" style="background:#f8f9fa; border:2px solid var(--primary); padding:10px;">
                <h4 id="svc-t">--</h4>
                <textarea id="svc-c" placeholder="å…§å®¹..."></textarea>
                <button onclick="submitSvcV21()">ç¢ºèªé€å‡º</button>
            </div>
            <div id="feed" style="margin-top:15px;"></div>
        </div>
    </div>
</div>

<script>
    // --- 1. Firebase ---
    const cfg = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73"
    };
    firebase.initializeApp(cfg);
    const db = firebase.firestore();

    // --- 2. èªè­‰ (ä¿®æ­£è¨»å†Šå½ˆçª—) ---
    function toggleAuth(reg) {
        document.getElementById('login-area').classList.toggle('hidden', reg);
        document.getElementById('register-area').classList.toggle('hidden', !reg);
    }

    async function doRegister() {
        const id = document.getElementById('r-id').value;
        const name = document.getElementById('r-name').value;
        const pw = document.getElementById('r-pw').value;
        const shift = document.getElementById('r-shift').value;
        if(!id || !pw) return alert("è«‹å¡«å¯«å¸³å¯†");
        
        await db.collection("users").doc(id).set({ name, pw, shift, points:0 });
        // ğŸš¨ é€™è£¡å¼·åˆ¶å½ˆçª—ç¢ºèª
        alert("è¨»å†ŠæˆåŠŸï¼è«‹é»æ“Šç¢ºèªå¾Œè¿”å›ç™»å…¥ç•«é¢ã€‚");
        toggleAuth(false);
    }

    async function doLogin() {
        const id = document.getElementById('l-id').value;
        const pw = document.getElementById('l-pw').value;
        const snap = await db.collection("users").doc(id).get();
        if(snap.exists && snap.data().pw === pw) {
            window.user = { ...snap.data(), id };
            startApp();
        } else alert("å¸³å¯†éŒ¯èª¤");
    }

    // --- 3. æ ¸å¿ƒåŠŸèƒ½ ---
    function startApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        if(window.user.shift === 'ä¸»ç®¡') document.getElementById('mgr-map-tools').classList.remove('hidden');

        // ç”Ÿæˆ 10 å†°ç®±
        const fg = document.getElementById('f-grid');
        for(let i=1; i<=10; i++){
            fg.innerHTML += `<div class="zone" id="f${i}" onclick="inputT('f${i}','å†°ç®±${i}')">å†°ç®±${i}<br><small>å¾…æ¸¬</small></div>`;
        }
        // éŒ¢å¹£
        const mt = document.getElementById('m-table');
        [500,100,50,10,5,1].forEach(u => {
            mt.innerHTML += `<tr><td>${u}å…ƒ</td><td><input type="number" id="mr${u}" oninput="calcV21()"></td><td><input type="number" id="ms${u}" oninput="calcV21()"></td></tr>`;
        });
        syncV21();
    }

    function syncV21() {
        db.collection("settings").doc("global_map").onSnapshot(s => { if(s.exists) renderMapV21(s.data()); });
        db.collection("broadcasts").orderBy("time","desc").limit(10).onSnapshot(s => {
            const f = document.getElementById('feed'); f.innerHTML = "";
            s.forEach(d => { f.innerHTML += `<div style="background:#eee; padding:10px; margin-bottom:5px;"><b>${d.data().type}</b>: ${d.data().content}</div>`; });
        });
        const ids = ['s-for-n','s-for-c','c-f','c-d','c-b'];
        ids.forEach(id => {
            db.collection("checks").doc(id).onSnapshot(s => {
                if(s.exists){
                    const el = document.getElementById(id);
                    el.className = `zone ok ${id.includes('for')?'highlight-foreign':''}`;
                    el.querySelector('small').innerText = `âœ… ${s.data().user}`;
                }
            });
        });
    }

    // --- 4. é»æ“Šå‹•ä½œ (å…¨åŸŸæ›è¼‰) ---
    window.inputT = async (id, name) => {
        const v = prompt(`${name} æº«åº¦ï¼š`, '-');
        if(!v) return;
        const n = parseFloat(v);
        let s = "æ­£å¸¸";
        if(n > -10) { alert("ğŸš¨ è­¦å‘Šï¼šæº«åº¦ç•°å¸¸ï¼"); s="ç•°å¸¸"; }
        await db.collection("checks").doc(id).set({ val:v+"åº¦", status:s, user:window.user.name });
    };

    window.quickCheck = async (id, name) => {
        if(confirm(`${name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
            await db.collection("checks").doc(id).set({ user:window.user.name, time:new Date() });
        }
    };

    window.calcV21 = () => {
        let total = 0;
        [500,100,50,10,5,1].forEach(u => {
            total += ((Number(document.getElementById('mr'+u).value)||0) + (Number(document.getElementById('ms'+u).value)||0)) * u;
        });
        document.getElementById('out-sum').innerText = total;
    };

    window.doCalcV21 = () => {
        const rev = Number(document.getElementById('v-rev').value)||0;
        const out = Number(document.getElementById('out-sum').innerText)||0;
        document.getElementById('diff-res').innerText = "èª¤å·®ï¼š" + (rev - out);
    };

    window.doSubmitV21 = async () => {
        await db.collection("reports").add({ user:window.user.name, time:new Date() });
        alert("âœ… æäº¤æˆåŠŸ");
        location.reload();
    };

    let curS = "";
    window.svc = (t) => { curS=t; document.getElementById('svc-pop').classList.remove('hidden'); document.getElementById('svc-t').innerText=t; };
    window.submitSvcV21 = async () => {
        await db.collection("broadcasts").add({ type:curS, content:document.getElementById('svc-c').value, time:new Date() });
        alert("âœ… å·²ç™¼é€");
        document.getElementById('svc-pop').classList.add('hidden');
    };

    // --- 5. æ¨¡å‹åœ– ---
    window.vS = [];
    function renderMapV21(d) {
        window.vS = d.shapes || [];
        const c = document.getElementById('shelf-canvas'); c.innerHTML = "";
        window.vS.forEach(s => {
            const div = document.createElement('div');
            div.className = `shape ${s.done?'done':''}`;
            div.style.left = s.x+"px"; div.style.top = s.y+"px"; div.style.width="60px"; div.style.height="40px";
            div.innerText = s.name;
            if(window.user.shift==='ä¸»ç®¡'){
                div.onmousedown = (e) => {
                    let ox = e.clientX-s.x; let oy = e.clientY-s.y;
                    document.onmousemove = (ev) => { s.x=ev.clientX-ox; s.y=ev.clientY-oy; div.style.left=s.x+"px"; div.style.top=s.y+"px"; };
                    document.onmouseup = () => document.onmousemove = null;
                };
            } else {
                div.onclick = async () => { if(confirm("å®Œæˆï¼Ÿ")){ s.done=true; await db.collection("settings").doc("global_map").set({shapes:window.vS}); }};
            }
            c.appendChild(div);
        });
    }
    window.addMapBox = () => { const n = prompt("åç¨±"); if(n){ window.vS.push({id:Date.now(), name:n, x:30, y:30, done:false}); renderMapV21({shapes:window.vS}); }};
    window.saveGlobalMap = async () => { await db.collection("settings").doc("global_map").set({shapes:window.vS}); alert("å·²ç™¼å¸ƒ"); };

    window.tab = (t) => {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    };
</script>
</body>
</html>