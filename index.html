<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é–€å¸‚ç³»çµ± V20</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #343a40; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; }
        
        /* èªè­‰ä»‹é¢æ¨£å¼ */
        .auth-box { padding: 40px 20px; text-align: center; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* é ç±¤å°èˆª */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .nav-item { flex: 0 0 auto; padding: 15px 20px; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; color: #666; white-space: nowrap; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8f9fa; }

        /* ç‹€æ…‹æ ¼å­ */
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 15px 5px; text-align: center; cursor: pointer; min-height: 80px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .zone.ok { background: #d4edda !important; border-color: #28a745 !important; color: #155724; font-weight: bold; }
        .zone.warning { background: #fff3cd !important; border-color: #dc3545 !important; animation: flash 1s infinite; }
        .highlight-foreign { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #6f42c1; color: #4a148c; font-weight: bold; }

        /* å¸³å‹™ç´°é …æ¨£å¼ */
        .money-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .money-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        .money-table input { width: 90px; height: 45px; font-size: 22px; text-align: center; border: 1px solid #999; border-radius: 4px; }
        
        /* æ¨¡å‹åœ– */
        #shelf-canvas { border: 2px solid #333; position: relative; width: 100%; height: 380px; background: #eee; overflow: hidden; background-size: contain; background-repeat: no-repeat; }
        .shape { position: absolute; border: 2px solid #333; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; text-align: center; font-size: 11px; cursor: pointer; padding: 5px; }
        .shape.done { background: #28a745 !important; color: white !important; font-weight: bold; }

        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-success { background: var(--success); }
        .hidden { display: none !important; }
        @keyframes flash { 0%, 100% {opacity: 1;} 50% {opacity: 0.7;} }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-screen" class="auth-box">
        <div class="card">
            <h2>ğŸª æ™ºæ…§é–€å¸‚ç³»çµ± V20</h2>
            <p id="conn-status" style="color:red; font-size:12px;">æ­£åœ¨é€£æ¥é›²ç«¯è³‡æ–™åº«...</p>
            
            <div id="login-area">
                <input type="text" id="l-id" placeholder="å¸³è™Ÿ">
                <input type="password" id="l-pw" placeholder="å¯†ç¢¼">
                <button id="btn-login" onclick="window.doLogin()" class="hidden">ç™»å…¥æ‰“å¡</button>
                <p id="toggle-reg" onclick="window.toggleAuth(true)" style="color:blue; cursor:pointer; margin-top:15px;" class="hidden">åˆæ¬¡ä½¿ç”¨ï¼Ÿé»æ­¤è¨»å†Šå¸³è™Ÿ</p>
            </div>

            <div id="register-area" class="hidden">
                <input type="text" id="r-name" placeholder="çœŸå¯¦å§“å">
                <select id="r-shift">
                    <option value="æ—©ç­">æ—©ç­</option>
                    <option value="æ™šç­">æ™šç­</option>
                    <option value="ä¸»ç®¡">ä¸»ç®¡</option>
                </select>
                <input type="text" id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
                <input type="password" id="r-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button class="btn-success" onclick="window.doRegister()">å®Œæˆè¨»å†Šä¸¦è¿”å›</button>
                <p onclick="window.toggleAuth(false)" style="color:blue; cursor:pointer; margin-top:15px;">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div style="background:var(--dark); color:white; padding:12px; display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ‘¤ <span id="user-info">--</span></span>
            <button onclick="location.reload()" style="width:auto; padding:5px 10px; font-size:11px;">ç™»å‡ºç³»çµ±</button>
        </div>
        <div class="nav-tabs">
            <div class="nav-item active" onclick="window.switchTab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="window.switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±</div>
            <div class="nav-item" onclick="window.switchTab('counter')">ğŸ’° å¸³å‹™</div>
            <div class="nav-item" onclick="window.switchTab('handover')">ğŸ¤ äº¤æ¥å®¢æœ</div>
            <div id="nav-mgr" class="nav-item hidden" onclick="window.switchTab('manager')">ğŸ“Š ä¸»ç®¡</div>
        </div>
        <div id="tab-stock" class="p-10">
            <div class="section-header" style="background:#f3e5f5; padding:10px;">ğŸ”¥ é‡é»æª¢æŸ¥</div>
            <div class="grid-box">
                <div class="zone highlight-foreign" id="s-for-n" onclick="window.checkSimple('s-for-n','å¤–ç±æ³¡éºµ')">â˜…å¤–ç±æ³¡éºµâ˜…<br><small>å¾…æª¢</small></div>
                <div class="zone highlight-foreign" id="s-for-c" onclick="window.checkSimple('s-for-c','å¤–ç±é¤…ä¹¾')">â˜…å¤–ç±é¤…ä¹¾â˜…<br><small>å¾…æª¢</small></div>
            </div>
            <div id="shelf-canvas"></div>
        </div>
        <div id="tab-temp" class="hidden">
            <div id="f-grid" class="grid-box"></div>
        </div>
        <div id="tab-counter" class="hidden">
            <div id="in-data-area"></div>
            <table class="money-table" id="m-table"></table>
            <div style="text-align:center; padding:20px; background:#333; color:white; margin-top:20px;">
                <h3 id="diff-show">èª¤å·®ï¼š0</h3>
                <button onclick="window.doV20Calc()" style="background:orange; color:black;">ğŸ§® è©¦ç®—èª¤å·®</button>
                <button onclick="window.doV20Submit()" style="background:green; margin-top:10px;">âœ… æäº¤æ­£å¼å ±è¡¨</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. Firebase åˆå§‹åŒ– ---
    const config = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73"
    };

    try {
        firebase.initializeApp(config);
        var db = firebase.firestore();
        document.getElementById('conn-status').innerText = "âœ… é›²ç«¯é€£ç·šæ­£å¸¸";
        document.getElementById('conn-status').style.color = "green";
        document.getElementById('btn-login').classList.remove('hidden');
        document.getElementById('toggle-reg').classList.remove('hidden');
    } catch (e) {
        document.getElementById('conn-status').innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢";
    }

    // --- 2. è¨»å†Šèˆ‡ç™»å…¥é‚è¼¯ ---
    window.toggleAuth = function(isReg) {
        document.getElementById('login-area').classList.toggle('hidden', isReg);
        document.getElementById('register-area').classList.toggle('hidden', !isReg);
        if(isReg) {
            document.getElementById('auth-title').innerText = "ğŸ†• è¨»å†Šæ–°å¸³è™Ÿ";
        } else {
            document.getElementById('auth-title').innerText = "ğŸª æ™ºæ…§é–€å¸‚ç³»çµ± V20";
        }
    };

    window.doRegister = async function() {
        const id = document.getElementById('r-id').value;
        const name = document.getElementById('r-name').value;
        const pw = document.getElementById('r-pw').value;
        const shift = document.getElementById('r-shift').value;
        if(!id || !name || !pw) return alert("è«‹å®Œæ•´å¡«å¯«å§“åã€å¸³è™Ÿèˆ‡å¯†ç¢¼ï¼");

        try {
            await db.collection("users").doc(id).set({
                name: name,
                pw: pw,
                shift: shift,
                points: 0
            });
            alert("ğŸ‰ è¨»å†ŠæˆåŠŸï¼ç³»çµ±å°‡ç‚ºæ‚¨è¿”å›ç™»å…¥ç•«é¢ï¼Œè«‹è¼¸å…¥å¸³å¯†ç™»å…¥ã€‚");
            window.toggleAuth(false);
        } catch (e) {
            alert("è¨»å†Šå¤±æ•—ï¼š" + e.message);
        }
    };

    window.doLogin = async function() {
        const id = document.getElementById('l-id').value;
        const pw = document.getElementById('l-pw').value;
        if(!id || !pw) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");

        try {
            const snap = await db.collection("users").doc(id).get();
            if (snap.exists && snap.data().pw === pw) {
                window.user = { ...snap.data(), id: id };
                alert("æ‰“å¡æˆåŠŸï¼æ­¡è¿ä¸Šç­ï¼Œ" + window.user.name);
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('user-info').innerText = window.user.name + " (" + window.user.shift + ")";
                startAppV20();
            } else {
                alert("âŒ å¸³è™Ÿä¸å­˜åœ¨æˆ–å¯†ç¢¼éŒ¯èª¤");
            }
        } catch (e) {
            alert("ç™»å…¥ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
        }
    };

    // --- 3. æ ¸å¿ƒåŠŸèƒ½ (ç°¡åŒ–è¼‰å…¥) ---
    function startAppV20() {
        // ç”ŸæˆéŒ¢å¹£è¡¨æ ¼
        const mT = document.getElementById('m-table');
        [500,100,50,10,5,1].forEach(u => {
            mT.innerHTML += `<tr><td>${u}å…ƒ</td><td><input type="number" id="m-reg-${u}" oninput="calcSum()"></td><td><input type="number" id="m-res-${u}" oninput="calcSum()"></td></tr>`;
        });
        
        // è¼‰å…¥å†°ç®±
        const fG = document.getElementById('f-grid');
        for(let i=1; i<=10; i++) {
            fG.innerHTML += `<div class="zone" onclick="alert('è«‹éŒ„å…¥æº«åº¦')">å†°ç®± ${i}<br><small>å¾…æ¸¬</small></div>`;
        }
    }

    window.switchTab = function(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
    };

    window.checkSimple = function(id, name) {
        if(confirm("ç¢ºèª " + name + " æª¢æŸ¥å®Œç•¢ï¼Ÿ")) {
            document.getElementById(id).classList.add('ok');
        }
    };
</script>
</body>
</html>