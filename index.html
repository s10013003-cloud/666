<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–€å¸‚ç‡Ÿé‹ä¸­æ¨ V10</title>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background: #f0f2f5; padding-bottom: 90px;}
        .container { padding: 15px; max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; }
        
        /* 1. å°èˆªèˆ‡åˆ†é  */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .nav-item { flex: 0 0 auto; padding: 15px 20px; cursor: pointer; color: #666; font-weight: bold; border-bottom: 4px solid transparent; white-space: nowrap;}
        .nav-item.active { color: #007bff; border-bottom-color: #007bff; background: #f8f9fa; }

        /* 2. å¤–ç±é£Ÿå“ç‰¹æ®Šæ¨™è¨˜ (é‡è¦) */
        .highlight-foreign { 
            background: linear-gradient(135deg, #6f42c1 0%, #4b2c84 100%) !important; 
            color: #ffd700 !important; 
            border: 2px solid #ffd700 !important;
            animation: glow 1.5s infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px #6f42c1; }
            to { box-shadow: 0 0 15px #ffd700; }
        }

        /* 3. æ¯æœˆæ•ˆæœŸæ¨¡å‹åœ– (ç•«å¸ƒæ¨£å¼) */
        #shelf-canvas-container { position: relative; width: 100%; border: 2px dashed #ccc; background: #fff; margin-top: 10px; }
        canvas { width: 100%; height: auto; touch-action: none; cursor: crosshair; }
        .canvas-controls { display: flex; gap: 5px; margin-top: 5px; }

        /* é€šç”¨å…ƒä»¶ */
        .section-header { background: #e9ecef; padding: 10px; margin: 15px -15px; font-weight: bold; border-left: 5px solid #007bff; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px 5px; text-align: center; cursor: pointer; min-height: 70px; }
        .zone.ok { background: #d4edda; border-color: #28a745; }
        .zone.warning { background: #fff3cd; border-color: #dc3545; }
        .hidden { display: none !important; }
        input, select, button { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; }
        button { background: #007bff; color: white; border: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="login-screen">
        <div style="text-align:center; padding:50px 0;">
            <h2>ğŸª é–€å¸‚ç³»çµ± V10</h2>
            <select id="login-role">
                <option value="morning">ğŸŒ æ—©ç­ (1111)</option>
                <option value="evening">ğŸŒ™ æ™šç­ (2222)</option>
                <option value="manager">ğŸ‘¨â€ğŸ’¼ ä¸»ç®¡ (8888)</option>
            </select>
            <input type="password" id="login-pwd" placeholder="å¯†ç¢¼">
            <input type="text" id="login-name" placeholder="è«‹è¼¸å…¥å§“å">
            <button onclick="window.login()">ç™»å…¥ä¸¦é–‹å§‹åŒæ­¥</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="nav-tabs">
            <div class="nav-item active" onclick="window.switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±æº«åº¦</div>
            <div class="nav-item" onclick="window.switchTab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="window.switchTab('monthly')">ğŸ—“ï¸ æ¯æœˆæ¨¡å‹åœ–</div>
            <div class="nav-item" onclick="window.switchTab('counter')">ğŸ’° å¸³å‹™å ±è¡¨</div>
        </div>

        <div id="tab-temp">
            <div class="section-header">â„ï¸ å†·è—å†°ç®± (0~7åº¦)</div>
            <div class="grid-box">
                <div class="zone" id="f-open-1" onclick="window.checkTemp('f-open-1','é–‹æ”¾å¼1','chiller')">é–‹æ”¾å¼ 1<br><small>å¾…æª¢æŸ¥</small></div>
                <div class="zone" id="f-chiller-1" onclick="window.checkTemp('f-chiller-1','å†·è—1','chiller')">å†·è— 1<br><small>å¾…æª¢æŸ¥</small></div>
            </div>
            <div class="section-header">ğŸ§Š å†·å‡å†°ç®± (<-10åº¦)</div>
            <div class="grid-box">
                <div class="zone" id="f-freezer-1" onclick="window.checkTemp('f-freezer-1','å†·å‡1','freezer')">å†·å‡ 1<br><small>å¾…æª¢æŸ¥</small></div>
                <div class="zone" id="f-chest-1" onclick="window.checkTemp('f-chest-1','è‡¥å¼1','freezer')">è‡¥å¼ 1<br><small>å¾…æª¢æŸ¥</small></div>
            </div>
        </div>

        <div id="tab-stock" class="hidden">
            <div class="section-header">ğŸ›’ æ¯æ—¥è£œè²¨èˆ‡æ•ˆæœŸ</div>
            <div class="grid-box">
                <div class="zone" id="stk-drink" onclick="window.checkStock('stk-drink','é£²æ–™è£œè²¨')">é£²æ–™è£œè²¨</div>
                <div class="zone" id="stk-cig" onclick="window.checkStock('stk-cig','è¸æ¶è£œè²¨')">è¸æ¶è£œè²¨</div>
                <div class="zone highlight-foreign" id="stk-for-noodle" onclick="window.checkStock('stk-for-noodle','â˜… å¤–ç±æ³¡éºµ')">â˜… å¤–ç±æ³¡éºµ â˜…</div>
                <div class="zone highlight-foreign" id="stk-for-cookie" onclick="window.checkStock('stk-for-cookie','â˜… å¤–ç±é¤…ä¹¾')">â˜… å¤–ç±é¤…ä¹¾ â˜…</div>
            </div>
        </div>

        <div id="tab-monthly" class="hidden">
            <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸæ¨¡å‹åœ–</div>
            <div id="shelf-canvas-container">
                <canvas id="shelfCanvas"></canvas>
            </div>
            
            <div id="manager-draw-tools" class="hidden">
                <div class="canvas-controls">
                    <button onclick="window.clearCanvas()" style="background:#dc3545;">æ¸…é™¤é‡ç•«</button>
                    <button onclick="window.saveCanvas()" style="background:#28a745;">å„²å­˜æ¨¡å‹åœ–</button>
                </div>
                <p style="font-size:12px; color:red;">* ä¸»ç®¡è«‹åœ¨æ­¤ç•«å‡ºåº—å…§è²¨æ¶åœ–ï¼Œå“¡å·¥é»æ“Šåœ“åœˆè™•å³å¯æ¨™è¨˜å®Œæˆã€‚</p>
            </div>

            <div style="margin-top:10px;">
                <p>å®Œæˆç‹€æ…‹ï¼š<span id="canvas-status">è«‹ä¸»ç®¡å…ˆä¸Šå‚³æ¨¡å‹åœ–</span></p>
                <button onclick="window.markShelfDone()" style="background:#6f42c1;">é»æ“Šæ­¤è™•æ¨™è¨˜é¸ä¸­å€åŸŸå®Œæˆ</button>
            </div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header">ğŸ’° ç‡Ÿæ¥­æ—¥å ±è¡¨</div>
            <p>æ­¤è™•è«‹åƒç…§å‰ç‰ˆå¡«å¯«ç‡Ÿæ¥­é¡ã€æ‰£é …ã€èª¤å·®ç­‰... (ç‚ºäº†ç©©å®šåº¦ï¼Œæœ¬ç‰ˆå…ˆå„ªåŒ–è³‡æ–™åº«é€£ç·š)</p>
            <button onclick="window.submitReport()" style="background:#28a745;">æäº¤ä»Šæ—¥å ±è¡¨åˆ°é›²ç«¯</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73",
        measurementId: "G-M4169BDVH5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; window.doc = doc; window.setDoc = setDoc; window.getDoc = getDoc; window.addDoc = addDoc;

    // --- ç•«å¸ƒé‚è¼¯ (æ¨¡å‹åœ–) ---
    const canvas = document.getElementById('shelfCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    canvas.width = 400; canvas.height = 300;
    ctx.strokeStyle = "#333"; ctx.lineWidth = 2;

    // ç›£è½é›²ç«¯æ¨¡å‹åœ–
    onSnapshot(doc(db, "settings", "shelf_map"), (snap) => {
        if(snap.exists()){
            const img = new Image();
            img.src = snap.data().image;
            img.onload = () => ctx.drawImage(img, 0, 0);
            document.getElementById('canvas-status').innerText = "æ¨¡å‹åœ–å·²è¼‰å…¥ï¼Œè«‹é»æ“Šä½ç½®æª¢æŸ¥ã€‚";
        }
    });

    // ç¹ªåœ–äº‹ä»¶
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', drawing);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('touchstart', (e) => startDraw(e.touches[0]));
    canvas.addEventListener('touchmove', (e) => drawing(e.touches[0]));
    canvas.addEventListener('touchend', stopDraw);

    function startDraw(e) { if(window.role !== 'manager') return; isDrawing = true; drawing(e); }
    function drawing(e) {
        if(!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.pageX) - rect.left;
        const y = (e.clientY || e.pageY) - rect.top;
        ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
    }
    function stopDraw() { isDrawing = false; ctx.beginPath(); }

    window.clearCanvas = () => ctx.clearRect(0,0,canvas.width,canvas.height);
    window.saveCanvas = async () => {
        const dataUrl = canvas.toDataURL();
        await setDoc(doc(db, "settings", "shelf_map"), { image: dataUrl, updatedBy: window.userName });
        alert("æ¨¡å‹åœ–å·²æˆåŠŸä¸Šå‚³é›²ç«¯ï¼");
    };

    // ç›£è½ç‹€æ…‹
    const allIds = ['f-open-1','f-chiller-1','f-freezer-1','f-chest-1','stk-drink','stk-cig','stk-for-noodle','stk-for-cookie'];
    allIds.forEach(id => {
        onSnapshot(doc(db, "checks", id), (snap) => {
            if(snap.exists()) {
                const d = snap.data();
                const el = document.getElementById(id);
                if(el){
                    el.className = `zone ${d.status==='ç•°å¸¸'?'warning':'ok'} ${id.includes('for')?'highlight-foreign':''}`;
                    el.querySelector('small').innerText = `âœ… ${d.val} (${d.checker})`;
                }
            }
        });
    });

</script>

<script>
    // --- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---
    window.role = ""; window.userName = "";

    window.login = function() {
        const r = document.getElementById('login-role').value;
        const p = document.getElementById('login-pwd').value;
        const n = document.getElementById('login-name').value;
        
        const pwds = { "morning":"1111", "evening":"2222", "manager":"8888" };
        if(p !== pwds[r]) return alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        if(!n) return alert("è«‹è¼¸å…¥å§“å");

        window.role = r; window.userName = n;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        
        if(r === 'manager') document.getElementById('manager-draw-tools').classList.remove('hidden');
    };

    window.switchTab = (t) => {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    };

    window.checkTemp = async (id, name, type) => {
        let val = prompt(`${name} æº«åº¦æª¢æŸ¥ï¼š`);
        if(!val) return;
        let num = parseFloat(val);
        let status = "æ­£å¸¸";
        if(type==='freezer' && num > -10) { alert("âš ï¸ é«˜æº«è­¦å‘Šï¼"); status="ç•°å¸¸"; }
        
        // è¨˜éŒ„åˆ°é›²ç«¯
        await window.setDoc(window.doc(window.db, "checks", id), {
            val: val+"åº¦", status, checker: window.userName, time: new Date()
        });
        // ç´€éŒ„ Log
        await window.addDoc(window.collection(window.db, "logs"), {
            item: name, val: val, checker: window.userName, time: new Date()
        });
    };

    window.checkStock = async (id, name) => {
        if(confirm(`${name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
            await window.setDoc(window.doc(window.db, "checks", id), {
                val: "å·²å®Œæˆ", status: "æ­£å¸¸", checker: window.userName, time: new Date()
            });
        }
    };

    window.markShelfDone = async () => {
        const pos = prompt("è«‹è¼¸å…¥æª¢æŸ¥çš„è²¨æ¶å€å¡Šåç¨± (ä¾‹å¦‚: æ³¡éºµå€):");
        if(pos) {
            await window.addDoc(window.collection(window.db, "monthly_checks"), {
                area: pos, checker: window.userName, date: new Date()
            });
            alert(`${pos} æ•ˆæœŸæª¢æŸ¥å·²è¨˜éŒ„ï¼`);
        }
    };
</script>
</body>
</html>