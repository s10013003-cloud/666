<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§é–€å¸‚ç³»çµ± V16</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #343a40; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; }
        
        /* å°èˆªåˆ— */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .nav-item { flex: 0 0 auto; padding: 15px; cursor: pointer; font-weight: bold; color: #666; border-bottom: 3px solid transparent; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8f9fa; }

        /* é€šçŸ¥éˆ´éº */
        #noti-bell { position: fixed; top: 15px; right: 15px; z-index: 2000; cursor: pointer; font-size: 24px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; }

        /* åœ–ç‰‡æ”¾å¤§å‹•ç•« */
        .img-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid #ddd; }
        .img-thumb:hover { transform: scale(1.05); }
        .img-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .img-overlay.show { display: flex; opacity: 1; }
        .img-overlay img { max-width: 90%; max-height: 90%; transform: scale(0.5); transition: transform 0.3s ease; }
        .img-overlay.show img { transform: scale(1); }

        /* æ¨¡å‹åœ– */
        #shelf-canvas { border: 2px solid #333; position: relative; width: 100%; height: 350px; background: #eee; overflow: hidden; background-size: contain; background-repeat: no-repeat; }
        .shape { position: absolute; border: 2px solid #333; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; text-align: center; font-size: 10px; cursor: pointer; }
        .shape.done { background: rgba(40, 167, 69, 0.8); color: white; }

        /* è¬ç”¨æ ¼å­ */
        .section-header { background: #e9ecef; padding: 10px; margin: 15px -15px; font-weight: bold; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 12px 5px; text-align: center; cursor: pointer; min-height: 60px; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .zone.ok { background: #d4edda; border-color: #28a745; }
        .zone.warning { background: #fff3cd; border-color: #dc3545; animation: flash 1s infinite; }
        .highlight-foreign { background: linear-gradient(135deg, #6f42c1 0%, #4b2c84 100%) !important; color: #ffd700 !important; font-weight: bold; border: 2px solid #ffd700 !important; }

        /* å¸³å‹™è¡¨æ ¼ */
        .money-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 12px; }
        .money-table th, .money-table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
        .money-table input { width: 50px; text-align: right; }

        /* é›»è©±å¡ */
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card-box { background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; padding: 8px; }

        input, select, button, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }
        @keyframes flash { 0%, 100% {opacity: 1;} 50% {opacity: 0.6;} }
    </style>
</head>
<body>

<div id="noti-bell" onclick="toggleNotiList()">
    ğŸ””<span id="noti-count" class="badge">0</span>
</div>

<div id="img-overlay" class="img-overlay" onclick="closeImgZoom()">
    <img id="img-zoom" src="">
</div>

<div class="container">
    <div id="auth-screen" style="padding:40px 20px; text-align:center;">
        <div style="background:white; padding:30px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1);">
            <h2 id="auth-title">ğŸª æ™ºæ…§é–€å¸‚ V16</h2>
            <div id="login-area">
                <input type="text" id="login-id" placeholder="å¸³è™Ÿ">
                <input type="password" id="login-pw" placeholder="å¯†ç¢¼">
                <button onclick="handleLogin()">ç™»å…¥æ‰“å¡</button>
                <p style="font-size:12px; color:blue; cursor:pointer;" onclick="toggleAuth(true)">è¨»å†Šå¸³è™Ÿ</p>
            </div>
            <div id="register-area" class="hidden">
                <input type="text" id="reg-name" placeholder="å§“å">
                <select id="reg-shift"><option value="æ—©ç­">æ—©ç­</option><option value="æ™šç­">æ™šç­</option><option value="ä¸»ç®¡">ä¸»ç®¡</option></select>
                <input type="text" id="reg-id" placeholder="è¨­å®šå¸³è™Ÿ">
                <input type="password" id="reg-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button onclick="handleRegister()" style="background:var(--success);">å®Œæˆè¨»å†Š</button>
                <p style="font-size:12px; cursor:pointer;" onclick="toggleAuth(false)">è¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div style="background:var(--dark); color:white; padding:10px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span>ğŸ‘¤ <span id="user-info">--</span></span>
            <button onclick="location.reload()" style="width:auto; padding:5px 10px; font-size:11px;">ç™»å‡º</button>
        </div>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±</div>
            <div class="nav-item" onclick="switchTab('counter')">ğŸ’° å¸³å‹™</div>
            <div class="nav-item" onclick="switchTab('handover')">ğŸ¤ äº¤æ¥/å®¢æœ</div>
            <div class="nav-item hidden" id="nav-mgr" onclick="switchTab('manager')">ğŸ“Š ä¸»ç®¡</div>
        </div>

        <div id="tab-stock">
            <div class="section-header">ğŸ”¥ å¤–ç±é£Ÿå“é‡é»æª¢æŸ¥</div>
            <div class="grid-box">
                <div class="zone highlight-foreign" id="s-for-n" onclick="checkBtn('s-for-n','â˜…å¤–ç±æ³¡éºµ')">â˜…å¤–ç±æ³¡éºµâ˜…<br><small>--</small></div>
                <div class="zone highlight-foreign" id="s-for-c" onclick="checkBtn('s-for-c','â˜…å¤–ç±é¤…ä¹¾')">â˜…å¤–ç±é¤…ä¹¾â˜…<br><small>--</small></div>
            </div>
            <div class="section-header">ğŸ“… æ¯æ—¥æ•ˆæœŸ</div>
            <div class="grid-box">
                <div class="zone" id="c-f" onclick="checkBtn('c-f','ç”Ÿé®®æ•ˆæœŸ')">ç”Ÿé®®æ•ˆæœŸ</div>
                <div class="zone" id="c-d" onclick="checkBtn('c-d','æ—¥é…æ•ˆæœŸ')">æ—¥é…æ•ˆæœŸ</div>
                <div class="zone" id="c-b" onclick="checkBtn('c-b','éºµåŒ…æ•ˆæœŸ')">éºµåŒ…æ•ˆæœŸ</div>
            </div>
            <div class="section-header">ğŸ›’ è£œè²¨æª¢æŸ¥</div>
            <div class="grid-box">
                <div class="zone" id="s-c" onclick="checkBtn('s-c','è¸æ¶')">è¸æ¶</div>
                <div class="zone" id="s-d" onclick="checkBtn('s-d','å†°ç®±é£²æ–™')">å†°ç®±é£²æ–™</div>
                <div class="zone" id="s-sd" onclick="checkBtn('s-sd','å±¤æ¶é£²æ–™')">å±¤æ¶é£²æ–™</div>
                <div class="zone" id="s-fr" onclick="checkBtn('s-fr','å†·å‡é£Ÿå“')">å†·å‡é£Ÿå“</div>
                <div class="zone" id="s-tr" onclick="checkBtn('s-tr','åƒåœ¾è¢‹/å…æ´—')">åƒåœ¾è¢‹/å…æ´—</div>
                <div class="zone" id="s-ts" onclick="checkBtn('s-ts','è¡›ç”Ÿç´™')">è¡›ç”Ÿç´™</div>
            </div>
            <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸæ¨¡å‹åœ–</div>
            <div id="mgr-map-ctrl" class="hidden">
                <input type="file" onchange="uploadMap(event)">
                <div style="display:flex; gap:5px;">
                    <button onclick="addBox()">+æ–¹å¡Š</button>
                    <button onclick="copyBox()">è¤‡è£½</button>
                    <button onclick="delBox()" style="background:red;">åˆªé™¤</button>
                    <button onclick="saveGlobalMap()" style="background:green;">ç™¼å¸ƒåœ–æ¡ˆ</button>
                </div>
            </div>
            <div id="shelf-canvas"></div>
        </div>

        <div id="tab-temp" class="hidden">
            <div class="section-header">â„ï¸ å†°ç®±æº«åº¦æª¢æŸ¥</div>
            <div id="fridge-grid" class="grid-box"></div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header">ğŸ“¥ é€²æ«ƒè³‡è¨Š <button id="mgr-in-btn" class="hidden" onclick="editIn()" style="width:auto; padding:2px 8px; font-size:10px;">ä¸»ç®¡ç·¨è¼¯</button></div>
            <div style="background:#e3f2fd; padding:10px; border-radius:8px;">
                æ”¶éŠ€ç¾é‡‘ï¼š<input type="number" id="in-cash" disabled>
                åº«å­˜é›¶éŒ¢ï¼š<input type="number" id="in-stock" disabled>
                <button id="in-save-btn" class="hidden" onclick="saveIn()" style="background:green;">å„²å­˜é€²æ«ƒ</button>
            </div>
            
            <div class="section-header">ğŸª™ é›¢æ«ƒé›¶éŒ¢é»ç®—</div>
            <table class="money-table">
                <thead><tr><th>é¢é¡</th><th>æ”¶éŠ€(ç•™)</th><th>åº«å­˜(é‡‘åº«)</th><th>å°è¨ˆ</th></tr></thead>
                <tbody id="money-body"></tbody>
            </table>
            <div style="text-align:right; font-weight:bold; color:blue;">ç¸½ç¾ï¼š$<span id="sum-all">0</span></div>

            <div class="section-header">ğŸ“ é›»è©±å¡ç›¤é»</div>
            <div id="card-list" class="card-grid"></div>

            <div class="section-header">ğŸ“Š ç‡Ÿæ”¶æ•¸æ“š</div>
            <div class="grid-box">
                <input type="number" id="v-sales" placeholder="ç‡Ÿæ¥­é¡" oninput="doAvg()">
                <input type="number" id="v-visit" placeholder="ä¾†å®¢æ•¸" oninput="doAvg()">
                <input type="number" id="v-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
            </div>
            <div class="grid-box" style="margin-top:5px;">
                <input type="number" id="v-cr" placeholder="ä¿¡ç”¨å¡"><input type="number" id="v-tw" placeholder="å°ç£Pay">
                <input type="number" id="v-ln" placeholder="LinePay"><input type="number" id="v-pt" placeholder="é»æ•¸">
                <input type="number" id="v-rf" placeholder="é€€æ¬¾"><input type="number" id="v-1k" placeholder="åƒéˆ”(å¼µ)">
            </div>
            
            <div class="section-header">â• é¡å¤–æ”¶æ”¯</div>
            <div style="display:flex; gap:5px;">
                <button onclick="addExtra('in')" style="background:green;">+ æ”¶å…¥</button>
                <button onclick="addExtra('out')" style="background:red;">+ æ”¯å‡º</button>
            </div>
            <div id="extra-list"></div>

            <div style="margin-top:20px; background:#333; color:white; padding:15px; border-radius:10px; text-align:center;">
                <h3>èª¤å·®ï¼š<span id="diff-show">0</span></h3>
                <button onclick="doCalc()" style="background:orange; color:black;">ğŸ§® åŸ·è¡Œè©¦ç®—</button>
                <button onclick="doSubmit()" style="background:green; margin-top:10px;">âœ… æäº¤å ±è¡¨</button>
            </div>
        </div>

        <div id="tab-handover" class="hidden">
            <div class="section-header">ğŸ’ æœå‹™é€šå ±æŒ‰éˆ•</div>
            <div class="grid-box">
                <button onclick="openForm('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="openForm('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
                <button onclick="openForm('å”®ç½„')">âš¡ å”®ç½„</button>
                <button onclick="openForm('å ±å»¢')">ğŸ—‘ï¸ å ±å»¢</button>
                <button onclick="openForm('äº¤æ¥')" style="background:orange;">ğŸ“ äº¤æ¥</button>
            </div>
            <div id="svc-form" class="hidden" style="background:#f8f9fa; border:2px solid #007bff; padding:15px; margin-top:10px; border-radius:10px;">
                <h3 id="svc-title">--</h3>
                <div id="svc-fields"></div>
                <input type="file" id="svc-img" accept="image/*" capture="camera">
                <button onclick="saveSvc()">é€å‡ºé€šå ±</button>
            </div>
            <div id="global-feed" style="margin-top:15px;"></div>
        </div>

        <div id="tab-manager" class="hidden">
            <div class="section-header">ğŸŒŸ å“¡å·¥è©•æ¯”</div>
            <select id="mgr-target"><option value="">é¸æ“‡å“¡å·¥</option></select>
            <div style="padding:10px; background:#f9f9f9;">
                <div class="money-row">æ•ˆç‡: <span class="stars" data-key="eff"></span></div>
                <div class="money-row">è£œè²¨: <span class="stars" data-key="stk"></span></div>
                <div class="money-row">ç’°å¢ƒ: <span class="stars" data-key="env"></span></div>
                <div class="money-row">å®¢å›: <span class="stars" data-key="fed"></span></div>
                <button onclick="saveRating()" style="background:green; margin-top:10px;">å„²å­˜è©•åˆ†</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, query, orderBy, limit, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73",
        measurementId: "G-M4169BDVH5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    // --- èªè­‰ ---
    window.handleRegister = async () => {
        const id = document.getElementById('reg-id').value;
        const name = document.getElementById('reg-name').value;
        const pw = document.getElementById('reg-pw').value;
        const shift = document.getElementById('reg-shift').value;
        if(!id || !name || !pw) return alert("è³‡æ–™ä¸å…¨");
        await setDoc(doc(db, "users", id), { name, pw, shift, points: 0 });
        alert("è¨»å†ŠæˆåŠŸï¼è«‹ç”¨å¸³è™Ÿç™»å…¥ã€‚");
        window.toggleAuth(false);
    };

    window.handleLogin = async () => {
        const id = document.getElementById('login-id').value;
        const pw = document.getElementById('login-pw').value;
        const snap = await getDoc(doc(db, "users", id));
        if(snap.exists() && snap.data().pw === pw) {
            window.user = { ...snap.data(), id };
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            initApp();
        } else alert("ç™»å…¥å¤±æ•—");
    };

    // --- æ ¸å¿ƒåŒæ­¥ ---
    function initApp() {
        document.getElementById('user-info').innerText = `${window.user.name} (${window.user.shift})`;
        if(window.user.shift === 'ä¸»ç®¡') {
            document.getElementById('nav-mgr').classList.remove('hidden');
            document.getElementById('mgr-map-ctrl').classList.remove('hidden');
            document.getElementById('mgr-in-btn').classList.remove('hidden');
        }

        // ç”Ÿæˆ 10 å†°ç®±
        const fgrid = document.getElementById('fridge-grid');
        const fs = [{id:'f1',n:'é–‹æ”¾1',t:'c'},{id:'f2',n:'é–‹æ”¾2',t:'c'},{id:'f3',n:'å†·è—1',t:'c'},{id:'f4',n:'å†·è—2',t:'c'},
                    {id:'f5',n:'å†·å‡1',t:'f'},{id:'f6',n:'å†·å‡2',t:'f'},{id:'f7',n:'è‡¥å¼1',t:'f'},{id:'f8',n:'è‡¥å¼2',t:'f'},
                    {id:'f9',n:'è‡¥å¼3',t:'f'},{id:'f10',n:'è‡¥å¼4',t:'f'}];
        fgrid.innerHTML = fs.map(f => `<div class="zone" id="${f.id}" onclick="inputT('${f.id}','${f.n}','${f.t}')">${f.n}<br><small>å¾…æ¸¬</small></div>`).join('');

        // ç”Ÿæˆè²¨å¹£
        const mBody = document.getElementById('money-body');
        [500,100,50,10,5,1].forEach(u => {
            mBody.innerHTML += `<tr><td>${u}å…ƒ</td><td><input type="number" id="r-${u}" oninput="calcSum()"></td><td><input type="number" id="s-${u}" oninput="calcSum()"></td><td id="sub-${u}">$0</td></tr>`;
        });

        // ç”Ÿæˆé›»è©±å¡
        const cards = ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
        document.getElementById('card-list').innerHTML = cards.map(c => `<div class="card-box"><label>${c}</label><input type="number" id="ci-${c}" placeholder="é€²"><input type="number" id="cs-${c}" placeholder="éŠ·" style="color:red;"><input type="number" id="cl-${c}" placeholder="å­˜" style="color:blue;"></div>`).join('');

        // ç”Ÿæˆæ˜Ÿæ˜Ÿ
        document.querySelectorAll('.stars').forEach(s => {
            for(let i=1;i<=5;i++) s.innerHTML += `<span style="font-size:20px;cursor:pointer;color:#ddd;" onclick="rateStar(this,${i})">â˜…</span>`;
        });

        // å•Ÿå‹•ç›£è½
        startSync();
    }

    function startSync() {
        // æ¨¡å‹åœ–
        onSnapshot(doc(db, "settings", "global_map"), (snap) => { if(snap.exists()) renderMap(snap.data()); });
        // é€²æ«ƒè³‡è¨Š
        onSnapshot(doc(db, "store_status", "current"), (snap) => {
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('in-cash').value = d.cash;
                document.getElementById('in-stock').value = d.stock;
                if(d.cards) for(let k in d.cards) document.getElementById(`ci-${k}`).value = d.cards[k];
            }
        });
        // äº¤æ¥è¨Šæ¯
        onSnapshot(query(collection(db, "broadcasts"), orderBy("time", "desc"), limit(20)), (snap) => {
            const feed = document.getElementById('global-feed');
            const notiCount = document.getElementById('noti-count');
            feed.innerHTML = ""; let unread = 0;
            snap.forEach(d => {
                const b = d.data();
                if(!b.done) unread++;
                feed.innerHTML += `
                    <div style="background:white; padding:10px; margin-bottom:10px; border-radius:8px; border-left:5px solid ${b.done?'green':'orange'};">
                        <b>[${b.type}] ${b.user}</b> <button onclick="markB('${d.id}', ${!b.done})" style="width:auto; padding:2px 8px; font-size:10px;">${b.done?'å–æ¶ˆ':'å‹¾é¸å®Œæˆ'}</button>
                        <div style="margin:5px 0;">${b.content}</div>
                        ${b.img ? `<img src="${b.img}" class="img-thumb" onclick="zoomImg('${b.img}')">` : ''}
                    </div>`;
            });
            notiCount.innerText = unread;
        });
        // ç•°å¸¸ç›£è½ (ä¸»ç®¡æé†’)
        onSnapshot(collection(db, "logs"), (snap) => {
            snap.docChanges().forEach(c => {
                if(c.type === "added" && c.doc.data().status === "ç•°å¸¸") {
                    alert(`ğŸš¨ ç•°å¸¸è­¦å ±ï¼š${c.doc.data().item} æº«åº¦ç‚º ${c.doc.data().val}ï¼`);
                }
            });
        });
    }

    // --- æ“ä½œå‡½æ•¸ ---
    window.inputT = async (id, name, type) => {
        const val = prompt(`${name} æº«åº¦ï¼š`, type==='f'?'-':'');
        if(!val) return;
        const num = parseFloat(val);
        let status = "æ­£å¸¸";
        if(type==='f' && num > -10) status = "ç•°å¸¸";
        if(type==='c' && (num < 0 || num > 7)) status = "ç•°å¸¸";
        await setDoc(doc(db, "checks", id), { val: num+"åº¦", status, user: window.user.name, time: serverTimestamp() });
        await addDoc(collection(db, "logs"), { item: name, val: num, status, user: window.user.name, timestamp: serverTimestamp() });
    };

    window.saveGlobalMap = async () => {
        await setDoc(doc(db, "settings", "global_map"), { shapes: window.vShapes, bg: window.mapBg });
        alert("æ¨¡å‹åœ–ç™¼å¸ƒæˆåŠŸ");
    };

    window.markB = async (id, status) => { await updateDoc(doc(db, "broadcasts", id), { done: status }); };
</script>

<script>
    // --- ä¸€èˆ¬ä»‹é¢é‚è¼¯ (éåŒæ­¥) ---
    window.vShapes = []; let selId = null;

    function toggleAuth(reg) {
        document.getElementById('login-area').classList.toggle('hidden', reg);
        document.getElementById('register-area').classList.toggle('hidden', !reg);
    }
    function switchTab(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }
    function zoomImg(src) {
        document.getElementById('img-zoom').src = src;
        document.getElementById('img-overlay').classList.add('show');
    }
    function closeImgZoom() { document.getElementById('img-overlay').classList.remove('show'); }

    // å¸³å‹™
    function calcSum() {
        let total = 0;
        [500,100,50,10,5,1].forEach(u => {
            const v = (parseFloat(document.getElementById(`r-${u}`).value)||0) + (parseFloat(document.getElementById(`s-${u}`).value)||0);
            document.getElementById(`sub-${u}`).innerText = "$" + (v * u);
            total += (v * u);
        });
        document.getElementById('sum-all').innerText = total;
    }
    function doAvg() {
        const t = parseFloat(document.getElementById('v-sales').value)||0;
        const v = parseFloat(document.getElementById('v-visit').value)||0;
        if(v > 0) document.getElementById('v-avg').value = Math.round(t/v);
    }
    
    let extras = [];
    function addExtra(type) {
        const amt = prompt("é‡‘é¡ï¼š"); const note = prompt("å‚™è¨»ï¼š");
        if(amt) {
            extras.push({type, amt: parseFloat(amt), note});
            document.getElementById('extra-list').innerHTML += `<div style="color:${type==='in'?'green':'red'}">${note}: $${amt}</div>`;
        }
    }

    function doCalc() {
        const inCash = parseFloat(document.getElementById('in-cash').value)||0;
        const inStock = parseFloat(document.getElementById('in-stock').value)||0;
        const outTotal = parseFloat(document.getElementById('sum-all').innerText);
        const turnover = parseFloat(document.getElementById('v-sales').value)||0;
        const deduct = (parseFloat(document.getElementById('v-cr').value)||0) + (parseFloat(document.getElementById('v-tw').value)||0) + (parseFloat(document.getElementById('v-ln').value)||0) + (parseFloat(document.getElementById('v-pt').value)||0) + (parseFloat(document.getElementById('v-rf').value)||0);
        const thousands = (parseFloat(document.getElementById('v-1k').value)||0) * 1000;
        const extraSum = extras.reduce((a, b) => a + (b.type==='in' ? b.amt : -b.amt), 0);
        
        const diff = ((inCash + inStock - outTotal + (turnover - deduct) - thousands + extraSum) * -1);
        document.getElementById('diff-show').innerText = diff;
        document.getElementById('diff-show').style.color = diff===0?'green':'red';
    }

    // æ¨¡å‹åœ–
    function renderMap(data) {
        window.vShapes = data.shapes || [];
        const canvas = document.getElementById('shelf-canvas');
        canvas.innerHTML = "";
        if(data.bg) canvas.style.backgroundImage = `url(${data.bg})`;
        window.vShapes.forEach(s => {
            const div = document.createElement('div');
            div.className = `shape ${s.done?'done':''} ${selId===s.id?'selected':''}`;
            div.style.left = s.x+"px"; div.style.top = s.y+"px"; div.style.width = s.w+"px"; div.style.height = s.h+"px";
            div.innerText = s.name;
            if(window.user.shift==='ä¸»ç®¡'){
                div.onmousedown = (e) => {
                    selId = s.id;
                    let ox = e.clientX-s.x; let oy = e.clientY-s.y;
                    document.onmousemove = (ev) => {
                        s.x = ev.clientX-ox; s.y = ev.clientY-oy;
                        div.style.left=s.x+"px"; div.style.top=s.y+"px";
                    };
                    document.onmouseup = () => document.onmousemove = null;
                };
            } else {
                div.onclick = async () => {
                    if(confirm("å®Œæˆæª¢æŸ¥?")) {
                        s.done = true;
                        await window.db.collection("settings").doc("global_map").set({shapes: window.vShapes, bg: window.mapBg});
                    }
                };
            }
            canvas.appendChild(div);
        });
    }

    // å…¶ä»–å°æŒ‰éˆ•åŠŸèƒ½ä¾æ­¤é¡æ¨...
    function checkBtn(id, name) {
        if(confirm(`${name} æª¢æŸ¥å®Œæˆ?`)) {
            document.getElementById(id).classList.add('ok');
        }
    }
</script>
</body>
</html>