<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é–€å¸‚ V46 (RC Edition)</title>
    <style>
        /* --- PX Mart Style System --- */
        :root { --primary: #005eb8; --accent: #e3001b; --success: #28a745; --bg: #f4f7f6; --white: #fff; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); padding-bottom: 120px; color: #333; user-select: none; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.08); }

        /* Nav */
        .nav { display: flex; position: sticky; top: 0; background: #fff; border-bottom: 2px solid #eee; z-index: 100; overflow-x: auto; }
        .nav div { flex: 0 0 auto; padding: 14px 18px; font-weight: bold; color: #666; cursor: pointer; white-space: nowrap; font-size: 15px; }
        .nav div.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #f0f8ff; }

        /* Headers */
        .head { background: #fff; padding: 12px 15px; margin: 10px 0; font-weight: 800; border-left: 5px solid var(--accent); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        
        /* Grid & Box */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 12px; }
        .box { border: 1px solid #ccc; padding: 15px; text-align: center; border-radius: 6px; cursor: pointer; background: #fff; min-height: 70px; display:flex; flex-direction:column; justify-content:center; align-items:center; position: relative; transition:0.2s; }
        .box:active { transform: scale(0.97); }
        .box.done { background: #e8f5e9 !important; border-color: var(--success) !important; color: #1b5e20; }
        .box.alert { background: #ffebee !important; border-color: var(--accent) !important; color: #c62828; font-weight: bold; animation: pulse 2s infinite; }
        .box.priority { border: 2px solid var(--accent); }

        /* Map */
        #map-area { position: relative; width: 94%; height: 400px; background: #eceff1; margin: 10px auto; overflow: hidden; border: 2px solid #b0bec5; border-radius: 4px; }
        .map-box { position: absolute; background: rgba(255,255,255,0.95); border: 2px solid #546e7a; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: 0.1s; }
        .map-box.done { border-color: var(--success); background: #e8f5e9; color: var(--success); }
        .map-box.selected { border: 3px solid var(--accent); z-index: 50; transform: scale(1.05); }
        .timer-badge { font-size: 10px; background: #333; color: white; padding: 2px 5px; border-radius: 4px; margin-top: 2px; }

        /* Controls */
        .reset-btn { position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; background: #fff; border: 1px solid #ccc; border-radius: 50%; color: #666; font-size: 14px; line-height: 22px; z-index: 10; display:flex; justify-content:center; align-items:center; }
        .del-item-btn { position: absolute; top: -8px; left: -8px; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; font-size: 12px; display: none; align-items: center; justify-content: center; border: 2px solid white; z-index: 10; }
        .editing .del-item-btn { display: flex; }
        .editing .box { border: 2px dashed var(--primary); opacity: 0.9; }

        /* Fridge Time Slots */
        .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .time-btn { padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fff; text-align: center; cursor: pointer; font-size: 12px; }
        .time-btn.checked { background: var(--success); color: white; border-color: var(--success); }
        .time-btn.missed { background: #cfd8dc; color: #fff; border-color: #b0bec5; cursor: not-allowed; font-weight: bold; }
        .time-btn.future { opacity: 0.5; cursor: not-allowed; background: #f0f0f0; }
        .time-btn.alert { background: var(--accent); color: white; }

        /* Feed */
        .feed-item { padding: 12px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 6px; background: #fff; border-left: 5px solid #ccc; }
        .feed-item.done { border-left-color: var(--success); background: #f1f8e9; }
        .feed-item.pending { border-left-color: var(--accent); background: #fff3e0; }

        /* UI */
        input, select, textarea { width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
        .btn-s { width: auto; padding: 5px 12px; font-size: 12px; margin-right: 5px; background: #555; }
        .btn-r { background: var(--accent); } .btn-o { background: #f39c12; }
        .hide { display: none !important; }
        
        /* Modal */
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:none; justify-content:center; align-items:center; }
        .modal-content { background:white; width:90%; max-height:90%; overflow-y:auto; padding:20px; border-radius:8px; }
        #img-zoom { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:3000; display:none; justify-content:center; align-items:center; }
        #img-zoom img { max-width:95%; max-height:95%; border: 3px solid white; border-radius: 4px; }

        /* Stars */
        .stars span { font-size: 32px; color: #e0e0e0; cursor: pointer; margin-right: 2px; }
        .stars span.gold { color: #fbc02d; }

        @keyframes pulse { 0%{box-shadow: 0 0 0 0 rgba(227, 0, 27, 0.4);} 70%{box-shadow: 0 0 0 10px rgba(227, 0, 27, 0);} 100%{box-shadow: 0 0 0 0 rgba(227, 0, 27, 0);} }
    </style>
</head>
<body>

<div id="img-zoom" onclick="this.style.display='none'"><img id="big-img"></div>
<div id="modal-overlay"><div class="modal-content" id="modal-body"></div></div>

<div class="container">
    <div id="page-auth" style="padding:40px 20px; text-align:center;">
        <h2 style="color:var(--primary); letter-spacing: 2px;">SMART STORE V46</h2>
        <div id="box-login" style="margin-top:30px;">
            <input id="l-id" placeholder="å“¡å·¥ç·¨è™Ÿ">
            <input id="l-pw" type="password" placeholder="å¯†ç¢¼">
            <button onclick="login()">ç™»å…¥ç³»çµ±</button>
            <p onclick="swAuth(true)" style="color:var(--primary); margin-top:20px; cursor:pointer;">è¨»å†Šå¸³è™Ÿ</p>
        </div>
        <div id="box-reg" class="hide" style="margin-top:30px;">
            <input id="r-name" placeholder="çœŸå¯¦å§“å">
            <select id="r-shift"><option>æ—©ç­</option><option>æ™šç­</option><option>ä¸»ç®¡</option></select>
            <input id="r-id" placeholder="è¨­å®šç·¨è™Ÿ">
            <input id="r-pw" type="password" placeholder="è¨­å®šå¯†ç¢¼">
            <button class="btn-g" onclick="reg()">ç¢ºèªè¨»å†Š</button>
            <p onclick="swAuth(false)" style="color:var(--primary); margin-top:20px; cursor:pointer;">è¿”å›ç™»å…¥</p>
        </div>
    </div>

    <div id="page-main" class="hide">
        <div style="background:#333; color:white; padding:10px; display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸª <span id="user-info">--</span></span>
            <button onclick="logout()" class="btn-s">ç™»å‡º</button>
        </div>

        <div class="nav">
            <div onclick="tab('stock')" id="n-stock" class="active">è£œè²¨</div>
            <div onclick="tab('expiry')" id="n-expiry">æ•ˆæœŸ</div>
            <div onclick="tab('temp')" id="n-temp">å†°ç®±</div>
            <div onclick="tab('count')" id="n-count">å¸³å‹™</div>
            <div onclick="tab('svc')" id="n-svc">å®¢æœ</div>
            <div onclick="tab('mgr')" id="n-mgr" class="hide">ä¸»ç®¡</div>
        </div>

        <div id="v-stock">
            <div class="head" style="border-color:var(--accent);">ğŸ”¥ é‡é»è£œè²¨</div>
            <div class="grid">
                <div class="box priority alert" id="s_noodle" onclick="doCheck('s_noodle','å¤–ç±æ³¡éºµ')">å¤–ç±æ³¡éºµ<br><small>å¾…è™•ç†</small></div>
                <div class="box priority alert" id="s_cookie" onclick="doCheck('s_cookie','å¤–ç±é¤…ä¹¾')">å¤–ç±é¤…ä¹¾<br><small>å¾…è™•ç†</small></div>
            </div>

            <div class="head">
                ğŸ›’ æ¯æ—¥è£œè²¨ 
                <button id="btn-add-stock" class="hide btn-s" onclick="addItem('stock')">+æ–°å¢</button>
                <button id="btn-edit-stock" class="hide btn-s btn-o" onclick="toggleEdit('stock-list')">ç®¡ç†</button>
            </div>
            <div class="grid" id="stock-list"></div>
        </div>

        <div id="v-expiry" class="hide">
            <div class="head">ğŸ“… æ¯æ—¥æ•ˆæœŸæª¢æŸ¥</div>
            <div class="grid">
                <div class="box alert" id="ex_bread" onclick="doCheck('ex_bread','éºµåŒ…')">éºµåŒ…<br><small>å¾…æª¢</small></div>
                <div class="box alert" id="ex_drink" onclick="doCheck('ex_drink','æ—¥é…é£²æ–™')">æ—¥é…é£²æ–™<br><small>å¾…æª¢</small></div>
                <div class="box alert" id="ex_veg" onclick="doCheck('ex_veg','ç”Ÿé®®è”¬èœ')">ç”Ÿé®®è”¬èœ<br><small>å¾…æª¢</small></div>
            </div>

            <div class="head">
                ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸåœ–
                <div id="map-tools" class="hide">
                    <button class="btn-s btn-g" onclick="addMapBox()">+æ–¹æ ¼</button>
                    <button class="btn-s btn-o" onclick="toggleMapEdit()">âœï¸ <span id="map-mode-txt">ç·¨è¼¯é—œ</span></button>
                </div>
            </div>
            <div id="map-editor" class="hide" style="padding:10px; background:#fff3e0; font-size:12px; color:var(--accent);">
                <b>ğŸ‘‰ è«‹é»æ“Šæ–¹æ ¼é€²è¡Œç·¨è¼¯ (ä¿®æ”¹å¤§å°/æ—¥æœŸ/åç¨±/åˆªé™¤)</b>
            </div>
            <div id="map-area"></div>
        </div>

        <div id="v-temp" class="hide">
            <div class="head">
                â„ï¸ å†°ç®±æº«åº¦ (æ™‚æ®µæª¢æ ¸)
                <div>
                    <button id="btn-add-fridge" class="hide btn-s" onclick="addItem('fridge')">+æ–°å¢</button>
                    <button id="btn-edit-fridge" class="hide btn-s btn-o" onclick="toggleEdit('fridge-list')">ç®¡ç†</button>
                </div>
            </div>
            <div class="grid" id="fridge-list"></div>
        </div>

        <div id="v-count" class="hide">
            <div class="head">ğŸ“¥ é€²æ«ƒ (ä¸»ç®¡å¯ä¿®)</div>
            <div style="padding:10px; background:#fff; margin:10px; border:1px solid #ccc;">
                æ”¶éŠ€ç•™åº•ï¼š<input type="number" id="in-cash" disabled style="width:100px; display:inline-block">
                é‡‘åº«ç•™åº•ï¼š<input type="number" id="in-vault" disabled style="width:100px; display:inline-block">
                <button id="btn-unlock-in" class="hide btn-s btn-o" style="margin-top:5px;" onclick="unlockIn()">ä¿®æ­£</button>
                <button id="btn-save-in" class="hide btn-s btn-g" style="margin-top:5px;" onclick="saveIn()">å„²å­˜</button>
            </div>

            <div class="head">ğŸª™ äº¤ç­é»ç®—</div>
            <table>
                <tr><th>å¹£å€¼</th><th>æ”¶éŠ€</th><th>é‡‘åº«</th><th>å°è¨ˆ</th></tr>
                <tbody id="money-table"></tbody>
                <tr><td colspan="3"><b>ç¸½è¨ˆ</b></td><td id="total-money" style="color:var(--primary); font-weight:bold;">0</td></tr>
            </table>

            <div class="head">ğŸ“ é›»è©±å¡</div>
            <div id="card-list" class="grid"></div>

            <div class="head">ğŸ“Š ç‡Ÿæ”¶çµç®—</div>
            <div class="grid">
                <input type="number" id="v-rev" placeholder="ç‡Ÿæ¥­é¡" oninput="doCalc()">
                <input type="number" id="v-vis" placeholder="ä¾†å®¢æ•¸" oninput="doCalc()">
                <input type="text" id="v-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
            </div>
            
            <div class="head">â• é¡å¤–æ”¶æ”¯</div>
            <div class="grid">
                <button class="btn-g" onclick="addEx('in')">+ æ”¶å…¥</button>
                <button class="btn-r" onclick="addEx('out')">+ æ”¯å‡º</button>
            </div>
            <div id="ex-list" style="padding:10px;"></div>

            <div class="head">èª¤å·®ï¼š<span id="diff-show" style="font-weight:bold;">0</span></div>
            <button class="btn-g" onclick="submitShift()">âœ… æäº¤äº¤ç­å ±è¡¨</button>
        </div>

        <div id="v-svc" class="hide">
            <div class="head">ğŸ¤ å®¢æœèˆ‡å…§å‹™</div>
            <div class="grid">
                <button onclick="popSvc('äº¤æ¥')">ğŸ“ äº¤æ¥äº‹é …</button>
                <button onclick="popSvc('å®¢è¨‚')">ğŸ›’ å®¢è¨‚ç™»è¨˜</button>
                <button onclick="popSvc('ç¶­ä¿®')">ğŸ”§ å ±ä¿®ç™»è¨˜</button>
                <button onclick="popSvc('è©¢å•')">â“ é¡§å®¢è©¢å•</button>
            </div>
            <div id="feed-area" style="margin-top:15px;"></div>
        </div>

        <div id="v-mgr" class="hide">
            <div class="head">ğŸŒŸ å“¡å·¥ KPI è©•æ ¸</div>
            <select id="mgr-users"><option>é¸æ“‡å“¡å·¥...</option></select>
            <div style="padding:15px; background:#fff; border:1px solid #ddd; margin-top:10px;">
                <div class="rating-row">SOP åŸ·è¡Œç‡: <span class="stars" data-c="1" onclick="rate(this,event)">â˜…â˜…â˜…â˜…â˜…</span></div>
                <div class="rating-row">å®¢è¨´/æœå‹™: <span class="stars" data-c="2" onclick="rate(this,event)">â˜…â˜…â˜…â˜…â˜…</span></div>
                <div class="rating-row">å‡ºå‹¤ç‹€æ³: <span class="stars" data-c="3" onclick="rate(this,event)">â˜…â˜…â˜…â˜…â˜…</span></div>
                <div class="rating-row">åœ˜éšŠç²¾ç¥: <span class="stars" data-c="4" onclick="rate(this,event)">â˜…â˜…â˜…â˜…â˜…</span></div>
                <textarea id="mgr-comment" placeholder="ä¸»ç®¡è©•èª..." style="height:60px;"></textarea>
                <button class="btn-g" onclick="saveRating()">é€å‡ºè©•æ ¸</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- Core ---
const DB = {
    get: (k) => JSON.parse(localStorage.getItem(k) || '{}'),
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    arr: (k) => JSON.parse(localStorage.getItem(k) || '[]'),
    push: (k, v) => { let a = JSON.parse(localStorage.getItem(k) || '[]'); a.unshift(v); localStorage.setItem(k, JSON.stringify(a)); }
};

const initData = () => {
    if(!localStorage.getItem('v46_stock')) localStorage.setItem('v46_stock', JSON.stringify(['å†°ç®±é£²æ–™','å±¤æ¶é£²æ–™','è¸æ¶','é›»æ± ','æ³¡éºµ/é¤…ä¹¾','åƒåœ¾è¢‹/å…æ´—é¤å…·','ç™¾è²¨ç”¨å“']));
    if(!localStorage.getItem('v46_fridge')) localStorage.setItem('v46_fridge', JSON.stringify([
        {n:'é–‹æ”¾å¼1',t:'c'},{n:'é–‹æ”¾å¼2',t:'c'},{n:'å†·è—æ«¥æ«ƒ1',t:'c'},{n:'å†·è—æ«¥æ«ƒ2',t:'c'},
        {n:'å†·å‡æ«¥æ«ƒ1',t:'f'},{n:'å†·å‡æ«¥æ«ƒ2',t:'f'},{n:'è‡¥å¼1',t:'f'},{n:'è‡¥å¼2',t:'f'},{n:'è‡¥å¼3',t:'f'},{n:'è‡¥å¼4',t:'f'}
    ]));
}
initData();

let me = null;
let shapes = DB.arr('map_shapes');
let selShapeIdx = null;
let imgBase64 = "";
let isMapEdit = false;
let exArr = []; // 2. é¡å¤–æ”¶æ”¯
const fridgeTimes = ["10:30","12:30","14:30","16:30","18:30","20:30","22:00"];

// --- Auth ---
function swAuth(reg) { document.getElementById('box-login').classList.toggle('hide', reg); document.getElementById('box-reg').classList.toggle('hide', !reg); }
function reg() {
    const id=document.getElementById('r-id').value, nm=document.getElementById('r-name').value, pw=document.getElementById('r-pw').value;
    if(!id||!nm||!pw) return alert("è«‹å¡«å¯«");
    let u=DB.get('users'); u[id]={name:nm, pw:pw, shift:document.getElementById('r-shift').value}; DB.set('users', u);
    alert("è¨»å†ŠæˆåŠŸ"); swAuth(false);
}
function login() {
    const id=document.getElementById('l-id').value, pw=document.getElementById('l-pw').value;
    let u=DB.get('users');
    if(u[id] && u[id].pw===pw) { me={...u[id], id}; startApp(); } else alert("å¸³å¯†éŒ¯èª¤");
}
function logout() { location.reload(); }

function startApp() {
    document.getElementById('page-auth').classList.add('hide');
    document.getElementById('page-main').classList.remove('hide');
    document.getElementById('user-info').innerText = `${me.name}(${me.shift})`;

    if(me.shift==='ä¸»ç®¡') {
        document.querySelectorAll('.hide').forEach(el=>{
            if(el.id.includes('mgr') || el.id.includes('btn-add') || el.id.includes('btn-edit') || el.id.includes('map-tools') || el.id.includes('unlock')) el.classList.remove('hide');
        });
        loadUserList();
    }
    
    renderStock();
    renderFridge();
    renderMoney();
    renderCards();
    renderFeed();
    drawMap();
    renderStatus();
    initStars();
}

function tab(t) {
    document.querySelectorAll('.nav div').forEach(e=>e.classList.remove('active'));
    document.getElementById('n-'+t).classList.add('active');
    ['stock','expiry','temp','count','svc','mgr'].forEach(x=>document.getElementById('v-'+x).classList.add('hide'));
    document.getElementById('v-'+t).classList.remove('hide');
}

// --- Check/Reset ---
function renderStock() {
    const list = JSON.parse(localStorage.getItem('v46_stock'));
    document.getElementById('stock-list').innerHTML = list.map((s,i) => `
        <div class="box alert" id="stk_${i}" onclick="doCheck('stk_${i}','${s}')">
            ${s}<br><small>å¾…æª¢</small>
            ${me.shift==='ä¸»ç®¡' ? `<div class="reset-btn" onclick="resetCheck('stk_${i}');event.stopPropagation()">â†»</div>` : ''}
            <div class="del-item-btn" onclick="delConfItem('stock',${i}); event.stopPropagation()">-</div>
        </div>`).join('');
}

function doCheck(id, name) {
    let s = DB.get('status');
    if(s[id] && !s[id].alert && !confirm("å·²å®Œæˆã€‚æ˜¯å¦è¦†è“‹ï¼Ÿ")) return;
    if(!s[id] && !confirm(`ç¢ºèªå®Œæˆ ${name}ï¼Ÿ`)) return;
    s[id] = {name, user:me.name, time:new Date().toLocaleTimeString(), alert:false};
    DB.set('status', s); renderStatus();
}

function resetCheck(id) {
    if(!confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) return;
    let s = DB.get('status'); delete s[id]; DB.set('status', s);
    if(id.includes('stk_')) renderStock(); else {
        const el=document.getElementById(id); el.className=`box alert ${id.includes('s_')?'priority':''}`;
        el.innerHTML=`${el.innerText.split('\n')[0]}<br><small>å¾…è™•ç†</small>
        ${me.shift==='ä¸»ç®¡' ? `<div class="reset-btn" onclick="resetCheck('${id}');event.stopPropagation()">â†»</div>` : ''}`;
    }
    renderStatus();
}

function renderStatus() {
    let s = DB.get('status');
    for(let k in s) {
        const el = document.getElementById(k);
        if(el && s[k] && !k.includes('ref_')) {
            el.className = `box ${s[k].alert?'alert':'done'} ${k.includes('s_')?'priority':''}`;
            el.innerHTML = `${s[k].name}<br><small>${s[k].alert?'âš ï¸ ç•°å¸¸':'âœ… '+s[k].user+' '+s[k].time}</small>
            ${me.shift==='ä¸»ç®¡' ? `<div class="reset-btn" onclick="resetCheck('${k}');event.stopPropagation()">â†»</div>` : ''}
            <div class="del-item-btn" onclick="delConfItem('${k.includes('stk')?'stock':'fridge'}',${k.split('_')[1]}); event.stopPropagation()">-</div>`;
        }
    }
    let st=DB.get('store');
    document.getElementById('in-cash').value=st.cash||0; document.getElementById('in-vault').value=st.vault||0;
    if(st.cards) for(let k in st.cards) document.getElementById(`cd_l_${k}`).placeholder = `ä¸Š:${st.cards[k]}`;
}

// --- 1. Map Editor Fix ---
function toggleMapEdit() { isMapEdit = !isMapEdit; document.getElementById('map-mode-txt').innerText = isMapEdit?"ç·¨è¼¯é–‹":"ç·¨è¼¯é—œ"; document.getElementById('map-editor').classList.toggle('hide', !isMapEdit); drawMap(); }

function drawMap() {
    const area = document.getElementById('map-area'); area.innerHTML = "";
    shapes = DB.arr('map_shapes');
    shapes.forEach((s, i) => {
        const el = document.createElement('div');
        el.className = `map-box ${s.done?'done':''} ${selShapeIdx===i && isMapEdit?'selected':''}`;
        el.style.left=s.x+'px'; el.style.top=s.y+'px'; el.style.width=(s.w||60)+'px'; el.style.height=(s.h||60)+'px';
        
        let info = s.name;
        if(s.date) {
            const days = Math.ceil((new Date(s.date)-new Date())/(1000*60*60*24));
            info += `<br><span style="color:${days<3?'red':'green'}">${days}å¤©</span>`;
        }
        if(s.done) info += `<br><span style="font-size:9px">âœ…${s.checker}</span>`;
        
        el.innerHTML = info;
        
        el.onclick = (e) => {
            e.stopPropagation();
            if(isMapEdit && me.shift==='ä¸»ç®¡') {
                selShapeIdx = i; editMapBox(); // Pop-up Editor
            } else {
                if(confirm(`${s.name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) { s.done=true; s.checker=me.name; saveMap(); }
            }
        };
        if(isMapEdit && me.shift==='ä¸»ç®¡') {
            el.onmousedown = (e) => {
                const sx=e.clientX-s.x, sy=e.clientY-s.y;
                document.onmousemove = (ev) => { s.x=ev.clientX-sx; s.y=ev.clientY-sy; el.style.left=s.x+'px'; el.style.top=s.y+'px'; };
                document.onmouseup = () => { document.onmousemove=null; saveMap(); };
            };
        }
        area.appendChild(el);
    });
}
function editMapBox() {
    const val = prompt("ä¿®æ”¹æ–¹æ ¼ (åç¨±,å¯¬,é«˜,YYYY-MM-DD)\nè¼¸å…¥ 'del' åˆªé™¤", `${shapes[selShapeIdx].name},${shapes[selShapeIdx].w},${shapes[selShapeIdx].h},${shapes[selShapeIdx].date||''}`);
    if(val) {
        if(val==='del') shapes.splice(selShapeIdx, 1);
        else {
            const p = val.split(',');
            if(p[0]) shapes[selShapeIdx].name = p[0];
            if(p[1]) shapes[selShapeIdx].w = parseInt(p[1]);
            if(p[2]) shapes[selShapeIdx].h = parseInt(p[2]);
            if(p[3]) shapes[selShapeIdx].date = p[3];
        }
        saveMap();
    }
}
function addMapBox() { const n=prompt("å:"); if(n) { shapes.push({name:n,x:50,y:50,w:60,h:60,done:false}); saveMap(); }}
function saveMap() { localStorage.setItem('map_shapes', JSON.stringify(shapes)); drawMap(); }

// --- Fridge Time Logic ---
function renderFridge() {
    const list = JSON.parse(localStorage.getItem('v46_fridge'));
    document.getElementById('fridge-list').innerHTML = list.map((f,i) => `
        <div class="box alert" id="ref_${i}" onclick="openFridgeModal('ref_${i}','${f.n}','${f.t}')">
            ${f.n}<br><small>å¾…æ¸¬</small>
            <div class="del-item-btn" onclick="delConfItem('fridge',${i}); event.stopPropagation()">-</div>
        </div>`).join('');
}

function openFridgeModal(id, name, type) {
    document.getElementById('modal-overlay').style.display='flex';
    let s = DB.get('status');
    const now = new Date();
    const curMin = now.getHours()*60 + now.getMinutes();
    
    let html = `<h3>${name}</h3><div class="time-grid">`;
    fridgeTimes.forEach(time => {
        const key = `${id}_${time.replace(':','')}`;
        const tParts = time.split(':');
        const tMin = parseInt(tParts[0])*60 + parseInt(tParts[1]);
        const data = s[key];
        
        // Strict Time Logic: Missed if > 60 mins late, Future if > 30 mins early
        let status = '';
        let label = data ? data.val : '--';
        
        if (data) status = data.alert ? 'alert' : 'checked';
        else {
            if (curMin > tMin + 60) { status = 'missed'; label = 'MISS'; }
            else if (curMin < tMin - 30) { status = 'future'; label = 'æœªåˆ°'; }
        }
        
        let action = "";
        if(status === 'missed') action = "alert('é€¾æ™‚ç„¡æ³•å¡«å¯«')";
        else if(status === 'future') action = "alert('æ™‚é–“æœªåˆ°')";
        else action = `saveTemp('${key}','${time}','${name}','${type}')`;

        html += `<div class="time-btn ${status}" onclick="${action}">
            ${time}<br>${label}
        </div>`;
    });
    html += `</div><button class="btn-r" style="margin-top:10px" onclick="document.getElementById('modal-overlay').style.display='none'">é—œé–‰</button>`;
    document.getElementById('modal-body').innerHTML = html;
}

function saveTemp(key, time, name, type) {
    const v = prompt(`${name} ${time} æº«åº¦:`, type==='f'?'-':'');
    if(v===null) return;
    if(v.trim()==="" || isNaN(Number(v))) return alert("âŒ ç„¡æ•ˆæ•¸å­—");
    const n=parseFloat(v);
    let alertFlag=false;
    if((type==='c' && (n<0 || n>7)) || (type==='f' && (n>-10 || n<-30))) { alert("ğŸš¨ æº«åº¦ç•°å¸¸"); alertFlag=true; }
    
    let s=DB.get('status');
    s[key] = {name:`${name} ${time}`, user:me.name, val:v+"Â°C", alert:alertFlag};
    DB.set('status', s);
    openFridgeModal(key.split('_').slice(0,2).join('_'), name, type);
}

// --- 3. Svc Image Fix ---
function popSvc(t) {
    document.getElementById('modal-overlay').style.display='flex';
    let html = `<h3>${t}</h3><div id="modal-fields">`;
    if(t==='å®¢è¨‚') html+=`<input id="f1" placeholder="å“å"><input id="f2" placeholder="æ¢ç¢¼"><input id="f3" placeholder="æ•¸é‡"><input id="f4" placeholder="å”®åƒ¹"><hr><input id="f5" placeholder="å®¢å"><input id="f6" placeholder="é›»è©±">`;
    else html+=`<textarea id="f1" placeholder="å…§å®¹..." style="height:100px"></textarea>`;
    html += `</div><div style="margin-top:10px"><input type="file" id="modal-img" accept="image/*" onchange="readImg()"></div>
    <button onclick="saveSvc('${t}')">é€å‡º</button><button class="btn-s" onclick="document.getElementById('modal-overlay').style.display='none'">å–æ¶ˆ</button>`;
    document.getElementById('modal-body').innerHTML = html;
    imgBase64="";
}
function readImg() {
    const f=document.getElementById('modal-img').files[0];
    if(f) { const r=new FileReader(); r.onload=e=>{ imgBase64=e.target.result; }; r.readAsDataURL(f); }
}
function saveSvc(t) {
    let txt=""; document.querySelectorAll('#modal-fields input, #modal-fields textarea').forEach(i=>{ if(i.value) txt+=i.placeholder+":"+i.value+"<br>"; });
    if(!txt && !imgBase64) return alert("ç©ºç™½");
    DB.push('feeds', {type:t, txt, img:imgBase64, user:me.name, time:new Date().toLocaleString(), done:false});
    alert("æˆåŠŸ"); document.getElementById('modal-overlay').style.display='none'; renderFeed();
}
function renderFeed() {
    const d=document.getElementById('feed-area'); d.innerHTML="";
    DB.arr('feeds').forEach((f,i)=>{
        d.innerHTML += `<div class="feed-item ${f.done?'done':'pending'}">
            <b>${f.type}</b> ${f.user} ${f.time}<br>${f.txt}
            ${f.img?`<img src="${f.img}" style="width:60px;margin-top:5px" onclick="document.getElementById('big-img').src='${f.img}';document.getElementById('img-zoom').style.display='flex'">`:''}
            <div style="text-align:right"><button class="btn-s" onclick="let fs=DB.arr('feeds');fs[${i}].done=!fs[${i}].done;localStorage.setItem('feeds',JSON.stringify(fs));renderFeed()">${f.done?'é‡é–‹':'å®Œæˆ'}</button></div>
        </div>`;
    });
}

// --- Finance ---
function renderMoney(){ document.getElementById('money-table').innerHTML=[500,100,50,10,5,1].map(u=>`<tr><td>${u}</td><td><input type="number" class="inp-money" id="mr_${u}" oninput="cM()"></td><td><input type="number" class="inp-money" id="mv_${u}" oninput="cM()"></td><td id="sub_${u}" style="color:blue">0</td></tr>`).join(''); }
function renderCards(){ document.getElementById('card-list').innerHTML=["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"].map(c=>`<div class="box" style="padding:5px"><b>${c}</b><div style="display:flex;gap:5px"><input type="number" id="cd_s_${c}" placeholder="éŠ·" style="width:50%"><input type="number" id="cd_l_${c}" placeholder="å­˜" style="width:50%"></div></div>`).join(''); }
function cM(){ let t=0; [500,100,50,10,5,1].forEach(u=>{ let r=Number(document.getElementById(`mr_${u}`).value)||0, v=Number(document.getElementById(`mv_${u}`).value)||0; document.getElementById(`sub_${u}`).innerText=(r+v)*u; t+=(r+v)*u; }); document.getElementById('total-money').innerText=t; doCalc(); }
function doCalc(){ 
    const inC=Number(document.getElementById('in-cash').value)||0, inV=Number(document.getElementById('in-vault').value)||0, cnt=Number(document.getElementById('total-money').innerText)||0, rev=Number(document.getElementById('v-rev').value)||0; 
    let ext=0; exArr.forEach(x=>{ if(x.type=='in') ext+=x.amt; else ext-=x.amt; });
    let diff=cnt-(inC+inV+rev+ext); document.getElementById('diff-show').innerText=diff; document.getElementById('diff-show').style.color=diff===0?'green':'red'; 
}
function unlockIn(){ document.getElementById('in-cash').disabled=false; document.getElementById('in-vault').disabled=false; }
function saveIn(){ DB.set('store', {cash:document.getElementById('in-cash').value, vault:document.getElementById('in-vault').value}); alert("å·²å„²å­˜"); }
function submitShift(){ 
    let s=DB.get('store'); s.cash=parseFloat(document.getElementById('total-money').innerText); 
    ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"].forEach(c=>{ if(!s.cards) s.cards={}; s.cards[c]=document.getElementById(`cd_l_${c