<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é–€å¸‚ç³»çµ± V26 (é€£ç·šè¨ºæ–·ç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* --- è¦–è¦ºè¨­å®š --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; }
        
        /* è¨ºæ–·é¢æ¿ (æ–°) */
        #diag-box { background: #000; color: #0f0; padding: 10px; font-size: 12px; font-family: monospace; border-bottom: 2px solid green; }

        /* å°èˆª */
        .nav { display: flex; position: sticky; top: 0; background: #fff; border-bottom: 3px solid #ddd; z-index: 99; }
        .nav div { flex: 1; padding: 15px 5px; text-align: center; font-weight: bold; color: #666; cursor: pointer; font-size: 14px; }
        .nav div.active { color: #007bff; border-bottom: 3px solid #007bff; background: #f0f8ff; }

        /* å€å¡Šæ¨™é¡Œ */
        .head { background: #e9ecef; padding: 10px; font-weight: bold; border-left: 5px solid #007bff; margin: 15px 0; }
        
        /* æ ¼å­ç³»çµ± */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 10px; }
        .box { border: 2px solid #ccc; padding: 15px 5px; text-align: center; border-radius: 8px; cursor: pointer; background: #fff; min-height: 60px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .box.ok { background: #d4edda !important; border-color: #28a745 !important; color: #155724; font-weight: bold; position:relative;}
        .box.ok::after { content:"âœ…"; position:absolute; top:2px; right:2px; font-size:12px; }
        .box.alert { background: #f8d7da !important; border-color: #dc3545 !important; color: #721c24; }
        
        /* å¤–ç±å°ˆå€ */
        .foreign { background: #f3e5f5; border: 2px solid #9c27b0; color: #6a1b9a; font-weight: bold; }
        
        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input, select, button, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #999; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-g { background: #28a745; } .btn-r { background: #dc3545; } .btn-o { background: #fd7e14; }

        /* å¸³å‹™è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; }
        td, th { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .money-inp { width: 100%; text-align: center; font-size: 18px; border: none; background: #f9f9f9; }

        /* éš±è—èˆ‡å½ˆçª— */
        .hide { display: none !important; }
        .popup { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none; justify-content:center; align-items:center; }
        .popup-content { background:white; padding:20px; width:90%; border-radius:10px; max-height: 80vh; overflow-y: auto;}
    </style>
</head>
<body>

<div class="container">
    <div id="diag-box">ç³»çµ±å•Ÿå‹•ä¸­...</div>

    <div id="page-auth" style="padding:40px 20px; text-align:center;">
        <h2>ğŸª é–€å¸‚ V26 (è¨ºæ–·ç‰ˆ)</h2>
        <div id="box-login">
            <input id="l-id" placeholder="å¸³è™Ÿ">
            <input id="l-pw" type="password" placeholder="å¯†ç¢¼">
            <button onclick="login()">ç™»å…¥</button>
            <p onclick="toReg(true)" style="color:blue; margin-top:20px;">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š</p>
        </div>
        <div id="box-reg" class="hide">
            <input id="r-name" placeholder="å§“å">
            <select id="r-shift"><option>æ—©ç­</option><option>æ™šç­</option><option>ä¸»ç®¡</option></select>
            <input id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
            <input id="r-pw" type="password" placeholder="è¨­å®šå¯†ç¢¼">
            <button class="btn-g" id="btn-reg-action" onclick="reg()">ç¢ºèªè¨»å†Š</button>
            <p onclick="toReg(false)" style="color:blue; margin-top:20px;">è¿”å›ç™»å…¥</p>
        </div>
    </div>

    <div id="page-main" class="hide">
        <div style="background:#333; color:white; padding:10px; display:flex; justify-content:space-between;">
            <span id="user-display">--</span>
            <button onclick="logout()" style="width:auto; padding:5px 10px; background:#555;">ç™»å‡º</button>
        </div>

        <div class="nav">
            <div onclick="tab('stock')" class="active" id="nav-stock">è£œè²¨æ•ˆæœŸ</div>
            <div onclick="tab('temp')" id="nav-temp">å†°ç®±</div>
            <div onclick="tab('counter')" id="nav-counter">å¸³å‹™</div>
            <div onclick="tab('svc')" id="nav-svc">äº¤æ¥å®¢æœ</div>
            <div onclick="tab('mgr')" id="nav-mgr" class="hide">ä¸»ç®¡</div>
        </div>

        <div id="view-stock">
            <div class="head">ğŸ”¥ é‡é»æª¢æŸ¥</div>
            <div class="grid">
                <div class="box foreign" id="stk-noodle" onclick="check('stk-noodle','å¤–ç±æ³¡éºµ')">å¤–ç±æ³¡éºµ<br><small>å¾…æª¢</small></div>
                <div class="box foreign" id="stk-cookie" onclick="check('stk-cookie','å¤–ç±é¤…ä¹¾')">å¤–ç±é¤…ä¹¾<br><small>å¾…æª¢</small></div>
            </div>

            <div class="head">ğŸ“… æ¯æ—¥æ•ˆæœŸ</div>
            <div class="grid">
                <div class="box" id="chk-fresh" onclick="check('chk-fresh','ç”Ÿé®®æ•ˆæœŸ')">ç”Ÿé®®æ•ˆæœŸ</div>
                <div class="box" id="chk-daily" onclick="check('chk-daily','æ—¥é…æ•ˆæœŸ')">æ—¥é…æ•ˆæœŸ</div>
                <div class="box" id="chk-bread" onclick="check('chk-bread','éºµåŒ…æ•ˆæœŸ')">éºµåŒ…æ•ˆæœŸ</div>
            </div>

            <div class="head">ğŸ›’ æ¯æ—¥è£œè²¨</div>
            <div class="grid">
                <div class="box" id="stk-cig" onclick="check('stk-cig','è¸æ¶è£œè²¨')">è¸æ¶</div>
                <div class="box" id="stk-drink1" onclick="check('stk-drink1','å†°ç®±é£²æ–™')">å†°ç®±é£²æ–™</div>
                <div class="box" id="stk-drink2" onclick="check('stk-drink2','å±¤æ¶é£²æ–™')">å±¤æ¶é£²æ–™</div>
                <div class="box" id="stk-frozen" onclick="check('stk-frozen','å†·å‡è£œè²¨')">å†·å‡é£Ÿå“</div>
                <div class="box" id="stk-trash" onclick="check('stk-trash','åƒåœ¾è¢‹/å…æ´—')">åƒåœ¾è¢‹/å…æ´—</div>
                <div class="box" id="stk-tissue" onclick="check('stk-tissue','è¡›ç”Ÿç´™')">è¡›ç”Ÿç´™</div>
            </div>

            <div class="head">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸåœ–</div>
            <div id="mgr-tools" class="hide" style="padding:10px;">
                <button onclick="addMapBox()" style="width:auto;">+å€å¡Š</button>
                <button onclick="saveMap()" class="btn-g" style="width:auto;">å„²å­˜è¨­å®š</button>
                <div style="margin-top:5px;">
                    <button onclick="copyShape()" style="width:auto; font-size:12px;">è¤‡è£½</button>
                    <button onclick="delShape()" class="btn-r" style="width:auto; font-size:12px;">åˆªé™¤</button>
                    <button onclick="renShape()" style="width:auto; font-size:12px;">æ”¹å</button>
                </div>
            </div>
            <div id="map-canvas" style="height:300px; background:#eee; position:relative; border:2px solid #333; margin:10px;"></div>
        </div>

        <div id="view-temp" class="hide">
            <div class="head">â„ï¸ å†·è—å€ (0 ~ 7åº¦)</div>
            <div class="grid">
                <div class="box" id="f1" onclick="temp('f1','é–‹æ”¾1','c')">é–‹æ”¾ 1<br><small>--</small></div>
                <div class="box" id="f2" onclick="temp('f2','é–‹æ”¾2','c')">é–‹æ”¾ 2<br><small>--</small></div>
                <div class="box" id="f3" onclick="temp('f3','å†·è—1','c')">å†·è— 1<br><small>--</small></div>
                <div class="box" id="f4" onclick="temp('f4','å†·è—2','c')">å†·è— 2<br><small>--</small></div>
            </div>
            <div class="head">ğŸ§Š å†·å‡å€ (ä½æ–¼ -10åº¦)</div>
            <div class="grid">
                <div class="box" id="f5" onclick="temp('f5','å†·å‡1','f')">å†·å‡ 1<br><small>--</small></div>
                <div class="box" id="f6" onclick="temp('f6','å†·å‡2','f')">å†·å‡ 2<br><small>--</small></div>
                <div class="box" id="f7" onclick="temp('f7','è‡¥å¼1','f')">è‡¥å¼ 1<br><small>--</small></div>
                <div class="box" id="f8" onclick="temp('f8','è‡¥å¼2','f')">è‡¥å¼ 2<br><small>--</small></div>
                <div class="box" id="f9" onclick="temp('f9','è‡¥å¼3','f')">è‡¥å¼ 3<br><small>--</small></div>
                <div class="box" id="f10" onclick="temp('f10','è‡¥å¼4','f')">è‡¥å¼ 4<br><small>--</small></div>
            </div>
        </div>

        <div id="view-counter" class="hide">
            <div class="head">ğŸ“¥ ä¸Šä¸€ç­ç•™å­˜ (é€²æ«ƒ)</div>
            <div style="background:#e3f2fd; padding:10px;">
                <label>æ”¶éŠ€æ©Ÿç•™å­˜ï¼š</label><input type="number" id="in-cash" disabled style="background:#fff;">
                <label>åº«å­˜é›¶éŒ¢ï¼š</label><input type="number" id="in-stock" disabled style="background:#fff;">
                <button id="btn-unlock" class="hide" onclick="unlockIn()" style="margin-top:5px; width:auto; font-size:12px;">ä¸»ç®¡ä¿®æ”¹</button>
                <button id="btn-save-in" class="hide btn-g" onclick="saveIn()">å„²å­˜ä¿®æ”¹</button>
            </div>

            <div class="head">ğŸª™ æœ¬ç­é›¢æ«ƒé»ç®—</div>
            <table>
                <tr><th>é¢é¡</th><th>æ”¶éŠ€æ©Ÿ(ç•™)</th><th>åº«å­˜(é‡‘åº«)</th></tr>
                <tbody id="money-body"></tbody>
            </table>
            <div style="text-align:right; font-weight:bold; color:blue; padding:10px;">é›¢æ«ƒç¸½è¨ˆï¼š$<span id="total-money">0</span></div>

            <div class="head">ğŸ“ é›»è©±å¡ (é€²/éŠ·/å­˜)</div>
            <div id="card-list"></div>

            <div class="head">ğŸ“Š ç‡Ÿæ”¶æ•¸æ“š</div>
            <div class="grid">
                <input type="number" id="v-sales" placeholder="ç‡Ÿæ¥­é¡">
                <input type="number" id="v-visit" placeholder="ä¾†å®¢æ•¸">
            </div>
            <div class="grid" style="margin-top:5px;">
                <input type="number" id="v-cr" placeholder="ä¿¡ç”¨å¡"><input type="number" id="v-tw" placeholder="å°ç£Pay">
                <input type="number" id="v-ln" placeholder="LinePay"><input type="number" id="v-pt" placeholder="é»æ•¸">
                <input type="number" id="v-rf" placeholder="é€€æ¬¾">
            </div>

            <div class="head">â• é¡å¤–æ”¶æ”¯</div>
            <div class="grid">
                <button class="btn-g" onclick="addExt('in')">æ–°å¢æ”¶å…¥</button>
                <button class="btn-r" onclick="addExt('out')">æ–°å¢æ”¯å‡º</button>
            </div>
            <div id="ext-list" style="padding:10px;"></div>

            <div style="background:#333; color:white; padding:15px; text-align:center; margin-top:20px;">
                <h2>èª¤å·®ï¼š<span id="diff-val">0</span></h2>
                <button class="btn-o" onclick="doCalc()">è©¦ç®—èª¤å·®</button>
                <button class="btn-g" onclick="submitReport()" style="margin-top:10px;">æäº¤å ±è¡¨</button>
            </div>
        </div>

        <div id="view-svc" class="hide">
            <div style="text-align:right; padding:5px;">
                <button id="bell-btn" onclick="popSvc('é€šçŸ¥')">ğŸ”” <span id="bell-count" style="color:yellow">0</span></button>
            </div>
            <div class="grid">
                <button onclick="popSvc('äº¤æ¥')">ğŸ“ äº¤æ¥</button>
                <button onclick="popSvc('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="popSvc('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
                <button onclick="popSvc('å”®ç½„')">âš¡ å”®ç½„</button>
                <button onclick="popSvc('å ±å»¢')">ğŸ—‘ï¸ å ±å»¢</button>
            </div>
            <div id="feed" style="margin-top:20px;"></div>
        </div>

        <div id="view-mgr" class="hide">
            <div class="head">ğŸŒŸ è©•åˆ†</div>
            <select id="mgr-target"><option>é¸æ“‡å“¡å·¥</option></select>
            <button onclick="saveScore()">å„²å­˜è©•åˆ†</button>
        </div>
    </div>
</div>

<div id="pop-svc" class="popup">
    <div class="popup-content">
        <h3 id="pop-title">--</h3>
        <div id="pop-fields"></div>
        <input type="file" id="pop-img" accept="image/*">
        <button class="btn-g" onclick="sendSvc()">é€å‡º</button>
        <button onclick="document.getElementById('pop-svc').style.display='none'" style="background:#666; margin-top:5px;">å–æ¶ˆ</button>
    </div>
</div>

<div id="img-modal" class="popup" onclick="this.style.display='none'">
    <img id="big-img" style="max-width:95%; max-height:95%;">
</div>

<script>
    // --- 1. Firebase é€£ç·šè¨­å®š ---
    const firebaseConfig = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73"
    };

    const diag = document.getElementById('diag-box');
    function log(msg) { diag.innerText = msg; console.log(msg); }

    let db;
    try {
        log("æ­£åœ¨é€£æ¥ Firebase...");
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        
        // å˜—è©¦å•Ÿç”¨é›¢ç·šæŒä¹…åŒ–ï¼Œè‹¥å¤±æ•—å‰‡å¿½ç•¥
        db.enablePersistence().catch(err => {
            if (err.code == 'failed-precondition') log("å¤šè¦–çª—é–‹å•Ÿï¼ŒæŒä¹…åŒ–åœç”¨");
            else if (err.code == 'unimplemented') log("ç€è¦½å™¨ä¸æ”¯æ´æŒä¹…åŒ–");
        });
        log("âœ… é€£ç·šå°±ç·’ (è‹¥è¨»å†Šç„¡åæ‡‰è«‹æª¢æŸ¥ç¶²è·¯)");
        document.getElementById('diag-box').style.color = '#0f0';
    } catch(e) {
        log("âŒ é€£ç·šå¤±æ•—: " + e.message);
        document.getElementById('diag-box').style.color = 'red';
    }

    let me = null;
    let shapes = [];
    let selId = null;
    let exArr = [];

    // --- 2. èªè­‰é‚è¼¯ ---
    function swAuth(x) {
        document.getElementById('box-login').classList.toggle('hide', x);
        document.getElementById('box-reg').classList.toggle('hide', !x);
    }

    function reg() {
        const btn = document.getElementById('btn-reg-action');
        btn.innerText = "è™•ç†ä¸­...";
        btn.disabled = true;

        const id = document.getElementById('r-id').value;
        const nm = document.getElementById('r-name').value;
        const pw = document.getElementById('r-pw').value;
        const sf = document.getElementById('r-shift').value;
        
        if(!id||!nm||!pw) {
            btn.innerText = "ç¢ºèªè¨»å†Š"; btn.disabled = false;
            return alert("è«‹å¡«å¯«å®Œæ•´");
        }
        
        db.collection('users').doc(id).set({name:nm, pw:pw, shift:sf, points:0})
            .then(() => {
                alert("âœ… è¨»å†ŠæˆåŠŸï¼è«‹æŒ‰ç¢ºå®šè¿”å›ç™»å…¥ã€‚");
                swAuth(false);
                btn.innerText = "ç¢ºèªè¨»å†Š"; btn.disabled = false;
            })
            .catch(e => {
                alert("âŒ è¨»å†Šå¤±æ•— (å¯èƒ½æ˜¯ç¶²è·¯å•é¡Œ): "+e);
                btn.innerText = "ç¢ºèªè¨»å†Š"; btn.disabled = false;
            });
    }

    function login() {
        const id = document.getElementById('l-id').value;
        const pw = document.getElementById('l-pw').value;
        log("æ­£åœ¨é©—è­‰å¸³è™Ÿ...");
        db.collection('users').doc(id).get().then(s => {
            if(s.exists && s.data().pw===pw) {
                me = {...s.data(), id};
                log("ç™»å…¥æˆåŠŸ");
                init();
            } else alert("å¸³å¯†éŒ¯èª¤");
        }).catch(e => {
            alert("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼š" + e.message);
        });
    }

    function logout() {
        location.reload();
    }

    // --- 3. å•Ÿå‹•èˆ‡ç”Ÿæˆ ---
    function init() {
        document.getElementById('page-auth').classList.add('hide');
        document.getElementById('page-main').classList.remove('hide');
        document.getElementById('user-display').innerText = `${me.name} (${me.shift})`;
        
        if(me.shift==='ä¸»ç®¡') {
            document.getElementById('mgr-tools').classList.remove('hide');
            document.getElementById('btn-unlock').classList.remove('hide');
            document.getElementById('nav-mgr').classList.remove('hide');
        }

        // ç”ŸæˆéŒ¢å¹£
        const mb = document.getElementById('money-body');
        [500,100,50,10,5,1].forEach(u => {
            mb.innerHTML += `<tr>
                <td>${u}</td>
                <td><input type="number" class="money-inp" id="mr${u}" oninput="calc()"></td>
                <td><input type="number" class="money-inp" id="ms${u}" oninput="calc()"></td>
                <td style="color:blue; font-weight:bold;" id="sub${u}">0</td>
            </tr>`;
        });

        // ç”Ÿæˆé›»è©±å¡
        const cards = ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
        document.getElementById('card-list').innerHTML = cards.map(c => `
            <div style="border:1px solid #ddd; padding:5px; margin-bottom:5px; border-radius:5px;">
                <b>${c}</b>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="ci-${c}" placeholder="é€²" style="font-size:12px;">
                    <input type="number" id="cs-${c}" placeholder="éŠ·" style="color:red; font-size:12px;">
                    <input type="number" id="cl-${c}" placeholder="å­˜" style="color:blue; font-size:12px;">
                </div>
            </div>
        `).join('');

        listen();
    }

    function listen() {
        // ç‹€æ…‹
        db.collection('checks').onSnapshot(s => {
            s.forEach(d => {
                const el = document.getElementById(d.id);
                if(el) {
                    el.className = 'box ok' + (d.id.includes('stk-noodle')||d.id.includes('stk-cookie') ? ' foreign' : '');
                    el.innerHTML = `${d.data().name}<br><small>âœ… ${d.data().user}</small>`;
                }
            });
        });

        // åœ°åœ–
        db.collection('settings').doc('map').onSnapshot(s => {
            if(s.exists) drawMap(s.data().shapes || []);
        });

        // é€²æ«ƒ
        db.collection('store').doc('status').onSnapshot(s => {
            if(s.exists) {
                const d = s.data();
                document.getElementById('in-cash').value = d.cash || 0;
                document.getElementById('in-stock').value = d.stock || 0;
                if(d.cardsDetail) {
                    for(let k in d.cardsDetail) {
                        const el = document.getElementById(`ci-${k}`);
                        if(el) el.value = d.cardsDetail[k];
                    }
                }
            }
        });

        // äº¤æ¥
        db.collection('feeds').orderBy('time','desc').limit(20).onSnapshot(s => {
            const div = document.getElementById('feed');
            div.innerHTML = "";
            let unread = 0;
            s.forEach(doc => {
                const b = doc.data();
                if(!b.done) unread++;
                div.innerHTML += `<div style="padding:10px; border-bottom:1px solid #ddd; background:${b.done?'#fff':'#fff8e1'}">
                    <b>[${b.type}] ${b.user}</b> <button onclick="doneFeed('${doc.id}',${!b.done})" style="font-size:10px; float:right;">${b.done?'å·²å®Œæˆ':'æ‰“å‹¾'}</button>
                    <p style="margin:5px 0;">${b.txt}</p>
                    ${b.img ? `<img src="${b.img}" style="width:80px; border:1px solid #ccc;" onclick="zoom('${b.img}')">` : ''}
                </div>`;
            });
            document.getElementById('bell-count').innerText = unread;
        });
    }

    // --- åŠŸèƒ½å‡½å¼ (æ›è¼‰å…¨åŸŸ) ---
    window.tab = (t) => {
        document.querySelectorAll('.nav div').forEach(e=>e.classList.remove('active'));
        document.getElementById('nav-'+t).classList.add('active');
        ['stock','temp','counter','svc','mgr'].forEach(x=> document.getElementById('view-'+x).classList.add('hide'));
        document.getElementById('view-'+t).classList.remove('hide');
    };

    window.check = async (id, name) => {
        if(confirm(name+" å®Œæˆï¼Ÿ")) db.collection('checks').doc(id).set({name, status:'ok', user:me.name, time:new Date()});
    };

    window.temp = async (id, name, type) => {
        const v = prompt(name+" æº«åº¦ï¼š", type==='f'?'-':'');
        if(!v) return;
        if((type==='f' && parseFloat(v)>-10) || (type==='c' && (parseFloat(v)<0 || parseFloat(v)>7))) alert("ğŸš¨ æº«åº¦ç•°å¸¸ï¼");
        db.collection('checks').doc(id).set({name, val:v, status:'ok', user:me.name, time:new Date()});
    };

    window.calc = () => {
        let tot = 0;
        [500,100,50,10,5,1].forEach(u => {
            const r = Number(document.getElementById('mr'+u).value)||0;
            const s = Number(document.getElementById('ms'+u).value)||0;
            const sub = (r+s)*u;
            document.getElementById('sub'+u).innerText = sub;
            tot += sub;
        });
        document.getElementById('total-money').innerText = tot;
    };

    window.addExt = (type) => {
        const a = prompt("é‡‘é¡"); const t = prompt("å‚™è¨»");
        if(a) {
            exArr.push({type, amt:Number(a), txt:t});
            document.getElementById('ext-list').innerHTML += `<div style="color:${type==='in'?'green':'red'}">${type==='in'?'æ”¶':'æ”¯'} ${a} (${t})</div>`;
        }
    };

    window.doCalc = () => {
        const inC = parseFloat(document.getElementById('in-cash').value)||0;
        const inS = parseFloat(document.getElementById('in-stock').value)||0;
        const out = parseFloat(document.getElementById('total-money').innerText)||0;
        const rev = parseFloat(document.getElementById('v-sales').value)||0;
        const ded = (parseFloat(document.getElementById('v-cr').value)||0) + 
                    (parseFloat(document.getElementById('v-tw').value)||0) + 
                    (parseFloat(document.getElementById('v-ln').value)||0) + 
                    (parseFloat(document.getElementById('v-pt').value)||0) + 
                    (parseFloat(document.getElementById('v-rf').value)||0);
        const ext = exArr.reduce((a,b) => a + (b.type==='in'?b.amt:-b.amt), 0);

        const diff = ((inC + inS) - out + (rev - ded) + ext) * -1;
        document.getElementById('diff-val').innerText = diff;
    };

    window.submitReport = async () => {
        const nextCash = parseFloat(document.getElementById('total-money').innerText);
        let cardDetails = {};
        ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"].forEach(c => {
            cardDetails[c] = parseFloat(document.getElementById(`cl-${c}`).value)||0;
        });

        await db.collection('store').doc('status').set({
            cash: nextCash, stock: 0,
            cardsDetail: cardDetails
        });
        await db.collection('reports').add({ diff: document.getElementById('diff-val').innerText, user:me.name, time:new Date() });
        alert("âœ… å ±è¡¨æäº¤æˆåŠŸï¼");
        location.reload();
    };

    // äº¤æ¥
    let curT = "";
    window.popSvc = (t) => {
        curT = t;
        document.getElementById('pop-svc').style.display = 'flex';
        document.getElementById('pop-title').innerText = t;
        const f = document.getElementById('pop-fields');
        if(t==='äº¤æ¥') f.innerHTML = `<textarea id="pi-t" placeholder="è«‹è¼¸å…¥äº¤æ¥äº‹é …..."></textarea>`;
        else f.innerHTML = `<input id="pi-1" placeholder="å“å/é …ç›®"><input id="pi-2" placeholder="å‚™è¨»/æ¢ç¢¼">`;
    };

    window.sendSvc = () => {
        let txt = "";
        if(document.getElementById('pi-t')) txt = document.getElementById('pi-t').value;
        else txt = document.getElementById('pi-1').value + " " + document.getElementById('pi-2').value;
        
        const file = document.getElementById('pop-img').files[0];
        const save = (url="") => {
            db.collection('feeds').add({type:curT, txt, img:url, user:me.name, time:new Date(), done:false});
            document.getElementById('pop-svc').style.display='none';
            alert("ç™¼é€æˆåŠŸ");
        };
        
        if(file) {
            const r = new FileReader();
            r.onload = e => save(e.target.result);
            r.readAsDataURL(file);
        } else save();
    };

    window.doneFeed = (id, s) => db.collection('feeds').doc(id).update({done:s});
    window.zoom = (src) => { document.getElementById('big-img').src = src; document.getElementById('img-modal').style.display = 'flex'; };

    // ä¸»ç®¡ç·¨è¼¯é€²æ«ƒ
    window.unlockIn = () => {
        document.getElementById('in-cash').disabled = false;
        document.getElementById('in-stock').disabled = false;
        document.getElementById('btn-save-in').classList.remove('hide');
    };
    window.saveIn = async () => {
        await db.collection('store').doc('status').update({
            cash: parseFloat(document.getElementById('in-cash').value),
            stock: parseFloat(document.getElementById('in-stock').value)
        });
        alert("æ›´æ–°æˆåŠŸ");
        location.reload();
    };

    // æ¨¡å‹åœ–
    function drawMap(data) {
        shapes = data;
        const c = document.getElementById('map-canvas');
        c.innerHTML = "";
        shapes.forEach((s, i) => {
            const d = document.createElement('div');
            d.style.cssText = `position:absolute; left:${s.x}px; top:${s.y}px; border:2px solid #333; background:${s.done?'green':'#fff'}; color:${s.done?'#fff':'#000'}; padding:5px; font-size:10px; cursor:pointer; width:50px; height:40px; display:flex; align-items:center; justify-content:center;`;
            d.innerText = s.name;
            
            if(me.shift==='ä¸»ç®¡') {
                d.onmousedown = e => {
                    selId = i;
                    document.getElementById('sel-name').innerText = s.name;
                    document.getElementById('edit-bar').classList.remove('hide');
                    const ox = e.clientX-s.x; const oy = e.clientY-s.y;
                    document.onmousemove = ev => { s.x=ev.clientX-ox; s.y=ev.clientY-oy; d.style.left=s.x+'px'; d.style.top=s.y+'px'; };
                    document.onmouseup = () => document.onmousemove = null;
                };
            } else {
                d.onclick = async () => { if(confirm("å®Œæˆ?")){ s.done=true; saveMap(); }};
            }
            c.appendChild(d);
        });
    }
    window.addMapBox = () => { const n=prompt("åç¨±"); if(n) { shapes.push({name:n, x:50, y:50, done:false}); saveMap(); }};
    window.saveMap = async () => { await db.collection('settings').doc('map').set({shapes}); alert("å·²å„²å­˜"); };
    window.delShape = () => { shapes.splice(selId, 1); saveMap(); document.getElementById('edit-bar').classList.add('hide'); };
    window.copyShape = () => { const s=shapes[selId]; shapes.push({...s, x:s.x+20, y:s.y+20}); saveMap(); };
    window.renShape = () => { const n=prompt("æ–°å"); if(n){ shapes[selId].name=n; saveMap(); }};

</script>
</body>
</html>