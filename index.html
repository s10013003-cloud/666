<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é–€å¸‚ V40 (RWD Retail Master)</title>
    <style>
        /* --- RWD Core Design --- */
        :root { --primary: #00695c; /* Teal for Professionalism */ --accent: #ff6f00; --success: #2e7d32; --danger: #c62828; --bg: #f1f3f4; --card: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Roboto", "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); padding-bottom: 120px; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card); min-height: 100vh; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }

        /* Navigation */
        .nav { display: flex; position: sticky; top: 0; background: #fff; border-bottom: 1px solid #ddd; z-index: 100; overflow-x: auto; scrollbar-width: none; }
        .nav::-webkit-scrollbar { display: none; }
        .nav div { flex: 0 0 auto; padding: 14px 18px; font-weight: 600; color: #666; cursor: pointer; white-space: nowrap; font-size: 15px; transition: 0.3s; }
        .nav div.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #e0f2f1; }

        /* Section Header */
        .head { background: #fafafa; padding: 12px 15px; margin: 15px 0 10px; font-weight: 700; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; font-size: 16px; border-bottom: 1px solid #eee; }
        
        /* Grid Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 12px; }
        .box { border: 1px solid #ccc; padding: 12px; text-align: center; border-radius: 8px; cursor: pointer; background: #fff; min-height: 70px; display:flex; flex-direction:column; justify-content:center; align-items:center; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.1s; }
        .box:active { transform: scale(0.98); }
        
        /* Status Colors */
        .box.ok { background: #e8f5e9 !important; border-color: var(--success) !important; color: #1b5e20; }
        .box.alert { background: #ffebee !important; border-color: var(--danger) !important; color: #b71c1c; font-weight: bold; animation: shake 0.4s; }
        .priority { border: 2px solid var(--accent) !important; background: #fff8e1; }

        /* Reset Button (The Refresh Icon) */
        .reset-btn { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: #fff; border: 1px solid #999; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 10; color: #555; }
        .reset-btn:active { background: var(--danger); color: white; border-color: var(--danger); }

        /* Delete Button (Manager Mode) */
        .del-item-btn { position: absolute; top: -8px; left: -8px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; font-size: 12px; display: none; align-items: center; justify-content: center; border: 2px solid white; z-index: 15; }
        .editing .del-item-btn { display: flex; }
        .editing .box { border: 2px dashed var(--primary); opacity: 0.9; }

        /* Interactive Map */
        #map-area { position: relative; width: 94%; height: 400px; background: #eee; margin: 10px auto; overflow: hidden; border: 2px solid #ccc; border-radius: 4px; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px; }
        .map-box { position: absolute; background: rgba(255,255,255,0.9); border: 2px solid #555; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; cursor: grab; user-select: none; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); padding: 2px; text-align: center; }
        .map-box.done { background: var(--success) !important; color: white !important; border-color: #004d40; }
        .map-box.selected { border: 3px solid var(--danger); z-index: 50; }
        .map-box.pinned { border-style: double; border-width: 4px; border-color: #333; }
        .pin-icon { font-size: 10px; position: absolute; top: 0; right: 0; display: none; }
        .map-box.pinned .pin-icon { display: block; }
        .timer-badge { font-size: 9px; background: #333; color: white; padding: 1px 4px; border-radius: 4px; margin-top: 2px; }

        /* Service Feed (Card Style) */
        .feed-item { padding: 12px; border: 1px solid #e0e0e0; margin-bottom: 12px; border-radius: 8px; transition: 0.2s; }
        .feed-item.done { background: #e8f5e9; border-left: 5px solid var(--success); }
        .feed-item.pending { background: #ffebee; border-left: 5px solid var(--danger); }
        .feed-meta { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 5px; }

        /* UI Elements */
        input, select, button, textarea { width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: 600; }
        button:active { filter: brightness(0.9); transform: translateY(1px); }
        .btn-g { background: var(--success); } .btn-r { background: var(--danger); } .btn-o { background: var(--accent); color: white; }
        .btn-sm { width: auto; padding: 5px 12px; font-size: 12px; margin-right: 5px; }
        .hide { display: none !important; }
        .stars span { font-size: 32px; color: #ddd; cursor: pointer; }
        .stars span.gold { color: #ffc107; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 10px; }
        td, th { border: 1px solid #eee; padding: 8px; text-align: center; }
        th { background: #f5f5f5; }
        .inp-money { width: 100%; text-align: center; padding: 8px; border: 1px solid #ccc; background: #fff; font-size: 16px; border-radius: 4px; }

        /* Image Modal */
        #img-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.92); z-index:999; display:none; justify-content:center; align-items:center; }
        #img-modal img { max-width:95%; max-height:95%; border: 3px solid white; border-radius: 4px; }
        
        @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 50%{transform:translateX(5px)} 75%{transform:translateX(-5px)} 100%{transform:translateX(0)} }
    </style>
</head>
<body>

<div id="img-modal" onclick="this.style.display='none'"><img id="big-img"></div>
<div id="bell" style="position:fixed; top:15px; right:15px; font-size:24px; background:white; border-radius:50%; padding:8px; box-shadow:0 4px 10px rgba(0,0,0,0.15); z-index:200; cursor:pointer;" onclick="gotoSvc()">ğŸ””<div id="badge" style="position:absolute; top:-2px; right:-2px; background:red; color:white; width:18px; height:18px; border-radius:50%; font-size:10px; line-height:18px; text-align:center; display:none;">0</div></div>

<div class="container">
    <div id="page-auth" style="padding:40px 20px; text-align:center;">
        <h2 style="color:var(--primary); margin-bottom:5px;">ğŸª æ™ºæ…§é–€å¸‚ V40</h2>
        <p style="color:#666; font-size:12px;">Retail UX Master Edition</p>
        <div id="box-login" style="margin-top:20px;">
            <input id="l-id" placeholder="å¸³è™Ÿ">
            <input id="l-pw" type="password" placeholder="å¯†ç¢¼">
            <button onclick="login()">ç™»å…¥</button>
            <p onclick="swAuth(true)" style="color:var(--primary); margin-top:20px; cursor:pointer;">è¨»å†Šæ–°å¸³è™Ÿ</p>
        </div>
        <div id="box-reg" class="hide" style="margin-top:20px;">
            <input id="r-name" placeholder="çœŸå¯¦å§“å">
            <select id="r-shift"><option>æ—©ç­</option><option>æ™šç­</option><option>ä¸»ç®¡</option></select>
            <input id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
            <input id="r-pw" type="password" placeholder="è¨­å®šå¯†ç¢¼">
            <button class="btn-g" onclick="reg()">ç¢ºèªè¨»å†Š</button>
            <p onclick="swAuth(false)" style="color:var(--primary); margin-top:20px; cursor:pointer;">è¿”å›ç™»å…¥</p>
        </div>
    </div>

    <div id="page-main" class="hide">
        <div style="background:#333; color:white; padding:12px; display:flex; justify-content:space-between; align-items:center;">
            <span id="user-info">--</span>
            <button onclick="logout()" class="btn-sm" style="background:#555;">ç™»å‡º</button>
        </div>

        <div class="nav">
            <div onclick="tab('stock')" id="n-stock" class="active">ğŸ“¦ è£œè²¨</div>
            <div onclick="tab('expiry')" id="n-expiry">ğŸ“… æ•ˆæœŸ</div>
            <div onclick="tab('temp')" id="n-temp">ğŸŒ¡ï¸ å†°ç®±</div>
            <div onclick="tab('count')" id="n-count">ğŸ’° å¸³å‹™</div>
            <div onclick="tab('svc')" id="n-svc">ğŸ¤ å®¢æœ</div>
            <div onclick="tab('mgr')" id="n-mgr" class="hide">ğŸ“Š ä¸»ç®¡</div>
        </div>

        <div id="v-stock">
            <div class="head" style="border-color:var(--accent);">ğŸ”¥ é‡é»è£œè²¨ (ä¸»ç®¡å¯é‡ç½®)</div>
            <div class="grid">
                <div class="box priority alert" id="s_noodle" onclick="doCheck('s_noodle','å¤–ç±æ³¡éºµ')">å¤–ç±æ³¡éºµ<br><small>å¾…è™•ç†</small></div>
                <div class="box priority alert" id="s_cookie" onclick="doCheck('s_cookie','å¤–ç±é¤…ä¹¾')">å¤–ç±é¤…ä¹¾<br><small>å¾…è™•ç†</small></div>
            </div>

            <div class="head">
                ğŸ›’ æ¯æ—¥è£œè²¨ 
                <button id="btn-edit-stock" class="hide btn-sm btn-o" onclick="toggleEdit('stock-list')">ç®¡ç†</button>
            </div>
            <div class="grid" id="stock-list"></div>
            <div id="add-stock-area" class="hide" style="padding:10px;">
                <button class="btn-g" style="width:100%" onclick="addItem('stock')">+ æ–°å¢è£œè²¨é …ç›®</button>
            </div>
        </div>

        <div id="v-expiry" class="hide">
            <div class="head">ğŸ“… æ¯æ—¥æ•ˆæœŸæª¢æŸ¥</div>
            <div class="grid">
                <div class="box alert" id="ex_bread" onclick="doCheck('ex_bread','éºµåŒ…')">éºµåŒ…<br><small>å¾…æª¢</small></div>
                <div class="box alert" id="ex_drink" onclick="doCheck('ex_drink','æ—¥é…é£²æ–™')">æ—¥é…é£²æ–™<br><small>å¾…æª¢</small></div>
                <div class="box alert" id="ex_veg" onclick="doCheck('ex_veg','ç”Ÿé®®è”¬èœ')">ç”Ÿé®®è”¬èœ<br><small>å¾…æª¢</small></div>
            </div>

            <div class="head">
                ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸåœ–
                <div id="map-tools" class="hide">
                    <button class="btn-sm btn-g" onclick="addMapBox()">+æ–¹æ ¼</button>
                    <button class="btn-sm btn-o" onclick="resetMapAll()">å…¨é‡ç½®</button>
                </div>
            </div>
            <div id="map-editor" class="hide" style="padding:10px; background:#e0f7fa; border-bottom:1px solid #ccc;">
                <b>é¸å–: <span id="sel-map-name" style="color:red">--</span></b>
                <div style="margin-top:5px; display:flex; gap:3px; flex-wrap:wrap;">
                    <button class="btn-sm" onclick="setMapSize()">ğŸ“ å°ºå¯¸</button>
                    <button class="btn-sm" onclick="setMapDate()">ğŸ“… æ—¥æœŸ</button>
                    <button class="btn-sm" onclick="togglePin()">ğŸ“Œ å›ºå®š</button>
                    <button class="btn-sm" onclick="renMapBox()">âœï¸ æ”¹å</button>
                    <button class="btn-sm" onclick="copyMapBox()">ğŸ“‹ è¤‡è£½</button>
                    <button class="btn-sm btn-r" onclick="delMapBox()">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            </div>
            <div id="map-area"></div>
        </div>

        <div id="v-temp" class="hide">
            <div class="head">â„ï¸ å†°ç®±æº«åº¦æª¢æŸ¥</div>
            <div class="grid" id="fridge-list"></div>
        </div>

        <div id="v-count" class="hide">
            <div style="padding:10px; background:#e8f5e9; text-align:center; margin:10px; border-radius:5px; font-size:12px;">
                ğŸ•’ ä¸Šæ¬¡äº¤ç­: <span id="last-shift-info">ç„¡è¨˜éŒ„</span>
            </div>

            <div class="head">ğŸ“¥ é€²æ«ƒ (ä¸»ç®¡å¯ä¿®)</div>
            <div style="padding:10px; background:#fff; border:1px solid #eee; margin:10px;">
                æ”¶éŠ€ç•™åº•ï¼š<input type="number" id="in-cash" disabled style="width:100px; display:inline-block">
                é‡‘åº«ç•™åº•ï¼š<input type="number" id="in-vault" disabled style="width:100px; display:inline-block">
                <div id="mgr-finance" class="hide" style="margin-top:5px;">
                    <button class="btn-sm btn-o" onclick="unlockIn()">âœï¸ ä¿®æ”¹</button>
                    <button class="btn-sm btn-g" onclick="saveIn()">ğŸ’¾ å„²å­˜</button>
                </div>
            </div>

            <div class="head">ğŸª™ äº¤ç­é»ç®— (å«é‡‘åº«)</div>
            <table>
                <tr><th>é¢é¡</th><th>æ”¶éŠ€æ©Ÿ</th><th>é‡‘åº«</th><th>å°è¨ˆ</th></tr>
                <tbody id="money-table"></tbody>
                <tr><td colspan="3"><b>ç¸½è¨ˆ</b></td><td id="total-money" style="color:blue; font-weight:bold;">0</td></tr>
            </table>

            <div class="head">ğŸ“ é›»è©±å¡</div>
            <div id="card-list" class="grid"></div>

            <div class="head">ğŸ“Š ç‡Ÿæ”¶æ•¸æ“š</div>
            <div class="grid">
                <input type="number" id="v-rev" placeholder="ç‡Ÿæ¥­é¡" oninput="doCalc()">
                <input type="number" id="v-vis" placeholder="ä¾†å®¢æ•¸" oninput="doCalc()">
                <input type="text" id="v-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
            </div>
            
            <div class="head">
                èª¤å·®ï¼š<span id="diff-show" style="font-weight:bold;">0</span>
            </div>
            <button class="btn-g" style="width:100%; margin-top:20px; padding:15px;" onclick="submitShift()">âœ… æäº¤äº¤ç­å ±è¡¨</button>
        </div>

        <div id="v-svc" class="hide">
            <div class="head">ğŸ¤ å®¢æœèˆ‡å…§å‹™</div>
            <div class="grid">
                <button onclick="popSvc('äº¤æ¥')">ğŸ“ äº¤æ¥</button>
                <button onclick="popSvc('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="popSvc('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
                <button onclick="popSvc('è©¢å•')" class="btn-o">â“ è©¢å•</button>
            </div>
            <div id="feed-area" style="margin-top:15px;"></div>
        </div>

        <div id="v-mgr" class="hide">
            <div class="head">ğŸŒŸ å“¡å·¥è©•åˆ†</div>
            <select id="mgr-users"><option>è¼‰å…¥å“¡å·¥...</option></select>
            <div style="padding:15px; background:#fff; margin-top:10px; border:1px solid #ddd;">
                <p>æœå‹™æ…‹åº¦: <span class="stars" data-c="1" onclick="rate(this,event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <p>é™³åˆ—æ•´é½Š: <span class="stars" data-c="2" onclick="rate(this,event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <p>çµå¸³é€Ÿåº¦: <span class="stars" data-c="3" onclick="rate(this,event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <p>å‡ºå‹¤ç‹€æ³: <span class="stars" data-c="4" onclick="rate(this,event)">â˜…â˜…â˜…â˜…â˜…</span></p>
                <button class="btn-g" onclick="saveRating()">é€å‡ºè©•åˆ†</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-form" class="hide" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:flex; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-height:90%; overflow-y:auto; padding:20px; border-radius:8px;">
        <h3 id="modal-title" style="margin-top:0">--</h3>
        <div id="modal-fields"></div>
        <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
            <label>ğŸ“· æ‹ç…§ä¸Šå‚³ï¼š</label>
            <input type="file" id="modal-img" accept="image/*" onchange="previewImg()">
            <img id="preview-box" style="width:100px; display:none; margin-top:5px; border:1px solid #ccc;">
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-g" style="flex:1" onclick="submitSvc()">é€å‡º</button>
            <button style="flex:1; background:#666;" onclick="document.getElementById('modal-form').classList.add('hide')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
// --- DB Core ---
const DB = {
    get: (k) => JSON.parse(localStorage.getItem(k) || '{}'),
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    arr: (k) => JSON.parse(localStorage.getItem(k) || '[]'),
    push: (k, v) => {
        let a = JSON.parse(localStorage.getItem(k) || '[]');
        a.unshift(v);
        localStorage.setItem(k, JSON.stringify(a));
    }
};

// --- Initialization (Fix Data) ---
const initData = () => {
    // Force reset for V40 standards
    if(!localStorage.getItem('v40_stock')) {
        localStorage.setItem('v40_stock', JSON.stringify([
            'å†°ç®±é£²æ–™','å±¤æ¶é£²æ–™','è¸æ¶','é›»æ± ','æ³¡éºµ/é¤…ä¹¾','åƒåœ¾è¢‹/å…æ´—é¤å…·','ç™¾è²¨ç”¨å“(ç‰™è†/æ´—è¡£ç²¾/è¡›ç”Ÿç´™)'
        ]));
    }
    if(!localStorage.getItem('v40_fridge')) {
        localStorage.setItem('v40_fridge', JSON.stringify([
            {n:'é–‹æ”¾å¼å†°ç®±1',t:'c'},{n:'é–‹æ”¾å¼å†°ç®±2',t:'c'},{n:'å†·è—æ«¥æ«ƒ1',t:'c'},{n:'å†·è—æ«¥æ«ƒ2',t:'c'},
            {n:'å†·å‡æ«¥æ«ƒ1',t:'f'},{n:'å†·å‡æ«¥æ«ƒ2',t:'f'},{n:'è‡¥å®¤å†°ç®±1',t:'f'},{n:'è‡¥å®¤å†°ç®±2',t:'f'},{n:'è‡¥å®¤å†°ç®±3',t:'f'},{n:'è‡¥å®¤å†°ç®±4',t:'f'}
        ]));
    }
}
initData();

let me = null;
let shapes = DB.arr('map_shapes');
let selShapeIdx = null;
let imgBase64 = "";
let curFeedId = null;

// --- Auth ---
function swAuth(reg) {
    document.getElementById('box-login').classList.toggle('hide', reg);
    document.getElementById('box-reg').classList.toggle('hide', !reg);
}
function reg() {
    const id=document.getElementById('r-id').value, nm=document.getElementById('r-name').value, pw=document.getElementById('r-pw').value;
    if(!id||!nm||!pw) return alert("è«‹å¡«å¯«å®Œæ•´");
    let u=DB.get('users'); u[id]={name:nm, pw:pw, shift:document.getElementById('r-shift').value}; DB.set('users', u);
    alert("âœ… è¨»å†ŠæˆåŠŸï¼"); swAuth(false);
}
function login() {
    const id=document.getElementById('l-id').value, pw=document.getElementById('l-pw').value;
    let u=DB.get('users');
    if(u[id] && u[id].pw===pw) { me={...u[id], id}; startApp(); } else alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
}
function logout() { location.reload(); }

// --- Start App ---
function startApp() {
    document.getElementById('page-auth').classList.add('hide');
    document.getElementById('page-main').classList.remove('hide');
    document.getElementById('user-info').innerText = `${me.name} (${me.shift})`;

    if(me.shift==='ä¸»ç®¡') {
        document.getElementById('n-mgr').classList.remove('hide');
        document.getElementById('mgr-finance').classList.remove('hide');
        document.getElementById('map-tools').classList.remove('hide');
        document.getElementById('btn-edit-stock').classList.remove('hide');
        document.getElementById('btn-edit-fridge').classList.remove('hide');
        loadUserList();
    }

    renderStock();
    renderFridge();
    renderMoney();
    renderCards();
    renderFeed();
    drawMap();
    renderStatus();
}

// --- Renderers ---
function renderStock() {
    const list = JSON.parse(localStorage.getItem('v40_stock'));
    document.getElementById('stock-list').innerHTML = list.map((s,i) => `
        <div class="box alert" id="stk_${i}" onclick="doCheck('stk_${i}','${s}')">
            ${s}<br><small>å¾…æª¢</small>
            ${me.shift==='ä¸»ç®¡' ? `<div class="reset-btn" onclick="resetCheck('stk_${i}'); event.stopPropagation()">â†»</div>` : ''}
            <div class="del-item-btn" onclick="delConfItem('stock',${i}); event.stopPropagation()">-</div>
        </div>
    `).join('');
}

function renderFridge() {
    const list = JSON.parse(localStorage.getItem('v40_fridge'));
    document.getElementById('fridge-list').innerHTML = list.map((f,i) => `
        <div class="box alert" id="ref_${i}" onclick="doTemp('ref_${i}','${f.n}','${f.t}')">
            ${f.n}<br><small>å¾…æ¸¬</small>
            <div class="del-item-btn" onclick="delConfItem('fridge',${i}); event.stopPropagation()">-</div>
        </div>
    `).join('');
}

function renderStatus() {
    let s = DB.get('status');
    let store = DB.get('store');
    
    for(let k in s) {
        const el = document.getElementById(k);
        if(el && s[k]) {
            el.className = `box ${s[k].alert?'alert':'ok'} ${k.includes('s_')?'priority':''}`;
            el.innerHTML = `${s[k].name}<br><small>${s[k].alert?'âš ï¸ ç•°å¸¸':'âœ… '+s[k].user+' '+s[k].time}</small>
            ${me.shift==='ä¸»ç®¡' ? `<div class="reset-btn" onclick="resetCheck('${k}'); event.stopPropagation()">â†»</div>` : ''}
            <div class="del-item-btn" onclick="delConfItem('${k.includes('stk')?'stock':'fridge'}',${k.split('_')[1]}); event.stopPropagation()">-</div>`;
        }
    }
    
    document.getElementById('in-cash').value = store.cash||0;
    document.getElementById('in-vault').value = store.vault||0;
    if(store.lastShift) document.getElementById('last-shift-info').innerText = `${store.lastShift.user} æ–¼ ${store.lastShift.time}`;
    
    if(store.cards) {
        for(let k in store.cards) {
            let el = document.getElementById(`cd_l_${k}`);
            if(el) el.placeholder = `ä¸Š:${store.cards[k]}`;
        }
    }
}

// --- Interaction Logic ---
function tab(t) {
    document.querySelectorAll('.nav div').forEach(e=>e.classList.remove('active'));
    document.getElementById('n-'+t).classList.add('active');
    ['stock','expiry','temp','count','svc','mgr'].forEach(x=>document.getElementById('v-'+x).classList.add('hide'));
    document.getElementById('v-'+t).classList.remove('hide');
}

// 1. Anti-touch & Check
function doCheck(id, name) {
    let s = DB.get('status');
    if(s[id] && !s[id].alert && !confirm(`æ­¤é …ç›®å·²ç”± ${s[id].user} å®Œæˆã€‚ç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
    if(!s[id] && !confirm(`${name} ç¢ºèªå®Œæˆï¼Ÿ`)) return; // First time check confirmation

    s[id] = {name, user:me.name, time:new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}), alert:false};
    DB.set('status', s);
    renderStatus();
}

// 5. Reset Button Logic
function resetCheck(id) {
    if(!confirm("ç¢ºå®šè¦é‡ç½®æ­¤é …ç›®ç‚ºã€Œæœªå®Œæˆã€ï¼Ÿ")) return;
    let s = DB.get('status');
    delete s[id]; 
    DB.set('status', s);
    // UI Reset
    const el = document.getElementById(id);
    el.className = `box alert ${id.includes('s_')?'priority':''}`;
    // Re-render text logic is complex here, simpler to reload status or hard refresh list
    if(id.includes('stk_')) renderStock();
    else if(id.includes('ref_')) renderFridge();
    else {
        // Hardcoded boxes
        const defaultName = id==='s_noodle'?'å¤–ç±æ³¡éºµ':(id==='s_cookie'?'å¤–ç±é¤…ä¹¾':(id==='ex_bread'?'éºµåŒ…':(id==='ex_drink'?'æ—¥é…é£²æ–™':'ç”Ÿé®®è”¬èœ')));
        el.innerHTML = `${defaultName}<br><small>å¾…è™•ç†</small>
        ${me.shift==='ä¸»ç®¡' ? `<div class="reset-btn" onclick="resetCheck('${id}'); event.stopPropagation()">â†»</div>` : ''}`;
    }
    renderStatus();
}

// 3. Fridge Validation
function doTemp(id, name, type) {
    const v = prompt(`${name} æº«åº¦è¼¸å…¥:`, type==='f'?'-':'');
    if(v === null) return;
    // 3. åš´æ ¼æª¢æŸ¥æ•¸å­—èˆ‡ç¬¦è™Ÿ
    if(v.trim() === "" || v === "-" || isNaN(Number(v))) return alert("âŒ ç„¡æ•ˆè¼¸å…¥ï¼è«‹è¼¸å…¥æ­£ç¢ºæ•¸å­—");
    
    const n = parseFloat(v);
    let alertFlag = false;
    
    if(type==='c' && (n<0 || n>7)) { alert("ğŸš¨ æº«åº¦ç•°å¸¸ (0~7)ï¼"); alertFlag=true; }
    if(type==='f') {
        if(n > -10) { alert("ğŸš¨ æº«åº¦ç•°å¸¸ (éœ€<-10)ï¼"); alertFlag=true; }
        if(n < -30) return alert("âŒ éŒ¯èª¤ï¼šæº«åº¦ä¸å¯èƒ½ä½æ–¼ -30 åº¦");
    }
    
    let s = DB.get('status');
    s[id] = {name, user:me.name, val:v+"Â°C", time:new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}), alert:alertFlag};
    DB.set('status', s);
    renderStatus();
}

// 6. Manager Add/Delete
function toggleEdit(id) {
    document.getElementById(id).classList.toggle('editing');
    document.getElementById(id==='stock-list'?'add-stock-area':'add-fridge-area').classList.toggle('hide');
}
function addItem(type) {
    const key = `v40_${type}`;
    let list = JSON.parse(localStorage.getItem(key));
    const n = prompt("åç¨±:"); if(!n) return;
    if(type==='fridge') {
        const t = prompt("é¡å‹ (c=å†·è—, f=å†·å‡)", "c");
        list.push({n, t});
    } else list.push(n);
    localStorage.setItem(key, JSON.stringify(list));
    startApp();
}
function delConfItem(type, idx) {
    if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
    const key = `v40_${type}`;
    let list = JSON.parse(localStorage.getItem(key));
    list.splice(idx, 1);
    localStorage.setItem(key, JSON.stringify(list));
    startApp();
}

// --- 7. Advanced Map Logic ---
function drawMap() {
    const area = document.getElementById('map-area');
    area.innerHTML = "";
    shapes = DB.arr('map_shapes');
    
    shapes.forEach((s, i) => {
        const el = document.createElement('div');
        el.className = `map-box ${s.done?'done':''} ${selShapeIdx===i?'selected':''} ${s.pinned?'pinned':''}`;
        el.style.left = s.x + 'px';
        el.style.top = s.y + 'px';
        el.style.width = (s.w||60) + 'px';
        el.style.height = (s.h||60) + 'px';
        
        let timerHtml = "";
        if(s.date) {
            const daysLeft = Math.ceil((new Date(s.date) - new Date()) / (1000 * 60 * 60 * 24));
            timerHtml = `<div class="timer-badge" style="background:${daysLeft<3?'red':(daysLeft<7?'orange':'green')}">${daysLeft}å¤©</div>`;
        }

        el.innerHTML = `<span>${s.name}</span>${timerHtml}${s.pinned?'<div class="pin-icon">ğŸ“Œ</div>':''}`;
        
        el.onclick = (e) => {
            e.stopPropagation();
            if(me.shift==='ä¸»ç®¡') {
                selShapeIdx = i;
                document.getElementById('sel-map-name').innerText = s.name;
                document.getElementById('map-editor').classList.remove('hide');
                drawMap();
            } else {
                if(confirm(`${s.name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) { s.done = true; saveMapData(); }
            }
        };

        // Drag (Only if not pinned)
        if(me.shift==='ä¸»ç®¡' && !s.pinned) {
            el.onmousedown = (e) => {
                if(e.target !== el) return;
                const sx = e.clientX - s.x, sy = e.clientY - s.y;
                document.onmousemove = (ev) => { s.x=ev.clientX-sx; s.y=ev.clientY-sy; el.style.left=s.x+'px'; el.style.top=s.y+'px'; };
                document.onmouseup = () => { document.onmousemove=null; saveMapData(); };
            };
        }
        area.appendChild(el);
    });
}

function addMapBox() { const n = prompt("åç¨±:"); if(n) { shapes.push({name:n, x:50, y:50, w:60, h:60, done:false, pinned:false}); saveMapData(); }}
function saveMapData() { localStorage.setItem('map_shapes', JSON.stringify(shapes)); drawMap(); }
function setMapDate() { const d = prompt("åˆ°æœŸæ—¥ (YYYY-MM-DD):"); if(d) { shapes[selShapeIdx].date = d; saveMapData(); }}
function setMapSize() { const w = prompt("å¯¬:", shapes[selShapeIdx].w); const h = prompt("é«˜:", shapes[selShapeIdx].h); if(w&&h) { shapes[selShapeIdx].w=parseInt(w); shapes[selShapeIdx].h=parseInt(h); saveMapData(); }}
function togglePin() { shapes[selShapeIdx].pinned = !shapes[selShapeIdx].pinned; saveMapData(); }
function renMapBox() { const n=prompt("æ–°å"); if(n){ shapes[selShapeIdx].name=n; saveMapData(); }}
function delMapBox() { if(confirm("åˆªé™¤æ­¤æ–¹æ ¼?")) { shapes.splice(selShapeIdx,1); saveMapData(); document.getElementById('map-editor').classList.add('hide'); }}
function copyMapBox() { const s=shapes[selShapeIdx]; shapes.push({...s, x:s.x+20, y:s.y+20}); saveMapData(); }
function resetMapAll() { if(confirm("å…¨é‡ç½®?")) { shapes.forEach(s=>s.done=false); saveMapData(); }}

// --- Finance & Shift ---
function renderMoney() {
    const denoms = [500,100,50,10,5,1];
    document.getElementById('money-table').innerHTML = denoms.map(u => `
        <tr><td>${u}</td>
        <td><input type="number" class="inp-money" id="mr_${u}" oninput="calcMoney()"></td>
        <td><input type="number" class="inp-money" id="mv_${u}" oninput="calcMoney()"></td>
        <td id="sub_${u}" style="font-weight:bold; color:blue;">0</td></tr>
    `).join('');
}
function renderCards() {
    const cards=["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
    document.getElementById('card-list').innerHTML = cards.map(c=>`
        <div class="box" style="display:block; text-align:left; padding:5px;">
            <b>${c}</b>
            <div class="row">
                <input type="number" id="cd_s_${c}" placeholder="éŠ·" style="width:50%"> 
                <input type="number" id="cd_l_${c}" placeholder="å­˜" style="width:50%">
            </div>
        </div>`).join('');
}
function calcMoney() {
    let tot = 0;
    [500,100,50,10,5,1].forEach(u => {
        const r = Number(document.getElementById(`mr_${u}`).value)||0;
        const v = Number(document.getElementById(`mv_${u}`).value)||0;
        const sub = (r+v)*u;
        document.getElementById(`sub_${u}`).innerText = sub;
        tot += sub;
    });
    document.getElementById('total-money').innerText = tot;
    doCalc();
}
function doCalc() {
    const inC = Number(document.getElementById('in-cash').value)||0;
    const inV = Number(document.getElementById('in-vault').value)||0;
    const count = Number(document.getElementById('total-money').innerText)||0;
    const rev = Number(document.getElementById('v-rev').value)||0;
    const vis = Number(document.getElementById('v-vis').value);
    if(vis>0) document.getElementById('v-avg').value = Math.round(rev/vis);
    
    const diff = count - (inC + inV + rev); 
    document.getElementById('diff-show').innerText = diff;
    document.getElementById('diff-show').style.color = diff===0?'green':'red';
}
function submitShift() {
    if(!confirm("ç¢ºå®šæäº¤äº¤ç­ï¼Ÿ")) return;
    let s = DB.get('store');
    s.cash = parseFloat(document.getElementById('total-money').innerText);
    s.lastShift = { user: me.name, time: new Date().toLocaleString() };
    
    let cards = {};
    ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"].forEach(c => {
        cards[c] = document.getElementById(`cd_l_${c}`).value || 0;
    });
    s.cards = cards;
    
    DB.set('store', s);
    alert("âœ… äº¤ç­æˆåŠŸï¼");
    location.reload();
}
function unlockIn() { document.getElementById('in-cash').disabled=false; document.getElementById('in-vault').disabled=false; }
function saveIn() { 
    let s = DB.get('store'); 
    s.cash=document.getElementById('in-cash').value; 
    s.vault=document.getElementById('in-vault').value; 
    DB.set('store', s); 
    alert("å·²å„²å­˜"); 
}
function addEx(type) {
    const a=prompt("é‡‘é¡"), t=prompt("å‚™è¨»");
    if(a) { exArr.push({type, amt:Number(a), txt:t}); document.getElementById('ex-list').innerHTML += `<div style="color:${type==='in'?'green':'red'}">${type==='in'?'æ”¶':'æ”¯'} $${a} (${t})</div>`; }
}

// --- Service ---
let curSvcType=""; 
function popSvc(t) {
    curSvcType=t; document.getElementById('modal-form').classList.remove('hide');
    document.getElementById('modal-title').innerText=t;
    const f=document.getElementById('modal-fields');
    curFeedId = null; 
    imgBase64=""; document.getElementById('preview-box').style.display='none';
    document.getElementById('modal-img').value="";

    if(t==='å®¢è¨‚') f.innerHTML=`<input id="f1" placeholder="å“å"><input id="f2" placeholder="æ¢ç¢¼"><input id="f3" placeholder="æ•¸é‡"><input id="f4" placeholder="å”®åƒ¹"><hr><input id="f5" placeholder="å®¢å"><input id="f6" placeholder="é›»è©±"><input id="f7" placeholder="LINE"><input id="f8" placeholder="æ™‚é–“">`;
    else if(t==='ç¶­ä¿®') f.innerHTML=`<input id="f1" placeholder="å“å"><input id="f2" placeholder="åŸå› "><input id="f3" placeholder="è³¼è²·æ—¥"><input id="f4" placeholder="æ¢ç¢¼"><hr><input id="f5" placeholder="å®¢å"><input id="f6" placeholder="é›»è©±"><input id="f7" placeholder="LINE"><input id="f8" placeholder="æ™‚é–“">`;
    else f.innerHTML=`<textarea id="f1" placeholder="è«‹è¼¸å…¥å…§å®¹..." style="height:100px"></textarea>`;
}

function previewImg() {
    const file = document.getElementById('modal-img').files[0];
    if(file) {
        const r = new FileReader();
        r.onload = e => { imgBase64 = e.target.result; document.getElementById('preview-box').src = imgBase64; document.getElementById('preview-box').style.display='block'; };
        r.readAsDataURL(file);
    }
}

function submitSvc() {
    let txt=""; document.querySelectorAll('#modal-fields input, #modal-fields textarea').forEach(i=>{ if(i.value) txt+=`${i.placeholder}: ${i.value}<br>`; });
    if(!txt && !imgBase64) return alert("âŒ ç©ºç™½ç„¡æ³•é€å‡º");
    
    let feeds = DB.arr('feeds');
    if(curFeedId !== null) {
        feeds[curFeedId].txt = txt;
        if(imgBase64) feeds[curFeedId].img = imgBase64;
    } else {
        feeds.unshift({type:curSvcType, txt, img:imgBase64, user:me.name, time:new Date().toLocaleString(), done:false});
    }
    localStorage.setItem('feeds', JSON.stringify(feeds));
    alert("âœ… æˆåŠŸ"); document.getElementById('modal-form').classList.add('hide'); renderFeed();
}

function renderFeed() {
    const d=document.getElementById('feed-area'); d.innerHTML="";
    const feeds = DB.arr('feeds');
    let unread=0;
    
    feeds.forEach((f,i)=>{
        if(!f.done) unread++;
        const canEdit = (me.shift==='ä¸»ç®¡' || me.name===f.user);
        
        // 4. Background Color for status
        d.innerHTML += `
            <div class="feed-item ${f.done?'done':'pending'}">
                <div class="feed-meta"><span>${f.type} | ${f.user}</span> <span>${f.time}</span></div>
                <div>${f.txt}</div>
                ${f.img ? `<img src="${f.img}" style="width:80px; margin-top:5px; cursor:pointer; border-radius:4px;" onclick="zoom('${f.img}')">` : ''}
                <div style="margin-top:5px; text-align:right;">
                    ${canEdit ? `<button class="btn-sm btn-o" onclick="editFeed(${i})">ç·¨è¼¯</button> <button class="btn-sm btn-r" onclick="delFeed(${i})">åˆªé™¤</button>` : ''}
                    <button class="btn-sm btn-g" onclick="toggleFeed(${i})">${f.done?'é‡é–‹':'å®Œæˆ'}</button>
                </div>
            </div>`;
    });
    const b = document.getElementById('badge');
    b.innerText = unread;
    b.style.display = unread>0 ? 'block' : 'none';
}

function toggleFeed(i) {
    if(!confirm("ç¢ºå®šè®Šæ›´ç‹€æ…‹ï¼Ÿ")) return;
    let fs=DB.arr('feeds'); fs[i].done=!fs[i].done; localStorage.setItem('feeds', JSON.stringify(fs)); renderFeed();
}
function delFeed(i) {
    if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
    let fs=DB.arr('feeds'); fs.splice(i,1); localStorage.setItem('feeds', JSON.stringify(fs)); renderFeed();
}
function editFeed(i) {
    let fs=DB.arr('feeds'); curFeedId = i; popSvc(fs[i].type);
    // Simple mock load, normally you'd parse back
}

function gotoSvc() { tab('svc'); }
function zoom(s) { document.getElementById('big-img').src=s; document.getElementById('img-overlay').classList.add('show'); }
function closeZoom() { document.getElementById('img-overlay').classList.remove('show'); }

// --- 8. Ratings ---
function loadUserList() {
    const u = DB.get('users');
    const s = document.getElementById('mgr-users');
    for(let k in u) if(u[k].shift!=='ä¸»ç®¡') { let o=document.createElement('option'); o.value=k; o.innerText=u[k].name; s.appendChild(o); }
}
function rate(span,e) { span.parentNode.querySelectorAll('span').forEach((s,i)=>s.className=i<e.target.cellIndex?'gold':''); }
function saveRating() {
    const uid = document.getElementById('mgr-users').value;
    if(!uid || uid === "è¼‰å…¥å“¡å·¥...") return alert("è«‹é¸æ“‡å“¡å·¥");
    alert("è©•åˆ†å·²å„²å­˜ï¼");
}
</script>
</body>
</html>