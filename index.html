<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§åº—å‹™ç³»çµ± V11 (æ­£å¼æ•´åˆç‰ˆ)</title>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background: #f0f2f5; padding-bottom: 90px;}
        .container { padding: 15px; max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; }
        
        /* è¨»å†Šèˆ‡ç™»å…¥ */
        #auth-screen { padding: 40px 20px; text-align: center; }
        .auth-box { background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 10px; text-align: left; }
        
        /* å°èˆªåˆ‡æ› */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .nav-item { flex: 0 0 auto; padding: 15px 20px; cursor: pointer; color: #666; font-weight: bold; border-bottom: 4px solid transparent; white-space: nowrap;}
        .nav-item.active { color: #007bff; border-bottom-color: #007bff; background: #f8f9fa; }

        /* å¤–ç±é£Ÿå“ç‰¹æ®Šè‰² */
        .highlight-foreign { background: #f3e5f5 !important; border: 2px solid #6f42c1 !important; color: #5e35b1 !important; font-weight: bold; }

        /* æ¨¡å‹åœ–å½¢ç‹€æ¨£å¼ */
        #shelf-canvas { border: 2px solid #333; position: relative; width: 100%; height: 300px; background: #fafafa; overflow: hidden; }
        .shelf-shape { position: absolute; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 2px solid #333; }
        .shape-square { border-radius: 0; }
        .shape-circle { border-radius: 50%; }
        .shape-triangle { width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom: 50px solid #ccc; background: transparent !important; border-top: none; }
        .shelf-shape.checked { background: #d4edda !important; border-color: #28a745 !important; }

        /* é€šç”¨å…ƒä»¶ */
        .section-header { background: #e9ecef; padding: 10px; margin: 15px -15px; font-weight: bold; border-left: 5px solid #007bff; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px 5px; text-align: center; cursor: pointer; min-height: 70px; }
        .zone.ok { background: #d4edda; border-color: #28a745; }
        .zone.warning { background: #fff3cd; border-color: #dc3545; animation: flash 1s infinite; }
        @keyframes flash { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }
        
        input, select, button { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }

        /* å ±è¡¨æ¨£å¼ */
        .report-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 14px; }
        .report-row input { width: 100px; text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-screen">
        <div class="auth-box">
            <h2 id="auth-title">ğŸª é–€å¸‚ç³»çµ±ç™»å…¥</h2>
            <div id="login-area">
                <input type="text" id="login-id" placeholder="å¸³è™Ÿ (æ‰‹æ©Ÿæˆ–åºè™Ÿ)">
                <input type="password" id="login-pw" placeholder="å¯†ç¢¼">
                <button onclick="handleLogin()">ç™»å…¥</button>
                <p style="font-size:12px; color:#666;" onclick="toggleAuth(true)">æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š</p>
            </div>
            <div id="register-area" class="hidden">
                <input type="text" id="reg-name" placeholder="çœŸå¯¦å§“å">
                <select id="reg-shift">
                    <option value="æ—©ç­">æ—©ç­</option>
                    <option value="æ™šç­">æ™šç­</option>
                    <option value="ä¸»ç®¡">ä¸»ç®¡</option>
                </select>
                <input type="text" id="reg-id" placeholder="è¨­å®šå¸³è™Ÿ">
                <input type="password" id="reg-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button onclick="handleRegister()" style="background:#28a745;">å®Œæˆè¨»å†Š</button>
                <p style="font-size:12px; color:#666;" onclick="toggleAuth(false)">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div style="background:#333; color:white; padding:10px; margin:-15px -15px 10px -15px; display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ‘¤ <span id="display-name">--</span> (<span id="display-shift">--</span>)</span>
            <span>ğŸ† <span id="display-points">0</span> pt</span>
            <button onclick="location.reload()" style="width:auto; padding:5px; font-size:10px;">ç™»å‡º</button>
        </div>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±</div>
            <div class="nav-item" onclick="switchTab('stock')">ğŸ“¦ æ•ˆæœŸè£œè²¨</div>
            <div class="nav-item" onclick="switchTab('counter')">ğŸ’° å¸³å‹™</div>
            <div class="nav-item" onclick="switchTab('service')">ğŸ’ å®¢æœ</div>
            <div class="nav-item" onclick="switchTab('handover')">ğŸ¤ äº¤æ¥</div>
            <div class="nav-item hidden" id="nav-mgr" onclick="switchTab('manager')">ğŸ“Š æ•¸æ“š</div>
        </div>

        <div id="tab-temp">
            <div class="section-header">â„ï¸ å†·è—å†°ç®± (0~7åº¦)</div>
            <div class="grid-box">
                <div class="zone" id="f-o-1" onclick="checkTemp('f-o-1','é–‹æ”¾å¼1','chiller')">é–‹æ”¾å¼1<small>--</small></div>
                <div class="zone" id="f-o-2" onclick="checkTemp('f-o-2','é–‹æ”¾å¼2','chiller')">é–‹æ”¾å¼2<small>--</small></div>
                <div class="zone" id="f-c-1" onclick="checkTemp('f-c-1','å†·è—1','chiller')">å†·è—1<small>--</small></div>
                <div class="zone" id="f-c-2" onclick="checkTemp('f-c-2','å†·è—2','chiller')">å†·è—2<small>--</small></div>
            </div>
            <div class="section-header">ğŸ§Š å†·å‡/è‡¥å¼å†°ç®± (<-10åº¦)</div>
            <div class="grid-box">
                <div class="zone" id="f-f-1" onclick="checkTemp('f-f-1','å†·å‡1','freezer')">å†·å‡1<small>--</small></div>
                <div class="zone" id="f-f-2" onclick="checkTemp('f-f-2','å†·å‡2','freezer')">å†·å‡2<small>--</small></div>
                <div class="zone" id="f-w-1" onclick="checkTemp('f-w-1','è‡¥å¼1','freezer')">è‡¥å¼1<small>--</small></div>
                <div class="zone" id="f-w-2" onclick="checkTemp('f-w-2','è‡¥å¼2','freezer')">è‡¥å¼2<small>--</small></div>
                <div class="zone" id="f-w-3" onclick="checkTemp('f-w-3','è‡¥å¼3','freezer')">è‡¥å¼3<small>--</small></div>
                <div class="zone" id="f-w-4" onclick="checkTemp('f-w-4','è‡¥å¼4','freezer')">è‡¥å¼4<small>--</small></div>
            </div>
        </div>

        <div id="tab-stock" class="hidden">
            <div class="section-header">ğŸ“… æ¯æ—¥æ•ˆæœŸ/é®®åº¦</div>
            <div class="grid-box">
                <div class="zone" id="chk-1" onclick="checkStock('chk-1','æ—¥é…é£²æ–™')">æ—¥é…é£²æ–™</div>
                <div class="zone" id="chk-2" onclick="checkStock('chk-2','ç”Ÿé®®è”¬èœ')">ç”Ÿé®®è”¬èœ</div>
                <div class="zone" id="chk-3" onclick="checkStock('chk-3','éºµåŒ…æ•ˆæœŸ')">éºµåŒ…æ•ˆæœŸ</div>
            </div>
            <div class="section-header">ğŸ›’ è£œè²¨æª¢æŸ¥</div>
            <div class="grid-box">
                <div class="zone" id="stk-1" onclick="checkStock('stk-1','è¸æ¶')">è¸æ¶</div>
                <div class="zone" id="stk-2" onclick="checkStock('stk-2','å†°ç®±é£²æ–™')">å†°ç®±é£²æ–™</div>
                <div class="zone" id="stk-3" onclick="checkStock('stk-3','å±¤æ¶é£²æ–™')">å±¤æ¶é£²æ–™</div>
                <div class="zone highlight-foreign" id="stk-4" onclick="checkStock('stk-4','å¤–ç±æ³¡éºµ')">â˜…å¤–ç±æ³¡éºµâ˜…</div>
                <div class="zone highlight-foreign" id="stk-5" onclick="checkStock('stk-5','å¤–ç±é¤…ä¹¾')">â˜…å¤–ç±é¤…ä¹¾â˜…</div>
                <div class="zone" id="stk-6" onclick="checkStock('stk-6','å†·å‡é£Ÿå“')">å†·å‡é£Ÿå“</div>
                <div class="zone" id="stk-7" onclick="checkStock('stk-7','åƒåœ¾è¢‹')">åƒåœ¾è¢‹</div>
                <div class="zone" id="stk-8" onclick="checkStock('stk-8','å…æ´—é¤å…·')">å…æ´—é¤å…·</div>
            </div>
            <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸ (æ¨¡å‹åœ–)</div>
            <div id="shelf-canvas">
                </div>
            <div id="mgr-tools" class="hidden" style="display:flex; gap:5px; margin-top:5px;">
                <button onclick="addShape('square')" style="font-size:10px;">+æ–¹å¡Š</button>
                <button onclick="addShape('circle')" style="font-size:10px;">+åœ“å½¢</button>
                <button onclick="saveMap()" style="font-size:10px; background:green;">å„²å­˜åœ°åœ–</button>
            </div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header">ğŸ’° å¸³å‹™å ±è¡¨</div>
            <div style="background:#f8f9fa; padding:10px; border-radius:5px;">
                <div class="report-row"><b>é€²æ«ƒç¸½ç¾é‡‘</b><input type="number" id="cash-in"></div>
                <hr>
                <div class="report-row">ç‡Ÿæ¥­é¡<input type="number" id="sales-total"></div>
                <div class="report-row">ä¿¡ç”¨å¡<input type="number" id="sales-credit"></div>
                <div class="report-row">å°ç£Pay<input type="number" id="sales-twpay"></div>
                <div class="report-row">LinePay<input type="number" id="sales-linepay"></div>
                <div class="report-row">é»æ•¸æŠ˜æŠµ<input type="number" id="sales-points"></div>
                <div class="report-row">ç¾é‡‘é€€æ¬¾<input type="number" id="sales-refund"></div>
                <hr>
                <div class="report-row">é›¢æ«ƒé›¶éŒ¢<input type="number" id="cash-out"></div>
                <div class="report-row">åƒéˆ”æŠ½é›¢<input type="number" id="cash-1000"></div>
                <button onclick="calculateDiff()" style="background:#ffc107; color:black;">è©¦ç®—èª¤å·®</button>
                <h3 style="text-align:center;">èª¤å·®ï¼š<span id="diff-res">0</span></h3>
                <button onclick="submitFinalReport()" style="background:green;">æäº¤æ­£å¼å ±è¡¨</button>
            </div>
        </div>

        <div id="tab-service" class="hidden">
            <div class="grid-box">
                <div class="zone" onclick="svcForm('å®¢äººè©¢å•')">å®¢äººè©¢å•/æ‹ç…§</div>
                <div class="zone" onclick="svcForm('å•†å“å”®ç½„')">å•†å“å”®ç½„é€šçŸ¥</div>
                <div class="zone" onclick="svcForm('å®¢è¨‚è³‡æ–™')">å®¢è¨‚è³‡æ–™</div>
                <div class="zone" onclick="svcForm('é›»å™¨ç¶­ä¿®')">é›»å™¨ç¶­ä¿®</div>
            </div>
        </div>
        
        <div id="tab-handover" class="hidden">
            <input type="text" id="task-input" placeholder="è¼¸å…¥äº¤æ¥äº‹é …...">
            <button onclick="addTask()">ç™¼å¸ƒä»»å‹™</button>
            <div id="task-list" style="margin-top:10px;"></div>
        </div>

        <div id="tab-manager" class="hidden">
            <div class="section-header">ğŸ“Š ä¸»ç®¡æ•¸æ“šåˆ†æ</div>
            <div id="mgr-stats">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>

<script type="module">
    // --- Firebase æ ¸å¿ƒ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73",
        measurementId: "G-M4169BDVH5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; window.setDoc = setDoc; window.addDoc = addDoc; window.doc = doc; window.getDoc = getDoc;

    // --- èªè­‰é‚è¼¯ ---
    window.toggleAuth = (reg) => {
        document.getElementById('login-area').classList.toggle('hidden', reg);
        document.getElementById('register-area').classList.toggle('hidden', !reg);
        document.getElementById('auth-title').innerText = reg ? "ğŸ†• è¨»å†Šæ–°å¤¥ä¼´" : "ğŸª é–€å¸‚ç³»çµ±ç™»å…¥";
    };

    window.handleRegister = async () => {
        const user = {
            name: document.getElementById('reg-name').value,
            shift: document.getElementById('reg-shift').value,
            id: document.getElementById('reg-id').value,
            pw: document.getElementById('reg-pw').value,
            points: 0
        };
        if(!user.id || !user.pw) return alert("è«‹å¡«å¯«å¸³å¯†");
        await setDoc(doc(db, "users", user.id), user);
        alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼");
        toggleAuth(false);
    };

    window.handleLogin = async () => {
        const id = document.getElementById('login-id').value;
        const pw = document.getElementById('login-pw').value;
        const snap = await getDoc(doc(db, "users", id));
        if(snap.exists() && snap.data().pw === pw) {
            window.user = snap.data();
            startApp();
        } else {
            alert("å¸³å¯†éŒ¯èª¤");
        }
    };

    function startApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('display-name').innerText = window.user.name;
        document.getElementById('display-shift').innerText = window.user.shift;
        document.getElementById('display-points').innerText = window.user.points;
        if(window.user.shift === 'ä¸»ç®¡') document.getElementById('nav-mgr').classList.remove('hidden');
        loadMap();
        listenUpdates();
    }

    // --- æ ¸å¿ƒæ›´æ–°ç›£è½ ---
    function listenUpdates() {
        // ä»»å‹™ç›£è½
        onSnapshot(query(collection(db, "tasks"), orderBy("time", "desc"), limit(10)), (snap) => {
            const list = document.getElementById('task-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                list.innerHTML += `<div style="background:#fff; padding:10px; border-radius:5px; margin-bottom:5px; border-left:4px solid ${t.done?'#28a745':'#ffc107'}">
                    <b>${t.msg}</b> <small>(${t.user})</small>
                </div>`;
            });
        });
        // æ ¼å­ç‹€æ…‹ç›£è½
        const ids = ['f-o-1','f-o-2','f-c-1','f-c-2','f-f-1','f-f-2','f-w-1','f-w-2','f-w-3','f-w-4','chk-1','chk-2','chk-3','stk-1','stk-2','stk-3','stk-4','stk-5','stk-6','stk-7','stk-8'];
        ids.forEach(id => {
            onSnapshot(doc(db, "checks", id), (snap) => {
                if(snap.exists()){
                    const d = snap.data();
                    const el = document.getElementById(id);
                    el.className = `zone ${d.status==='ç•°å¸¸'?'warning':'ok'} ${id==='stk-4'||id==='stk-5'?'highlight-foreign':''}`;
                    el.querySelector('small').innerText = `âœ… ${d.val} (${d.user})`;
                }
            });
        });
    }

    // --- æ¨¡å‹åœ–é‚è¼¯ ---
    let shapes = [];
    window.addShape = (type) => {
        const name = prompt("å€å¡Šåç¨± (å¦‚ï¼šé£²æ–™1æ¶)");
        if(!name) return;
        const shape = { id: Date.now(), type, name, x: 50, y: 50, checked: false };
        shapes.push(shape);
        renderShapes();
    };

    function renderShapes() {
        const container = document.getElementById('shelf-canvas');
        container.innerHTML = "";
        shapes.forEach(s => {
            const div = document.createElement('div');
            div.className = `shelf-shape shape-${s.type} ${s.checked?'checked':''}`;
            div.style.left = s.x + "px"; div.style.top = s.y + "px";
            div.style.width = "60px"; div.style.height = "60px";
            div.innerText = s.name;
            if(window.user.shift === 'ä¸»ç®¡') {
                div.onmousedown = (e) => dragStart(e, s);
            } else {
                div.onclick = () => toggleShelf(s);
            }
            container.appendChild(div);
        });
    }

    async function loadMap() {
        const snap = await getDoc(doc(db, "settings", "map"));
        if(snap.exists()) {
            shapes = snap.data().shapes;
            renderShapes();
        }
    }

    window.saveMap = async () => {
        await setDoc(doc(db, "settings", "map"), { shapes });
        alert("åœ°åœ–å„²å­˜æˆåŠŸ");
    };

    function toggleShelf(s) {
        s.checked = !s.checked;
        renderShapes();
        // ç´€éŒ„æ—¥èªŒ
        addDoc(collection(db, "logs"), { type: 'æ¯æœˆæ•ˆæœŸ', item: s.name, user: window.user.name, time: new Date() });
    }

    // --- å†°ç®±/è£œè²¨é‚è¼¯ ---
    window.checkTemp = async (id, name, type) => {
        const val = prompt(`${name} æº«åº¦ï¼š`);
        if(!val) return;
        const num = parseFloat(val);
        let status = "æ­£å¸¸";
        if(type === 'freezer' && num > -10) {
            status = "ç•°å¸¸";
            alert("âš ï¸âš ï¸ è­¦å‘Šï¼šå†·å‡æº«åº¦ç•°å¸¸ï¼å·²é€šå ±ä¸»ç®¡ï¼");
        }
        if(type === 'chiller' && (num < 0 || num > 7)) status = "ç•°å¸¸";
        await setDoc(doc(db, "checks", id), { val: num+"åº¦", status, user: window.user.name, time: new Date() });
        await addDoc(collection(db, "logs"), { type: 'å†°ç®±', item: name, val: num, status, user: window.user.name, time: new Date() });
    };

    window.checkStock = async (id, name) => {
        if(confirm(`${name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
            await setDoc(doc(db, "checks", id), { val: "OK", status: "æ­£å¸¸", user: window.user.name, time: new Date() });
        }
    };
</script>

<script>
    // --- ä¸€èˆ¬ UI é‚è¼¯ ---
    function switchTab(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
        if(window.user && window.user.shift === 'ä¸»ç®¡') document.getElementById('mgr-tools').classList.remove('hidden');
    }

    function calculateDiff() {
        const inCash = parseFloat(document.getElementById('cash-in').value) || 0;
        const sales = parseFloat(document.getElementById('sales-total').value) || 0;
        const deduct = (parseFloat(document.getElementById('sales-credit').value)||0) +
                       (parseFloat(document.getElementById('sales-twpay').value)||0) +
                       (parseFloat(document.getElementById('sales-linepay').value)||0) +
                       (parseFloat(document.getElementById('sales-points').value)||0) +
                       (parseFloat(document.getElementById('sales-refund').value)||0);
        const out = parseFloat(document.getElementById('cash-out').value) || 0;
        const thousand = (parseFloat(document.getElementById('cash-1000').value) || 0) * 1000;
        
        // å…¬å¼ï¼š(((é€²æ«ƒ+ç‡Ÿæ”¶-æ‰£é …)-é›¢æ«ƒ-åƒéˆ”)*-1)
        const diff = ((inCash + (sales - deduct)) - out - thousand) * -1;
        document.getElementById('diff-res').innerText = diff;
    }
</script>
</body>
</html>