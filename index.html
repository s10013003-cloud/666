<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é–€å¸‚ç³»çµ± V27 (é˜²å´©æ½°ç‰ˆ)</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            alert("ç³»çµ±éŒ¯èª¤: " + msg + "\nè¡Œæ•¸: " + line);
            return true;
        };
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; }
        
        /* èªè­‰å€å¡Š */
        .auth-box { padding: 40px 20px; text-align: center; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* å°èˆª */
        .nav { display: flex; position: sticky; top: 0; background: #fff; border-bottom: 3px solid #ddd; z-index: 1000; }
        .nav div { flex: 1; padding: 15px 0; text-align: center; font-weight: bold; color: #666; cursor: pointer; }
        .nav div.active { color: #007bff; border-bottom: 3px solid #007bff; background: #f0f8ff; }

        /* æ ¼å­èˆ‡æŒ‰éˆ• */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
        .box { border: 2px solid #ddd; padding: 15px 5px; text-align: center; border-radius: 8px; cursor: pointer; background: #fff; min-height: 60px; }
        .box.ok { background: #d4edda !important; border-color: #28a745 !important; }
        .foreign { background: #f3e5f5; border: 2px solid #9c27b0; color: #6a1b9a; font-weight: bold; }

        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #999; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-g { background: #28a745; } .btn-r { background: #dc3545; } .btn-o { background: #fd7e14; }
        .hide { display: none !important; }

        /* å¸³å‹™è¡¨ */
        table { width: 100%; border-collapse: collapse; }
        td, th { border: 1px solid #ddd; padding: 5px; text-align: center; }
        .inp-m { width: 60px; text-align: center; padding: 5px; }
    </style>
</head>
<body>

<div style="position:fixed; top:10px; right:10px; font-size:24px; background:white; border-radius:50%; padding:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:2000;" onclick="showNoti()">ğŸ””<span id="badge" style="background:red; color:white; font-size:10px; border-radius:50%; padding:2px 5px; position:absolute; top:0; right:0; display:none;">0</span></div>

<div class="container">
    <div id="p-auth" class="auth-box">
        <div class="card">
            <h2>ğŸª é–€å¸‚ V27 (é˜²å´©æ½°ç‰ˆ)</h2>
            <div id="b-login">
                <input id="lid" placeholder="å¸³è™Ÿ">
                <input id="lpw" type="password" placeholder="å¯†ç¢¼">
                <button onclick="login()">ç™»å…¥</button>
                <p onclick="swAuth(true)" style="color:blue; margin-top:15px; cursor:pointer;">è¨»å†Š</p>
            </div>
            <div id="b-reg" class="hide">
                <input id="rid" placeholder="è¨­å®šå¸³è™Ÿ">
                <input id="rnm" placeholder="å§“å">
                <select id="rsf"><option>æ—©ç­</option><option>æ™šç­</option><option>ä¸»ç®¡</option></select>
                <input id="rpw" type="password" placeholder="è¨­å®šå¯†ç¢¼">
                <button class="btn-g" onclick="reg()">ç¢ºèªè¨»å†Š</button>
                <p onclick="swAuth(false)" style="color:blue; margin-top:15px; cursor:pointer;">è¿”å›</p>
            </div>
        </div>
    </div>

    <div id="p-main" class="hide">
        <div style="background:#333; color:white; padding:10px; display:flex; justify-content:space-between;">
            <span id="u-info">--</span>
            <button onclick="logout()" style="width:auto; padding:5px 10px; background:#555;">ç™»å‡º</button>
        </div>

        <div class="nav">
            <div onclick="go('stock')" id="n-stock" class="active">è£œè²¨</div>
            <div onclick="go('temp')" id="n-temp">å†°ç®±</div>
            <div onclick="go('count')" id="n-count">å¸³å‹™</div>
            <div onclick="go('svc')" id="n-svc">äº¤æ¥</div>
        </div>

        <div id="v-stock">
            <div style="padding:10px; background:#f3e5f5; color:#4a148c; font-weight:bold;">ğŸ”¥ é‡é»æª¢æŸ¥</div>
            <div class="grid">
                <div class="box foreign" id="s-noodle" onclick="chk('s-noodle','å¤–ç±æ³¡éºµ')">å¤–ç±æ³¡éºµ</div>
                <div class="box foreign" id="s-cookie" onclick="chk('s-cookie','å¤–ç±é¤…ä¹¾')">å¤–ç±é¤…ä¹¾</div>
            </div>
            <div style="padding:10px; background:#eee;">ğŸ“… æ¯æ—¥æ•ˆæœŸ</div>
            <div class="grid">
                <div class="box" id="c-f" onclick="chk('c-f','ç”Ÿé®®æ•ˆæœŸ')">ç”Ÿé®®æ•ˆæœŸ</div>
                <div class="box" id="c-d" onclick="chk('c-d','æ—¥é…æ•ˆæœŸ')">æ—¥é…æ•ˆæœŸ</div>
                <div class="box" id="c-b" onclick="chk('c-b','éºµåŒ…æ•ˆæœŸ')">éºµåŒ…æ•ˆæœŸ</div>
            </div>
            <div style="padding:10px; background:#eee;">ğŸ›’ æ¯æ—¥è£œè²¨</div>
            <div class="grid">
                <div class="box" id="s-c" onclick="chk('s-c','è¸æ¶')">è¸æ¶</div>
                <div class="box" id="s-d" onclick="chk('s-d','å†°ç®±é£²æ–™')">å†°ç®±é£²æ–™</div>
                <div class="box" id="s-sd" onclick="chk('s-sd','å±¤æ¶é£²æ–™')">å±¤æ¶é£²æ–™</div>
                <div class="box" id="s-fr" onclick="chk('s-fr','å†·å‡é£Ÿå“')">å†·å‡é£Ÿå“</div>
                <div class="box" id="s-tr" onclick="chk('s-tr','åƒåœ¾è¢‹/å…æ´—')">åƒåœ¾è¢‹/å…æ´—</div>
                <div class="box" id="s-ti" onclick="chk('s-ti','è¡›ç”Ÿç´™')">è¡›ç”Ÿç´™</div>
            </div>
            <div style="padding:10px; background:#eee;">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸåœ–</div>
            <div id="mgr-tool" class="hide" style="padding:5px;">
                <button onclick="addBox()" style="width:auto;">+æ–¹å¡Š</button>
                <button onclick="saveMap()" class="btn-g" style="width:auto;">ç™¼å¸ƒ</button>
                <button onclick="delBox()" class="btn-r" style="width:auto;">åˆªé™¤</button>
            </div>
            <div id="shelf-canvas" style="height:300px; background:#ddd; position:relative; margin:10px; border:2px solid #333;"></div>
        </div>

        <div id="v-temp" class="hide">
            <div style="padding:10px; background:#e0f7fa;">â„ï¸ å†·è—å€ (0~7)</div>
            <div class="grid" id="g-c"></div>
            <div style="padding:10px; background:#e1f5fe;">ğŸ§Š å†·å‡å€ (<-10)</div>
            <div class="grid" id="g-f"></div>
        </div>

        <div id="v-count" class="hide">
            <div style="padding:10px; background:#fff3e0;">ğŸ“¥ é€²æ«ƒ (ä¸Šä¸€ç­)</div>
            <div style="padding:10px;">
                æ”¶éŠ€ï¼š<input id="in-c" disabled style="width:80px;"> 
                åº«å­˜ï¼š<input id="in-s" disabled style="width:80px;">
                <button id="btn-edit-in" class="hide" onclick="editIn()" style="width:auto; font-size:12px;">ä¿®æ”¹</button>
            </div>
            <div style="padding:10px; background:#e8f5e9;">ğŸª™ é›¢æ«ƒé»ç®—</div>
            <table id="m-table"></table>
            <div style="text-align:right; padding:10px; font-weight:bold; color:blue;">ç¸½è¨ˆ: $<span id="all-sum">0</span></div>
            
            <div style="padding:10px; background:#eee;">ğŸ“Š ç‡Ÿæ”¶</div>
            <input type="number" id="v-sales" placeholder="ç‡Ÿæ¥­é¡" oninput="doAvg()">
            <input type="number" id="v-visit" placeholder="ä¾†å®¢æ•¸" oninput="doAvg()">
            <input type="text" id="v-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
            
            <div style="padding:10px;">
                <button class="btn-g" onclick="addEx('in')">+æ”¶å…¥</button>
                <button class="btn-r" onclick="addEx('out')">+æ”¯å‡º</button>
                <div id="ex-list"></div>
            </div>

            <div style="text-align:center; padding:20px;">
                <h3 id="diff-show">èª¤å·®ï¼š0</h3>
                <button class="btn-o" onclick="doCalc()">è©¦ç®—èª¤å·®</button>
                <button class="btn-g" onclick="subRep()">æäº¤å ±è¡¨</button>
            </div>
        </div>

        <div id="v-svc" class="hide">
            <div class="grid">
                <button onclick="pop('äº¤æ¥')">äº¤æ¥</button>
                <button onclick="pop('å®¢è¨‚')">å®¢è¨‚</button>
                <button onclick="pop('ç¶­ä¿®')">ç¶­ä¿®</button>
                <button onclick="pop('å”®ç½„')">å”®ç½„</button>
                <button onclick="pop('å ±å»¢')">å ±å»¢</button>
            </div>
            <div id="feed" style="margin-top:10px;"></div>
        </div>
        
        <div id="v-mgr" class="hide">
            <div style="padding:10px; font-weight:bold;">ğŸŒŸ è©•åˆ†</div>
            <select id="mgr-target"><option>é¸å“¡å·¥</option></select>
            <button onclick="saveScore()">å„²å­˜è©•åˆ†</button>
        </div>
    </div>
</div>

<div id="pop-f" class="hide" style="position:fixed; top:20%; left:5%; width:90%; background:white; border:2px solid blue; padding:20px; z-index:3000;">
    <h3 id="pop-t"></h3>
    <div id="pop-i"></div>
    <input type="file" id="pop-p" accept="image/*">
    <button class="btn-g" onclick="send()">é€å‡º</button>
    <button onclick="document.getElementById('pop-f').classList.add('hide')"