<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–€å¸‚ç‡Ÿé‹æˆ°æƒ…ç³»çµ± V13</title>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background: #f0f2f5; padding-bottom: 90px; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; }
        
        /* å°èˆª */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .nav-item { flex: 0 0 auto; padding: 12px 15px; cursor: pointer; color: #666; font-weight: bold; border-bottom: 4px solid transparent; white-space: nowrap;}
        .nav-item.active { color: #007bff; border-bottom-color: #007bff; background: #f8f9fa; }

        /* è©•åˆ†æ˜Ÿæ˜Ÿ */
        .star-rating { color: #ddd; cursor: pointer; font-size: 25px; }
        .star-rating.selected { color: #ffc107; }

        /* å†°ç®±èˆ‡æ ¼å­ */
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px 5px; text-align: center; cursor: pointer; min-height: 60px; font-size: 14px; }
        .zone.ok { background: #d4edda; border-color: #28a745; }
        .zone.warning { background: #fff3cd; border-color: #dc3545; animation: flash 1s infinite; }
        .highlight-foreign { background: linear-gradient(135deg, #6f42c1 0%, #4b2c84 100%) !important; color: #ffd700 !important; font-weight: bold; }

        /* åœ–ç‰‡é è¦½ */
        .preview-img { width: 100%; max-height: 150px; object-fit: cover; border-radius: 5px; margin-top: 5px; }
        
        /* ç³»çµ±æç¤º */
        #notification-badge { position: fixed; top: 10px; right: 10px; background: red; color: white; border-radius: 50%; padding: 5px 10px; font-size: 12px; z-index: 1001; cursor: pointer; }

        /* é€šç”¨å…ƒä»¶ */
        .section-header { background: #e9ecef; padding: 10px; margin: 15px -15px; font-weight: bold; border-left: 5px solid #007bff; display: flex; justify-content: space-between; }
        input, select, button, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; }
        .hidden { display: none !important; }
        
        /* å¸³å‹™è¡¨æ ¼ */
        .money-table { width: 100%; font-size: 12px; border-collapse: collapse; }
        .money-table td { padding: 5px; border-bottom: 1px solid #eee; }
        .money-table input { padding: 4px; width: 60px; text-align: right; }
        .subtotal { color: #007bff; font-weight: bold; text-align: right; }

        /* æ¯æœˆæ¨¡å‹ */
        #shelf-canvas { border: 2px solid #333; position: relative; width: 100%; height: 300px; background: #eee; overflow: hidden; background-size: contain; }
        .shelf-shape { position: absolute; cursor: pointer; border: 2px solid #333; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; text-align: center; font-size: 9px; padding: 2px; }
    </style>
</head>
<body>

<div id="notification-badge" class="hidden" onclick="switchTab('handover')">æ–°é€šçŸ¥!</div>

<div class="container">
    <div id="auth-screen">
        <div class="auth-box" style="text-align:center; padding:30px;">
            <h2>ğŸª é–€å¸‚æ™ºæ…§ç³»çµ± V13</h2>
            <div id="login-area">
                <input type="text" id="login-id" placeholder="å¸³è™Ÿ">
                <input type="password" id="login-pw" placeholder="å¯†ç¢¼">
                <button onclick="handleLogin()">ä¸Šç­æ‰“å¡ (GPS é©—è­‰)</button>
                <p style="font-size:12px; cursor:pointer;" onclick="toggleAuth(true)">è¨»å†Šæ–°å¸³è™Ÿ</p>
            </div>
            <div id="register-area" class="hidden">
                <input type="text" id="reg-name" placeholder="å“¡å·¥å§“å">
                <select id="reg-shift"><option value="æ—©ç­">æ—©ç­</option><option value="æ™šç­">æ™šç­</option><option value="ä¸»ç®¡">ä¸»ç®¡</option></select>
                <input type="text" id="reg-id" placeholder="è¨­å®šå¸³è™Ÿ">
                <input type="password" id="reg-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button onclick="handleRegister()" style="background:#28a745;">å®Œæˆè¨»å†Š</button>
                <p style="font-size:12px; cursor:pointer;" onclick="toggleAuth(false)">è¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div style="background:#333; color:white; padding:10px; margin:-15px -15px 10px -15px; display:flex; justify-content:space-between; align-items:center;">
            <span><span id="display-info">--</span> ğŸ†<span id="display-points">0</span></span>
            <button onclick="location.reload()" style="width:auto; padding:5px; font-size:10px;">ç™»å‡º</button>
        </div>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±</div>
            <div class="nav-item" onclick="switchTab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="switchTab('counter')">ğŸ’° å¸³å‹™</div>
            <div class="nav-item" onclick="switchTab('handover')">ğŸ¤ äº¤æ¥/å®¢æœ</div>
            <div class="nav-item hidden" id="nav-mgr" onclick="switchTab('manager')">ğŸ“Š ä¸»ç®¡è©•åˆ†</div>
        </div>

        <div id="tab-temp">
            <div class="section-header">â„ï¸ å†·è— (0-7åº¦)</div>
            <div class="grid-box" id="chiller-grid"></div>
            <div class="section-header">ğŸ§Š å†·å‡/è‡¥å¼ (<-10åº¦)</div>
            <div class="grid-box" id="freezer-grid"></div>
        </div>

        <div id="tab-stock" class="hidden">
            <div class="section-header">ğŸ”¥ é‡é»è£œè²¨ (å¤–ç±é£Ÿå“)</div>
            <div class="grid-box">
                <div class="zone highlight-foreign" id="stk-for-noodle" onclick="checkStock('stk-for-noodle','å¤–ç±æ³¡éºµ')">â˜…å¤–ç±æ³¡éºµâ˜…<small>--</small></div>
                <div class="zone highlight-foreign" id="stk-for-cookie" onclick="checkStock('stk-for-cookie','å¤–ç±é¤…ä¹¾')">â˜…å¤–ç±é¤…ä¹¾â˜…<small>--</small></div>
            </div>
            <div class="section-header">ğŸ“¦ æ¯æ—¥æ•ˆæœŸèˆ‡è£œè²¨</div>
            <div class="grid-box" id="stock-grid"></div>
            
            <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸæ¨¡å‹åœ–</div>
            <div id="mgr-canvas-tools" class="hidden">
                <input type="file" accept="image/*" onchange="uploadBg(event)">
                <button onclick="addShape('rect')" style="width:30%; display:inline;">+æ–¹å¡Š</button>
                <button onclick="saveMap()" style="width:30%; display:inline; background:green;">å„²å­˜</button>
            </div>
            <div id="shelf-canvas"></div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header">ğŸ“¥ é€²æ«ƒè³‡è¨Š (ä¸Šä¸€ç­)</div>
            <div style="background:#e3f2fd; padding:10px; border-radius:5px; font-size:12px;" id="last-shift-info">è®€å–ä¸­...</div>
            
            <div class="section-header">ğŸª™ é›¢æ«ƒé›¶éŒ¢/åº«å­˜é»ç®—</div>
            <table class="money-table" id="out-money-table">
                </table>
            <div style="text-align:right; font-weight:bold; color:#007bff;">æœ¬ç­é»ç®—ç¸½è¨ˆï¼š$<span id="out-money-total">0</span></div>

            <div class="section-header">ğŸ“ é›»è©±å¡ç›¤é» (é€²/éŠ·/å­˜)</div>
            <div id="card-input-area"></div>

            <div class="section-header">ğŸ’µ ç‡Ÿæ”¶æ•¸æ“š</div>
            <div class="grid-box">
                <input type="number" id="val-turnover" placeholder="ç‡Ÿæ¥­é¡">
                <input type="number" id="val-credit" placeholder="ä¿¡ç”¨å¡">
                <input type="number" id="val-twpay" placeholder="å°ç£Pay">
                <input type="number" id="val-linepay" placeholder="LinePay">
                <input type="number" id="val-points" placeholder="é»æ•¸">
                <input type="number" id="val-refund" placeholder="ç¾é‡‘é€€æ¬¾">
            </div>
            
            <div class="section-header">â• é¡å¤–æ”¶æ”¯</div>
            <button onclick="addExtra('in')" style="background:green; width:48%; display:inline;">+æ”¶å…¥</button>
            <button onclick="addExtra('out')" style="background:red; width:48%; display:inline;">+æ”¯å‡º</button>
            <div id="extra-list" style="font-size:12px;"></div>

            <div style="margin-top:20px; text-align:center; background:#333; color:white; padding:15px; border-radius:10px;">
                <h3>ç›®å‰èª¤å·®ï¼š<span id="diff-res">0</span> å…ƒ</h3>
                <button onclick="calculateDiff()" style="background:#ffc107; color:black;">ğŸ§® è©¦ç®—èª¤å·®</button>
                <button onclick="submitFinalReport()" style="background:#28a745; margin-top:10px;">âœ… æäº¤æ­£å¼å ±è¡¨</button>
            </div>
        </div>

        <div id="tab-handover" class="hidden">
            <div class="section-header">ğŸ¤ äº¤æ¥äº‹é … (å¯æ‹ç…§)</div>
            <textarea id="task-msg" placeholder="è¼¸å…¥å…§å®¹..."></textarea>
            <input type="file" id="task-img" accept="image/*" capture="camera">
            <button onclick="sendTask()">ç™¼å¸ƒäº¤æ¥</button>
            <div id="task-display"></div>

            <div class="section-header">ğŸ’ å®¢æœ/ç¶­ä¿®/å ±å»¢</div>
            <div class="grid-box">
                <button onclick="openSvc('preorder')">å®¢è¨‚é è³¼</button>
                <button onclick="openSvc('repair')">é›»å™¨ç¶­ä¿®</button>
                <button onclick="openSvc('soldout')">å•†å“å”®ç½„</button>
                <button onclick="openSvc('scrap')">å ±å»¢ç´€éŒ„</button>
            </div>
            <div id="svc-form" class="hidden" style="background:#f8f9fa; padding:10px; border:1px solid #ddd; margin-top:10px;">
                <h4 id="svc-title">è¡¨å–®</h4>
                <div id="svc-fields"></div>
                <button onclick="submitSvc()">é€å‡º</button>
            </div>
            <div id="svc-list" style="margin-top:10px; font-size:12px;"></div>
        </div>

        <div id="tab-manager" class="hidden">
            <div class="section-header">ğŸŒŸ å“¡å·¥æ¯æ—¥è©•æ¯”</div>
            <select id="eval-target"><option value="">é¸æ“‡å“¡å·¥</option></select>
            <div id="eval-criteria">
                <div class="report-row">å·¥ä½œæ•ˆç‡: <span class="star-group" data-key="efficiency"></span></div>
                <div class="report-row">è£œè²¨å®Œæˆ: <span class="star-group" data-key="stocking"></span></div>
                <div class="report-row">ç’°å¢ƒæ•´ç†: <span class="star-group" data-key="cleanup"></span></div>
                <div class="report-row">é¡§å®¢å›é¥‹: <span class="star-group" data-key="feedback"></span></div>
            </div>
            <button onclick="submitEvaluation()" style="background:#28a745; margin-top:10px;">å„²å­˜è©•åˆ†ä¸¦ç™¼é€ç©åˆ†</button>
            
            <div class="section-header">ğŸ“ˆ ç‡Ÿé‹çµ±è¨ˆæ•¸æ“š</div>
            <div id="mgr-data-area" style="font-size:12px;"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73",
        measurementId: "G-M4169BDVH5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    // --- èªè­‰ & GPS ---
    window.handleRegister = async () => {
        const id = document.getElementById('reg-id').value;
        const data = {
            name: document.getElementById('reg-name').value,
            shift: document.getElementById('reg-shift').value,
            pw: document.getElementById('reg-pw').value,
            points: 0, color: '#' + Math.floor(Math.random()*16777215).toString(16)
        };
        await setDoc(doc(db, "users", id), data);
        alert("è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥");
        window.toggleAuth(false);
    };

    window.handleLogin = () => {
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            const snap = await getDoc(doc(db, "users", id));
            if(snap.exists() && snap.data().pw === pw) {
                window.user = { ...snap.data(), id };
                window.gps = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                initApp();
            } else alert("ç™»å…¥å¤±æ•—");
        }, () => alert("è«‹é–‹å•Ÿ GPS ä»¥å®Œæˆæ‰“å¡æª¢æ ¸"));
    };

    // --- åˆå§‹åŒ–å…§å®¹ ---
    function initApp() {
        document.getElementById('display-info').innerText = `${window.user.name} (${window.user.shift})`;
        if(window.user.shift === 'ä¸»ç®¡') {
            document.getElementById('nav-mgr').classList.remove('hidden');
            document.getElementById('mgr-canvas-tools').classList.remove('hidden');
        }
        
        // ç”Ÿæˆ 10 å°å†°ç®±
        const cGrid = document.getElementById('chiller-grid');
        const fGrid = document.getElementById('freezer-grid');
        const fridges = [
            {id:'f1', n:'é–‹æ”¾1', t:'chiller'}, {id:'f2', n:'é–‹æ”¾2', t:'chiller'},
            {id:'f3', n:'å†·è—1', t:'chiller'}, {id:'f4', n:'å†·è—2', t:'chiller'},
            {id:'f5', n:'å†·å‡1', t:'freezer'}, {id:'f6', n:'å†·å‡2', t:'freezer'},
            {id:'f7', n:'è‡¥å¼1', t:'freezer'}, {id:'f8', n:'è‡¥å¼2', t:'freezer'},
            {id:'f9', n:'è‡¥å¼3', t:'freezer'}, {id:'f10', n:'è‡¥å¼4', t:'freezer'}
        ];
        fridges.forEach(f => {
            const html = `<div class="zone" id="${f.id}" onclick="checkTemp('${f.id}','${f.n}','${f.t}')">${f.n}<br><small>å¾…æ¸¬</small></div>`;
            if(f.t === 'chiller') cGrid.innerHTML += html; else fGrid.innerHTML += html;
        });

        // è£œè²¨æª¢æŸ¥
        const sGrid = document.getElementById('stock-grid');
        const stocks = ['è¸æ¶','å†°ç®±é£²æ–™','å±¤æ¶é£²æ–™','å†·å‡é£Ÿå“','åƒåœ¾è¢‹/å…æ´—','æ—¥é…æ•ˆæœŸ','ç”Ÿé®®æ•ˆæœŸ','éºµåŒ…æ•ˆæœŸ'];
        sGrid.innerHTML = stocks.map((s,i) => `<div class="zone" id="stk-${i}" onclick="checkStock('stk-${i}','${s}')">${s}</div>`).join('');

        // å¸³å‹™æ˜ç´° (1-500)
        const mT = document.getElementById('out-money-table');
        const units = [500, 100, 50, 10, 5, 1];
        mT.innerHTML = units.map(u => `<tr><td>${u}å…ƒ</td><td><input type="number" id="coin-${u}" oninput="calcSub(${u})">å¼µ/æš</td><td class="subtotal" id="sub-${u}">$0</td></tr>`).join('');

        // é›»è©±å¡ (é€²/éŠ·/å­˜)
        const cards = ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
        document.getElementById('card-input-area').innerHTML = cards.map(c => `
            <div style="display:flex; gap:5px; font-size:11px;">
                <label style="width:60px;">${c}</label>
                <input type="number" id="card-in-${c}" placeholder="é€²">
                <input type="number" id="card-sold-${c}" placeholder="éŠ·">
                <input type="number" id="card-left-${c}" placeholder="å­˜">
            </div>
        `).join('');

        // æ˜Ÿæ˜Ÿè©•åˆ†ç”Ÿæˆ
        document.querySelectorAll('.star-group').forEach(group => {
            for(let i=1; i<=5; i++) {
                const s = document.createElement('span');
                s.innerHTML = "â˜…"; s.className = "star-rating";
                s.onclick = () => {
                    group.querySelectorAll('.star-rating').forEach((st, idx) => st.classList.toggle('selected', idx < i));
                    group.dataset.value = i;
                };
                group.appendChild(s);
            }
        });

        startListeners();
    }

    // --- å³æ™‚ç›£è½ ---
    function startListeners() {
        onSnapshot(doc(db, "settings", "map"), (snap) => { if(snap.exists()) renderMap(snap.data()); });
        onSnapshot(query(collection(db, "tasks"), orderBy("time", "desc"), limit(5)), (snap) => {
            const list = document.getElementById('task-display'); list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                list.innerHTML += `<div style="border-bottom:1px solid #eee; padding:5px;">
                    <b>${t.msg}</b> <small>(${t.user})</small>
                    ${t.img ? `<img src="${t.img}" class="preview-img">` : ''}
                    <button onclick="markTask('${d.id}')" style="width:auto; padding:2px 5px; font-size:10px;">${t.done?'âœ…':'æ‰“å‹¾'}</button>
                </div>`;
            });
            if(!snap.empty) document.getElementById('notification-badge').classList.remove('hidden');
        });
        
        // è¼‰å…¥å“¡å·¥åˆ—è¡¨
        getDocs(collection(db, "users")).then(snap => {
            const sel = document.getElementById('eval-target');
            snap.forEach(d => sel.innerHTML += `<option value="${d.id}">${d.data().name}</option>`);
        });

        // ç©åˆ†èˆ‡æ ¼å­ç‹€æ…‹ç›£è½ (ç•¥...)
        onSnapshot(doc(db, "users", window.user.id), (snap) => {
            document.getElementById('display-points').innerText = snap.data().points || 0;
        });
    }

    // --- æ ¸å¿ƒæ“ä½œ ---
    window.checkTemp = async (id, name, type) => {
        const def = type === 'freezer' ? '-' : '';
        const val = prompt(`${name} æº«åº¦:`, def);
        if(!val) return;
        const num = parseFloat(val);
        let status = "æ­£å¸¸";
        if(type==='freezer' && num > -10) { alert("âš ï¸ æº«åº¦ç•°å¸¸é€šçŸ¥ä¸»ç®¡ï¼"); status="ç•°å¸¸"; }
        await setDoc(doc(db, "checks", id), { val: num+"åº¦", status, checker: window.user.name, time: new Date() });
        const el = document.getElementById(id);
        el.className = `zone ${status==='ç•°å¸¸'?'warning':'ok'}`;
        el.querySelector('small').innerText = `âœ… ${num}åº¦`;
    };

    window.sendTask = async () => {
        const msg = document.getElementById('task-msg').value;
        const file = document.getElementById('task-img').files[0];
        let imgBase64 = "";
        if(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                await addDoc(collection(db, "tasks"), { msg, img: e.target.result, user: window.user.name, time: new Date(), done: false });
                alert("ç™¼å¸ƒæˆåŠŸ");
            };
            reader.readAsDataURL(file);
        } else {
            await addDoc(collection(db, "tasks"), { msg, user: window.user.name, time: new Date(), done: false });
            alert("ç™¼å¸ƒæˆåŠŸ");
        }
    };

    // --- å¸³å‹™è¨ˆç®— ---
    window.calcSub = (u) => {
        const qty = parseFloat(document.getElementById(`coin-${u}`).value) || 0;
        document.getElementById(`sub-${u}`).innerText = "$" + (qty * u);
        let total = 0;
        [500,100,50,10,5,1].forEach(x => total += (parseFloat(document.getElementById(`coin-${x}`).value) || 0) * x);
        document.getElementById('out-money-total').innerText = total;
    };

    window.calculateDiff = () => {
        const inCash = parseFloat(prompt("è«‹è¼¸å…¥é€²æ«ƒæ‰‹å­˜ç¾é‡‘åº«å­˜ (è‹¥ç„¡å‰‡ç”±ç³»çµ±å¸¶å…¥ä¸Šä¸€ç­)")) || 0;
        const outTotal = parseFloat(document.getElementById('out-money-total').innerText);
        const turnover = parseFloat(document.getElementById('val-turnover').value) || 0;
        const deduct = (parseFloat(document.getElementById('val-credit').value)||0) + 
                       (parseFloat(document.getElementById('val-twpay').value)||0) +
                       (parseFloat(document.getElementById('val-linepay').value)||0) +
                       (parseFloat(document.getElementById('val-points').value)||0) +
                       (parseFloat(document.getElementById('val-refund').value)||0);
        const thousands = (parseFloat(document.getElementById('val-thousands')?.value)||0) * 1000;
        
        // å…¬å¼ä¿®æ­£: (((é€²æ«ƒç¾é‡‘åº«å­˜)-(é›¢æ«ƒé»ç®—ç¾é‡‘)+ç‡Ÿæ¥­é¡-æ‰£é …-åƒéˆ”æŠ½é›¢)*-1)
        const diff = ((inCash - outTotal + turnover - deduct - thousands) * -1);
        document.getElementById('diff-res').innerText = diff;
    };

    // --- ä¸»ç®¡è©•åˆ† ---
    window.submitEvaluation = async () => {
        const target = document.getElementById('eval-target').value;
        if(!target) return alert("è«‹é¸æ“‡å“¡å·¥");
        let totalStars = 0;
        document.querySelectorAll('.star-group').forEach(g => totalStars += parseInt(g.dataset.value || 0));
        const bonus = totalStars * 10;
        const userRef = doc(db, "users", target);
        const snap = await getDoc(userRef);
        await setDoc(userRef, { points: (snap.data().points || 0) + bonus }, { merge: true });
        alert(`è©•åˆ†å®Œæˆï¼å·²ç‚ºè©²å“¡å·¥å¢åŠ  ${bonus} ç©åˆ†`);
    };

    // --- æ¨¡å‹åœ– ---
    let shapes = [];
    window.addShape = (type) => {
        const name = prompt("å€åŸŸåç¨±:");
        const s = { id: Date.now(), type, name, x: 50, y: 50, done: false, color: "#fff" };
        shapes.push(s); renderMap({ shapes });
    };
    window.saveMap = async () => {
        await setDoc(doc(db, "settings", "map"), { shapes, bg: window.mapBg || "" });
        alert("åœ°åœ–å„²å­˜æˆåŠŸ");
    };
    function renderMap(data) {
        shapes = data.shapes || [];
        const canvas = document.getElementById('shelf-canvas');
        canvas.innerHTML = "";
        if(data.bg) canvas.style.backgroundImage = `url(${data.bg})`;
        shapes.forEach(s => {
            const d = document.createElement('div');
            d.className = 'shelf-shape';
            d.innerText = `${s.name}\n${s.done ? 'âœ…'+s.time : ''}`;
            d.style.left = s.x+"px"; d.style.top = s.y+"px";
            d.style.width = "60px"; d.style.height = "50px";
            d.style.background = s.done ? s.color : "rgba(255,255,255,0.8)";
            if(window.user.shift === 'ä¸»ç®¡') {
                d.onmousedown = (e) => {
                    let ox = e.clientX - s.x; let oy = e.clientY - s.y;
                    document.onmousemove = (ev) => { s.x = ev.clientX-ox; s.y = ev.clientY-oy; d.style.left=s.x+"px"; d.style.top=s.y+"px"; };
                    document.onmouseup = () => document.onmousemove = null;
                };
            } else {
                d.onclick = async () => {
                    s.done = true; s.time = new Date().toLocaleDateString(); s.color = window.user.color;
                    await setDoc(doc(db, "settings", "map"), { shapes });
                };
            }
            canvas.appendChild(d);
        });
    }

</script>

<script>
    // UI æ§åˆ¶
    function toggleAuth(reg) {
        document.getElementById('login-area').classList.toggle('hidden', reg);
        document.getElementById('register-area').classList.toggle('hidden', !reg);
    }
    function switchTab(t) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('[id^="tab-"]').forEach(p => p.classList.add('hidden'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
        if(t === 'handover') document.getElementById('notification-badge').classList.add('hidden');
    }
    function checkStock(id, name) {
        if(confirm(`${name} æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
            document.getElementById(id).classList.add('ok');
            document.getElementById(id).innerHTML = `${name}<br><small>âœ… å®Œæˆ</small>`;
        }
    }
    function openSvc(type) {
        document.getElementById('svc-form').classList.remove('hidden');
        document.getElementById('svc-title').innerText = type;
        let html = "";
        if(type==='preorder') html = `<input id="p-name" placeholder="å“å"><input id="p-code" placeholder="æ¢ç¢¼"><input id="p-qty" placeholder="æ•¸é‡"><input id="c-name" placeholder="é¡§å®¢å§“å"><input id="c-phone" placeholder="é›»è©±"><input id="c-line" placeholder="LINE ID">`;
        if(type==='repair') html = `<input id="r-name" placeholder="å“å"><input id="r-code" placeholder="æ¢ç¢¼"><input id="r-date" placeholder="è³¼è²·æ—¥æœŸ"><input id="c-name" placeholder="é¡§å®¢å§“å"><input id="c-phone" placeholder="é›»è©±">`;
        document.getElementById('svc-fields').innerHTML = html;
    }
</script>
</body>
</html>