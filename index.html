<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é–€å¸‚æˆ°æƒ…ç³»çµ± V19 - ç©©å®šé€£ç·šç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #343a40; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; }
        
        /* èªè­‰ä»‹é¢ */
        .auth-box { padding: 40px 20px; text-align: center; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* å°èˆª */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .nav-item { flex: 0 0 auto; padding: 15px 20px; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; color: #666; white-space: nowrap; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8f9fa; }

        /* ç‹€æ…‹æ ¼å­èˆ‡å¤–ç±æ¨™è¨˜ */
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .zone { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px 5px; text-align: center; cursor: pointer; min-height: 80px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .zone.ok { background: #d4edda !important; border-color: #28a745 !important; color: #155724; font-weight: bold; }
        .zone.warning { background: #fff3cd !important; border-color: #dc3545 !important; animation: flash 1s infinite; }
        .highlight-foreign { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #6f42c1; color: #4a148c; font-weight: bold; }

        /* å¸³å‹™å¤§ç©ºæ ¼èˆ‡é›»è©±å¡ */
        .money-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .money-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        .money-table input { width: 90px; height: 45px; font-size: 22px; text-align: center; border: 1px solid #999; border-radius: 4px; }
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card-box { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }

        /* åœ–ç‰‡ç¸®æ”¾å‹•ç•« */
        .img-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .img-overlay.show { display: flex; opacity: 1; }
        .img-overlay img { max-width: 90%; max-height: 90%; transform: scale(0.7); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .img-overlay.show img { transform: scale(1); }

        /* æ¨¡å‹åœ– */
        #shelf-canvas { border: 2px solid #333; position: relative; width: 100%; height: 380px; background: #eee; overflow: hidden; background-size: contain; background-repeat: no-repeat; }
        .shape { position: absolute; border: 2px solid #333; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; text-align: center; font-size: 11px; cursor: pointer; padding: 5px; }
        .shape.done { background: #28a745 !important; color: white !important; font-weight: bold; }

        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-success { background: var(--success); }
        .hidden { display: none !important; }
        @keyframes flash { 0%, 100% {opacity: 1;} 50% {opacity: 0.7;} }
    </style>
</head>
<body>

<div id="img-overlay" class="img-overlay" onclick="closeImgZoom()">
    <img id="img-zoom" src="">
</div>

<div class="container">
    <div id="auth-screen" class="auth-box">
        <div class="card">
            <h2>ğŸª æ™ºæ…§é–€å¸‚ç³»çµ± V19</h2>
            <div id="login-area">
                <input type="text" id="l-id" placeholder="å¸³è™Ÿ">
                <input type="password" id="l-pw" placeholder="å¯†ç¢¼">
                <button onclick="window.doLogin()">ç™»å…¥æ‰“å¡</button>
                <p onclick="window.toggleAuth(true)" style="color:blue; cursor:pointer; margin-top:15px;">åˆæ¬¡ä½¿ç”¨ï¼Ÿé»æ­¤è¨»å†Šå¸³è™Ÿ</p>
            </div>
            <div id="register-area" class="hidden">
                <input type="text" id="r-name" placeholder="çœŸå¯¦å§“å">
                <select id="r-shift"><option value="æ—©ç­">æ—©ç­</option><option value="æ™šç­">æ™šç­</option><option value="ä¸»ç®¡">ä¸»ç®¡</option></select>
                <input type="text" id="r-id" placeholder="è¨­å®šå¸³è™Ÿ">
                <input type="password" id="r-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button class="btn-success" onclick="window.doRegister()">å®Œæˆè¨»å†Š</button>
                <p onclick="window.toggleAuth(false)" style="color:blue; cursor:pointer; margin-top:15px;">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div style="background:var(--dark); color:white; padding:12px; display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ‘¤ <span id="user-info">--</span></span>
            <button onclick="location.reload()" style="width:auto; padding:5px 10px; font-size:11px;">ç™»å‡º</button>
        </div>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="window.switchTab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="window.switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±</div>
            <div class="nav-item" onclick="window.switchTab('counter')">ğŸ’° å¸³å‹™</div>
            <div class="nav-item" onclick="window.switchTab('handover')">ğŸ¤ äº¤æ¥å®¢æœ</div>
            <div id="nav-mgr" class="nav-item hidden" onclick="window.switchTab('manager')">ğŸ“Š ä¸»ç®¡</div>
        </div>

        <div id="tab-stock">
            <div class="section-header" style="background:#f3e5f5; color:#4a148c; padding:10px;">ğŸ”¥ å¤–ç±é£Ÿå“æª¢æŸ¥ (é‡é»)</div>
            <div class="grid-box">
                <div class="zone highlight-foreign" id="s-for-n" onclick="window.checkSimple('s-for-n','å¤–ç±æ³¡éºµ')">â˜…å¤–ç±æ³¡éºµâ˜…<br><small>å¾…æª¢</small></div>
                <div class="zone highlight-foreign" id="s-for-c" onclick="window.checkSimple('s-for-c','å¤–ç±é¤…ä¹¾')">â˜…å¤–ç±é¤…ä¹¾â˜…<br><small>å¾…æª¢</small></div>
            </div>
            <div class="section-header" style="padding:10px;">ğŸ“… æ¯æ—¥æ•ˆæœŸ</div>
            <div class="grid-box">
                <div class="zone" id="c-f" onclick="window.checkSimple('c-f','ç”Ÿé®®æ•ˆæœŸ')">ç”Ÿé®®æ•ˆæœŸ</div>
                <div class="zone" id="c-d" onclick="window.checkSimple('c-d','æ—¥é…æ•ˆæœŸ')">æ—¥é…æ•ˆæœŸ</div>
                <div class="zone" id="c-b" onclick="window.checkSimple('c-b','éºµåŒ…æ•ˆæœŸ')">éºµåŒ…æ•ˆæœŸ</div>
            </div>
            <div class="section-header" style="padding:10px;">ğŸ›’ æ¯æ—¥è£œè²¨</div>
            <div class="grid-box">
                <div class="zone" id="s-cig" onclick="window.checkSimple('s-cig','è¸æ¶')">è¸æ¶</div>
                <div class="zone" id="s-f-d" onclick="window.checkSimple('s-f-d','å†°ç®±é£²æ–™')">å†°ç®±é£²æ–™</div>
                <div class="zone" id="s-s-d" onclick="window.checkSimple('s-s-d','å±¤æ¶é£²æ–™')">å±¤æ¶é£²æ–™</div>
                <div class="zone" id="s-fr" onclick="window.checkSimple('s-fr','å†·å‡é£Ÿå“')">å†·å‡é£Ÿå“</div>
                <div class="zone" id="s-tr" onclick="window.checkSimple('s-tr','åƒåœ¾è¢‹/å…æ´—')">åƒåœ¾è¢‹/å…æ´—</div>
                <div class="zone" id="s-ti" onclick="window.checkSimple('s-ti','è¡›ç”Ÿç´™')">è¡›ç”Ÿç´™</div>
            </div>
            <div class="section-header" style="padding:10px;">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸæ¨¡å‹åœ–</div>
            <div id="mgr-map-ctrl" class="hidden">
                <div style="display:flex; gap:5px;">
                    <button onclick="window.addMapBox()">+æ–°å¢å€å¡Š</button>
                    <button onclick="window.saveMapV19()" style="background:green;">å„²å­˜ç™¼å¸ƒ</button>
                </div>
            </div>
            <div id="shelf-canvas"></div>
        </div>

        <div id="tab-temp" class="hidden">
            <div class="section-header" style="padding:10px;">ğŸŒ¡ï¸ å†°ç®±æº«åº¦æª¢æŸ¥ (0-7 / <-10)</div>
            <div id="f-grid" class="grid-box"></div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header" style="padding:10px;">ğŸ“¥ é€²æ«ƒè³‡è¨Š <button id="m-edit-btn" class="hidden" onclick="window.unlockIn()" style="width:auto; padding:2px 8px; font-size:11px;">ä¸»ç®¡ç·¨è¼¯</button></div>
            <div style="background:#e3f2fd; padding:15px; border-radius:10px;">
                é€²æ«ƒ-ç¾é‡‘ï¼š<input type="number" id="in-cash" disabled>
                é€²æ«ƒ-åº«å­˜ï¼š<input type="number" id="in-stock" disabled>
                <button id="in-save" class="hidden" onclick="window.saveInV19()" style="background:green;">ç¢ºèªå„²å­˜</button>
            </div>
            <div class="section-header" style="padding:10px;">ğŸª™ é›¢æ«ƒé»ç®— (å¤§ç©ºæ ¼è¼¸å…¥)</div>
            <table class="money-table" id="m-table"></table>
            <div style="text-align:right; font-weight:bold; color:blue; padding:10px;">é›¢æ«ƒç¸½ç¾ï¼š$<span id="out-sum">0</span></div>
            <div class="section-header" style="padding:10px;">ğŸ“ é›»è©±å¡ç›¤é»</div>
            <div id="card-list" class="card-grid"></div>
            <div class="section-header" style="padding:10px;">ğŸ“Š ç‡Ÿæ”¶æ•¸æ“š</div>
            <div class="grid-box">
                <input type="number" id="v-rev" placeholder="ç‡Ÿæ¥­é¡" oninput="window.calcV19Avg()">
                <input type="number" id="v-vis" placeholder="ä¾†å®¢æ•¸" oninput="window.calcV19Avg()">
                <input type="text" id="v-avg" placeholder="å®¢å–®åƒ¹" readonly style="background:#eee;">
            </div>
            <div class="grid-box" style="margin-top:5px;">
                <input type="number" id="v-cr" placeholder="ä¿¡ç”¨å¡"><input type="number" id="v-tw" placeholder="å°ç£Pay">
                <input type="number" id="v-ln" placeholder="LinePay"><input type="number" id="v-pt" placeholder="é»æ•¸">
                <input type="number" id="v-rf" placeholder="é€€æ¬¾"><input type="number" id="v-1k" placeholder="åƒéˆ”(å¼µ)">
            </div>
            <button onclick="window.doV19Calc()" style="background:orange; color:black; margin-top:10px;">ğŸ§® è©¦ç®—èª¤å·®</button>
            <h2 style="text-align:center;">èª¤å·®ï¼š<span id="diff-show">0</span></h2>
            <button onclick="window.doV19Submit()" style="background:green;">âœ… æäº¤æ­£å¼å ±è¡¨</button>
        </div>

        <div id="tab-handover" class="hidden">
            <div class="grid-box">
                <button onclick="window.openV19Svc('äº¤æ¥')">ğŸ“ äº¤æ¥</button>
                <button onclick="window.openV19Svc('å®¢è¨‚')">ğŸ›’ å®¢è¨‚</button>
                <button onclick="window.openV19Svc('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®</button>
                <button onclick="window.openV19Svc('å”®ç½„')">âš¡ å”®ç½„</button>
                <button onclick="window.openV19Svc('å ±å»¢')">ğŸ—‘ï¸ å ±å»¢</button>
            </div>
            <div id="svc-pop" class="hidden" style="background:#fff; border:3px solid var(--primary); padding:15px; border-radius:12px; margin-top:15px;">
                <h3 id="svc-title">è¡¨å–®</h3>
                <div id="svc-fields"></div>
                <input type="file" id="svc-img" accept="image/*" capture="camera">
                <button onclick="window.submitV19Svc()" style="margin-top:10px;">ç¢ºèªé€å‡º</button>
                <button onclick="document.getElementById('svc-pop').classList.add('hidden')" style="background:#666; margin-top:5px;">å–æ¶ˆ</button>
            </div>
            <div id="feed" style="margin-top:20px;"></div>
        </div>

        <div id="tab-manager" class="hidden">
            <div class="section-header" style="padding:10px;">ğŸŒŸ ç¸¾æ•ˆè©•ç­‰</div>
            <select id="e-target"><option value="">é¸æ“‡å“¡å·¥</option></select>
            <div style="padding:15px; background:var(--light); border-radius:8px;">
                <button onclick="window.saveEvalV19()" style="background:green;">é€å‡ºè©•åˆ†</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. Firebase åˆå§‹åŒ– (ç©©å®šå…¨åŸŸç‰ˆ) ---
    const config = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73"
    };
    firebase.initializeApp(config);
    const db = firebase.firestore();

    // --- 2. å…¨åŸŸè®Šæ•¸èˆ‡æ›è¼‰ (æ ¸å¿ƒä¿®å¾©) ---
    window.user = null;
    window.vShapes = [];

    // --- èªè­‰é‚è¼¯ ---
    window.toggleAuth = (isReg) => {
        document.getElementById('login-area').style.display = isReg ? 'none' : 'block';
        document.getElementById('register-area').style.display = isReg ? 'block' : 'none';
    };

    window.doRegister = async () => {
        const id = document.getElementById('r-id').value;
        const name = document.getElementById('r-name').value;
        const pw = document.getElementById('r-pw').value;
        const shift = document.getElementById('r-shift').value;
        if(!id || !name || !pw) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
        
        await db.collection("users").doc(id).set({ name, pw, shift, points: 0 });
        alert("âœ… è¨»å†ŠæˆåŠŸï¼è«‹é»æ“Šç¢ºèªå¾Œé€²è¡Œç™»å…¥ã€‚");
        window.toggleAuth(false);
    };

    window.doLogin = async () => {
        const id = document.getElementById('l-id').value;
        const pw = document.getElementById('l-pw').value;
        try {
            const snap = await db.collection("users").doc(id).get();
            if (snap.exists && snap.data().pw === pw) {
                window.user = { ...snap.data(), id };
                startAppV19();
            } else {
                alert("âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
            }
        } catch (e) {
            alert("é€£ç·šå¤±æ•—ï¼š" + e.message);
        }
    };

    // --- æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---
    function startAppV19() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('user-info').innerText = `${window.user.name} (${window.user.shift})`;
        
        if (window.user.shift === 'ä¸»ç®¡') {
            document.getElementById('nav-mgr').classList.remove('hidden');
            document.getElementById('mgr-map-ctrl').classList.remove('hidden');
            document.getElementById('m-edit-btn').classList.remove('hidden');
        }

        // ç”Ÿæˆå†°ç®±
        const fs = [{id:'f1',n:'é–‹æ”¾1',t:'c'},{id:'f2',n:'é–‹æ”¾2',t:'c'},{id:'f3',n:'å†·è—1',t:'c'},{id:'f4',n:'å†·è—2',t:'c'},
                    {id:'f5',n:'å†·å‡1',t:'f'},{id:'f6',n:'å†·å‡2',t:'f'},{id:'f7',n:'è‡¥å¼1',t:'f'},{id:'f8',n:'è‡¥å¼2',t:'f'},
                    {id:'f9',n:'è‡¥å¼3',t:'f'},{id:'f10',n:'è‡¥å¼4',t:'f'}];
        document.getElementById('f-grid').innerHTML = fs.map(f => `<div class="zone" id="${f.id}" onclick="window.inputTempV19('${f.id}','${f.n}','${f.t}')">${f.n}<br><small>å¾…æ¸¬</small></div>`).join('');

        // ç”ŸæˆéŒ¢å¹£è¡¨æ ¼ (å¤§ç©ºæ ¼)
        const units = [500,100,50,10,5,1];
        document.getElementById('m-table').innerHTML = units.map(u => `<tr><td>${u}å…ƒ</td><td><input type="number" id="m-reg-${u}" oninput="window.calcV19Sum()"></td><td><input type="number" id="m-res-${u}" oninput="window.calcV19Sum()"></td><td id="sub-${u}">$0</td></tr>`).join('');

        // ç”Ÿæˆé›»è©±å¡
        const cards = ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
        document.getElementById('card-list').innerHTML = cards.map(c => `<div class="card-box"><label>${c}</label><input type="number" id="ci-${c}" placeholder="é€²"><input type="number" id="cs-${c}" placeholder="éŠ·" style="color:red;"><input type="number" id="cl-${c}" placeholder="å­˜" style="color:blue;"></div>`).join('');

        startV19Sync();
        checkV19Times();
    }

    function startV19Sync() {
        // æ¨¡å‹åœ–é€£å‹•
        db.collection("settings").doc("global_map").onSnapshot(s => { if(s.exists) renderMapV19(s.data()); });
        // é€²æ«ƒè³‡è¨Šé€£å‹•
        db.collection("store_status").doc("current").onSnapshot(s => {
            if(s.exists()){
                document.getElementById('in-cash').value = s.data().cash || 0;
                document.getElementById('in-stock').value = s.data().stock || 0;
                if(s.data().cards) for(let k in s.data().cards) document.getElementById(`ci-${k}`).value = s.data().cards[k];
            }
        });
        // æª¢æŸ¥é …ç›®ç›£è½
        const checkIds = ['f1','f2','f3','f4','f5','f6','f7','f8','f9','f10','s-for-n','s-for-c','c-f','c-d','c-b','s-cig','s-f-d','s-s-d','s-fr','s-tr','s-ti'];
        checkIds.forEach(id => {
            db.collection("checks").doc(id).onSnapshot(s => {
                if(s.exists()){
                    const d = s.data();
                    const el = document.getElementById(id);
                    if(el) {
                        el.className = `zone ${d.status==='ç•°å¸¸'?'warning':'ok'} ${id.includes('for')?'highlight-foreign':''}`;
                        el.querySelector('small').innerText = `âœ… ${d.val} (${d.user})`;
                    }
                }
            });
        });
        // äº¤æ¥ç›£è½
        db.collection("broadcasts").orderBy("time","desc").limit(10).onSnapshot(s => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            s.forEach(d => {
                const b = d.data();
                feed.innerHTML += `<div style="background:#fff; border-left:5px solid ${b.done?'green':'orange'}; padding:12px; margin-bottom:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <b>[${b.type}] ${b.user}</b> <div style="margin:5px 0;">${b.content}</div>
                    ${b.img ? `<img src="${b.img}" style="width:80px; border-radius:5px;" onclick="window.zoomV19('${b.img}')">` : ''}
                </div>`;
            });
        });
    }

    // --- æ›è¼‰åŠŸèƒ½åˆ° Window ---
    window.inputTempV19 = async (id, name, type) => {
        const val = prompt(`${name} æº«åº¦ï¼š`, type==='f'?'-':'');
        if(!val) return alert("è­¦å‘Šï¼šæº«åº¦ç‚ºå¿…å¡«é …ç›®ï¼");
        const num = parseFloat(val);
        let status = "æ­£å¸¸";
        if((type==='f' && num > -10) || (type==='c' && (num < 0 || num > 7))) status = "ç•°å¸¸";
        if(status === "ç•°å¸¸") alert("ğŸš¨ åš´é‡è­¦å‘Šï¼šå†°ç®±æº«åº¦ç•°å¸¸ï¼å·²ç™¼å‡ºä¸»ç®¡é€šçŸ¥ï¼");
        
        await db.collection("checks").doc(id).set({ val: val+"åº¦", status, user: window.user.name, time: new Date() });
        await db.collection("logs").add({ item: name, val: num, status, user: window.user.name, timestamp: new Date() });
    };

    window.checkSimple = async (id, name) => {
        if(confirm(`${name} æª¢æŸ¥å®Œæˆå—ï¼Ÿ`)) {
            await db.collection("checks").doc(id).set({ val: "OK", status: "æ­£å¸¸", user: window.user.name, time: new Date() });
        }
    };

    window.calcV19Sum = () => {
        let total = 0;
        [500,100,50,10,5,1].forEach(u => {
            const val = (Number(document.getElementById(`m-reg-${u}`).value)||0) + (Number(document.getElementById(`m-res-${u}`).value)||0);
            document.getElementById(`sub-${u}`).innerText = "$" + (val * u);
            total += (val * u);
        });
        document.getElementById('out-sum').innerText = total;
    };

    window.calcV19Avg = () => {
        const rev = Number(document.getElementById('v-rev').value);
        const vis = Number(document.getElementById('v-vis').value);
        if(vis > 0) document.getElementById('v-avg').value = Math.round(rev/vis);
    };

    window.doV19Calc = () => {
        const inTotal = (Number(document.getElementById('in-cash').value)||0) + (Number(document.getElementById('in-stock').value)||0);
        const outTotal = Number(document.getElementById('out-sum').innerText);
        const rev = Number(document.getElementById('v-rev').value)||0;
        const ded = (Number(document.getElementById('v-cr').value)||0) + (Number(document.getElementById('v-tw').value)||0) + (Number(document.getElementById('v-ln').value)||0) + (Number(document.getElementById('v-pt').value)||0) + (Number(document.getElementById('v-rf').value)||0);
        const thousands = (Number(document.getElementById('v-1k').value)||0) * 1000;
        const diff = ((inTotal - outTotal + (rev - ded) - thousands) * -1);
        document.getElementById('diff-show').innerText = diff;
    };

    window.doV19Submit = async () => {
        const diff = document.getElementById('diff-show').innerText;
        if(!confirm(`èª¤å·®ç‚º ${diff} å…ƒï¼Œç¢ºèªæäº¤å ±è¡¨ï¼Ÿ`)) return;
        await db.collection("reports").add({ diff, user: window.user.name, date: new Date() });
        alert("âœ… å ±è¡¨æäº¤æˆåŠŸï¼");
        location.reload();
    };

    window.openV19Svc = (type) => {
        document.getElementById('svc-pop').classList.remove('hidden');
        document.getElementById('svc-title').innerText = type;
        const f = document.getElementById('svc-fields');
        f.innerHTML = type === 'äº¤æ¥' ? `<textarea id="s-msg" placeholder="è¼¸å…¥äº¤æ¥å…§å®¹"></textarea>` : `<input id="s-p" placeholder="å“å"> <input id="s-b" placeholder="æ¢ç¢¼/ç´°é …">`;
    };

    window.submitV19Svc = async () => {
        const title = document.getElementById('svc-title').innerText;
        const msg = document.getElementById('s-msg') ? document.getElementById('s-msg').value : (document.getElementById('s-p').value + " / " + document.getElementById('s-b').value);
        const file = document.getElementById('svc-img').files[0];
        const save = async (img = "") => {
            await db.collection("broadcasts").add({ type: title, content: msg, img, user: window.user.name, time: new Date(), done: false });
            alert("âœ… é€šå ±å·²åŒæ­¥çµ¦æ‰€æœ‰äºº");
            document.getElementById('svc-pop').classList.add('hidden');
        };
        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => save(e.target.result);
            reader.readAsDataURL(file);
        } else save();
    };

    // --- æ¨¡å‹åœ–é‚è¼¯ ---
    function renderMapV19(data) {
        window.vShapes = data.shapes || [];
        const canvas = document.getElementById('shelf-canvas');
        canvas.innerHTML = "";
        window.vShapes.forEach(s => {
            const div = document.createElement('div');
            div.className = `shape ${s.done?'done':''}`;
            div.style.left = s.x+"px"; div.style.top = s.y+"px";
            div.innerText = s.name;
            if(window.user.shift==='ä¸»ç®¡') {
                div.onmousedown = (e) => {
                    let ox = e.clientX-s.x; let oy = e.clientY-s.y;
                    document.onmousemove = (ev) => { s.x=ev.clientX-ox; s.y=ev.clientY-oy; div.style.left=s.x+"px"; div.style.top=s.y+"px"; };
                    document.onmouseup = () => document.onmousemove = null;
                };
            } else {
                div.onclick = async () => {
                    if(confirm(`ç¢ºèªã€${s.name}ã€‘æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
                        s.done = true;
                        await db.collection("settings").doc("global_map").set({ shapes: window.vShapes });
                    }
                };
            }
            canvas.appendChild(div);
        });
    }

    window.addMapBox = () => {
        const n = prompt("å€åŸŸåç¨±ï¼š");
        if(n) { window.vShapes.push({id:Date.now(), name:n, x:30, y:30, w:60, h:40, done:false}); renderMapV19({shapes:window.vShapes}); }
    };
    window.saveMapV19 = async () => { await db.collection("settings").doc("global_map").set({ shapes: window.vShapes }); alert("é…ç½®å·²ç™¼å¸ƒ"); };

    window.unlockIn = () => { document.getElementById('in-cash').disabled = false; document.getElementById('in-stock').disabled = false; document.getElementById('in-save').classList.remove('hidden'); };
    window.saveInV19 = async () => { await db.collection("store_status").doc("current").set({ cash: Number(document.getElementById('in-cash').value), stock: Number(document.getElementById('in-stock').value) }); alert("é€²æ«ƒè³‡è¨Šå·²æ›´æ–°"); location.reload(); };

    function checkV19Times() {
        const times = ["10:00","12:30","14:30","16:30","18:30","20:30","22:00"];
        setInterval(() => {
            const now = new Date();
            const cur = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            if(times.includes(cur)) alert("â° æª¢æŸ¥æ™‚é–“åˆ°äº†ï¼è«‹é‡æ¸¬å†°ç®±æº«åº¦ã€‚");
        }, 60000);
    }
</script>

<script>
    // --- ä¸€èˆ¬ UI èˆ‡å‹•ç•« ---
    function switchTab(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }
    function zoomV19(src) {
        document.getElementById('img-zoom').src = src;
        const overlay = document.getElementById('img-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('show'), 10);
    }
    function closeImgZoom() {
        const overlay = document.getElementById('img-overlay');
        overlay.classList.remove('show');
        setTimeout(() => overlay.style.display = 'none', 300);
    }
</script>
</body>
</html>