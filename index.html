<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§åº—å‹™ç³»çµ± V15 (çµ‚æ¥µåŒæ­¥ç‰ˆ)</title>
    <style>
        /* --- å…¨å±€ç¾åŒ–æ¨£å¼ --- */
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --warning: #ffc107; --dark: #343a40; --light: #f8f9fa; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; color: #333; line-height: 1.5; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* å°èˆª */
        .nav-tabs { display: flex; overflow-x: auto; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .nav-item { flex: 0 0 auto; padding: 14px 18px; cursor: pointer; color: #666; font-weight: bold; border-bottom: 3px solid transparent; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--light); }

        /* é€šçŸ¥éˆ´éº */
        #noti-bell-container { position: fixed; top: 15px; right: 15px; z-index: 2000; }
        .bell-btn { font-size: 24px; cursor: pointer; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .noti-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; }
        .noti-dropdown { position: absolute; right: 0; top: 40px; width: 280px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; max-height: 400px; overflow-y: auto; }
        .noti-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        .noti-item:hover { background: #f9f9f9; }

        /* åœ–ç‰‡æ”¾å¤§æ•ˆæœ */
        .img-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; }
        .img-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:none; justify-content:center; align-items:center; }
        .img-overlay img { max-width: 95%; max-height: 95%; }

        /* æ¨¡å‹åœ–ç·¨è¼¯å™¨ */
        #shelf-canvas { border: 2px solid var(--dark); position: relative; width: 100%; height: 350px; background: #eee; overflow: hidden; background-size: contain; background-repeat: no-repeat; }
        .shape { position: absolute; border: 2px solid #333; background: rgba(255,255,255,0.85); display: flex; align-items: center; justify-content: center; font-size: 10px; text-align: center; cursor: pointer; padding: 4px; box-sizing: border-box; }
        .shape.done { background: rgba(40, 167, 69, 0.8) !important; color: white; }
        .shape.selected { border: 3px solid var(--primary); z-index: 10; }

        /* é›»è©±å¡ç¶²æ ¼ */
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: var(--light); border-radius: 8px; }
        .card-box { background: white; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .card-box label { font-size: 12px; font-weight: bold; color: var(--primary); }
        .card-box input { width: 100%; padding: 5px; font-size: 14px; border: 1px solid #eee; }

        /* æŒ‰éˆ•ç¾åŒ– */
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-mgr { background: var(--dark); }
        .btn-add { background: var(--success); }
        .btn-del { background: var(--danger); }

        /* å¸³å‹™ç´°é … */
        .money-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .money-row input { width: 60px; text-align: right; }
        .money-subtotal { width: 70px; text-align: right; font-weight: bold; color: var(--primary); }

        .section-header { background: #e9ecef; padding: 10px; margin: 15px -15px; font-weight: bold; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="img-overlay" class="img-overlay" onclick="this.style.display='none'">
    <img id="img-zoom" src="">
</div>

<div id="noti-bell-container">
    <div class="bell-btn" onclick="toggleNotiDropdown()">ğŸ””<span id="noti-badge" class="noti-badge hidden">0</span></div>
    <div id="noti-dropdown" class="noti-dropdown">
        <div style="padding:10px; border-bottom:1px solid #eee; font-weight:bold;">æœ€æ–°äº¤æ¥/é€šçŸ¥</div>
        <div id="noti-content">ç›®å‰æ²’æœ‰æ–°æ¶ˆæ¯</div>
    </div>
</div>

<div class="container">
    <div id="auth-screen" style="padding:30px; text-align:center;">
        <div style="background:white; padding:30px; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,0.1);">
            <h2 id="auth-title">ğŸª æ™ºæ…§é–€å¸‚ V15</h2>
            <div id="login-area">
                <input type="text" id="login-id" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
                <input type="password" id="login-pw" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                <button onclick="handleLogin()">ç™»å…¥æ‰“å¡</button>
                <p style="font-size:13px; color:#666; margin-top:15px;" onclick="toggleAuth(true)">åˆæ¬¡ä½¿ç”¨ï¼Ÿé»æ­¤è¨»å†Š</p>
            </div>
            <div id="register-area" class="hidden">
                <input type="text" id="reg-name" placeholder="çœŸå¯¦å§“å">
                <select id="reg-shift"><option value="æ—©ç­">æ—©ç­</option><option value="æ™šç­">æ™šç­</option><option value="ä¸»ç®¡">ä¸»ç®¡</option></select>
                <input type="text" id="reg-id" placeholder="è¨­å®šç™»å…¥å¸³è™Ÿ">
                <input type="password" id="reg-pw" placeholder="è¨­å®šå¯†ç¢¼">
                <button onclick="handleRegister()" style="background:var(--success);">ç¢ºèªè¨»å†Š</button>
                <p style="font-size:13px; color:#666; margin-top:15px;" onclick="toggleAuth(false)">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div style="background:var(--dark); color:white; padding:12px; margin:-15px -15px 10px -15px; display:flex; justify-content:space-between; align-items:center;">
            <span><span id="display-info">--</span> ğŸ† <span id="display-points">0</span></span>
            <button onclick="location.reload()" style="width:auto; padding:5px 10px; background:#555; font-size:11px;">ç™»å‡ºç³»çµ±</button>
        </div>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('stock')">ğŸ“¦ è£œè²¨æ•ˆæœŸ</div>
            <div class="nav-item" onclick="switchTab('temp')">ğŸŒ¡ï¸ å†°ç®±æº«åº¦</div>
            <div class="nav-item" onclick="switchTab('counter')">ğŸ’° å¸³å‹™æœƒè¨ˆ</div>
            <div class="nav-item" onclick="switchTab('handover')">ğŸ¤ äº¤æ¥å®¢æœ</div>
            <div class="nav-item hidden" id="nav-mgr" onclick="switchTab('manager')">ğŸ“Š ä¸»ç®¡å¾Œå°</div>
        </div>

        <div id="tab-stock">
            <div class="section-header">ğŸ—“ï¸ æ¯æœˆæ•ˆæœŸæ¨¡å‹åœ– (å³æ™‚åŒæ­¥)</div>
            <div id="mgr-map-tools" class="hidden" style="margin-bottom:10px;">
                <input type="file" id="map-bg-up" onchange="uploadMapBg(event)" style="font-size:12px;">
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button onclick="addShape()" class="btn-add" style="flex:1; font-size:12px;">+æ–°å€å¡Š</button>
                    <button onclick="copyShape()" class="btn-mgr" style="flex:1; font-size:12px;">è¤‡è£½</button>
                    <button onclick="deleteShape()" class="btn-del" style="flex:1; font-size:12px;">åˆªé™¤</button>
                    <button onclick="renameShape()" class="btn-mgr" style="flex:1; font-size:12px;">æ”¹å</button>
                </div>
                <button onclick="saveGlobalMap()" style="background:var(--success); margin-top:5px;">ğŸ“¢ ç™¼ä½ˆæ¨¡å‹åœ–çµ¦æ‰€æœ‰äºº</button>
            </div>
            <div id="shelf-canvas"></div>
            
            <div class="section-header">ğŸ“… æ¯æ—¥æ•ˆæœŸ</div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                <div class="zone" id="c-f" onclick="quickCheck('c-f','ç”Ÿé®®æ•ˆæœŸ')">ç”Ÿé®®</div>
                <div class="zone" id="c-d" onclick="quickCheck('c-d','æ—¥é…æ•ˆæœŸ')">æ—¥é…</div>
                <div class="zone" id="c-b" onclick="quickCheck('c-b','éºµåŒ…æ•ˆæœŸ')">éºµåŒ…</div>
            </div>
            <div class="section-header">ğŸ›’ è£œè²¨æª¢æŸ¥</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <div class="zone highlight-foreign" id="s-for-n" onclick="quickCheck('s-for-n','â˜…å¤–ç±æ³¡éºµ')">â˜…å¤–ç±æ³¡éºµâ˜…</div>
                <div class="zone highlight-foreign" id="s-for-c" onclick="quickCheck('s-for-c','â˜…å¤–ç±é¤…ä¹¾')">â˜…å¤–ç±é¤…ä¹¾â˜…</div>
                <div class="zone" onclick="quickCheck('s-c','è¸æ¶')">è¸æ¶</div>
                <div class="zone" onclick="quickCheck('s-d','å†°ç®±é£²æ–™')">å†°ç®±é£²æ–™</div>
                <div class="zone" onclick="quickCheck('s-sd','å±¤æ¶é£²æ–™')">å±¤æ¶é£²æ–™</div>
                <div class="zone" onclick="quickCheck('s-fr','å†·å‡é£Ÿå“')">å†·å‡é£Ÿå“</div>
                <div class="zone" onclick="quickCheck('s-tr','åƒåœ¾è¢‹/å…æ´—')">åƒåœ¾è¢‹/å…æ´—</div>
                <div class="zone" onclick="quickCheck('s-ts','è¡›ç”Ÿç´™')">è¡›ç”Ÿç´™</div>
            </div>
        </div>

        <div id="tab-temp" class="hidden">
            <div id="temp-alert" class="hidden" style="background:var(--danger); color:white; padding:10px; border-radius:8px; margin-bottom:10px; font-weight:bold; animation:flash 1s infinite;">
                ğŸš¨ ç¾åœ¨æ˜¯æª¢æŸ¥æ™‚é–“ï¼Œè«‹ç«‹å³è¼¸å…¥å„å†°ç®±æº«åº¦ï¼
            </div>
            <div class="section-header">ğŸŒ¡ï¸ å†°ç®±æº«åº¦ç´€éŒ„ (æ™‚é–“é»æª¢æ ¸)</div>
            <div id="fridge-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                </div>
        </div>

        <div id="tab-counter" class="hidden">
            <div class="section-header">ğŸ“¥ é€²æ«ƒè³‡è¨Š <button id="btn-mgr-edit-in" class="hidden" onclick="enableInEdit()" style="width:auto; padding:2px 8px; font-size:10px;">ä¸»ç®¡ç·¨è¼¯</button></div>
            <div id="in-data-box" style="background:var(--light); padding:10px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between;">æ”¶éŠ€ç¾é‡‘: <input type="number" id="in-cash" disabled></div>
                <div style="display:flex; justify-content:space-between;">åº«å­˜é›¶éŒ¢: <input type="number" id="in-stock" disabled></div>
                <button id="btn-in-save" class="hidden" onclick="saveInEdit()" style="background:var(--success);">å„²å­˜é€²æ«ƒè¨­å®š</button>
            </div>

            <div class="section-header">ğŸª™ é›¢æ«ƒé»ç®— (æ”¶éŠ€æ©Ÿ / åº«å­˜)</div>
            <div id="money-detail-table" style="background:white; border:1px solid #ddd;">
                </div>
            <div style="text-align:right; font-weight:bold; padding:10px; color:var(--primary);">
                é›¢æ«ƒç¸½é‡‘é¡ï¼š$<span id="out-money-total">0</span>
            </div>

            <div class="section-header">ğŸ“ é›»è©±å¡ç›¤é» (ç¾åŒ–ç‰ˆ)</div>
            <div class="card-grid" id="card-inputs">
                </div>

            <div class="section-header">ğŸ“Š ç‡Ÿæ”¶æ•¸æ“š (è‡ªå‹•ç®—å®¢å–®)</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><small>ç‡Ÿæ¥­é¡</small><input type="number" id="sales-total" oninput="calcAvg()"></div>
                <div><small>ä¾†å®¢æ•¸</small><input type="number" id="sales-visitors" oninput="calcAvg()"></div>
                <div><small>å®¢å–®åƒ¹</small><input type="number" id="sales-avg" readonly style="background:#eee;"></div>
            </div>
            <div class="section-header">ğŸ”» æ‰£é …èˆ‡æ”¶æ”¯</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                <input type="number" id="sales-credit" placeholder="ä¿¡ç”¨å¡">
                <input type="number" id="sales-tw" placeholder="å°ç£Pay">
                <input type="number" id="sales-line" placeholder="LINE Pay">
                <input type="number" id="sales-pts" placeholder="ä½¿ç”¨é»æ•¸">
                <input type="number" id="sales-ref" placeholder="ç¾é‡‘é€€æ¬¾">
                <input type="number" id="sales-1000" placeholder="åƒéˆ”å¼µæ•¸">
            </div>
            <div style="margin-top:10px;">
                <button onclick="openExtraPopup('in')" style="width:48%; background:var(--success);">+ é¡å¤–æ”¶å…¥</button>
                <button onclick="openExtraPopup('out')" style="width:48%; background:var(--danger);">+ é¡å¤–æ”¯å‡º</button>
                <div id="extra-list-box" style="font-size:12px; margin-top:5px;"></div>
            </div>

            <div style="margin-top:20px; text-align:center; background:var(--dark); color:white; padding:15px; border-radius:10px;">
                <h3>çµç®—èª¤å·®ï¼š<span id="final-diff">0</span> å…ƒ</h3>
                <button onclick="calculateAccounting()" style="background:var(--warning); color:black;">ğŸ§® åŸ·è¡Œè©¦ç®—</button>
                <button onclick="submitDailyReport()" style="background:var(--success); margin-top:10px;">âœ… æäº¤æ—¥å ±è¡¨</button>
            </div>
        </div>

        <div id="tab-handover" class="hidden">
            <div class="section-header">ğŸ“ äº¤æ¥äº‹é …èˆ‡å›å ±</div>
            <div class="grid-box">
                <button onclick="openSvcForm('äº¤æ¥')">ğŸ“ æ–°äº¤æ¥</button>
                <button onclick="openSvcForm('å®¢è¨‚')">ğŸ›’ å®¢è¨‚é è³¼</button>
                <button onclick="openSvcForm('ç¶­ä¿®')">ğŸ”§ ç¶­ä¿®è³‡æ–™</button>
                <button onclick="openSvcForm('å”®ç½„')">âš¡ å•†å“å”®ç½„</button>
                <button onclick="openSvcForm('å ±å»¢')">ğŸ—‘ï¸ å ±å»¢ç´€éŒ„</button>
            </div>

            <div id="svc-popup" class="hidden" style="background:#fff; border:2px solid var(--primary); padding:15px; border-radius:10px; margin-top:10px;">
                <h3 id="svc-title">--</h3>
                <div id="svc-fields"></div>
                <input type="file" id="svc-img" accept="image/*" capture="camera">
                <button onclick="submitUniversalSvc()" style="margin-top:10px;">ç¢ºèªé€å‡ºè³‡æ–™</button>
                <button onclick="closeSvcPopup()" style="background:#666; margin-top:5px;">å–æ¶ˆ</button>
            </div>

            <div id="global-feed" style="margin-top:20px;">
                </div>
        </div>

        <div id="tab-manager" class="hidden">
            <div class="section-header">ğŸŒŸ å“¡å·¥æ¯æ—¥è©•åˆ† (é€£å‹•ç©åˆ†)</div>
            <select id="mgr-target-user"><option value="">é¸æ“‡å“¡å·¥</option></select>
            <div id="mgr-rating-box" style="background:var(--light); padding:15px; border-radius:10px;">
                <div class="money-row">å·¥ä½œæ•ˆç‡: <span class="stars" data-key="eff"></span></div>
                <div class="money-row">è£œè²¨åº¦: <span class="stars" data-key="stk"></span></div>
                <div class="money-row">ç’°å¢ƒæ•´ç†: <span class="stars" data-key="env"></span></div>
                <div class="money-row">é¡§å®¢å›é¥‹: <span class="stars" data-key="fed"></span></div>
                <button onclick="submitMgrRating()" style="background:var(--success); margin-top:10px;">å„²å­˜è©•åˆ†ä¸¦ç™¼æ”¾ç©åˆ†</button>
            </div>
            
            <div class="section-header">ğŸ“ˆ é–€å¸‚ç¸¾æ•ˆèˆ‡èª¤å·®çµ±è¨ˆ</div>
            <div id="mgr-stats-panel" style="font-size:12px;">è¼‰å…¥æ•¸æ“šä¸­...</div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAiOKSjZq6TPc9O75NcxsQqFYhY2wziW1w",
        authDomain: "join-home-f3070.firebaseapp.com",
        projectId: "join-home-f3070",
        storageBucket: "join-home-f3070.firebasestorage.app",
        messagingSenderId: "590173788810",
        appId: "1:590173788810:web:13986424ec8bf9a5f7eb73",
        measurementId: "G-M4169BDVH5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    // --- èªè­‰é‚è¼¯ ---
    window.handleRegister = async () => {
        const id = document.getElementById('reg-id').value;
        const name = document.getElementById('reg-name').value;
        const pw = document.getElementById('reg-pw').value;
        const shift = document.getElementById('reg-shift').value;
        if(!id || !name || !pw) return alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
        
        await setDoc(doc(db, "users", id), { name, pw, shift, points: 0, created: serverTimestamp() });
        alert("ğŸ‰ è¨»å†ŠæˆåŠŸï¼è«‹ä½¿ç”¨æ‚¨çš„å¸³è™Ÿç™»å…¥ã€‚");
        window.toggleAuth(false);
    };

    window.handleLogin = async () => {
        const id = document.getElementById('login-id').value;
        const pw = document.getElementById('login-pw').value;
        const snap = await getDoc(doc(db, "users", id));
        if(snap.exists() && snap.data().pw === pw) {
            window.user = { ...snap.data(), id };
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            initV15App();
        } else alert("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼");
    };

    // --- åˆå§‹åŒ– UI ---
    function initV15App() {
        document.getElementById('display-info').innerText = `${window.user.name} (${window.user.shift})`;
        if(window.user.shift === 'ä¸»ç®¡') {
            document.getElementById('nav-mgr').classList.remove('hidden');
            document.getElementById('mgr-map-tools').classList.remove('hidden');
            document.getElementById('btn-mgr-edit-in').classList.remove('hidden');
        }
        
        // ç”Ÿæˆ 10 å°å†°ç®±
        const fridges = [
            {id:'f1',n:'é–‹æ”¾1',t:'chiller'},{id:'f2',n:'é–‹æ”¾2',t:'chiller'},
            {id:'f3',n:'å†·è—1',t:'chiller'},{id:'f4',n:'å†·è—2',t:'chiller'},
            {id:'f5',n:'å†·å‡1',t:'freezer'},{id:'f6',n:'å†·å‡2',t:'freezer'},
            {id:'f7',n:'è‡¥å¼1',t:'freezer'},{id:'f8',n:'è‡¥å¼2',t:'freezer'},
            {id:'f9',n:'è‡¥å¼3',t:'freezer'},{id:'f10',n:'è‡¥å¼4',t:'freezer'}
        ];
        document.getElementById('fridge-list').innerHTML = fridges.map(f => `
            <div class="zone" id="${f.id}" onclick="inputTemp('${f.id}','${f.n}','${f.t}')">${f.n}<br><small>å¾…é‡æ¸¬</small></div>
        `).join('');

        // ç”ŸæˆéŒ¢å¹£é»ç®—
        const units = [500,100,50,10,5,1];
        document.getElementById('money-detail-table').innerHTML = units.map(u => `
            <div class="money-row">
                <label>${u}å…ƒ</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="m-reg-${u}" placeholder="æ©Ÿ" oninput="calcV15Money()">
                    <input type="number" id="m-res-${u}" placeholder="åº«" oninput="calcV15Money()">
                </div>
                <div class="money-subtotal" id="m-sub-${u}">$0</div>
            </div>
        `).join('');

        // ç”Ÿæˆé›»è©±å¡
        const cards = ["IF499","OK499","ä¸­è¯499","IF599","OK599","ä¸­è¯599","æ—ºå¡"];
        document.getElementById('card-inputs').innerHTML = cards.map(c => `
            <div class="card-box">
                <label>${c}</label>
                <input type="number" id="c-in-${c}" placeholder="é€²æ«ƒ" style="font-size:10px;">
                <input type="number" id="c-sold-${c}" placeholder="è²©å”®" style="color:red; font-size:10px;">
                <input type="number" id="c-left-${c}" placeholder="é›¢æ«ƒ" style="color:blue; font-size:10px;">
            </div>
        `).join('');

        // ç”Ÿæˆæ˜Ÿç´šè©•ç­‰
        document.querySelectorAll('.stars').forEach(s => {
            for(let i=1;i<=5;i++) s.innerHTML += `<span class="star" onclick="rateStar(this, ${i})" style="font-size:20px; cursor:pointer; color:#ddd;">â˜…</span>`;
        });

        startV15Listeners();
        checkTimeAlert();
        setInterval(checkTimeAlert, 60000); // æ¯ä¸€åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æé†’
    }

    // --- å³æ™‚ç›£è½èˆ‡æ ¸å¿ƒé‚è¼¯ ---
    function startV15Listeners() {
        // æ¨¡å‹åœ–å³æ™‚åŒæ­¥ (é€™è§£æ±ºäº†çœ‹ä¸åˆ°çš„å•é¡Œ)
        onSnapshot(doc(db, "settings", "global_map"), (snap) => {
            if(snap.exists()) renderMapV15(snap.data());
        });

        // é€²æ«ƒè³‡è¨Šç›£è½
        onSnapshot(doc(db, "store_status", "current"), (snap) => {
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('in-cash').value = d.cash || 0;
                document.getElementById('in-stock').value = d.stock || 0;
                // è‡ªå‹•å¡«å…¥é›»è©±å¡é€²æ«ƒ
                if(d.cards){
                    for(let key in d.cards) {
                        const el = document.getElementById(`c-in-${key}`);
                        if(el) el.value = d.cards[key];
                    }
                }
            }
        });

        // äº¤æ¥èˆ‡å®¢æœ Feed (å³æ™‚çœ‹åˆ°æ‰€æœ‰äººçš„å…§å®¹)
        onSnapshot(query(collection(db, "broadcasts"), orderBy("time", "desc"), limit(20)), (snap) => {
            const feed = document.getElementById('global-feed');
            const notiList = document.getElementById('noti-content');
            feed.innerHTML = ""; notiList.innerHTML = "";
            let unread = 0;
            
            snap.forEach(d => {
                const b = d.data();
                if(!b.done) unread++;
                const itemHtml = `
                    <div style="background:white; border-radius:8px; padding:12px; margin-bottom:10px; border-left:5px solid ${b.done?'var(--success)':'var(--warning)'}; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <b>[${b.type}] ${b.user}</b>
                            <div style="display:flex; gap:5px;">
                                <button onclick="markBdone('${d.id}', ${!b.done})" style="width:auto; padding:2px 8px; font-size:10px; background:${b.done?'#666':'var(--success)'}">${b.done?'å–æ¶ˆå‹¾é¸':'å®Œæˆæ‰“å‹¾'}</button>
                                ${window.user.shift==='ä¸»ç®¡' || window.user.name === b.user ? `<button onclick="deleteB('${d.id}')" style="width:auto; padding:2px 8px; font-size:10px; background:var(--danger);">åˆªé™¤</button>` : ''}
                            </div>
                        </div>
                        <div style="margin:5px 0; font-size:14px;">${b.content}</div>
                        ${b.img ? `<img src="${b.img}" class="img-thumb" onclick="zoomImg('${b.img}')">` : ''}
                        <div style="font-size:10px; color:#999; text-align:right;">${new Date(b.time?.toDate()).toLocaleString()}</div>
                    </div>
                `;
                feed.innerHTML += itemHtml;
                if(!b.done) notiList.innerHTML += `<div class="noti-item" onclick="switchTab('handover')">ğŸ”” <b>${b.type}</b>: ${b.content.substring(0,15)}...</div>`;
            });
            
            if(unread > 0){
                document.getElementById('noti-badge').innerText = unread;
                document.getElementById('noti-badge').classList.remove('hidden');
            } else {
                document.getElementById('noti-badge').classList.add('hidden');
                notiList.innerHTML = "<div style='padding:10px; color:#999;'>ç„¡å¾…è¾¦äº‹é …</div>";
            }
        });

        // æ ¼å­ç‹€æ…‹ç›£è½
        const ids = ['f1','f2','f3','f4','f5','f6','f7','f8','f9','f10','c-f','c-d','c-b','s-for-n','s-for-c'];
        ids.forEach(id => {
            onSnapshot(doc(db, "checks", id), (snap) => {
                if(snap.exists()){
                    const d = snap.data();
                    const el = document.getElementById(id);
                    if(el){
                        el.className = `zone ${d.status==='ç•°å¸¸'?'warning':'ok'} ${id.includes('for')?'highlight-foreign':''}`;
                        el.querySelector('small').innerText = `âœ… ${d.val} (${d.user})`;
                    }
                }
            });
        });
    }

    // --- æ ¸å¿ƒæ“ä½œå‡½æ•¸ ---
    window.inputTemp = async (id, name, type) => {
        const val = prompt(`${name} æº«åº¦ï¼š`, type==='freezer'?'-':'');
        if(val === null) return;
        if(val === "") return alert("è­¦å‘Šï¼šè«‹ç¢ºå¯¦è¼¸å…¥æº«åº¦ï¼Œä¸å¯ç©ºç™½ï¼");
        
        const num = parseFloat(val);
        let status = "æ­£å¸¸";
        if(type==='freezer' && num > -10) { alert("âš ï¸ åš´é‡è­¦å‘Šï¼šå†·å‡æº«åº¦é«˜æ–¼-10åº¦ï¼å·²é€šçŸ¥ä¸»ç®¡ã€‚"); status="ç•°å¸¸"; }
        if(type==='chiller' && (num < 0 || num > 7)) { alert("âš ï¸ è­¦å‘Šï¼šå†·è—æº«åº¦ç•°å¸¸ï¼"); status="ç•°å¸¸"; }
        
        await setDoc(doc(db, "checks", id), { val: val+"åº¦", status, user: window.user.name, time: serverTimestamp() });
        await addDoc(collection(db, "logs"), { item: name, val: num, status, user: window.user.name, time: serverTimestamp() });
    };

    window.submitUniversalSvc = async () => {
        const title = document.getElementById('svc-title').innerText;
        const file = document.getElementById('svc-img').files[0];
        const fields = document.querySelectorAll('#svc-fields input, #svc-fields textarea');
        let content = "";
        fields.forEach(f => { if(f.value) content += `[${f.placeholder}: ${f.value}] `; });
        
        const save = async (base64Img = "") => {
            await addDoc(collection(db, "broadcasts"), {
                type: title, content, img: base64Img, user: window.user.name, time: serverTimestamp(), done: false
            });
            alert("âœ… å›å ±æˆåŠŸï¼æ‰€æœ‰åŒäº‹éƒ½æœƒæ”¶åˆ°é€šçŸ¥ã€‚");
            closeSvcPopup();
        };

        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => save(e.target.result);
            reader.readAsDataURL(file);
        } else save();
    };

    window.saveGlobalMap = async () => {
        await setDoc(doc(db, "settings", "global_map"), { shapes: window.vShapes, bg: window.mapBg || "" });
        alert("ğŸ“¢ æ¨¡å‹åœ–å·²ç™¼ä½ˆï¼Œæ‰€æœ‰äººç¾åœ¨éƒ½èƒ½çœ‹åˆ°äº†ï¼");
    };

    window.markBdone = async (id, status) => { await updateDoc(doc(db, "broadcasts", id), { done: status }); };
    window.deleteB = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ¶ˆæ¯ï¼Ÿ")) await deleteDoc(doc(db, "broadcasts", id)); };

    // æé†’æ™‚é–“æª¢æ ¸
    function checkTimeAlert() {
        const targetTimes = ["10:00","12:30","14:30","16:30","18:30","20:30","22:00"];
        const now = new Date();
        const curTimeStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        
        if(targetTimes.includes(curTimeStr)) {
            document.getElementById('temp-alert').classList.remove('hidden');
            alert("â° å†°ç®±æª¢æŸ¥æ™‚é–“åˆ°ï¼è«‹ç¢ºå¯¦é‡æ¸¬ä¸¦è¼¸å…¥æ•¸æ“šã€‚");
        }
    }
</script>

<script>
    // --- ä¸€èˆ¬ä»‹é¢é‚è¼¯ (èˆ‡ Firebase ç„¡é—œ) ---
    window.vShapes = [];
    let selectedShapeId = null;

    function toggleAuth(reg) {
        document.getElementById('login-area').classList.toggle('hidden', reg);
        document.getElementById('register-area').classList.toggle('hidden', !reg);
    }

    function switchTab(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
        document.getElementById('noti-dropdown').style.display = 'none';
    }

    function toggleNotiDropdown() {
        const d = document.getElementById('noti-dropdown');
        d.style.display = d.style.display === 'block' ? 'none' : 'block';
    }

    function zoomImg(src) {
        document.getElementById('img-zoom').src = src;
        document.getElementById('img-overlay').style.display = 'flex';
    }

    // å¸³å‹™è¨ˆç®—
    window.calcV15Money = () => {
        let total = 0;
        [500,100,50,10,5,1].forEach(u => {
            const val = (parseFloat(document.getElementById(`m-reg-${u}`).value)||0) + (parseFloat(document.getElementById(`m-res-${u}`).value)||0);
            const sub = val * u;
            document.getElementById(`m-sub-${u}`).innerText = "$" + sub;
            total += sub;
        });
        document.getElementById('out-money-total').innerText = total;
    };

    window.calcAvg = () => {
        const t = parseFloat(document.getElementById('sales-total').value)||0;
        const v = parseFloat(document.getElementById('sales-visitors').value)||0;
        if(v > 0) document.getElementById('sales-avg').value = Math.round(t/v);
    };

    // æ¨¡å‹åœ– ç·¨è¼¯é‚è¼¯
    function renderMapV15(data) {
        window.vShapes = data.shapes || [];
        const canvas = document.getElementById('shelf-canvas');
        canvas.innerHTML = "";
        if(data.bg) canvas.style.backgroundImage = `url(${data.bg})`;
        
        window.vShapes.forEach(s => {
            const div = document.createElement('div');
            div.className = `shape ${s.done?'done':''} ${selectedShapeId === s.id ? 'selected' : ''}`;
            div.style.left = s.x + "px"; div.style.top = s.y + "px";
            div.style.width = s.w + "px"; div.style.height = s.h + "px";
            div.innerText = s.name + (s.done ? '\nâœ…' : '');
            
            if(window.user.shift === 'ä¸»ç®¡'){
                div.onmousedown = (e) => {
                    selectedShapeId = s.id;
                    let ox = e.clientX - s.x; let oy = e.clientY - s.y;
                    document.onmousemove = (ev) => {
                        s.x = ev.clientX - ox; s.y = ev.clientY - oy;
                        div.style.left = s.x + "px"; div.style.top = s.y + "px";
                    };
                    document.onmouseup = () => { document.onmousemove = null; renderMapV15({shapes:window.vShapes, bg:window.mapBg}); };
                };
            } else {
                div.onclick = async () => {
                    if(confirm(`ç¢ºèªã€${s.name}ã€‘æª¢æŸ¥å®Œæˆï¼Ÿ`)) {
                        s.done = true; s.time = new Date().toLocaleTimeString();
                        await window.setDoc(window.doc(window.db, "settings", "global_map"), { shapes: window.vShapes, bg: window.mapBg });
                    }
                };
            }
            canvas.appendChild(div);
        });
    }

    window.addShape = () => {
        const name = prompt("å€åŸŸåç¨±ï¼š");
        if(!name) return;
        window.vShapes.push({ id:Date.now(), name, x:30, y:30, w:60, h:40, done:false });
        renderMapV15({shapes:window.vShapes, bg:window.mapBg});
    };
    window.deleteShape = () => {
        if(!selectedShapeId) return alert("è«‹å…ˆé»é¸åœ–å½¢");
        window.vShapes = window.vShapes.filter(s => s.id !== selectedShapeId);
        selectedShapeId = null;
        renderMapV15({shapes:window.vShapes, bg:window.mapBg});
    };
    window.renameShape = () => {
        if(!selectedShapeId) return alert("è«‹å…ˆé»é¸åœ–å½¢");
        const s = window.vShapes.find(x => x.id === selectedShapeId);
        const nn = prompt("æ–°åç¨±ï¼š", s.name);
        if(nn) s.name = nn;
        renderMapV15({shapes:window.vShapes, bg:window.mapBg});
    };
    window.copyShape = () => {
        if(!selectedShapeId) return alert("è«‹å…ˆé»é¸åœ–å½¢");
        const s = window.vShapes.find(x => x.id === selectedShapeId);
        window.vShapes.push({...s, id:Date.now(), x: s.x+10, y: s.y+10});
        renderMapV15({shapes:window.vShapes, bg:window.mapBg});
    };

    window.uploadMapBg = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            window.mapBg = ev.target.result;
            document.getElementById('shelf-canvas').style.backgroundImage = `url(${ev.target.result})`;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    // å®¢æœè¡¨å–®
    window.openSvcForm = (type) => {
        document.getElementById('svc-popup').classList.remove('hidden');
        document.getElementById('svc-title').innerText = type;
        const f = document.getElementById('svc-fields');
        f.innerHTML = "";
        if(type==='å®¢è¨‚'){
            f.innerHTML = `<input id="f-p" placeholder="å“å"> <input id="f-b" placeholder="æ¢ç¢¼"> <input id="f-q" placeholder="æ•¸é‡"> <input id="f-c" placeholder="å®¢å"> <input id="f-ph" placeholder="é›»è©±"> <input id="f-l" placeholder="LINE ID"> <input id="f-t" placeholder="æ–¹ä¾¿è¯çµ¡æ™‚é–“">`;
        } else if(type==='ç¶­ä¿®'){
            f.innerHTML = `<input id="f-p" placeholder="é›»å™¨å"> <input id="f-b" placeholder="æ¢ç¢¼"> <input id="f-d" type="date" placeholder="è³¼è²·æ—¥"> <input id="f-c" placeholder="å®¢å"> <input id="f-ph" placeholder="é›»è©±">`;
        } else if(type==='å”®ç½„' || type==='å ±å»¢'){
            f.innerHTML = `<input id="f-p" placeholder="å“å"> <input id="f-b" placeholder="æ¢ç¢¼">`;
        } else {
            f.innerHTML = `<textarea id="f-msg" placeholder="è«‹æè¿°å…§å®¹..."></textarea>`;
        }
    };
    window.closeSvcPopup = () => document.getElementById('svc-popup').classList.add('hidden');

</script>
</body>
</html>